<?php
/**
 * ============================================================================
 * Redis Bot Protection - SEO –û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–ê –í–ï–†–°–Ü–Ø v3.8.4 (ADMIN AJAX FIX)
 * ============================================================================
 * 
 * –í–ï–†–°–Ü–Ø 3.8.4 - ADMIN AJAX PROTECTION FIX (2026-01-28)
 * 
 * –ù–û–í–ï v3.8.4:
 * üî• –ë—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫ URL –∞–¥–º—ñ–Ω–∫–∏ ($ADMIN_URL_WHITELIST)
 * üî• –í–∏–∫–ª—é—á–µ–Ω–Ω—è AJAX –∑–∞–ø–∏—Ç—ñ–≤ –∑ Rate Limit (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
 * üî• –ú–Ω–æ–∂–Ω–∏–∫ –ª—ñ–º—ñ—Ç—ñ–≤ –¥–ª—è AJAX –∑–∞–ø–∏—Ç—ñ–≤ ($AJAX_RATE_LIMIT_MULTIPLIER)
 * üî• –§—É–Ω–∫—Ü—ñ—è _should_skip_rate_limit() –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
 * üî• –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ Content-Type —Ç–∞ Accept –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è AJAX
 * üî• –î–æ–¥–∞–Ω–æ PetalBot (Huawei Petal Search) –¥–æ –±—ñ–ª–æ–≥–æ —Å–ø–∏—Å–∫—É –ø–æ—à—É–∫–æ–≤–∏—Ö —Å–∏—Å—Ç–µ–º
 * 
 * –ü–†–û–ë–õ–ï–ú–ê –Ø–ö–£ –í–ò–†–Ü–®–ï–ù–û:
 * - –ü—Ä–∏ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ–π —Ä–æ–±–æ—Ç—ñ –≤ –∞–¥–º—ñ–Ω—Ü—ñ (–±–∞–≥–∞—Ç–æ AJAX –∑–∞–ø–∏—Ç—ñ–≤) Rate Limit –±–ª–æ–∫—É–≤–∞–≤ –∞–¥–º—ñ–Ω–∞
 * - AJAX –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–∞–∫–∏–π —Å–∞–º–∏–π User-Agent —è–∫ —ñ –±—Ä–∞—É–∑–µ—Ä (–≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ X-Requested-With)
 * - JS Challenge –≤–∂–µ –ø—Ä–æ–ø—É—Å–∫–∞–≤ AJAX, –∞–ª–µ Rate Limit –≤ protect() - –Ω—ñ
 * 
 * –í–ê–†–Ü–ê–ù–¢–ò –†–Ü–®–ï–ù–ù–Ø (–º–æ–∂–Ω–∞ –∫–æ–º–±—ñ–Ω—É–≤–∞—Ç–∏):
 * 1. –î–æ–¥–∞—Ç–∏ —Å–≤—ñ–π IP –≤ $ADMIN_IP_WHITELIST (–Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–µ)
 * 2. –£–≤—ñ–º–∫–Ω—É—Ç–∏ $ADMIN_URL_WHITELIST (–∑–∞—Ö–∏—â–∞—î –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ URL)
 * 3. –£–≤—ñ–º–∫–Ω—É—Ç–∏ $AJAX_SKIP_RATE_LIMIT (–ø—Ä–æ–ø—É—Å–∫–∞—î –≤—Å—ñ AJAX)
 * 4. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ $AJAX_RATE_LIMIT_MULTIPLIER (–∑–±—ñ–ª—å—à—É—î –ª—ñ–º—ñ—Ç–∏ –¥–ª—è AJAX)
 * 
 * ============================================================================
 * 
 * –í–ï–†–°–Ü–Ø 3.8.3 - OFFICIAL GOOGLE IP WHITELIST (2026-01-27)
 * 
 * –ù–û–í–ï v3.8.3:
 * üî• –û–Ω–æ–≤–ª–µ–Ω–æ IP –¥—ñ–∞–ø–∞–∑–æ–Ω–∏ Google –∑ –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ –¥–∂–µ—Ä–µ–ª–∞
 * üî• –ó–∞–º—ñ–Ω–µ–Ω–æ —à–∏—Ä–æ–∫—ñ –¥—ñ–∞–ø–∞–∑–æ–Ω–∏ –Ω–∞ —Ç–æ—á–Ω—ñ /27 —Ç–∞ /28 –ø—ñ–¥–º–µ—Ä–µ–∂—ñ
 * üî• –î–æ–¥–∞–Ω–æ 160+ IPv4 —Ç–∞ 130+ IPv6 –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ–≤ Googlebot
 * üî• –î–∂–µ—Ä–µ–ª–æ: https://developers.google.com/search/apis/ipranges/googlebot.json
 * üî• –î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Google: 2026-01-20
 * 
 * –í–ê–ñ–õ–ò–í–û: –°—Ç–∞—Ä—ñ —à–∏—Ä–æ–∫—ñ –¥—ñ–∞–ø–∞–∑–æ–Ω–∏ (/16, /17) –≤–∫–ª—é—á–∞–ª–∏ –±–∞–≥–∞—Ç–æ IP —â–æ –ù–ï —î Googlebot!
 * –ù–æ–≤—ñ —Ç–æ—á–Ω—ñ –¥—ñ–∞–ø–∞–∑–æ–Ω–∏ –≥–∞—Ä–∞–Ω—Ç—É—é—Ç—å —â–æ —Ç—ñ–ª—å–∫–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π Googlebot –±—É–¥–µ –≤ whitelist.
 * 
 * –í–ï–†–°–Ü–Ø 3.8.2 - UNIFIED IP WHITELIST (2026-01-26)
 * 
 * –ù–û–í–ï v3.8.2:
 * üî• –Ñ–¥–∏–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è _is_whitelisted_ip() –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –í–°–Ü–• –±—ñ–ª–∏—Ö —Å–ø–∏—Å–∫—ñ–≤
 * üî• –í–°–Ü IP –∑ –±—É–¥—å-—è–∫–æ–≥–æ –±—ñ–ª–æ–≥–æ —Å–ø–∏—Å–∫—É –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å –í–°–Ü –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –æ–¥–Ω–∞–∫–æ–≤–æ
 * üî• –°–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞: –æ–¥–∏–Ω –≤–∏–∫–ª–∏–∫ –∑–∞–º—ñ—Å—Ç—å –¥–≤–æ—Ö –æ–∫—Ä–µ–º–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
 * 
 * –ë–Ü–õ–Ü –°–ü–ò–°–ö–ò IP (–æ–±–∏–¥–≤–∞ –ø—Ä–∞—Ü—é—é—Ç—å –û–î–ù–ê–ö–û–í–û):
 * - $ADMIN_IP_WHITELIST    - –≤–ª–∞—Å–Ω—ñ/–∞–¥–º—ñ–Ω—Å—å–∫—ñ IP
 * - $SEARCH_ENGINE_IP_RANGES - IP –ø–æ—à—É–∫–æ–≤–∏—Ö —Å–∏—Å—Ç–µ–º
 * 
 * –©–û –ü–†–û–ü–£–°–ö–ê–Ñ–¢–¨–°–Ø –¥–ª—è IP –∑ –±—ñ–ª–∏—Ö —Å–ø–∏—Å–∫—ñ–≤:
 * ‚úÖ JS Challenge (PoW)
 * ‚úÖ Rate Limit
 * ‚úÖ Burst Detection  
 * ‚úÖ UA Rotation
 * ‚úÖ No-Cookie Attack Detection
 * 
 * –í–ï–†–°–Ü–Ø 3.8.1 - ADMIN IP WHITELIST + STATS FIX (2026-01-26)
 * 
 * –ù–û–í–ï v3.8.1:
 * üî• –ë—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫ –∞–¥–º—ñ–Ω—Å—å–∫–∏—Ö/–≤–ª–∞—Å–Ω–∏—Ö IP ($ADMIN_IP_WHITELIST)
 * üî• –ê–¥–º—ñ–Ω—Å—å–∫—ñ IP –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å –í–°–Ü –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (JS Challenge, Rate Limit, —ñ —Ç.–¥.)
 * üî• –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ IPv4 —Ç–∞ IPv6 –∑ CIDR –Ω–æ—Ç–∞—Ü—ñ—î—é
 * üîß –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ 'passed' —Ç–µ–ø–µ—Ä –ª–æ–≥—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –†–ï–ê–õ–¨–ù–û–ú–£ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—ñ challenge
 * üîß –ü—Ä–∏–±—Ä–∞–Ω–æ —Ö–∏–±–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ cookie
 * 
 * –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ê–î–ú–Ü–ù–°–¨–ö–ò–• IP:
 * $ADMIN_IP_WHITELIST = array(
 *     '212.84.160.58/32',           // –û–¥–∏–Ω–æ—á–Ω–∏–π IPv4
 *     '212.84.160.58',              // –¢–µ —Å–∞–º–µ –±–µ–∑ /32
 *     '10.0.0.0/8',                 // –ü—ñ–¥–º–µ—Ä–µ–∂–∞
 *     '2a00:1e20:11:9108::/64',     // IPv6
 * );
 * 
 * –í–ï–†–°–Ü–Ø 3.8.0 - PROOF OF WORK PROTECTION (2026-01-26)
 * 
 * –ù–û–í–ï v3.8.0:
 * üî• Proof of Work (PoW) challenge –∑–∞–º—ñ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ–≥–æ —Å—É–º—É–≤–∞–Ω–Ω—è
 * üî• SHA-256 —Ö–µ—à—É–≤–∞–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞
 * üî• –ù–∞–ª–∞—à—Ç–æ–≤—É–≤–∞–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω—É–ª—ñ–≤ —É —Ö–µ—à—ñ)
 * üî• –î–≤–∞ —Å—Ç–∏–ª—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏: Cloudflare —Ç–∞ SMF
 * üî• –°–µ—Ä–≤–µ—Ä–Ω–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è PoW —Ä—ñ—à–µ–Ω–Ω—è
 * üî• –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—á–∏—Å–ª–µ–Ω—å (—Ö–µ—à—ñ/—Å–µ–∫)
 * üî• –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ CPU-–ª–µ–≥–∫–∏—Ö –±–æ—Ç—ñ–≤
 * 
 * –Ø–ö –ü–†–ê–¶–Æ–Ñ:
 * - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º—É—î challenge_id —Ç–∞ difficulty (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω—É–ª—ñ–≤)
 * - –ë—Ä–∞—É–∑–µ—Ä —à—É–∫–∞—î nonce —Ç–∞–∫–∏–π, —â–æ SHA256(id + nonce) –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ N –Ω—É–ª—ñ–≤
 * - –ü—Ä–∏ difficulty=4: ~65,000 —Ö–µ—à—ñ–≤, 1-3 —Å–µ–∫—É–Ω–¥–∏
 * - –ü—Ä–∏ difficulty=5: ~1,000,000 —Ö–µ—à—ñ–≤, 10-30 —Å–µ–∫—É–Ω–¥
 * - –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–∏—Ñ—ñ–∫—É—î hash(id + nonce) —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î cookie
 * 
 * –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø PoW:
 * $_JSC_CONFIG['pow_enabled'] = true;      // –£–≤—ñ–º–∫–Ω—É—Ç–∏ PoW
 * $_JSC_CONFIG['pow_difficulty'] = 4;      // –ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ω—É–ª—ñ–≤ (4-5 —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
 * $_JSC_CONFIG['pow_timeout'] = 60;        // –ú–∞–∫—Å–∏–º—É–º —Å–µ–∫—É–Ω–¥
 * $_JSC_CONFIG['pow_style'] = 'cloudflare'; // 'cloudflare' –∞–±–æ 'smf'
 * 
 * –ü–ï–†–ï–í–ê–ì–ò PoW:
 * ‚úÖ –ë–æ—Ç–∏ –ø–æ–≤–∏–Ω–Ω—ñ –≤–∏—Ç—Ä–∞—á–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω—ñ CPU —Ä–µ—Å—É—Ä—Å–∏
 * ‚úÖ –ù–µ –º–æ–∂–Ω–∞ –æ–±—ñ–π—Ç–∏ –±–µ–∑ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–±—á–∏—Å–ª–µ–Ω—å
 * ‚úÖ –ú–∞—Å—à—Ç–∞–±—É—î—Ç—å—Å—è –∑—ñ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—é
 * ‚úÖ –õ–µ–≥—ñ—Ç–∏–º–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —á–µ–∫–∞—é—Ç—å 1-3 —Å–µ–∫—É–Ω–¥–∏
 * ‚úÖ –ë–æ—Ç–∏ –Ω–∞ —Å–ª–∞–±–∫–æ–º—É –∑–∞–ª—ñ–∑—ñ –±–ª–æ–∫—É—é—Ç—å—Å—è —Ç–∞–π–º–∞—É—Ç–æ–º
 * 
 * ============================================================================
 * 
 * –í–ï–†–°–Ü–Ø 3.6.5 - NO COOKIE ATTACK PROTECTION (2026-01-15)
 * 
 * –í–ï–†–°–Ü–Ø 3.7.0 - IP WHITELIST FOR ALL USER AGENTS (2026-01-18)
 * 
 * –ù–û–í–ï v3.7.0:
 * üî• –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ IP –ø–æ –±—ñ–ª–æ–º—É —Å–ø–∏—Å–∫—É –¥–ª—è –í–°–Ü–• User-Agent (–Ω–µ —Ç—ñ–ª—å–∫–∏ –±–æ—Ç—ñ–≤)
 * üî• –Ø–∫—â–æ IP –Ω–∞–ª–µ–∂–∏—Ç—å Google/Bing/Yandex - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ë–ï–ó challenge
 * üî• –ö–µ—à—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ IP –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤ Redis (24 –≥–æ–¥–∏–Ω–∏)
 * üî• –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ IPv4 —Ç–∞ IPv6 CIDR
 * üî• –ú–∏—Ç—Ç—î–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ - –±–µ–∑ –∑–∞—Ç—Ä–∏–º–æ–∫ rDNS
 * üî• –ö–æ–¥ challenge —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑–º—ñ–Ω–µ–Ω–æ –∑ 503 –Ω–∞ 200 –¥–ª—è SEO
 * 
 * –Ø–ö –ü–†–ê–¶–Æ–Ñ:
 * - –ë—É–¥—å-—è–∫–∏–π –∑–∞–ø–∏—Ç ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ IP –ø–æ –±—ñ–ª–æ–º—É —Å–ø–∏—Å–∫—É
 * - IP –≤ —Å–ø–∏—Å–∫—É Google/Bing/Yandex ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ (–±—É–¥—å-—è–∫–∏–π User-Agent!)
 * - IP –ù–ï –≤ —Å–ø–∏—Å–∫—É ‚Üí –∑–≤–∏—á–∞–π–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ (UA, rDNS, rate limit)
 * 
 * ============================================================================
 * 
 * –í–ï–†–°–Ü–Ø 3.6.6 - COUNTER RESET ON SUCCESSFUL LOGIN (2026-01-15)
 * 
 * –ù–û–í–ï v3.6.6:
 * üî• –°–∫–∏–¥–∞–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ no_cookie_attempts –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ cookie
 * üî• –î–æ–∑–≤–æ–ª—è—î –∫—ñ–ª—å–∫–æ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –æ–¥–Ω–æ–≥–æ IP –∑–∞—Ö–æ–¥–∏—Ç–∏ –Ω–∞ —Å–∞–π—Ç
 * üî• –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
 * 
 * –Ø–ö –ü–†–ê–¶–Æ–Ñ:
 * - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á 1: –ó–∞—Ö–æ–¥–∏—Ç—å ‚Üí JS Challenge ‚Üí –æ—Ç—Ä–∏–º—É—î cookie ‚Üí –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–∫–∏–¥–∞—î—Ç—å—Å—è
 * - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á 2: –ó–∞—Ö–æ–¥–∏—Ç—å ‚Üí JS Challenge ‚Üí –æ—Ç—Ä–∏–º—É—î cookie ‚Üí –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–∫–∏–¥–∞—î—Ç—å—Å—è
 * - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á 3: –ó–∞—Ö–æ–¥–∏—Ç—å ‚Üí JS Challenge ‚Üí –æ—Ç—Ä–∏–º—É—î cookie ‚Üí –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–∫–∏–¥–∞—î—Ç—å—Å—è
 * - –í—Å—ñ 3+ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å –∑–∞–π—Ç–∏ –∑ –æ–¥–Ω–æ–≥–æ IP –±–µ–∑ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è!
 * 
 * –ü–†–û–ë–õ–ï–ú–ê –Ø–ö–£ –í–ò–†–Ü–®–ï–ù–û:
 * - –†–∞–Ω—ñ—à–µ: –ó –æ–¥–Ω–æ–≥–æ IP –º–æ–≥–ª–∏ –∑–∞–π—Ç–∏ —Ç—ñ–ª—å–∫–∏ 3 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (–ø–æ—Ä—ñ–≥ $noCookieThreshold)
 * - –¢–µ–ø–µ—Ä: –ù–µ–æ–±–º–µ–∂–µ–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ –æ–¥–Ω–æ–≥–æ IP ‚úÖ
 * 
 * 
 * –í–ï–†–°–Ü–Ø 3.6.7 - ADMIN PANEL FIX (2026-01-15)
 * 
 * –ù–û–í–ï v3.6.7:
 * üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è IP –≤ –∞–¥–º—ñ–Ω—Ü—ñ –¥–ª—è blocked:no_cookie
 * üîß –î–æ–¥–∞–Ω–æ –ø–æ–ª–µ 'ip' –≤ –¥–∞–Ω—ñ blocked:no_cookie –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ –∞–¥–º—ñ–Ω–∫–æ—é
 * 
 * ============================================================================
 * 
 * 
 * –ù–û–í–ï v3.6.5:
 * üî• –®–≤–∏–¥–∫–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –±–æ—Ç—ñ–≤ –ë–ï–ó cookies (3 –∑–∞–ø–∏—Ç–∏ –∑–∞–º—ñ—Å—Ç—å 100)
 * üî• –ñ–æ—Ä—Å—Ç–∫—ñ rate limits –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –±–µ–∑ bot_protection_uid
 * üî• –í–∏—è–≤–ª–µ–Ω–Ω—è –±–æ—Ç—ñ–≤ —è–∫—ñ –ù–ï –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å cookies
 * üî• API –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –≤ 30 —Ä–∞–∑—ñ–≤ —à–≤–∏–¥—à–µ
 * 
 * –Ø–ö –ü–†–ê–¶–Æ–Ñ:
 * - –ë–æ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å JS Challenge ‚Üí –æ—Ç—Ä–∏–º—É—î mk_verified cookie
 * - –ë–æ—Ç —Ä–æ–±–∏—Ç—å –∑–∞–ø–∏—Ç–∏, –∞–ª–µ –ù–ï –∑–±–µ—Ä—ñ–≥–∞—î bot_protection_uid cookie
 * - –°–∏—Å—Ç–µ–º–∞ –≤–∏—è–≤–ª—è—î 3 –∑–∞–ø–∏—Ç–∏ –±–µ–∑ bot_protection_uid –∑–∞ 30 —Å–µ–∫—É–Ω–¥
 * - –ë–õ–û–ö–£–í–ê–ù–ù–Ø: Redis + API (–∑–∞–º—ñ—Å—Ç—å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è 100 –∑–∞–ø–∏—Ç—ñ–≤)
 * 
 * –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø (—Ä—è–¥–æ–∫ ~607):
 * - $noCookieThreshold = 3;        // –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –±–µ–∑ cookie
 * - $noCookieTimeWindow = 30;      // –ó–∞ —Å–∫—ñ–ª—å–∫–∏ —Å–µ–∫—É–Ω–¥
 * - $noCookieRateLimits = array(); // –ñ–æ—Ä—Å—Ç–∫—ñ –ª—ñ–º—ñ—Ç–∏
 * 
 * ============================================================================
 * 
 * –í–ï–†–°–Ü–Ø 3.6.0 - SEO OPTIMIZATION + CUSTOM USER AGENTS (2026-01-14)
 * 
 * –ù–û–í–ï v3.6.0:
 * ‚úÖ –†–æ–∑—à–∏—Ä–µ–Ω–∏–π whitelist –ø–æ—à—É–∫–æ–≤–∏—Ö —Å–∏—Å—Ç–µ–º (40+ –±–æ—Ç—ñ–≤)
 * ‚úÖ –°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ (Instagram, Pinterest, LinkedIn, TikTok —Ç–∞ —ñ–Ω.)
 * ‚úÖ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ (Pingdom, UptimeRobot, GTmetrix —Ç–∞ —ñ–Ω.)
 * ‚úÖ –í–ª–∞—Å–Ω—ñ User Agents - whitelist –¥–ª—è –≤–∞—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
 * ‚úÖ –†–∞–Ω–Ω—î –≤–∏—è–≤–ª–µ–Ω–Ω—è –±–æ—Ç—ñ–≤ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ü–ï–†–ï–î Rate Limit)
 * ‚úÖ –û–∫—Ä–µ–º—ñ –ª—ñ–º—ñ—Ç–∏ –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö –±–æ—Ç—ñ–≤
 * ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è SEO –±–æ—Ç—ñ–≤
 * ‚úÖ –®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–µ–∑ Redis overhead –¥–ª—è –±–æ—Ç—ñ–≤
 * SEO –ë–û–¢–ò (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å—Å—è):
 * - Google (Googlebot, Google-InspectionTool, AdsBot, APIs-Google)
 * - Yandex (YandexBot, YandexImages, YandexMetrika)
 * - Bing (Bingbot, BingPreview, msnbot)
 * - Baidu (Baiduspider)
 * - DuckDuckGo (DuckDuckBot)
 * - Yahoo (Slurp)
 * - Seznam (SeznamBot)
 * - Sogou (Sogou Spider)
 * - Exabot
 * - Applebot (Apple)
 * - Screaming Frog SEO Spider
 * - Semrush, Ahrefs, Majestic
 * 
 * –°–û–¶–Ü–ê–õ–¨–ù–Ü –ú–ï–†–ï–ñ–Ü:
 * - Facebook (facebookexternalhit, facebookcatalog)
 * - Twitter/X (Twitterbot)
 * - Instagram (Instagram)
 * - Pinterest (Pinterest)
 * - LinkedIn (LinkedInBot)
 * - TikTok (TikTok, Bytespider)
 * - WhatsApp, Telegram, Viber
 * - Discord, Slack
 * 
 * –ú–û–ù–Ü–¢–û–†–ò–ù–ì:
 * - Pingdom, UptimeRobot, StatusCake
 * - GTmetrix, WebPageTest
 * - Lighthouse
 * 
 * –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –í–õ–ê–°–ù–ò–• USER AGENTS:
 * $protection->addCustomUserAgent('MyApp/1.0');
 * $protection->addCustomUserAgent('MyBot');
 * $protection->setCustomUserAgents(['MyApp/1.0', 'MyBot', 'MyCrawler']);
 * 
 * ============================================================================
 */

// ============================================================================
// –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø –í–õ–ê–°–ù–ò–• USER AGENTS (–ù–ê–ô–í–ò–©–ò–ô –ü–†–Ü–û–†–ò–¢–ï–¢)
// ============================================================================

/**
 * –í–ê–ñ–õ–ò–í–û! –í–ª–∞—Å–Ω—ñ User Agents –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è –ü–ï–†–ï–î JS Challenge!
 * 
 * –î–æ–¥–∞–π —Å—é–¥–∏ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ User Agents —Å–≤–æ—ó—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤/–±–æ—Ç—ñ–≤:
 * - –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ (Pingdom, UptimeRobot, StatusCake)
 * - –í–ª–∞—Å–Ω—ñ –∫—Ä–∞—É–ª–µ—Ä–∏ —Ç–∞ —Å–∫—Ä–µ–π–ø–µ—Ä–∏
 * - –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏ –∫–æ–º–ø–∞–Ω—ñ—ó
 * - API –∫–ª—ñ—î–Ω—Ç–∏
 * 
 * ‚ö†Ô∏è –£–í–ê–ì–ê: –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–∞–Ω–∞–¥—Ç–æ –∑–∞–≥–∞–ª—å–Ω—ñ –ø–∞—Ç—Ç–µ—Ä–Ω–∏!
 * ‚ùå –ü–û–ì–ê–ù–û: 'Android', 'Windows', 'Mozilla', 'Chrome'
 * ‚úÖ –î–û–ë–†–ï: 'MyCompany-Monitor', 'MyBot/1.0', 'InternalService'
 */
$CUSTOM_USER_AGENTS = array(
    // –î–æ–¥–∞–π —Å–≤–æ—ó User Agents —Ç—É—Ç:
    'hosttracker',           // ‚úÖ OK - –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
    //'nexus',                 // ‚ö†Ô∏è –ú–æ–∂–µ –∑–±—ñ–≥–∞—Ç–∏—Å—è –∑ Nexus —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º–∏
    // 'Android',            // ‚ùå –ù–ï –î–û–î–ê–í–ê–ô! –¶–µ –∑–∞–±–ª–æ–∫—É—î –≤—Å—ñ Android –ø—Ä–∏—Å—Ç—Ä–æ—ó!
    
    // –ü—Ä–∏–∫–ª–∞–¥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω—ñ–≤:
    // 'MyCompany-Monitor/1.0',
    // 'InternalBot',
    // 'API-Client-v2',
);

// ============================================================================
// –ë–Ü–õ–ò–ô –°–ü–ò–°–û–ö –ê–î–ú–Ü–ù–°–¨–ö–ò–•/–í–õ–ê–°–ù–ò–• IP (v3.8.1) - –ù–ê–ô–í–ò–©–ò–ô –ü–†–Ü–û–†–ò–¢–ï–¢!
// ============================================================================
/**
 * IP –∞–¥—Ä–µ—Å–∏ —è–∫—ñ –ó–ê–í–ñ–î–ò –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å—Å—è –ë–ï–ó –±—É–¥—å-—è–∫–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫!
 * 
 * ‚ö†Ô∏è –£–í–ê–ì–ê: –¶—ñ IP –ø–æ–≤–Ω—ñ—Å—Ç—é –æ–±—Ö–æ–¥—è—Ç—å –∑–∞—Ö–∏—Å—Ç! –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ç—ñ–ª—å–∫–∏ –¥–ª—è:
 * - –í–ª–∞—Å–Ω–∏—Ö IP –∞–¥—Ä–µ—Å (–¥—ñ–º, –æ—Ñ—ñ—Å)
 * - IP —Å–µ—Ä–≤–µ—Ä—ñ–≤ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É
 * - –î–æ–≤—ñ—Ä–µ–Ω–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä—ñ–≤
 * 
 * –§–æ—Ä–º–∞—Ç–∏:
 * - –û–¥–∏–Ω–æ—á–Ω–∏–π IP: '212.84.160.58/32' –∞–±–æ '212.84.160.58'
 * - –ü—ñ–¥–º–µ—Ä–µ–∂–∞: '192.168.1.0/24'
 * - IPv6: '2a00:1e20:11:9108::/64'
 */
$ADMIN_IP_WHITELIST = array(
    // ========================================================================
    // –î–û–î–ê–ô –°–í–û–á IP –¢–£–¢:
    // ========================================================================
    // '212.84.160.58/32',           // –ü—Ä–∏–∫–ª–∞–¥: –î–æ–º–∞—à–Ω—ñ–π IP
    // '212.84.160.58',              // –¢–µ —Å–∞–º–µ –±–µ–∑ /32
    // '10.0.0.0/8',                 // –ü—Ä–∏–∫–ª–∞–¥: –í–Ω—É—Ç—Ä—ñ—à–Ω—è –º–µ—Ä–µ–∂–∞
    // '2a00:1e20:11:9108::/64',     // –ü—Ä–∏–∫–ª–∞–¥: IPv6
);

// ============================================================================
// –ù–û–í–ï v3.8.4: –ë–Ü–õ–ò–ô –°–ü–ò–°–û–ö URL –ê–î–ú–Ü–ù–ö–ò
// ============================================================================
/**
 * URL —à–ª—è—Ö–∏ —è–∫—ñ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å Rate Limit —Ç–∞ —ñ–Ω—à—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
 * 
 * ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: 
 * - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∞—Å—Ç–∫–æ–≤–∞ (strpos), —Ç–æ–±—Ç–æ '/admin' –∑–±—ñ–≥–∞—î—Ç—å—Å—è –∑ '/admin/ajax.php'
 * - –ë—É–¥—å –æ–±–µ—Ä–µ–∂–Ω–∏–π –∑ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —à–ª—è—Ö–∞–º–∏!
 * - JS Challenge –≤—Å–µ –æ–¥–Ω–æ –ø—Ä–∞—Ü—é—î (–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –±–æ—Ç—ñ–≤)
 * 
 * –§–æ—Ä–º–∞—Ç–∏:
 * - '/admin'                - –∞–¥–º—ñ–Ω–∫–∞ DLE/—ñ–Ω—à–∏—Ö CMS
 * - '/engine/ajax'          - AJAX –¥–≤–∏–∂–∫–∞ DLE
 * - '/wp-admin'             - WordPress –∞–¥–º—ñ–Ω–∫–∞
 * - '/administrator'        - Joomla –∞–¥–º—ñ–Ω–∫–∞
 */
$ADMIN_URL_WHITELIST_ENABLED = true;  // –£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –±—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫ URL

$ADMIN_URL_WHITELIST = array(
    // ========================================================================
    // –®–õ–Ø–•–ò –ê–î–ú–Ü–ù–ö–ò (—á–∞—Å—Ç–∫–æ–≤–µ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è)
    // ========================================================================
    '/admin',                    // DLE —Ç–∞ –±–∞–≥–∞—Ç–æ —ñ–Ω—à–∏—Ö CMS
    '/engine/ajax',              // DLE AJAX –∑–∞–ø–∏—Ç–∏
    '/engine/admin',             // DLE –∞–¥–º—ñ–Ω–∫–∞ (engine)
    '/engine/inc/',              // DLE includes (–¥–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ AJAX –æ–±—Ä–æ–±–Ω–∏–∫–∏)
    
    // WordPress (—Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ):
    // '/wp-admin',
    // '/wp-json',
    
    // Joomla (—Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ):
    // '/administrator',
    
    // SMF (—Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ):
    // '?action=admin',
);

// ============================================================================
// –ù–û–í–ï v3.8.4: –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø RATE LIMIT –î–õ–Ø AJAX –ó–ê–ü–ò–¢–Ü–í
// ============================================================================
/**
 * –ü—Ä–æ–ø—É—Å–∫–∞—Ç–∏ Rate Limit –¥–ª—è –í–°–Ü–• AJAX –∑–∞–ø–∏—Ç—ñ–≤?
 * 
 * ‚ö†Ô∏è –£–í–ê–ì–ê: 
 * - –ë–æ—Ç–∏ –º–æ–∂—É—Ç—å –µ–º—É–ª—é–≤–∞—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Requested-With
 * - –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä–∞–∑–æ–º –∑ JS Challenge (—è–∫–∏–π –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è)
 * - –ë–µ–∑–ø–µ—á–Ω—ñ—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ $ADMIN_URL_WHITELIST –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö URL
 * 
 * true  = –í—Å—ñ AJAX –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å Rate Limit (–º–µ–Ω—à –±–µ–∑–ø–µ—á–Ω–æ)
 * false = AJAX –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è Rate Limit (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
 */
$AJAX_SKIP_RATE_LIMIT = false;

/**
 * –ú–Ω–æ–∂–Ω–∏–∫ –ª—ñ–º—ñ—Ç—ñ–≤ –¥–ª—è AJAX –∑–∞–ø–∏—Ç—ñ–≤ (—è–∫—â–æ $AJAX_SKIP_RATE_LIMIT = false)
 * 
 * –ù–∞–ø—Ä–∏–∫–ª–∞–¥, 3.0 = –ª—ñ–º—ñ—Ç–∏ –≤ 3 —Ä–∞–∑–∏ –≤–∏—â—ñ –¥–ª—è AJAX –∑–∞–ø–∏—Ç—ñ–≤
 * –¶–µ –¥–æ–∑–≤–æ–ª—è—î –±—ñ–ª—å—à–µ AJAX –∑–∞–ø–∏—Ç—ñ–≤ –±–µ–∑ –ø–æ–≤–Ω–æ–≥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑–∞—Ö–∏—Å—Ç—É
 * 
 * –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è:
 * - 1.0 = –±–µ–∑ –∑–º—ñ–Ω (AJAX = –∑–≤–∏—á–∞–π–Ω—ñ –∑–∞–ø–∏—Ç–∏)
 * - 2.0 = –ø–æ–¥–≤—ñ–π–Ω—ñ –ª—ñ–º—ñ—Ç–∏ –¥–ª—è AJAX
 * - 3.0 = –ø–æ—Ç—Ä—ñ–π–Ω—ñ –ª—ñ–º—ñ—Ç–∏ –¥–ª—è AJAX (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è –∞–¥–º—ñ–Ω–æ–∫)
 * - 5.0 = –ø'—è—Ç–∏–∫—Ä–∞—Ç–Ω—ñ –ª—ñ–º—ñ—Ç–∏ (–¥–ª—è –¥—É–∂–µ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∏—Ö AJAX –æ–ø–µ—Ä–∞—Ü—ñ–π)
 */
$AJAX_RATE_LIMIT_MULTIPLIER = 3.0;

// ============================================================================
// –ë–Ü–õ–ò–ô –°–ü–ò–°–û–ö IP –ü–û–®–£–ö–û–í–ò–• –°–ò–°–¢–ï–ú (v3.8.3 - –û–ù–û–í–õ–ï–ù–û 2026-01-27)
// ============================================================================
/**
 * –û–±'—î–¥–Ω–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫ CIDR –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ–≤ –ø–æ—à—É–∫–æ–≤–∏—Ö —Å–∏—Å—Ç–µ–º
 * –ü–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –¥–ª—è –í–°–Ü–• User-Agent!
 * 
 * –î–∂–µ—Ä–µ–ª–∞:
 * - Google: https://developers.google.com/search/apis/ipranges/googlebot.json (–û–ù–û–í–õ–ï–ù–û!)
 * - Bing: https://www.bing.com/toolbox/bingbot.json
 * - Yandex: https://yandex.com/support/webmaster/robot-workings/check-yandex-robots.html
 */
$SEARCH_ENGINE_IP_RANGES = array(
    // ========================================================================
    // –¢–ï–°–¢–û–í–Ü IP (–¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏) - —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
    // ========================================================================
    // '212.84.160.58/32',              // –í–∏—Ç–∞–ª—ñ–π IPv4
    // '2a00:1e20:11:9108::/64',        // –í–∏—Ç–∞–ª—ñ–π IPv6
    
    // ========================================================================
    // GOOGLEBOT - –û–§–Ü–¶–Ü–ô–ù–ò–ô –°–ü–ò–°–û–ö (2026-01-20)
    // –î–∂–µ—Ä–µ–ª–æ: https://developers.google.com/search/apis/ipranges/googlebot.json
    // ========================================================================
    
	// GOOGLE PROXY / WEB LIGHT / INFRASTRUCTURE
	'74.125.0.0/16',
	'172.217.0.0/16',
	'142.250.0.0/15',
	'66.102.0.0/20',

    // GOOGLEBOT IPv4
	'66.249.64.0/19',
    '192.178.4.0/27',
    '192.178.4.128/27',
    '192.178.4.160/27',
    '192.178.4.192/27',
    '192.178.4.32/27',
    '192.178.4.64/27',
    '192.178.4.96/27',
    '192.178.5.0/27',
    '192.178.6.0/27',
    '192.178.6.128/27',
    '192.178.6.160/27',
    '192.178.6.192/27',
    '192.178.6.224/27',
    '192.178.6.32/27',
    '192.178.6.64/27',
    '192.178.6.96/27',
    '192.178.7.0/27',
    '192.178.7.128/27',
    '192.178.7.160/27',
    '192.178.7.192/27',
    '192.178.7.224/27',
    '192.178.7.32/27',
    '192.178.7.64/27',
    '192.178.7.96/27',
    '34.100.182.96/28',
    '34.101.50.144/28',
    '34.118.254.0/28',
    '34.118.66.0/28',
    '34.126.178.96/28',
    '34.146.150.144/28',
    '34.147.110.144/28',
    '34.151.74.144/28',
    '34.152.50.64/28',
    '34.154.114.144/28',
    '34.155.98.32/28',
    '34.165.18.176/28',
    '34.175.160.64/28',
    '34.176.130.16/28',
    '34.22.85.0/27',
    '34.64.82.64/28',
    '34.65.242.112/28',
    '34.80.50.80/28',
    '34.88.194.0/28',
    '34.89.10.80/28',
    '34.89.198.80/28',
    '34.96.162.48/28',
    '35.247.243.240/28',
    '66.249.64.0/27',
    '66.249.64.128/27',
    '66.249.64.160/27',
    '66.249.64.192/27',
    '66.249.64.224/27',
    '66.249.64.32/27',
    '66.249.64.64/27',
    '66.249.64.96/27',
    '66.249.65.0/27',
    '66.249.65.128/27',
    '66.249.65.160/27',
    '66.249.65.192/27',
    '66.249.65.224/27',
    '66.249.65.32/27',
    '66.249.65.64/27',
    '66.249.65.96/27',
    '66.249.66.0/27',
    '66.249.66.128/27',
    '66.249.66.160/27',
    '66.249.66.192/27',
    '66.249.66.224/27',
    '66.249.66.32/27',
    '66.249.66.64/27',
    '66.249.66.96/27',
    '66.249.67.0/27',
    '66.249.67.32/27',
    '66.249.67.64/27',
    '66.249.68.0/27',
    '66.249.68.128/27',
    '66.249.68.160/27',
    '66.249.68.192/27',
    '66.249.68.32/27',
    '66.249.68.64/27',
    '66.249.68.96/27',
    '66.249.69.0/27',
    '66.249.69.128/27',
    '66.249.69.160/27',
    '66.249.69.192/27',
    '66.249.69.224/27',
    '66.249.69.32/27',
    '66.249.69.64/27',
    '66.249.69.96/27',
    '66.249.70.0/27',
    '66.249.70.128/27',
    '66.249.70.160/27',
    '66.249.70.192/27',
    '66.249.70.224/27',
    '66.249.70.32/27',
    '66.249.70.64/27',
    '66.249.70.96/27',
    '66.249.71.0/27',
    '66.249.71.128/27',
    '66.249.71.160/27',
    '66.249.71.192/27',
    '66.249.71.224/27',
    '66.249.71.32/27',
    '66.249.71.64/27',
    '66.249.71.96/27',
    '66.249.72.0/27',
    '66.249.72.128/27',
    '66.249.72.160/27',
    '66.249.72.192/27',
    '66.249.72.224/27',
    '66.249.72.32/27',
    '66.249.72.64/27',
    '66.249.73.0/27',
    '66.249.73.128/27',
    '66.249.73.160/27',
    '66.249.73.192/27',
    '66.249.73.224/27',
    '66.249.73.32/27',
    '66.249.73.64/27',
    '66.249.73.96/27',
    '66.249.74.0/27',
    '66.249.74.128/27',
    '66.249.74.160/27',
    '66.249.74.192/27',
    '66.249.74.224/27',
    '66.249.74.32/27',
    '66.249.74.64/27',
    '66.249.74.96/27',
    '66.249.75.0/27',
    '66.249.75.128/27',
    '66.249.75.160/27',
    '66.249.75.192/27',
    '66.249.75.224/27',
    '66.249.75.32/27',
    '66.249.75.64/27',
    '66.249.75.96/27',
    '66.249.76.0/27',
    '66.249.76.128/27',
    '66.249.76.160/27',
    '66.249.76.192/27',
    '66.249.76.224/27',
    '66.249.76.32/27',
    '66.249.76.64/27',
    '66.249.76.96/27',
    '66.249.77.0/27',
    '66.249.77.128/27',
    '66.249.77.160/27',
    '66.249.77.192/27',
    '66.249.77.224/27',
    '66.249.77.32/27',
    '66.249.77.64/27',
    '66.249.77.96/27',
    '66.249.78.0/27',
    '66.249.78.128/27',
    '66.249.78.160/27',
    '66.249.78.32/27',
    '66.249.78.64/27',
    '66.249.78.96/27',
    '66.249.79.0/27',
    '66.249.79.128/27',
    '66.249.79.160/27',
    '66.249.79.192/27',
    '66.249.79.224/27',
    '66.249.79.32/27',
    '66.249.79.64/27',
    
    // GOOGLEBOT IPv6
    '2001:4860:4801:10::/64',
    '2001:4860:4801:12::/64',
    '2001:4860:4801:13::/64',
    '2001:4860:4801:14::/64',
    '2001:4860:4801:15::/64',
    '2001:4860:4801:16::/64',
    '2001:4860:4801:17::/64',
    '2001:4860:4801:18::/64',
    '2001:4860:4801:19::/64',
    '2001:4860:4801:1a::/64',
    '2001:4860:4801:1b::/64',
    '2001:4860:4801:1c::/64',
    '2001:4860:4801:1d::/64',
    '2001:4860:4801:1e::/64',
    '2001:4860:4801:1f::/64',
    '2001:4860:4801:20::/64',
    '2001:4860:4801:21::/64',
    '2001:4860:4801:22::/64',
    '2001:4860:4801:23::/64',
    '2001:4860:4801:24::/64',
    '2001:4860:4801:25::/64',
    '2001:4860:4801:26::/64',
    '2001:4860:4801:27::/64',
    '2001:4860:4801:28::/64',
    '2001:4860:4801:29::/64',
    '2001:4860:4801:2::/64',
    '2001:4860:4801:2a::/64',
    '2001:4860:4801:2b::/64',
    '2001:4860:4801:2c::/64',
    '2001:4860:4801:2d::/64',
    '2001:4860:4801:2e::/64',
    '2001:4860:4801:2f::/64',
    '2001:4860:4801:30::/64',
    '2001:4860:4801:31::/64',
    '2001:4860:4801:32::/64',
    '2001:4860:4801:33::/64',
    '2001:4860:4801:34::/64',
    '2001:4860:4801:35::/64',
    '2001:4860:4801:36::/64',
    '2001:4860:4801:37::/64',
    '2001:4860:4801:38::/64',
    '2001:4860:4801:39::/64',
    '2001:4860:4801:3a::/64',
    '2001:4860:4801:3b::/64',
    '2001:4860:4801:3c::/64',
    '2001:4860:4801:3d::/64',
    '2001:4860:4801:3e::/64',
    '2001:4860:4801:3f::/64',
    '2001:4860:4801:40::/64',
    '2001:4860:4801:41::/64',
    '2001:4860:4801:42::/64',
    '2001:4860:4801:44::/64',
    '2001:4860:4801:45::/64',
    '2001:4860:4801:46::/64',
    '2001:4860:4801:47::/64',
    '2001:4860:4801:48::/64',
    '2001:4860:4801:49::/64',
    '2001:4860:4801:4a::/64',
    '2001:4860:4801:4b::/64',
    '2001:4860:4801:4c::/64',
    '2001:4860:4801:4d::/64',
    '2001:4860:4801:4e::/64',
    '2001:4860:4801:50::/64',
    '2001:4860:4801:51::/64',
    '2001:4860:4801:52::/64',
    '2001:4860:4801:53::/64',
    '2001:4860:4801:54::/64',
    '2001:4860:4801:55::/64',
    '2001:4860:4801:56::/64',
    '2001:4860:4801:57::/64',
    '2001:4860:4801:58::/64',
    '2001:4860:4801:59::/64',
    '2001:4860:4801:60::/64',
    '2001:4860:4801:61::/64',
    '2001:4860:4801:62::/64',
    '2001:4860:4801:63::/64',
    '2001:4860:4801:64::/64',
    '2001:4860:4801:65::/64',
    '2001:4860:4801:66::/64',
    '2001:4860:4801:67::/64',
    '2001:4860:4801:68::/64',
    '2001:4860:4801:69::/64',
    '2001:4860:4801:6a::/64',
    '2001:4860:4801:6b::/64',
    '2001:4860:4801:6c::/64',
    '2001:4860:4801:6d::/64',
    '2001:4860:4801:6e::/64',
    '2001:4860:4801:6f::/64',
    '2001:4860:4801:70::/64',
    '2001:4860:4801:71::/64',
    '2001:4860:4801:72::/64',
    '2001:4860:4801:73::/64',
    '2001:4860:4801:74::/64',
    '2001:4860:4801:75::/64',
    '2001:4860:4801:76::/64',
    '2001:4860:4801:77::/64',
    '2001:4860:4801:78::/64',
    '2001:4860:4801:79::/64',
    '2001:4860:4801:7a::/64',
    '2001:4860:4801:7b::/64',
    '2001:4860:4801:7c::/64',
    '2001:4860:4801:7d::/64',
    '2001:4860:4801:80::/64',
    '2001:4860:4801:81::/64',
    '2001:4860:4801:82::/64',
    '2001:4860:4801:83::/64',
    '2001:4860:4801:84::/64',
    '2001:4860:4801:85::/64',
    '2001:4860:4801:86::/64',
    '2001:4860:4801:87::/64',
    '2001:4860:4801:88::/64',
    '2001:4860:4801:90::/64',
    '2001:4860:4801:91::/64',
    '2001:4860:4801:92::/64',
    '2001:4860:4801:93::/64',
    '2001:4860:4801:94::/64',
    '2001:4860:4801:95::/64',
    '2001:4860:4801:96::/64',
    '2001:4860:4801:97::/64',
    '2001:4860:4801:a0::/64',
    '2001:4860:4801:a1::/64',
    '2001:4860:4801:a2::/64',
    '2001:4860:4801:a3::/64',
    '2001:4860:4801:a4::/64',
    '2001:4860:4801:a5::/64',
    '2001:4860:4801:a6::/64',
    '2001:4860:4801:a7::/64',
    '2001:4860:4801:a8::/64',
    '2001:4860:4801:a9::/64',
    '2001:4860:4801:aa::/64',
    '2001:4860:4801:ab::/64',
    '2001:4860:4801:ac::/64',
    '2001:4860:4801:ad::/64',
    '2001:4860:4801:ae::/64',
    '2001:4860:4801:b0::/64',
    '2001:4860:4801:b1::/64',
    '2001:4860:4801:b2::/64',
    '2001:4860:4801:b3::/64',
    '2001:4860:4801:b4::/64',
    '2001:4860:4801:b5::/64',
    '2001:4860:4801:c::/64',
    '2001:4860:4801:f::/64',
    // YANDEX IPv4
    '5.45.192.0/18',
    '5.255.192.0/18',
    '37.9.64.0/18',
    '37.140.128.0/18',
    '77.88.0.0/18',
    '84.201.128.0/18',
    '87.250.224.0/19',
    '90.156.176.0/22',
    '93.158.128.0/18',
    '95.108.128.0/17',
    '100.43.64.0/19',
    '130.193.32.0/19',
    '141.8.128.0/18',
    '178.154.128.0/17',
    '185.32.187.0/24',
    '199.21.96.0/22',
    '199.36.240.0/22',
    '213.180.192.0/19',
    // YANDEX IPv6
    '2a02:6b8::/32',
    // BING/MICROSOFT IPv4
    '13.66.0.0/16',
    '13.67.0.0/16',
    '13.68.0.0/15',
    '13.104.0.0/14',
    '20.33.0.0/16',
    '20.40.0.0/13',
    '40.74.0.0/15',
    '40.76.0.0/14',
    '40.80.0.0/12',
    '52.96.0.0/12',
    '52.160.0.0/11',
    '52.224.0.0/11',
    '65.52.0.0/14',
    '65.55.0.0/16',
    '104.40.0.0/13',
    '104.208.0.0/13',
    '131.253.0.0/16',
    '157.55.0.0/16',
    '157.56.0.0/14',
    '168.61.0.0/16',
    '191.232.0.0/13',
    '199.30.16.0/20',
    '207.46.0.0/16',
    // BING IPv6
    '2620:1ec:c::0/40',
    '2620:1ec:8f8::/46',
    '2a01:111::/32',
    // BAIDU IPv4
    '116.179.0.0/16',
    '119.63.192.0/21',
    '123.125.71.0/24',
    '180.76.0.0/16',
    '220.181.0.0/16',
    // DUCKDUCKGO IPv4
    '20.191.45.212/32',
    '40.88.21.235/32',
    '52.142.24.149/32',
    '52.142.26.175/32',
    '72.94.249.34/32',
    '72.94.249.35/32',
    // YAHOO IPv4
    '67.195.0.0/16',
    '72.30.0.0/16',
    '74.6.0.0/16',
    '98.136.0.0/14',
    // FACEBOOK IPv4
    '31.13.24.0/21',
    '31.13.64.0/18',
    '66.220.144.0/20',
    '69.63.176.0/20',
    '69.171.224.0/19',
    '157.240.0.0/16',
    '173.252.64.0/18',
    '185.60.216.0/22',
    // FACEBOOK IPv6
    '2a03:2880::/32',
    // APPLE IPv4
    '17.0.0.0/8',
    // APPLE IPv6
    '2620:149::/32',
    '2a01:b740::/32',
    // PETALBOT (HUAWEI) IPv4 - https://aspiegel.com/petalbot
    '114.119.128.0/17',          // –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω PetalBot
);

// ============================================================================
// –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø JS CHALLENGE
// ============================================================================

$_JSC_CONFIG = array(
    'enabled' => true,
    'secret_key' => 'CHANGE_THIS_SECRET_KEY_123!',  // !!! –ó–ú–Ü–ù–ò –ù–ê –°–í–Ü–ô !!!
    'cookie_name' => 'mk_verified',
    'token_lifetime' => 86400,  // 24 –≥–æ–¥–∏–Ω–∏
    
    // ========================================================================
    // PROOF OF WORK (PoW) –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø - v3.8.0
    // ========================================================================
    'pow_enabled' => true,             // –£–≤—ñ–º–∫–Ω—É—Ç–∏ PoW –∑–∞–º—ñ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ–≥–æ challenge
    'pow_difficulty' => 4,             // –ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ω—É–ª—ñ–≤ (4 = ~1-3 —Å–µ–∫, 5 = ~10-30 —Å–µ–∫)
    'pow_timeout' => 60,               // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (—Å–µ–∫—É–Ω–¥–∏)
    'pow_style' => 'cloudflare',       // 'cloudflare' –∞–±–æ 'smf' (—Å—Ç–∏–ª—å —Å—Ç–æ—Ä—ñ–Ω–∫–∏)
);

// ============================================================================
// –®–í–ò–î–ö–ê –ü–ï–†–ï–í–Ü–†–ö–ê –í–õ–ê–°–ù–ò–• USER AGENTS (–ü–ï–†–ï–î JS CHALLENGE!)
// ============================================================================

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ User Agent –≤ whitelist –≤–ª–∞—Å–Ω–∏—Ö UA
 * –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –î–û JS Challenge –¥–ª—è –Ω–µ–≥–∞–π–Ω–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫—É
 */
function _is_custom_ua($userAgent) {
    global $CUSTOM_USER_AGENTS;
    
    if (empty($CUSTOM_USER_AGENTS) || empty($userAgent)) {
        return false;
    }
    
    $userAgentLower = strtolower($userAgent);
    
    foreach ($CUSTOM_USER_AGENTS as $customUA) {
        if (empty($customUA)) {
            continue;
        }
        // –ß–∞—Å—Ç–∫–æ–≤–µ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è (strpos) –¥–ª—è –≥–Ω—É—á–∫–æ—Å—Ç—ñ
        if (stripos($userAgentLower, strtolower($customUA)) !== false) {
            error_log("CUSTOM UA WHITELIST: Allowing - contains: " . $customUA . " | Full UA: " . substr($userAgent, 0, 100));
            return true;
        }
    }
    
    return false;
}

/**
 * –®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ SEO –±–æ—Ç—ñ–≤ –¥–ª—è —Ä–∞–Ω–Ω—å–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫—É
 */
function _is_seo_bot($userAgent) {
    if (empty($userAgent)) {
        return false;
    }
    
    $userAgentLower = strtolower($userAgent);
    
    // –ë–∞–∑–æ–≤–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —à–≤–∏–¥–∫–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
    $seoBots = array(
        'googlebot', 'yandex', 'bingbot', 'duckduckbot',
        'facebookexternalhit', 'twitterbot', 'pinterest',
        'linkedinbot', 'whatsapp', 'telegram', 'viber',
        'petalbot'  // v3.8.4: Huawei Petal Search
    );
    
    foreach ($seoBots as $bot) {
        if (strpos($userAgentLower, $bot) !== false) {
            return true;
        }
    }
    
    return false;
}

// ============================================================================
// –ü–ï–†–ï–í–Ü–†–ö–ê –ê–î–ú–Ü–ù–°–¨–ö–ò–• IP (v3.8.1) - –ù–ê–ô–í–ò–©–ò–ô –ü–†–Ü–û–†–ò–¢–ï–¢!
// ============================================================================

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ IP –ø–æ –±—ñ–ª–æ–º—É —Å–ø–∏—Å–∫—É –∞–¥–º—ñ–Ω—ñ–≤/–≤–ª–∞—Å–Ω–∏—Ö IP
 * –ü—Ä–∞—Ü—é—î –¥–ª—è –ë–£–î–¨-–Ø–ö–û–ì–û User-Agent!
 * –ü—Ä–æ–ø—É—Å–∫–∞—î –í–°–Ü –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (JS Challenge, Rate Limit, —ñ —Ç.–¥.)
 * 
 * @param string $ip IP –∞–¥—Ä–µ—Å–∞
 * @return bool true —è–∫—â–æ IP –≤ –±—ñ–ª–æ–º—É —Å–ø–∏—Å–∫—É –∞–¥–º—ñ–Ω—ñ–≤
 */
function _is_admin_ip($ip) {
    global $ADMIN_IP_WHITELIST;
    
    if (empty($ADMIN_IP_WHITELIST) || empty($ip)) {
        return false;
    }
    
    foreach ($ADMIN_IP_WHITELIST as $cidr) {
        if (empty($cidr)) {
            continue;
        }
        
        // –Ø–∫—â–æ –±–µ–∑ –º–∞—Å–∫–∏ - –¥–æ–¥–∞—î–º–æ /32 –¥–ª—è IPv4 –∞–±–æ /128 –¥–ª—è IPv6
        if (strpos($cidr, '/') === false) {
            $cidr = $cidr . (strpos($cidr, ':') !== false ? '/128' : '/32');
        }
        
        if (_ip_in_cidr_check($ip, $cidr)) {
            error_log("ADMIN IP WHITELIST: Allowing IP $ip (matched $cidr)");
            return true;
        }
    }
    
    return false;
}

/**
 * v3.8.2: –£–ù–Ü–í–ï–†–°–ê–õ–¨–ù–ê –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ IP –ø–æ –í–°–Ü–• –±—ñ–ª–∏—Ö —Å–ø–∏—Å–∫–∞—Ö
 * –ü–µ—Ä–µ–≤—ñ—Ä—è—î: $ADMIN_IP_WHITELIST + $SEARCH_ENGINE_IP_RANGES
 * 
 * @param string $ip IP –∞–¥—Ä–µ—Å–∞
 * @return bool|string false —è–∫—â–æ –Ω–µ –≤ —Å–ø–∏—Å–∫—É, —ñ–Ω–∞–∫—à–µ –Ω–∞–∑–≤–∞ —Å–ø–∏—Å–∫—É ('admin' –∞–±–æ 'search_engine')
 */
function _is_whitelisted_ip($ip) {
    if (empty($ip)) {
        return false;
    }
    
    // 1. –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞–¥–º—ñ–Ω—Å—å–∫—ñ IP (–Ω–∞–π–≤–∏—â–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç)
    if (_is_admin_ip($ip)) {
        return 'admin';
    }
    
    // 2. –ü–æ—Ç—ñ–º –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ IP –ø–æ—à—É–∫–æ–≤–∏—Ö —Å–∏—Å—Ç–µ–º
    if (_is_search_engine_ip($ip)) {
        return 'search_engine';
    }
    
    return false;
}

// ============================================================================
// –ù–û–í–ï v3.8.4: –§–£–ù–ö–¶–Ü–á –ü–ï–†–ï–í–Ü–†–ö–ò URL –ê–î–ú–Ü–ù–ö–ò –¢–ê AJAX
// ============================================================================

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ URL –Ω–∞–ª–µ–∂–∏—Ç—å –¥–æ –∞–¥–º—ñ–Ω–∫–∏
 * –ü–æ–≤–µ—Ä—Ç–∞—î true —è–∫—â–æ URL –∑–±—ñ–≥–∞—î—Ç—å—Å—è –∑ –±—É–¥—å-—è–∫–∏–º —à–ª—è—Ö–æ–º –∑ $ADMIN_URL_WHITELIST
 * 
 * @return bool true —è–∫—â–æ URL –≤ –±—ñ–ª–æ–º—É —Å–ø–∏—Å–∫—É –∞–¥–º—ñ–Ω–∫–∏
 */
function _is_admin_url() {
    global $ADMIN_URL_WHITELIST_ENABLED, $ADMIN_URL_WHITELIST;
    
    if (empty($ADMIN_URL_WHITELIST_ENABLED) || empty($ADMIN_URL_WHITELIST)) {
        return false;
    }
    
    $uri = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '';
    if (empty($uri)) {
        return false;
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —ñ —à–ª—è—Ö —ñ –ø–æ–≤–Ω–∏–π URI (–¥–ª—è query string —è–∫ ?action=admin)
    $path = parse_url($uri, PHP_URL_PATH);
    if (empty($path)) {
        $path = $uri;
    }
    
    $uriLower = strtolower($uri);
    $pathLower = strtolower($path);
    
    foreach ($ADMIN_URL_WHITELIST as $adminPath) {
        if (empty($adminPath)) {
            continue;
        }
        
        $adminPathLower = strtolower($adminPath);
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —ñ —à–ª—è—Ö —ñ –ø–æ–≤–Ω–∏–π URI
        if (strpos($pathLower, $adminPathLower) !== false || 
            strpos($uriLower, $adminPathLower) !== false) {
            // Debug log (—Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
            // error_log("ADMIN URL WHITELIST: Matched '$adminPath' for URI: $uri");
            return true;
        }
    }
    
    return false;
}

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –∑–∞–ø–∏—Ç —î AJAX
 * –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Requested-With —Ç–∞ Content-Type/Accept –¥–ª—è fetch API
 * 
 * @return bool true —è–∫—â–æ —Ü–µ AJAX –∑–∞–ø–∏—Ç
 */
function _is_ajax_request() {
    // 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Å–ø–æ—Å—ñ–±: –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Requested-With (jQuery, axios, etc.)
    if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && 
        strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') {
        return true;
    }
    
    // 2. Fetch API: Content-Type = application/json
    if (!empty($_SERVER['CONTENT_TYPE'])) {
        $contentType = strtolower($_SERVER['CONTENT_TYPE']);
        if (strpos($contentType, 'application/json') !== false) {
            return true;
        }
    }
    
    // 3. Fetch API: Accept –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ application/json
    if (!empty($_SERVER['HTTP_ACCEPT'])) {
        $accept = strtolower($_SERVER['HTTP_ACCEPT']);
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ JSON —î –ø–µ—Ä—à–∏–º —É —Å–ø–∏—Å–∫—É Accept (–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç)
        if (strpos($accept, 'application/json') === 0) {
            return true;
        }
    }
    
    // 4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ X-JSC-Response (–Ω–∞—à –≤–ª–∞—Å–Ω–∏–π AJAX –¥–ª—è JS Challenge)
    if (!empty($_SERVER['HTTP_X_JSC_RESPONSE'])) {
        return true;
    }
    
    return false;
}

/**
 * v3.8.4: –£–ù–Ü–í–ï–†–°–ê–õ–¨–ù–ê –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ç–∏ Rate Limit
 * –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—Å—ñ—Ö —É–º–æ–≤ –ø—Ä–æ–ø—É—Å–∫—É
 * 
 * @param string $ip IP –∞–¥—Ä–µ—Å–∞
 * @return bool|string false —è–∫—â–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ Rate Limit, —ñ–Ω–∞–∫—à–µ –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–ø—É—Å–∫—É
 */
function _should_skip_rate_limit($ip) {
    global $AJAX_SKIP_RATE_LIMIT;
    
    // 1. –ë—ñ–ª—ñ —Å–ø–∏—Å–∫–∏ IP (–Ω–∞–π–≤–∏—â–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç - –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –ø–µ—Ä—à–∏–º)
    $whitelistType = _is_whitelisted_ip($ip);
    if ($whitelistType !== false) {
        return 'ip_whitelist:' . $whitelistType;
    }
    
    // 2. URL –∞–¥–º—ñ–Ω–∫–∏ (–¥—Ä—É–≥–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç)
    if (_is_admin_url()) {
        return 'admin_url';
    }
    
    // 3. AJAX –∑–∞–ø–∏—Ç–∏ (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π –ø—Ä–æ–ø—É—Å–∫)
    if (!empty($AJAX_SKIP_RATE_LIMIT) && _is_ajax_request()) {
        return 'ajax_request';
    }
    
    return false;
}

/**
 * v3.8.4: –û—Ç—Ä–∏–º–∞—Ç–∏ –º–Ω–æ–∂–Ω–∏–∫ Rate Limit –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É
 * –ü–æ–≤–µ—Ä—Ç–∞—î –º–Ω–æ–∂–Ω–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–∏–ø—É –∑–∞–ø–∏—Ç—É (AJAX –æ—Ç—Ä–∏–º—É—î –≤–∏—â–∏–π –º–Ω–æ–∂–Ω–∏–∫)
 * 
 * @return float –º–Ω–æ–∂–Ω–∏–∫ (1.0 = –±–µ–∑ –∑–º—ñ–Ω, >1.0 = –∑–±—ñ–ª—å—à–µ–Ω—ñ –ª—ñ–º—ñ—Ç–∏)
 */
function _get_rate_limit_multiplier() {
    global $AJAX_RATE_LIMIT_MULTIPLIER;
    
    // –Ø–∫—â–æ —Ü–µ AJAX –∑–∞–ø–∏—Ç —ñ –º–Ω–æ–∂–Ω–∏–∫ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π
    if (_is_ajax_request() && !empty($AJAX_RATE_LIMIT_MULTIPLIER) && $AJAX_RATE_LIMIT_MULTIPLIER > 1.0) {
        return (float)$AJAX_RATE_LIMIT_MULTIPLIER;
    }
    
    return 1.0;
}

/**
 * –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ IP –≤ CIDR (–¥–ª—è –∞–¥–º—ñ–Ω—Å—å–∫–æ–≥–æ whitelist)
 */
function _ip_in_cidr_check($ip, $cidr) {
    if (strpos($cidr, '/') === false) {
        return $ip === $cidr;
    }
    
    list($subnet, $mask) = explode('/', $cidr);
    $mask = (int)$mask;
    
    $ipIsV6 = (strpos($ip, ':') !== false);
    $cidrIsV6 = (strpos($subnet, ':') !== false);
    
    // IPv4 —ñ IPv6 –Ω–µ –º–æ–∂—É—Ç—å —Å–ø—ñ–≤–ø–∞–¥–∞—Ç–∏
    if ($ipIsV6 !== $cidrIsV6) {
        return false;
    }
    
    if ($ipIsV6) {
        // IPv6
        if ($mask < 0 || $mask > 128) {
            return false;
        }
        return _ipv6_in_cidr_fast($ip, $subnet, $mask);
    }
    
    // IPv4
    if ($mask < 0 || $mask > 32) {
        return false;
    }
    
    $ip_long = ip2long($ip);
    $subnet_long = ip2long($subnet);
    
    if ($ip_long === false || $subnet_long === false) {
        return false;
    }
    
    $mask_long = -1 << (32 - $mask);
    
    return ($ip_long & $mask_long) === ($subnet_long & $mask_long);
}

// ============================================================================
// –ü–ï–†–ï–í–Ü–†–ö–ê IP –ü–û –ë–Ü–õ–û–ú–£ –°–ü–ò–°–ö–£ (v3.7.0)
// ============================================================================

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ IP –ø–æ –±—ñ–ª–æ–º—É —Å–ø–∏—Å–∫—É –ø–æ—à—É–∫–æ–≤–∏—Ö —Å–∏—Å—Ç–µ–º
 * –ü—Ä–∞—Ü—é—î –¥–ª—è –ë–£–î–¨-–Ø–ö–û–ì–û User-Agent!
 * –ö–µ—à—É—î—Ç—å—Å—è –≤ Redis –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ
 * 
 * @param string $ip IP –∞–¥—Ä–µ—Å–∞
 * @return bool true —è–∫—â–æ IP –≤ –±—ñ–ª–æ–º—É —Å–ø–∏—Å–∫—É
 */
function _is_search_engine_ip($ip) {
    global $SEARCH_ENGINE_IP_RANGES;
    
    static $redis = null;
    static $connected = false;
    static $logged = array(); // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –ª–æ–≥—ñ–≤
    
    // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Redis (–æ–¥–∏–Ω —Ä–∞–∑)
    if ($redis === null) {
        try {
            $redis = new Redis();
            $connected = $redis->connect('127.0.0.1', 6379, 0.5);
            if ($connected) {
                $redis->select(1);
                $redis->setOption(Redis::OPT_SERIALIZER, Redis::SERIALIZER_PHP);
            }
        } catch (Exception $e) {
            $connected = false;
        }
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–µ—à—É Redis
    if ($connected) {
        $cacheKey = 'bot_protection:ip_whitelist:' . $ip;
        try {
            $cached = $redis->get($cacheKey);
            if ($cached !== false) {
                // –Ø–∫—â–æ IP –≤–∂–µ –≤ –∫–µ—à—ñ —ñ –≤—ñ–Ω whitelisted - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ true
                // –õ–æ–≥—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –∑–∞–ø–∏—Ç!
                if ($cached === '1' || $cached === 1 || $cached === true) {
                    if (!isset($logged[$ip])) {
                        $logged[$ip] = true;
                        _log_search_engine_visit($redis, $ip, 'IP-cached');
                    }
                    return true;
                }
                return false;
            }
        } catch (Exception $e) {
            // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –∫–µ—à—É
        }
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ IP –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω–∞—Ö
    $result = false;
    $matchedEngine = 'unknown';
    $isIPv6 = (strpos($ip, ':') !== false);
    
    foreach ($SEARCH_ENGINE_IP_RANGES as $cidr) {
        $cidrIsIPv6 = (strpos($cidr, ':') !== false);
        if ($isIPv6 !== $cidrIsIPv6) {
            continue;
        }
        
        if (_ip_in_cidr_fast($ip, $cidr)) {
            $result = true;
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ—à—É–∫–æ–≤—É —Å–∏—Å—Ç–µ–º—É –ø–æ CIDR
            $matchedEngine = _detect_engine_by_cidr($cidr);
            break;
        }
    }
    
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –∫–µ—à Redis (24 –≥–æ–¥–∏–Ω–∏)
    if ($connected) {
        try {
            $redis->setex($cacheKey, 86400, $result ? '1' : '0');
        } catch (Exception $e) {
            // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –∫–µ—à—É
        }
    }
    
    if ($result) {
        error_log("SEARCH ENGINE IP WHITELIST: Allowing IP=$ip (engine=$matchedEngine)");
        // –õ–æ–≥—É—î–º–æ –≤—ñ–∑–∏—Ç –≤ Redis —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –∑–∞–ø–∏—Ç!
        if ($connected && !isset($logged[$ip])) {
            $logged[$ip] = true;
            _log_search_engine_visit($redis, $ip, 'IP', $matchedEngine);
        }
    }
    
    return $result;
}

/**
 * v3.7.0: –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ—à—É–∫–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ –ø–æ CIDR
 */
function _detect_engine_by_cidr($cidr) {
    // Test IPs
    if (strpos($cidr, '185.6.186.') === 0 || strpos($cidr, '2a00:1e20:11:9108') === 0) {
        return 'Test';
    }
    
    // Google ranges start with 66.249, 64.233, 72.14, 74.125, etc.
    if (preg_match('/^(66\.249|64\.233|72\.14|74\.125|216\.239|209\.85|108\.177|142\.250|172\.217|172\.253|173\.194|192\.178|34\.64|35\.190|203\.208)/', $cidr)) {
        return 'Google';
    }
    if (strpos($cidr, '2001:4860') === 0 || strpos($cidr, '2404:6800') === 0 || strpos($cidr, '2607:f8b0') === 0) {
        return 'Google';
    }
    
    // Yandex
    if (preg_match('/^(5\.45|5\.255|37\.9|37\.140|77\.88|84\.201|87\.250|93\.158|95\.108|141\.8|178\.154|213\.180)/', $cidr)) {
        return 'Yandex';
    }
    if (strpos($cidr, '2a02:6b8') === 0) {
        return 'Yandex';
    }
    
    // Bing/Microsoft
    if (preg_match('/^(13\.|20\.|40\.|52\.|65\.|104\.|131\.253|157\.55|157\.56|168\.6|191\.232|199\.30|207\.46)/', $cidr)) {
        return 'Bing';
    }
    if (strpos($cidr, '2620:1ec') === 0 || strpos($cidr, '2a01:111') === 0) {
        return 'Bing';
    }
    
    // Baidu
    if (preg_match('/^(116\.179|119\.63|123\.125|180\.76|220\.181)/', $cidr)) {
        return 'Baidu';
    }
    
    // Facebook
    if (preg_match('/^(31\.13|66\.220|69\.63|69\.171|157\.240|173\.252|185\.60)/', $cidr)) {
        return 'Facebook';
    }
    
    // Apple
    if (strpos($cidr, '17.') === 0) {
        return 'Apple';
    }
    
    // DuckDuckGo
    if (preg_match('/^(20\.191|40\.88|52\.142|72\.94)/', $cidr)) {
        return 'DuckDuckGo';
    }
    
    // Yahoo
    if (preg_match('/^(67\.195|72\.30|74\.6|98\.136)/', $cidr)) {
        return 'Yahoo';
    }
    
    // PetalBot (Huawei)
    if (preg_match('/^114\.119\./', $cidr)) {
        return 'PetalBot';
    }
    
    return 'Other';
}

/**
 * v3.7.0: –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤—ñ–∑–∏—Ç—É –ø–æ—à—É–∫–æ–≤–æ–≥–æ –±–æ—Ç–∞ –≤ Redis
 */
function _log_search_engine_visit($redis, $ip, $method, $engine = null) {
    if (!$redis) {
        return;
    }
    
    try {
        // –í–∏–∑–Ω–∞—á–∞—î–º–æ engine –∑ User-Agent —è–∫—â–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ
        if (!$engine) {
            // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–µ—Å—Ç–æ–≤—ñ IP (–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç!)
            if ($ip === '185.6.186.106' || strpos($ip, '2a00:1e20:11:9108') === 0) {
                $engine = 'Test';
            } else {
                $ua = isset($_SERVER['HTTP_USER_AGENT']) ? strtolower($_SERVER['HTTP_USER_AGENT']) : '';
                if (strpos($ua, 'googlebot') !== false || strpos($ua, 'google-inspectiontool') !== false) {
                    $engine = 'Google';
                } elseif (strpos($ua, 'yandex') !== false) {
                    $engine = 'Yandex';
                } elseif (strpos($ua, 'bingbot') !== false || strpos($ua, 'msnbot') !== false) {
                    $engine = 'Bing';
                } elseif (strpos($ua, 'baiduspider') !== false) {
                    $engine = 'Baidu';
                } elseif (strpos($ua, 'duckduckbot') !== false) {
                    $engine = 'DuckDuckGo';
                } elseif (strpos($ua, 'facebookexternalhit') !== false || strpos($ua, 'facebot') !== false) {
                    $engine = 'Facebook';
                } elseif (strpos($ua, 'applebot') !== false) {
                    $engine = 'Apple';
                } elseif (strpos($ua, 'petalbot') !== false) {
                    $engine = 'PetalBot';
                } else {
                    $engine = 'Other';
                }
            }
        }
        
        $today = date('Y-m-d');
        $host = isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : 'unknown';
        $url = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '/';
        $ua = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '-';
        
        // –°–∫–æ—Ä–æ—á—É—î–º–æ UA
        if (strlen($ua) > 100) {
            $ua = substr($ua, 0, 100) . '...';
        }
        
        $prefix = 'bot_protection:';
        
        // 1. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ –±–æ—Ç–∞
        $totalKey = $prefix . 'search_stats:total:' . strtolower($engine);
        $redis->incr($totalKey);
        
        // 2. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –¥–µ–Ω–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ –±–æ—Ç–∞
        $todayKey = $prefix . 'search_stats:today:' . $today . ':' . strtolower($engine);
        $redis->incr($todayKey);
        $redis->expire($todayKey, 86400 * 7);
        
        // 3. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ —Ö–æ—Å—Ç—É
        $hostKey = $prefix . 'search_stats:hosts:' . $host;
        $redis->incr($hostKey);
        $redis->expire($hostKey, 86400 * 30);
        
        // 4. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ –º–µ—Ç–æ–¥—É
        $methodKey = $prefix . 'search_stats:methods:' . strtolower($method);
        $redis->incr($methodKey);
        
        // 5. –î–æ–¥–∞—î–º–æ –∑–∞–ø–∏—Å –≤ –ª–æ–≥
        $logEntry = array(
            'time' => date('Y-m-d H:i:s'),
            'engine' => $engine,
            'ip' => $ip,
            'method' => $method,
            'host' => $host,
            'url' => $url,
            'ua' => $ua,
        );
        
        $logKey = $prefix . 'search_log';
        $redis->lpush($logKey, $logEntry);
        $redis->ltrim($logKey, 0, 499);
        
    } catch (Exception $e) {
        // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏
    }
}

/**
 * –®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ IP –≤ CIDR –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ (IPv4 —Ç–∞ IPv6)
 */
function _ip_in_cidr_fast($ip, $cidr) {
    if (strpos($cidr, '/') === false) {
        return $ip === $cidr;
    }
    
    list($subnet, $bits) = explode('/', $cidr, 2);
    $bits = (int)$bits;
    
    // IPv6
    if (strpos($ip, ':') !== false) {
        return _ipv6_in_cidr_fast($ip, $subnet, $bits);
    }
    
    // IPv4
    if ($bits < 0 || $bits > 32) {
        return false;
    }
    
    $ip_long = ip2long($ip);
    $subnet_long = ip2long($subnet);
    
    if ($ip_long === false || $subnet_long === false) {
        return false;
    }
    
    if ($bits === 0) {
        return true;
    }
    
    $mask = -1 << (32 - $bits);
    return ($ip_long & $mask) === ($subnet_long & $mask);
}

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ IPv6 –≤ CIDR –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ
 */
function _ipv6_in_cidr_fast($ip, $subnet, $bits) {
    if ($bits < 0 || $bits > 128) {
        return false;
    }
    
    $ip_bin = @inet_pton($ip);
    $subnet_bin = @inet_pton($subnet);
    
    if ($ip_bin === false || $subnet_bin === false) {
        return false;
    }
    
    if ($bits === 0) {
        return true;
    }
    
    $full_bytes = (int)floor($bits / 8);
    $remaining_bits = $bits % 8;
    
    for ($i = 0; $i < $full_bytes; $i++) {
        if ($ip_bin[$i] !== $subnet_bin[$i]) {
            return false;
        }
    }
    
    if ($remaining_bits > 0 && $full_bytes < 16) {
        $mask = 0xFF << (8 - $remaining_bits);
        if ((ord($ip_bin[$full_bytes]) & $mask) !== (ord($subnet_bin[$full_bytes]) & $mask)) {
            return false;
        }
    }
    
    return true;
}

// ============================================================================
// JS CHALLENGE –§–£–ù–ö–¶–Ü–á
// ============================================================================

function _jsc_getClientIP() {
    if (!empty($_SERVER['HTTP_CF_CONNECTING_IP'])) {
        return $_SERVER['HTTP_CF_CONNECTING_IP'];
    } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        $ips = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);
        return trim($ips[0]);
    } elseif (!empty($_SERVER['HTTP_X_REAL_IP'])) {
        return $_SERVER['HTTP_X_REAL_IP'];
    }
    return isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : '0.0.0.0';
}

function _jsc_isVerified($secret_key, $cookie_name) {
    if (!isset($_COOKIE[$cookie_name])) {
        return false;
    }
    $cookie = $_COOKIE[$cookie_name];
    if (strlen($cookie) !== 64) {
        // v3.7.0: –õ–æ–≥—É—î–º–æ –Ω–µ–≤–∞–ª—ñ–¥–Ω—É cookie (failed)
        _jsc_logStats('failed', _jsc_getClientIP());
        return false;
    }
    $ip = _jsc_getClientIP();
    $expected = hash('sha256', $ip . date('Y-m-d') . $secret_key);
    $verified = hash_equals($expected, $cookie);
    
    // v3.8.1: –ù–ï –ª–æ–≥—É—î–º–æ 'passed' —Ç—É—Ç - —Ü–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ cookie
    // 'passed' –ª–æ–≥—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—ñ challenge (POST)
    if (!$verified) {
        // Cookie —î, –∞–ª–µ –Ω–µ–≤—ñ—Ä–Ω–∞ (–º–æ–∂–ª–∏–≤–æ –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∞ –∞–±–æ –ø—ñ–¥—Ä–æ–±–ª–µ–Ω–∞)
        _jsc_logStats('expired', $ip);
    }
    
    return $verified;
}

/**
 * v3.7.0: –õ–æ–≥—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ JS Challenge –≤ Redis
 * @param string $type - 'shown', 'passed', 'failed', 'expired'
 * @param string $ip - IP –∞–¥—Ä–µ—Å–∞ –∫–ª—ñ—î–Ω—Ç–∞
 */
function _jsc_logStats($type, $ip = null) {
    static $redis = null;
    static $connected = false;
    static $logged = array(); // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –¥—É–±–ª—é–≤–∞–Ω–Ω—é –≤ –æ–¥–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ
    
    // –õ–æ–≥—É—î–º–æ –∫–æ–∂–µ–Ω —Ç–∏–ø —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –∑–∞–ø–∏—Ç
    if (isset($logged[$type])) {
        return;
    }
    $logged[$type] = true;
    
    if ($ip === null) {
        $ip = _jsc_getClientIP();
    }
    
    // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Redis
    if ($redis === null) {
        try {
            $redis = new Redis();
            $connected = $redis->connect('127.0.0.1', 6379, 0.5);
            if ($connected) {
                $redis->select(1);
                $redis->setOption(Redis::OPT_SERIALIZER, Redis::SERIALIZER_PHP);
            }
        } catch (Exception $e) {
            $connected = false;
            return;
        }
    }
    
    if (!$connected) {
        return;
    }
    
    try {
        $prefix = 'bot_protection:jsc_stats:';
        $today = date('Y-m-d');
        $hour = date('Y-m-d:H');
        
        // 1. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫
        $redis->incr($prefix . 'total:' . $type);
        
        // 2. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –¥–µ–Ω–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫
        $dailyKey = $prefix . 'daily:' . $today . ':' . $type;
        $redis->incr($dailyKey);
        $redis->expire($dailyKey, 86400 * 7); // 7 –¥–Ω—ñ–≤
        
        // 3. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –ø–æ–≥–æ–¥–∏–Ω–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫
        $hourlyKey = $prefix . 'hourly:' . $hour . ':' . $type;
        $redis->incr($hourlyKey);
        $redis->expire($hourlyKey, 86400 * 2); // 2 –¥–Ω—ñ
        
        // 4. –î–æ–¥–∞—î–º–æ –∑–∞–ø–∏—Å –≤ –ª–æ–≥ (–æ—Å—Ç–∞–Ω–Ω—ñ 100 –∑–∞–ø–∏—Å—ñ–≤)
        $logEntry = array(
            'date' => date('Y-m-d H:i:s'),
            'ip' => $ip,
            'ua' => isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '-',
        );
        
        $logKey = $prefix . 'log:' . $type;
        $redis->lPush($logKey, $logEntry);
        $redis->lTrim($logKey, 0, 99); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ 100
        
    } catch (Exception $e) {
        // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏
    }
}

function _jsc_generateChallenge($secret_key) {
    global $_JSC_CONFIG;
    
    // v3.8.0: Proof of Work challenge
    if (!empty($_JSC_CONFIG['pow_enabled'])) {
        $challenge_id = bin2hex(random_bytes(16));
        $difficulty = isset($_JSC_CONFIG['pow_difficulty']) ? (int)$_JSC_CONFIG['pow_difficulty'] : 4;
        $timeout = isset($_JSC_CONFIG['pow_timeout']) ? (int)$_JSC_CONFIG['pow_timeout'] : 60;
        $style = isset($_JSC_CONFIG['pow_style']) ? $_JSC_CONFIG['pow_style'] : 'cloudflare';
        
        return array(
            'type' => 'pow',
            'id' => $challenge_id,
            'timestamp' => time(),
            'difficulty' => $difficulty,
            'timeout' => $timeout,
            'style' => $style,
            'target' => str_repeat('0', $difficulty)
        );
    }
    
    // Fallback: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π challenge (—Å—É–º–∞ —á–∏—Å–µ–ª)
    $id = md5(uniqid(mt_rand(), true));
    $timestamp = time();
    $numbers = array();
    for ($i = 0; $i < 5; $i++) {
        $numbers[] = mt_rand(10, 99);
    }
    $answer = array_sum($numbers);
    $target = hash('sha256', $id . $timestamp . $answer . $secret_key);
    return array(
        'type' => 'sum',
        'id' => $id,
        'timestamp' => $timestamp,
        'numbers' => $numbers,
        'target' => $target,
        'difficulty' => 3
    );
}

function _jsc_showChallengePage($challenge, $redirect_url) {
    // v3.8.0: –õ–æ–≥—É—î–º–æ –ø–æ–∫–∞–∑ challenge
    _jsc_logStats('shown');
    
    $challengeJson = json_encode($challenge);
    $redirectJson = json_encode($redirect_url);
    $isPow = isset($challenge['type']) && $challenge['type'] === 'pow';
    $style = isset($challenge['style']) ? $challenge['style'] : 'cloudflare';
    
    http_response_code(200);
    header('Content-Type: text/html; charset=UTF-8');
    header('Cache-Control: no-cache, no-store, must-revalidate');
    header('X-Robots-Tag: noindex, nofollow');
    
    // v3.8.0: –í–∏–±—ñ—Ä —Å—Ç–∏–ª—é —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    if ($isPow && $style === 'cloudflare') {
        _jsc_showCloudflarePoWPage($challengeJson, $redirectJson);
    } else {
        _jsc_showSMFChallengePage($challengeJson, $redirectJson, $isPow);
    }
    exit;
}

/**
 * v3.8.0: Cloudflare-style Proof of Work —Å—Ç–æ—Ä—ñ–Ω–∫–∞
 */
function _jsc_showCloudflarePoWPage($challengeJson, $redirectJson) {
    echo '<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞... –ü–æ–¥–æ–∂–¥–∏—Ç–µ</title>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #ffffff; color: #000; font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 17px; display: flex; align-items: center; justify-content: center; text-align: center; }
        .container { max-width: 540px; padding: 40px 24px; }
        .cf-logo { width: 360px; max-width: 90vw; margin-bottom: 48px; }
        h1 { font-size: 34px; font-weight: 500; margin: 0 0 16px; color: #000; }
        .subtitle { font-size: 20px; color: #222; margin: 0 0 40px; }
        .cf-spinner { position: relative; width: 80px; height: 80px; margin: 0 auto 32px; }
        .cf-spinner::before, .cf-spinner::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 6px solid transparent; }
        .cf-spinner::before { border-top-color: #f38020; animation: spin 1.2s linear infinite; }
        .cf-spinner::after { border-top-color: #e04e2a; animation: spin 1.5s linear infinite reverse; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-container { margin: 24px 0; }
        .progress-bar { width: 100%; height: 8px; background: #e5e5e5; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #f38020, #e04e2a); width: 0%; transition: width 0.3s ease; }
        .status { font-size: 18px; color: #444; margin-top: 16px; min-height: 24px; }
        .status.success { color: #2e7d32; font-weight: 600; }
        .stats { font-size: 14px; color: #888; margin-top: 12px; font-family: monospace; }
        .error { margin-top: 30px; padding: 20px; background: #fff5f5; border: 1px solid #ffcccc; border-radius: 8px; color: #c00; display: none; text-align: left; font-size: 15px; line-height: 1.5; }
        .error strong { display: block; margin-bottom: 8px; }
        .small { margin-top: 60px; font-size: 13px; color: #999; }
        .small a { color: #f38020; text-decoration: none; }
        .checkmark { display: none; width: 80px; height: 80px; margin: 0 auto 32px; }
        .checkmark.show { display: block; animation: scaleIn 0.3s ease; }
        @keyframes scaleIn { from { transform: scale(0); } to { transform: scale(1); } }
        .checkmark circle { fill: #2e7d32; }
        .checkmark path { stroke: #fff; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; stroke-dasharray: 24; stroke-dashoffset: 24; animation: draw 0.4s ease 0.2s forwards; }
        @keyframes draw { to { stroke-dashoffset: 0; } }
    </style>
</head>
<body>

<div class="container">
    <img src="https://www.cloudflare.com/img/logo-cloudflare-dark.svg" alt="Security Check" class="cf-logo" onerror="this.style.display=\'none\'">
    <h1 id="title">–ü—Ä–æ–≤–µ—Ä–∫–∞...</h1>
    <p class="subtitle" id="subtitle">–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—à –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º –Ω–∞ —Å–∞–π—Ç</p>
    
    <div class="cf-spinner" id="spinner"></div>
    <svg class="checkmark" id="checkmark" viewBox="0 0 80 80">
        <circle cx="40" cy="40" r="38"/>
        <path d="M24 42 L35 53 L56 28" fill="none"/>
    </svg>
    
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
    </div>
    <div class="status" id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞—â–∏—Ç—ã...</div>
    <div class="stats" id="stats"></div>
    
    <div class="error" id="error"></div>
    <div class="small">Powered by <a href="#">MurKir Security</a> | Proof-of-Work Protection</div>
</div>

<script>
    var challengeData = ' . $challengeJson . ';
    var redirectUrl = ' . $redirectJson . ';
    
    var progressBar = document.getElementById("progress");
    var statusEl = document.getElementById("status");
    var statsEl = document.getElementById("stats");
    var errorEl = document.getElementById("error");
    var spinnerEl = document.getElementById("spinner");
    var checkmarkEl = document.getElementById("checkmark");
    var titleEl = document.getElementById("title");
    var subtitleEl = document.getElementById("subtitle");

    function updateProgress(percent, message) {
        progressBar.style.width = percent + "%";
        statusEl.textContent = message;
    }

    function showError(msg) {
        errorEl.innerHTML = "<strong>‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</strong>" + msg;
        errorEl.style.display = "block";
        spinnerEl.style.display = "none";
        statusEl.textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞";
        statsEl.textContent = "";
    }
    
    function showSuccess() {
        spinnerEl.style.display = "none";
        checkmarkEl.classList.add("show");
        titleEl.textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!";
        subtitleEl.textContent = "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–∞–π—Ç...";
        statusEl.className = "status success";
    }

    // SHA-256 hash function
    async function sha256(str) {
        var buf = new TextEncoder().encode(str);
        var hash = await crypto.subtle.digest("SHA-256", buf);
        return Array.from(new Uint8Array(hash)).map(function(b) {
            return b.toString(16).padStart(2, "0");
        }).join("");
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ cookies
    function areCookiesEnabled() {
        try {
            document.cookie = "cookietest=1; SameSite=Lax";
            var result = document.cookie.indexOf("cookietest=") !== -1;
            document.cookie = "cookietest=1; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax";
            return result;
        } catch (e) {
            return false;
        }
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ —Ü–∏–∫–ª—É
    function checkLoopProtection() {
        try {
            var key = "pow_attempts_" + challengeData.id.substr(0, 8);
            var attempts = parseInt(sessionStorage.getItem(key) || "0", 10);
            if (attempts >= 3) return false;
            sessionStorage.setItem(key, (attempts + 1).toString());
            return true;
        } catch (e) {
            return true;
        }
    }

    async function performChallenge() {
        try {
            updateProgress(5, "–ê–Ω–∞–ª–∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è...");
            await new Promise(function(r) { setTimeout(r, 400); });
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü–∏–∫–ª—É
            if (!checkLoopProtection()) {
                showError("<br>–û–±–Ω–∞—Ä—É–∂–µ–Ω —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ cookies –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                return;
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ cookies
            updateProgress(10, "–ü—Ä–æ–≤–µ—Ä–∫–∞ cookies...");
            await new Promise(function(r) { setTimeout(r, 300); });
            
            if (!areCookiesEnabled()) {
                showError("<br>–î–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å cookies –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
                return;
            }
            
            // Proof of Work
            updateProgress(15, "–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...");
            
            var nonce = 0;
            var hash = "";
            var target = challengeData.target || "0".repeat(challengeData.difficulty || 4);
            var startTime = Date.now();
            var timeout = (challengeData.timeout || 60) * 1000;
            var lastUpdate = startTime;
            var hashesPerUpdate = 1000;
            
            while (true) {
                hash = await sha256(challengeData.id + nonce);
                
                if (hash.startsWith(target)) {
                    break;
                }
                
                nonce++;
                
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –∫–æ–∂–Ω—ñ 500 —ñ—Ç–µ—Ä–∞—Ü—ñ–π
                if (nonce % hashesPerUpdate === 0) {
                    var elapsed = Date.now() - startTime;
                    var hashRate = Math.round(nonce / (elapsed / 1000));
                    
                    // –ü—Ä–æ–≥—Ä–µ—Å –≤—ñ–¥ 15% –¥–æ 85%
                    var progress = Math.min(85, 15 + (elapsed / timeout) * 70);
                    updateProgress(progress, "–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...");
                    statsEl.textContent = nonce.toLocaleString() + " —Ö–µ—à–µ–π | " + hashRate.toLocaleString() + " H/s";
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ timeout
                    if (elapsed > timeout) {
                        showError("<br>–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
                        return;
                    }
                    
                    // –î–∞—î–º–æ –±—Ä–∞—É–∑–µ—Ä—É "–¥–∏—Ö–∞—Ç–∏"
                    await new Promise(function(r) { setTimeout(r, 0); });
                }
            }
            
            var totalTime = ((Date.now() - startTime) / 1000).toFixed(2);
            statsEl.textContent = nonce.toLocaleString() + " —Ö–µ—à–µ–π –∑–∞ " + totalTime + " —Å–µ–∫";
            
            updateProgress(90, "–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...");
            
            // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            var xhr = new XMLHttpRequest();
            xhr.open("POST", window.location.href, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("X-JSC-Response", "1");
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var result = JSON.parse(xhr.responseText);
                        if (result.success) {
                            updateProgress(100, "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
                            showSuccess();
                            
                            // –û—á–∏—â–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞
                            try {
                                sessionStorage.removeItem("pow_attempts_" + challengeData.id.substr(0, 8));
                            } catch (e) {}
                            
                            setTimeout(function() {
                                window.location.href = redirectUrl;
                            }, 800);
                        } else {
                            showError("<br>" + (result.error || "–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏"));
                        }
                    } catch (e) {
                        showError("<br>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                    }
                } else {
                    showError("<br>HTTP –æ—à–∏–±–∫–∞: " + xhr.status);
                }
            };
            
            xhr.onerror = function() {
                showError("<br>–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.");
            };
            
            xhr.send(JSON.stringify({
                challenge_id: challengeData.id,
                nonce: nonce,
                hash: hash,
                timestamp: challengeData.timestamp,
                type: "pow"
            }));
            
        } catch (error) {
            showError("<br>–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É: " + error.message);
        }
    }

    window.addEventListener("load", function() {
        setTimeout(performChallenge, 500);
    });
</script>
</body>
</html>';
}

/**
 * v3.8.0: SMF-style Challenge —Å—Ç–æ—Ä—ñ–Ω–∫–∞ (–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Å—Ç–∏–ª—å –∑ PoW –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é)
 */
function _jsc_showSMFChallengePage($challengeJson, $redirectJson, $isPow = false) {
    echo '<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Verdana, Arial, sans-serif;
            font-size: 13px;
            background: #e5e5e8;
            color: #000;
            padding: 20px;
        }
        #wrapper {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid #bbb;
        }
        #header {
            background: linear-gradient(to bottom, #315d7d 0%, #1e5380 100%);
            padding: 20px;
            border-bottom: 1px solid #144063;
        }
        #header h1 {
            color: #fff;
            font-size: 22px;
            font-weight: normal;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            margin: 0;
        }
        #content {
            padding: 30px;
            background: #fff;
        }
        .catbg {
            background: linear-gradient(to bottom, #ffffff 0%, #e0e0e0 100%);
            border: 1px solid #ccc;
            border-bottom: 1px solid #aaa;
            padding: 10px;
            font-weight: bold;
            color: #444;
            margin-bottom: 15px;
        }
        .windowbg {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 25px;
            margin-bottom: 15px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e5e8;
            border-top: 4px solid #1e5380;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-text {
            text-align: center;
            color: #444;
            line-height: 1.6;
            margin: 15px 0;
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #fff;
            border: 1px solid #bbb;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(to bottom, #7db8e5 0%, #4e9bd6 100%);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
        }
        .status {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 15px;
            font-style: italic;
        }
        .stats {
            text-align: center;
            color: #888;
            font-size: 11px;
            margin-top: 10px;
            font-family: monospace;
        }
        .error {
            background: #fff0f0;
            border: 1px solid #cc3300;
            color: #cc3300;
            padding: 15px;
            border-radius: 3px;
            margin-top: 15px;
            display: none;
        }
        .success { color: #080; }
        .smalltext {
            font-size: 11px;
            color: #777;
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        #footer {
            background: #e5e5e8;
            padding: 15px;
            text-align: center;
            font-size: 11px;
            color: #666;
            border-top: 1px solid #bbb;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="header">
            <h1>üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h1>
        </div>
        <div id="content">
            <div class="catbg">
                –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏' . ($isPow ? ' (Proof-of-Work)' : '') . '
            </div>
            <div class="windowbg">
                <div class="spinner" id="spinner"></div>
                <div class="info-text">
                    <strong>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</strong><br>
                    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                <div class="status" id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏...</div>
                <div class="stats" id="stats"></div>
                <div class="error" id="error"></div>
                <div class="smalltext">
                    –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.<br>
                    –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
                </div>
            </div>
        </div>
        <div id="footer">
            Powered by MurKir Security | SMF-Style Interface
        </div>
    </div>
    <script>
        var challengeData = ' . $challengeJson . ';
        var redirectUrl = ' . $redirectJson . ';
        var progressBar = document.getElementById("progress");
        var statusEl = document.getElementById("status");
        var statsEl = document.getElementById("stats");
        var errorEl = document.getElementById("error");
        var loopProtection = 0;
        
        function updateProgress(percent, message) {
            progressBar.style.width = percent + "%";
            statusEl.textContent = message;
        }
        
        function showError(message) {
            errorEl.innerHTML = message;
            errorEl.style.display = "block";
            statusEl.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏";
            document.getElementById("spinner").style.display = "none";
        }
        
        function sleep(ms) {
            return new Promise(function(resolve) { setTimeout(resolve, ms); });
        }
        
        function areCookiesEnabled() {
            try {
                document.cookie = "cookietest=1; SameSite=Lax";
                var result = document.cookie.indexOf("cookietest=") !== -1;
                document.cookie = "cookietest=1; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax";
                return result;
            } catch (e) {
                return false;
            }
        }
        
        function checkLoopProtection() {
            try {
                var key = "jsc_attempts_" + challengeData.id.substr(0, 8);
                var attempts = parseInt(sessionStorage.getItem(key) || "0", 10);
                if (attempts >= 3) return false;
                sessionStorage.setItem(key, (attempts + 1).toString());
                return true;
            } catch (e) {
                var url = new URL(window.location.href);
                var attempts = parseInt(url.searchParams.get("_jsc_retry") || "0", 10);
                return attempts < 3;
            }
        }
        
        // SHA-256 for PoW
        async function sha256(str) {
            var buf = new TextEncoder().encode(str);
            var hash = await crypto.subtle.digest("SHA-256", buf);
            return Array.from(new Uint8Array(hash)).map(function(b) {
                return b.toString(16).padStart(2, "0");
            }).join("");
        }
        
        async function performChallenge() {
            try {
                updateProgress(10, "–ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞...");
                await sleep(300);
                
                if (!checkLoopProtection()) {
                    showError("<strong>üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏</strong><br><br>" +
                        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ cookies –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)");
                    return;
                }
                
                updateProgress(20, "–ü—Ä–æ–≤–µ—Ä–∫–∞ JavaScript...");
                await sleep(300);
                
                updateProgress(30, "–ü—Ä–æ–≤–µ—Ä–∫–∞ cookies...");
                await sleep(300);
                
                if (!areCookiesEnabled()) {
                    showError("<strong>‚ö†Ô∏è Cookies –æ—Ç–∫–ª—é—á–µ–Ω—ã</strong><br><br>" +
                        "–î–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å cookies –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
                    return;
                }
                
                var answer, nonce, hash;
                var isPow = challengeData.type === "pow";
                
                if (isPow) {
                    // Proof of Work
                    updateProgress(40, "–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...");
                    
                    nonce = 0;
                    var target = challengeData.target || "0".repeat(challengeData.difficulty || 4);
                    var startTime = Date.now();
                    var timeout = (challengeData.timeout || 60) * 1000;
                    
                    while (true) {
                        hash = await sha256(challengeData.id + nonce);
                        if (hash.startsWith(target)) break;
                        nonce++;
                        
                        if (nonce % 500 === 0) {
                            var elapsed = Date.now() - startTime;
                            var hashRate = Math.round(nonce / (elapsed / 1000));
                            var progress = Math.min(85, 40 + (elapsed / timeout) * 45);
                            updateProgress(progress, "–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...");
                            statsEl.textContent = nonce.toLocaleString() + " —Ö–µ—à–µ–π | " + hashRate.toLocaleString() + " H/s";
                            
                            if (elapsed > timeout) {
                                showError("<strong>‚è±Ô∏è –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ</strong><br><br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                                return;
                            }
                            await sleep(0);
                        }
                    }
                    
                    var totalTime = ((Date.now() - startTime) / 1000).toFixed(2);
                    statsEl.textContent = nonce.toLocaleString() + " —Ö–µ—à–µ–π –∑–∞ " + totalTime + " —Å–µ–∫";
                } else {
                    // Sum challenge (legacy)
                    updateProgress(60, "–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏...");
                    answer = challengeData.numbers.reduce(function(sum, num) { return sum + num; }, 0);
                }
                
                updateProgress(90, "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ—à–µ–Ω–∏—è...");
                
                var xhr = new XMLHttpRequest();
                xhr.open("POST", window.location.href, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.setRequestHeader("X-JSC-Response", "1");
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            var result = JSON.parse(xhr.responseText);
                            if (result.success) {
                                updateProgress(100, "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
                                statusEl.className = "status success";
                                document.getElementById("spinner").style.display = "none";
                                
                                try {
                                    var key = (isPow ? "pow_attempts_" : "jsc_attempts_") + challengeData.id.substr(0, 8);
                                    sessionStorage.removeItem(key);
                                } catch (e) {}
                                
                                setTimeout(function() {
                                    window.location.href = redirectUrl;
                                }, 500);
                            } else {
                                showError(result.error || "Verification failed");
                            }
                        } catch (e) {
                            showError("Invalid response");
                        }
                    } else {
                        showError("HTTP " + xhr.status);
                    }
                };
                
                xhr.onerror = function() {
                    showError("Network error");
                };
                
                var payload = {
                    challenge_id: challengeData.id,
                    timestamp: challengeData.timestamp,
                    type: isPow ? "pow" : "sum"
                };
                
                if (isPow) {
                    payload.nonce = nonce;
                    payload.hash = hash;
                } else {
                    payload.answer = answer;
                }
                
                xhr.send(JSON.stringify(payload));
                
            } catch (error) {
                showError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
            }
        }
        
        window.addEventListener("load", function() {
            setTimeout(performChallenge, 1000);
        });
    </script>
</body>
</html>';
}

// ============================================================================
// –û–ë–†–û–ë–ö–ê POST –ó–ê–ü–ò–¢–£ JS CHALLENGE
// ============================================================================
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_SERVER['HTTP_X_JSC_RESPONSE'])) {
    header('Content-Type: application/json; charset=utf-8');
    header('Cache-Control: no-cache, no-store');
    
    $input = json_decode(file_get_contents('php://input'), true);
    
    if (!$input || !isset($input['challenge_id']) || !isset($input['timestamp'])) {
        echo json_encode(array('success' => false, 'error' => 'Invalid request'));
        exit;
    }
    
    $timestamp = (int)$input['timestamp'];
    $challengeType = isset($input['type']) ? $input['type'] : 'sum';
    
    // v3.8.0: –†—ñ–∑–Ω–∏–π timeout –¥–ª—è PoW —Ç–∞ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ challenge
    $maxAge = ($challengeType === 'pow') ? 120 : 300;
    
    if (time() - $timestamp > $maxAge) {
        echo json_encode(array('success' => false, 'error' => 'Challenge expired'));
        exit;
    }
    
    // v3.8.0: Proof of Work –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è
    if ($challengeType === 'pow') {
        if (!isset($input['nonce']) || !isset($input['hash'])) {
            echo json_encode(array('success' => false, 'error' => 'Missing PoW data'));
            exit;
        }
        
        $challengeId = $input['challenge_id'];
        $nonce = (int)$input['nonce'];
        $clientHash = $input['hash'];
        $difficulty = isset($_JSC_CONFIG['pow_difficulty']) ? (int)$_JSC_CONFIG['pow_difficulty'] : 4;
        
        // –°–µ—Ä–≤–µ—Ä–Ω–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è PoW
        $serverHash = hash('sha256', $challengeId . $nonce);
        $target = str_repeat('0', $difficulty);
        
        if ($serverHash !== $clientHash) {
            _jsc_logStats('failed', _jsc_getClientIP());
            echo json_encode(array('success' => false, 'error' => 'Hash mismatch'));
            exit;
        }
        
        if (strpos($serverHash, $target) !== 0) {
            _jsc_logStats('failed', _jsc_getClientIP());
            echo json_encode(array('success' => false, 'error' => 'Invalid PoW solution'));
            exit;
        }
    } else {
        // Legacy: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—É–º–∏ (–¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ)
        if (!isset($input['answer'])) {
            _jsc_logStats('failed', _jsc_getClientIP());
            echo json_encode(array('success' => false, 'error' => 'Missing answer'));
            exit;
        }
    }
    
    // v3.8.1: –õ–æ–≥—É—î–º–æ —É—Å–ø—ñ—à–Ω–µ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è challenge (–¥–ª—è –í–°–Ü–• —Ç–∏–ø—ñ–≤)
    _jsc_logStats('passed', _jsc_getClientIP());
    
    $ip = _jsc_getClientIP();
    $token = hash('sha256', $ip . date('Y-m-d') . $_JSC_CONFIG['secret_key']);
    
    $secure = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off';
    $lifetime = $_JSC_CONFIG['token_lifetime'];
    $cookie_name = $_JSC_CONFIG['cookie_name'];
    
    if (PHP_VERSION_ID >= 70300) {
        setcookie($cookie_name, $token, [
            'expires' => time() + $lifetime,
            'path' => '/',
            'secure' => $secure,
            'httponly' => true,
            'samesite' => 'Lax'
        ]);
    } else {
        setcookie($cookie_name, $token, time() + $lifetime, '/', '', $secure, true);
    }
    
    echo json_encode(array('success' => true, 'token' => $token));
    exit;
}

// ============================================================================
// –®–í–ò–î–ö–ê –ü–ï–†–ï–í–Ü–†–ö–ê –ë–õ–û–ö–£–í–ê–ù–ù–Ø
// ============================================================================

function _quick_block_check() {
    try {
        $redis = new Redis();
        $redis->connect('127.0.0.1', 6379, 1);
        $redis->select(1);
        
        $ip = _jsc_getClientIP();
        $prefix = 'bot_protection:';
        
        if ($redis->exists($prefix . 'ua_blocked:' . $ip)) {
            return true;
        }
        
        $ua = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';
        $lang = isset($_SERVER['HTTP_ACCEPT_LANGUAGE']) ? $_SERVER['HTTP_ACCEPT_LANGUAGE'] : '';
        $browserHash = hash('sha256', $ua . '|' . $lang);
        
        $cookieName = 'bot_protection_uid';
        $cookieId = isset($_COOKIE[$cookieName]) ? $_COOKIE[$cookieName] : '';
        
        if (!empty($cookieId)) {
            $userId = $cookieId . '_' . substr($browserHash, 0, 16);
        } else {
            $userId = $ip . '_' . substr($browserHash, 0, 16);
        }
        
        if ($redis->exists($prefix . 'blocked:' . hash('md5', $userId))) {
            return true;
        }
        
        $redis->close();
        return false;
        
    } catch (Exception $e) {
        return false;
    }
}

function _show_502_error() {
    http_response_code(502);
    header('Content-Type: text/html; charset=UTF-8');
    header('Cache-Control: no-cache, no-store');
    
    echo '<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>502 Bad Gateway</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Verdana, Arial, sans-serif;
            font-size: 13px;
            background: #e5e5e8;
            color: #000;
            padding: 20px;
        }
        #wrapper {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border: 1px solid #bbb;
        }
        #header {
            background: linear-gradient(to bottom, #7d3131 0%, #803e1e 100%);
            padding: 20px;
            border-bottom: 1px solid #631414;
        }
        #header h1 {
            color: #fff;
            font-size: 22px;
            font-weight: normal;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            margin: 0;
        }
        #content {
            padding: 30px;
            background: #fff;
        }
        .catbg {
            background: linear-gradient(to bottom, #ffffff 0%, #ffe0e0 100%);
            border: 1px solid #cc9999;
            border-bottom: 1px solid #aa7777;
            padding: 10px;
            font-weight: bold;
            color: #880000;
            margin-bottom: 15px;
        }
        .windowbg {
            background: #fff5f5;
            border: 1px solid #cc9999;
            padding: 25px;
            margin-bottom: 15px;
        }
        .error-icon {
            text-align: center;
            font-size: 48px;
            margin-bottom: 20px;
            color: #cc3300;
        }
        .error-code {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #cc3300;
            margin-bottom: 15px;
        }
        .info-text {
            color: #444;
            line-height: 1.8;
            margin: 15px 0;
        }
        .info-box {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #cc3300;
        }
        .info-box strong {
            display: block;
            margin-bottom: 10px;
            color: #880000;
        }
        .info-box ul {
            margin-left: 20px;
            color: #666;
        }
        .info-box li {
            margin: 5px 0;
        }
        .button {
            display: inline-block;
            background: linear-gradient(to bottom, #7db8e5 0%, #4e9bd6 100%);
            border: 1px solid #3a7ba8;
            color: #fff;
            padding: 8px 20px;
            text-decoration: none;
            border-radius: 3px;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            cursor: pointer;
            margin-top: 15px;
        }
        .button:hover {
            background: linear-gradient(to bottom, #8dc5f0 0%, #5ea8e0 100%);
        }
        .center {
            text-align: center;
        }
        .smalltext {
            font-size: 11px;
            color: #777;
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        #footer {
            background: #e5e5e8;
            padding: 15px;
            text-align: center;
            font-size: 11px;
            color: #666;
            border-top: 1px solid #bbb;
        }
        #countdown {
            font-weight: bold;
            color: #1e5380;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="header">
            <h1>‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</h1>
        </div>
        <div id="content">
            <div class="catbg">
                –û—à–∏–±–∫–∞ 502 - Bad Gateway
            </div>
            <div class="windowbg">
                <div class="error-icon">‚ö†</div>
                <div class="error-code">HTTP 502 Bad Gateway</div>
                
                <div class="info-text center">
                    <strong>–°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</strong><br>
                    –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å.<br>
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
                </div>
                
                <div class="info-box">
                    <strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong>
                    <ul>
                        <li>–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤</li>
                        <li>–ü—Ä–æ–≤–æ–¥—è—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</li>
                        <li>–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º</li>
                        <li>–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–ª—É–∂–±</li>
                    </ul>
                </div>
                
                <div class="center">
                    <a href="javascript:location.reload()" class="button">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    </a>
                </div>
                
                <div class="smalltext">
                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ <span id="countdown">10</span> —Å–µ–∫—É–Ω–¥...<br>
                    –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∞–π—Ç–∞.
                </div>
            </div>
        </div>
        <div id="footer">
            SMF 2.0.15 | SMF ¬© 2017, Simple Machines | Powered by MurKir Security
        </div>
    </div>
    
    <script>
        var counter = 10;
        var countdownEl = document.getElementById("countdown");
        
        var interval = setInterval(function() {
            counter--;
            if (countdownEl) {
                countdownEl.textContent = counter;
            }
            if (counter <= 0) {
                clearInterval(interval);
                location.reload();
            }
        }, 1000);
    </script>
</body>
</html>';
    exit;
}

if (_quick_block_check()) {
    _show_502_error();
}

// ============================================================================
// –ü–ï–†–ï–í–Ü–†–ö–ê JS CHALLENGE (–ó –ü–†–Ü–û–†–ò–¢–ï–¢–û–ú IP WHITELIST v3.7.0)
// ============================================================================
if ($_JSC_CONFIG['enabled']) {
    $clientIP = _jsc_getClientIP();  // –î–æ–¥–∞–Ω–æ v3.7.0
    $userAgent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';
    $_jsc_skip = false;
    
    // ========================================================================
    // –ü–†–Ü–û–†–ò–¢–ï–¢ 0: –í–°–Ü –ë–Ü–õ–Ü –°–ü–ò–°–ö–ò IP (–ê–ë–°–û–õ–Æ–¢–ù–ò–ô –ü–†–Ü–û–†–ò–¢–ï–¢!) - v3.8.2
    // ========================================================================
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î: $ADMIN_IP_WHITELIST + $SEARCH_ENGINE_IP_RANGES
    // –¶—ñ IP –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å—Å—è –ë–ï–ó –ë–£–î–¨-–Ø–ö–ò–• –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫!
    $whitelistType = _is_whitelisted_ip($clientIP);
    if ($whitelistType !== false) {
        $_jsc_skip = true;
        // –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤–∂–µ –∑—Ä–æ–±–ª–µ–Ω–æ –≤ _is_admin_ip() –∞–±–æ _is_search_engine_ip()
    }
    
    // ========================================================================
    // –ü–†–Ü–û–†–ò–¢–ï–¢ 1: –í–õ–ê–°–ù–Ü USER AGENTS
    // ========================================================================
    if (!$_jsc_skip && _is_custom_ua($userAgent)) {
        $_jsc_skip = true;
        // error_log –≤–∂–µ –∑—Ä–æ–±–ª–µ–Ω–æ –≤ _is_custom_ua()
    }
    
    // ========================================================================
    // –ü–†–Ü–û–†–ò–¢–ï–¢ 2: SEO –ë–û–¢–ò (–ø–æ User-Agent)
    // ========================================================================
    if (!$_jsc_skip && _is_seo_bot($userAgent)) {
        $_jsc_skip = true;
    }
    
    // ========================================================================
    // –ü–†–Ü–û–†–ò–¢–ï–¢ 3: –°–¢–ê–¢–ò–ß–ù–Ü –§–ê–ô–õ–ò –¢–ê AJAX
    // ========================================================================
    if (!$_jsc_skip) {
        $uri = isset($_SERVER['REQUEST_URI']) ? strtolower($_SERVER['REQUEST_URI']) : '';
        $skipExt = array('.js', '.css', '.json', '.xml', '.txt', '.ico', '.png', '.jpg', '.jpeg', '.gif', '.webp', '.svg', '.woff', '.woff2', '.ttf', '.mp4', '.mp3', '.pdf', '.zip', '.rar');
        
        foreach ($skipExt as $ext) {
            if (strpos($uri, $ext) !== false) {
                $_jsc_skip = true;
                break;
            }
        }
        
        if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') {
            $_jsc_skip = true;
        }
    }
    
    // ========================================================================
    // –ü–û–ö–ê–ó JS CHALLENGE (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –∑–≤–∏—á–∞–π–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)
    // ========================================================================
    if (!$_jsc_skip && !_jsc_isVerified($_JSC_CONFIG['secret_key'], $_JSC_CONFIG['cookie_name'])) {
        $challenge = _jsc_generateChallenge($_JSC_CONFIG['secret_key']);
        $currentUrl = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' ? 'https' : 'http') . 
                      '://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
        _jsc_showChallengePage($challenge, $currentUrl);
    }
}

// ============================================================================
// –ö–õ–ê–°–° –ó–ê–•–ò–°–¢–£
// ============================================================================

class SimpleBotProtection {
    
    private $redis = null;
    private $redisHost = '127.0.0.1';
    private $redisPort = 6379;
    private $redisDB = 1;
    private $redisPassword = '';
    private $redisPrefix = 'bot_protection:';
    private $debugMode = false;
    
    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è rate limit
    private $rateLimitSettings = array(
        'max_requests_per_minute' => 30,
        'max_requests_per_5min' => 100,
        'max_requests_per_hour' => 500,
        'burst_threshold' => 10,
        'block_duration' => 900,
        'cookie_multiplier' => 1.5,
        'js_verified_multiplier' => 2.0,
    );
    
    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è UA Rotation
    private $uaRotationSettings = array(
        'enabled' => true,
        'max_unique_ua_per_5min' => 10,
        'max_unique_ua_per_hour' => 20,
        'block_duration' => 7200,
        'tracking_window' => 3600,
    );
    
    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è API
    private $apiSettings = array(
        'enabled' => false,
        'url' => 'https://mysite.com/redis-bot_protection/API/iptables.php',
        'api_key' => '12345',
        'timeout' => 5,
        'retry_on_failure' => 2,
        'verify_ssl' => true,
        'user_agent' => 'BotProtection/3.8.4',
        'block_on_api' => true,
        'block_on_redis' => true,
    );
    
    // ============================================================================
    // –ó–ê–•–ò–°–¢ –í–Ü–î –ë–û–¢–Ü–í –ë–ï–ó COOKIES v1.0 (2026-01-15)
    // ============================================================================
    
    /**
     * –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –±–æ—Ç—ñ–≤ –±–µ–∑ cookies
     * 
     * –ë–æ—Ç–∏ —á–∞—Å—Ç–æ –ù–ï –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å cookies (bot_protection_uid), –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ
     * –ø—Ä–æ–π—à–ª–∏ JS Challenge (mk_verified). –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∏—è–≤–∏—Ç–∏ —ó—Ö —à–≤–∏–¥—à–µ.
     * 
     * –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–Ü –ó–ù–ê–ß–ï–ù–ù–Ø:
     * - –ú–∞–ª–∏–π —Å–∞–π—Ç (–ª–µ–≥–∫–∏–π —Ç—Ä–∞—Ñ—ñ–∫): threshold=5, window=60
     * - –°–µ—Ä–µ–¥–Ω—ñ–π —Å–∞–π—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ): threshold=3, window=30
     * - –ü—ñ–¥ –∞—Ç–∞–∫–æ—é (–∂–æ—Ä—Å—Ç–∫–æ): threshold=2, window=20
     */
    
    // –°–∫—ñ–ª—å–∫–∏ –∑–∞–ø–∏—Ç—ñ–≤ –±–µ–∑ bot_protection_uid –ø–µ—Ä–µ–¥ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è–º
    private $noCookieThreshold = 3;
    
    // –ó–∞ —è–∫–∏–π –ø–µ—Ä—ñ–æ–¥ —á–∞—Å—É —Ä–∞—Ö—É–≤–∞—Ç–∏ (—Å–µ–∫—É–Ω–¥–∏)
    private $noCookieTimeWindow = 30;
    
    /**
     * –ñ–æ—Ä—Å—Ç–∫—ñ rate limits –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ë–ï–ó bot_protection_uid cookie
     * 
     * –¶—ñ –ª—ñ–º—ñ—Ç–∏ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –¢–Ü–õ–¨–ö–ò –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –±–µ–∑ cookie.
     * –ó–≤–∏—á–∞–π–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ cookie –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å rateLimitSettings.
     */
    private $noCookieRateLimits = array(
        'minute' => 10,      // –ó–∞–º—ñ—Å—Ç—å 20 (–∑–≤–∏—á–∞–π–Ω–∏–π)
        '5min' => 30,        // –ó–∞–º—ñ—Å—Ç—å 100
        'hour' => 200,       // –ó–∞–º—ñ—Å—Ç—å 1000
        'day' => 1000,       // –ó–∞–º—ñ—Å—Ç—å 5000
        'burst' => 5,        // –ó–∞–º—ñ—Å—Ç—å 20 (10 —Å–µ–∫—É–Ω–¥)
    );
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—ñ–≤ –±–µ–∑ bot_protection_uid cookie
     * 
     * –í–∏—è–≤–ª—è—î –±–æ—Ç–∏ —è–∫—ñ –ø—Ä–æ–π—à–ª–∏ JS Challenge (–º–∞—é—Ç—å mk_verified),
     * –∞–ª–µ –ù–ï –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å bot_protection_uid cookie.
     * 
     * @param string $ip IP –∞–¥—Ä–µ—Å–∞
     * @return bool true —è–∫—â–æ —Ç—Ä–µ–±–∞ –±–ª–æ–∫—É–≤–∞—Ç–∏
     */
    private function checkNoCookieAttempts($ip) {
        $key = $this->redisPrefix . 'no_cookie_attempts:' . $ip;
        
        // –û—Ç—Ä–∏–º—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é —Å–ø—Ä–æ–±
        $attempts = $this->redis->get($key);
        if (!$attempts || !is_array($attempts)) {
            $attempts = array();
        }
        
        $now = time();
        
        // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Å—Ç–∞—Ä—ñ –∑–∞–ø–∏—Å–∏ (–∑–∞ –º–µ–∂–∞–º–∏ time window)
        $filtered = array();
        foreach ($attempts as $timestamp) {
            if (($now - $timestamp) < $this->noCookieTimeWindow) {
                $filtered[] = $timestamp;
            }
        }
        
        // –î–æ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Å–ø—Ä–æ–±—É
        $filtered[] = $now;
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ Redis –∑ –ø–æ–¥–≤—ñ–π–Ω–∏–º TTL (—â–æ–± –Ω–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ –¥–∞–Ω—ñ)
        $this->redis->setex($key, $this->noCookieTimeWindow * 2, $filtered);
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ä–æ–≥—É
        $attemptCount = count($filtered);
        
        if ($attemptCount >= $this->noCookieThreshold) {
            error_log(sprintf(
                "NO COOKIE ATTACK DETECTED: IP=%s, attempts=%d in %dsec (threshold=%d)",
                $ip, 
                $attemptCount, 
                $this->noCookieTimeWindow,
                $this->noCookieThreshold
            ));
            
            // –ë–ª–æ–∫—É—î–º–æ –≤ Redis
            $blockKey = $this->redisPrefix . 'blocked:no_cookie:' . $ip;
            $this->redis->setex($blockKey, 3600, array(
                'ip' => $ip,  // –î–æ–¥–∞–Ω–æ –¥–ª—è –∞–¥–º—ñ–Ω–∫–∏
                'time' => $now,
                'reason' => 'no_cookie_attack',
                'attempts' => $attemptCount,
                'threshold' => $this->noCookieThreshold,
                'window' => $this->noCookieTimeWindow
            ));
            
            // –ë–ª–æ–∫—É—î–º–æ —á–µ—Ä–µ–∑ API
            if ($this->apiSettings['enabled'] && $this->apiSettings['block_on_api']) {
                $apiResult = $this->callBlockingAPI($ip, 'block');
                
                if ($apiResult['status'] === 'success') {
                    error_log("API BLOCK SUCCESS: IP=$ip (no cookie attack, $attemptCount attempts in {$this->noCookieTimeWindow}sec)");
                } elseif ($apiResult['status'] !== 'already_blocked') {
                    $msg = isset($apiResult['message']) ? $apiResult['message'] : 'unknown';
                    error_log("API BLOCK FAILED: IP=$ip, reason=" . $msg);
                }
            }
            
            return true;
        }
        
        // –õ–æ–≥—É–≤–∞–Ω–Ω—è —è–∫—â–æ –≤–∫–ª—é—á–µ–Ω–æ debug —Ä–µ–∂–∏–º
        if ($this->debugMode && $attemptCount > 1) {
            error_log(sprintf(
                "NO COOKIE CHECK: IP=%s, attempts=%d/%d in %dsec",
                $ip, 
                $attemptCount, 
                $this->noCookieThreshold,
                $this->noCookieTimeWindow
            ));
        }
        
        return false;
    }
    
    /**
     * –û–Ω–æ–≤–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –±–æ—Ç—ñ–≤ –±–µ–∑ cookies
     * 
     * @param array $settings –ù–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
     *                        - threshold: int - –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–±
     *                        - time_window: int - –ø–µ—Ä—ñ–æ–¥ —á–∞—Å—É –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
     *                        - rate_limits: array - –≤–ª–∞—Å–Ω—ñ –ª—ñ–º—ñ—Ç–∏
     */
    public function updateNoCookieSettings($settings) {
        if (isset($settings['threshold'])) {
            $this->noCookieThreshold = max(1, (int)$settings['threshold']);
        }
        if (isset($settings['time_window'])) {
            $this->noCookieTimeWindow = max(10, (int)$settings['time_window']);
        }
        if (isset($settings['rate_limits']) && is_array($settings['rate_limits'])) {
            $this->noCookieRateLimits = array_merge(
                $this->noCookieRateLimits, 
                $settings['rate_limits']
            );
        }
    }
    
    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è rDNS
    private $rdnsSettings = array(
        'enabled' => true,
        'cache_ttl' => 3600,
        'rate_limit_per_minute' => 10,
        'rdns_on_limit_action' => 'skip',
    );
    
    private $rdnsPrefix = 'rdns:';
    
    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è SEO –±–æ—Ç—ñ–≤
    private $searchLogSettings = array(
        'enabled' => true,
        'file' => '/var/log/search_engines.log',
        'max_size' => 1048576,
        'keep_backups' => 3,
        'log_host' => true,
        'log_url' => true,
        'log_ua' => true,
        'ua_max_length' => 100,
        // v3.7.0: Redis —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        'redis_stats' => true,           // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ Redis
        'redis_log_max' => 500,          // –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø–∏—Å—ñ–≤ –≤ –ª–æ–≥—É Redis
        'redis_stats_ttl' => 86400 * 30, // TTL –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (30 –¥–Ω—ñ–≤)
    );
    
    // ========================================================================
    // –†–û–ó–®–ò–†–ï–ù–ò–ô WHITELIST –ü–û–®–£–ö–û–í–ò–• –°–ò–°–¢–ï–ú (SEO v3.6.0)
    // ========================================================================
    
    private $searchEngines = array(
        // GOOGLE
        'google' => array(
            'user_agent_patterns' => array(
                'google-read-aloud', 'googlebot', 'google-inspectiontool', 'adsbot-google', 
                'apis-google', 'mediapartners-google', 'googleother',
                'google-site-verification', 'googlebot-image', 'googlebot-news',
                'googlebot-video', 'google-structured-data'
            ),
            'rdns_patterns' => array('.googlebot.com', '.google.com'),
            'skip_forward_verification' => false,
            'ip_ranges' => array(
                '66.249.64.0/19', '64.233.160.0/19', '72.14.192.0/18',
                '203.208.32.0/19', '74.125.0.0/16', '216.239.32.0/19',
                '2001:4860::/32',
            )
        ),
        
        // YANDEX
        'yandex' => array(
            'user_agent_patterns' => array(
                'yandex', 'yandexbot', 'yandexmetrika', 'yandexwebmaster',
                'yandexdirect', 'yandexmobilebot', 'yandeximages'
            ),
            'rdns_patterns' => array('.yandex.ru', '.yandex.net', '.yandex.com'),
            'skip_forward_verification' => false,
            'ip_ranges' => array(
                '5.45.192.0/18', '5.255.192.0/18', '37.9.64.0/18',
                '37.140.128.0/18', '77.88.0.0/16', '87.250.224.0/19',
                '93.158.128.0/18', '95.108.128.0/17', '100.43.64.0/19',
                '141.8.128.0/18', '178.154.128.0/17', '213.180.192.0/19',
                '2a02:6b8::/32',
            )
        ),
        
        // BING/MICROSOFT
        'bing' => array(
            'user_agent_patterns' => array('bingbot', 'bingpreview', 'msnbot', 'adidxbot'),
            'rdns_patterns' => array('.search.msn.com'),
            'skip_forward_verification' => false,
            'ip_ranges' => array(
                '13.66.0.0/16', '13.67.0.0/16', '13.68.0.0/16',
                '40.76.0.0/14', '157.55.0.0/16', '199.30.16.0/20',
                '207.46.0.0/16', '2620:1ec:c::0/40',
            )
        ),
        
        // BAIDU
        'baidu' => array(
            'user_agent_patterns' => array('baiduspider', 'baidu'),
            'rdns_patterns' => array('.crawl.baidu.com', '.baidu.com'),
            'skip_forward_verification' => false,
            'ip_ranges' => array(
                '116.179.0.0/16', '119.63.192.0/21', '123.125.71.0/24', 
                '180.76.0.0/16', '220.181.0.0/16',
            )
        ),
        
        // DUCKDUCKGO
        'duckduckgo' => array(
            'user_agent_patterns' => array('duckduckbot', 'duckduckgo'),
            'rdns_patterns' => array('.duckduckgo.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array(
                '20.191.45.212/32', '40.88.21.235/32', '52.142.26.175/32',
                '52.142.24.149/32', '72.94.249.34/32', '72.94.249.35/32',
            )
        ),
        
        // YAHOO
        'yahoo' => array(
            'user_agent_patterns' => array('slurp', 'yahoo'),
            'rdns_patterns' => array('.crawl.yahoo.net'),
            'skip_forward_verification' => false,
            'ip_ranges' => array(
                '67.195.0.0/16', '74.6.0.0/16', '98.136.0.0/14',
                '202.160.176.0/20', '209.191.64.0/18',
            )
        ),
        
        // SEZNAM (Czech)
        'seznam' => array(
            'user_agent_patterns' => array('seznambot', 'seznam'),
            'rdns_patterns' => array('.seznam.cz'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // SOGOU (China)
        'sogou' => array(
            'user_agent_patterns' => array('sogou'),
            'rdns_patterns' => array('.sogou.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // EXABOT
        'exabot' => array(
            'user_agent_patterns' => array('exabot'),
            'rdns_patterns' => array('.exabot.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // APPLE
        'applebot' => array(
            'user_agent_patterns' => array('applebot'),
            'rdns_patterns' => array('.applebot.apple.com'),
            'skip_forward_verification' => false,
            'ip_ranges' => array(
                '17.0.0.0/8',
                '2a01:b740::/32',
            )
        ),
        
        // FACEBOOK
        'facebook' => array(
            'user_agent_patterns' => array('facebookexternalhit', 'facebookcatalog'),
            'rdns_patterns' => array('.facebook.com', '.fbsv.net'),
            'skip_forward_verification' => true,
            'ip_ranges' => array(
                '31.13.24.0/21', '31.13.64.0/18', '66.220.144.0/20',
                '69.63.176.0/20', '173.252.64.0/18', '2a03:2880::/32',
            )
        ),
        
        // TWITTER/X
        'twitter' => array(
            'user_agent_patterns' => array('twitterbot'),
            'rdns_patterns' => array('.twitter.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // INSTAGRAM
        'instagram' => array(
            'user_agent_patterns' => array('instagram'),
            'rdns_patterns' => array('.instagram.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // PINTEREST
        'pinterest' => array(
            'user_agent_patterns' => array('pinterest'),
            'rdns_patterns' => array('.pinterest.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array(
                '54.236.1.0/24',
            )
        ),
        
        // LINKEDIN
        'linkedin' => array(
            'user_agent_patterns' => array('linkedinbot'),
            'rdns_patterns' => array('.linkedin.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // TIKTOK/BYTEDANCE
        'tiktok' => array(
            'user_agent_patterns' => array('tiktok', 'bytespider', 'bytedance'),
            'rdns_patterns' => array('.bytedance.com', '.tiktok.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // WHATSAPP
        'whatsapp' => array(
            'user_agent_patterns' => array('whatsapp'),
            'rdns_patterns' => array('.whatsapp.net'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // TELEGRAM
        'telegram' => array(
            'user_agent_patterns' => array('telegrambot', 'telegram'),
            'rdns_patterns' => array('.telegram.org'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // VIBER
        'viber' => array(
            'user_agent_patterns' => array('viber'),
            'rdns_patterns' => array('.viber.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // DISCORD
        'discord' => array(
            'user_agent_patterns' => array('discordbot', 'discord'),
            'rdns_patterns' => array('.discord.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // SLACK
        'slack' => array(
            'user_agent_patterns' => array('slackbot', 'slack'),
            'rdns_patterns' => array('.slack.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // SEO TOOLS
        'semrush' => array(
            'user_agent_patterns' => array('semrushbot'),
            'rdns_patterns' => array('.semrush.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'ahrefs' => array(
            'user_agent_patterns' => array('ahrefsbot'),
            'rdns_patterns' => array('.ahrefs.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'majestic' => array(
            'user_agent_patterns' => array('majestic', 'mj12bot'),
            'rdns_patterns' => array('.majestic12.co.uk'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'screaming_frog' => array(
            'user_agent_patterns' => array('screaming frog'),
            'rdns_patterns' => array(),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'sitebulb' => array(
            'user_agent_patterns' => array('sitebulb'),
            'rdns_patterns' => array(),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // MONITORING
        'pingdom' => array(
            'user_agent_patterns' => array('pingdom'),
            'rdns_patterns' => array('.pingdom.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'uptimerobot' => array(
            'user_agent_patterns' => array('uptimerobot'),
            'rdns_patterns' => array('.uptimerobot.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'statuscake' => array(
            'user_agent_patterns' => array('statuscake'),
            'rdns_patterns' => array('.statuscake.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'gtmetrix' => array(
            'user_agent_patterns' => array('gtmetrix'),
            'rdns_patterns' => array('.gtmetrix.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'webpagetest' => array(
            'user_agent_patterns' => array('webpagetest'),
            'rdns_patterns' => array('.webpagetest.org'),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        'lighthouse' => array(
            'user_agent_patterns' => array('lighthouse', 'chrome-lighthouse'),
            'rdns_patterns' => array(),
            'skip_forward_verification' => true,
            'ip_ranges' => array()
        ),
        
        // v3.8.4: PETALBOT (HUAWEI PETAL SEARCH)
        'petalbot' => array(
            'user_agent_patterns' => array('petalbot'),
            'rdns_patterns' => array('.petalsearch.com', '.aspiegel.com'),
            'skip_forward_verification' => true,
            'ip_ranges' => array(
                '114.119.128.0/17',
            )
        ),
    );
    
    // ========================================================================
    // –í–õ–ê–°–ù–Ü USER AGENTS (v3.6.0)
    // ========================================================================
    
    private $customUserAgents = array();
    
    public function __construct() {
        global $CUSTOM_USER_AGENTS;
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤–ª–∞—Å–Ω—ñ UA –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
        $this->customUserAgents = $CUSTOM_USER_AGENTS;
        $this->connectRedis();
    }
    
    /**
     * –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Redis
     */
    private function connectRedis() {
        try {
            $this->redis = new Redis();
            $this->redis->connect($this->redisHost, $this->redisPort, 1);
            
            if ($this->redisPassword) {
                $this->redis->auth($this->redisPassword);
            }
            
            $this->redis->select($this->redisDB);
            $this->redis->setOption(Redis::OPT_SERIALIZER, Redis::SERIALIZER_PHP);
            
        } catch (Exception $e) {
            error_log("Redis connection failed: " . $e->getMessage());
            $this->redis = null;
        }
    }
    
    /**
     * ========================================================================
     * –ì–û–õ–û–í–ù–ò–ô –ú–ï–¢–û–î –ó–ê–•–ò–°–¢–£ (v3.8.4 - Admin URL + AJAX Support)
     * ========================================================================
     */
    public function protect() {
        try {
            $ip = $this->getClientIP();
            $userAgent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';
            
            // ================================================================
            // –ö–†–û–ö 0: –ü–ï–†–ï–í–Ü–†–ö–ê –ü–†–û–ü–£–°–ö–£ RATE LIMIT (v3.8.4)
            // ================================================================
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î: IP whitelist, Admin URL whitelist, AJAX (—è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ)
            $skipReason = _should_skip_rate_limit($ip);
            if ($skipReason !== false) {
                if ($this->debugMode) {
                    error_log("BOT PROTECTION: Skipping all checks - reason: $skipReason, IP: $ip");
                }
                return; // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –í–°–Ü –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
            }
            
            // ================================================================
            // –ö–†–û–ö 1: –®–í–ò–î–ö–ê –ü–ï–†–ï–í–Ü–†–ö–ê –í–õ–ê–°–ù–ò–• USER AGENTS
            // ================================================================
            if ($this->isCustomUserAgent($userAgent)) {
                if ($this->debugMode) {
                    error_log("BOT PROTECTION: Custom User Agent detected, allowing: " . substr($userAgent, 0, 50));
                }
                return; // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –≤–ª–∞—Å–Ω—ñ UA
            }
            
            // ================================================================
            // –ö–†–û–ö 2: –ü–ï–†–ï–í–Ü–†–ö–ê –ü–û–®–£–ö–û–í–ò–• –°–ò–°–¢–ï–ú (rDNS)
            // ================================================================
            // rDNS –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è –¥–ª—è –±–æ—Ç—ñ–≤ —è–∫—ñ –Ω–µ –≤ IP whitelist
            if ($this->verifySearchEngineRDNS($ip, $userAgent)) {
                if ($this->debugMode) {
                    error_log("BOT PROTECTION: Search engine verified by rDNS, allowing");
                }
                return; // –í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –ø–æ—à—É–∫–æ–≤–∏–π –±–æ—Ç
            }
            
            // ================================================================
            // –ö–†–û–ö 3: –ü–ï–†–ï–í–Ü–†–ö–ê REDIS (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∏–π)
            // ================================================================
            if (!$this->redis) {
                if ($this->debugMode) {
                    error_log("BOT PROTECTION: Redis not available, protection disabled");
                }
                return; // –Ø–∫—â–æ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
            }
            
            // Debug logging
            if ($this->debugMode) {
                error_log("BOT PROTECTION: Checking IP=$ip, UA=" . substr($userAgent, 0, 50) . ", AJAX=" . (_is_ajax_request() ? 'yes' : 'no'));
            }
            
            // ================================================================
            // –ö–†–û–ö 4: –ü–ï–†–ï–í–Ü–†–ö–ò –ó–ê–•–ò–°–¢–£ (–¥–ª—è –∑–≤–∏—á–∞–π–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)
            // ================================================================
            
            // v3.8.4: –û—Ç—Ä–∏–º—É—î–º–æ –º–Ω–æ–∂–Ω–∏–∫ –¥–ª—è AJAX –∑–∞–ø–∏—Ç—ñ–≤
            $rateMultiplier = _get_rate_limit_multiplier();
            
            if ($this->debugMode && $rateMultiplier > 1.0) {
                error_log("BOT PROTECTION: AJAX rate limit multiplier applied: x" . $rateMultiplier);
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ UA Rotation (–Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –º–Ω–æ–∂–Ω–∏–∫ - —Ü–µ —ñ–Ω—à–∏–π —Ç–∏–ø –∞—Ç–∞–∫–∏)
            if ($this->checkUserAgentRotation($ip)) {
                error_log("BOT PROTECTION: UA rotation detected, blocking IP=$ip");
                $this->show502Error();
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Rate Limit —ñ Burst (–∑ –º–Ω–æ–∂–Ω–∏–∫–æ–º –¥–ª—è AJAX)
            if ($this->checkRateLimit($ip, $rateMultiplier)) {
                error_log("BOT PROTECTION: Rate limit exceeded, blocking IP=$ip");
                $this->show502Error();
            }
            
            if ($this->debugMode) {
                error_log("BOT PROTECTION: Request allowed for IP=$ip");
            }
            
        } catch (Exception $e) {
            error_log("BOT PROTECTION ERROR: " . $e->getMessage() . " at line " . $e->getLine());
            return; // –ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
        }
    }
    
    /**
     * ========================================================================
     * –ü–ï–†–ï–í–Ü–†–ö–ê –í–õ–ê–°–ù–ò–• USER AGENTS (v3.6.0)
     * ========================================================================
     */
    private function isCustomUserAgent($userAgent) {
        if (empty($this->customUserAgents)) {
            return false;
        }
        
        $userAgentLower = strtolower($userAgent);
        
        foreach ($this->customUserAgents as $customUA) {
            if (stripos($userAgentLower, strtolower($customUA)) !== false) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * –î–æ–¥–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π User Agent –¥–æ whitelist
     */
    public function addCustomUserAgent($userAgent) {
        global $CUSTOM_USER_AGENTS;
        if (!in_array($userAgent, $CUSTOM_USER_AGENTS)) {
            $CUSTOM_USER_AGENTS[] = $userAgent;
        }
        $this->customUserAgents = $CUSTOM_USER_AGENTS;
    }
    
    /**
     * –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –º–∞—Å–∏–≤ –≤–ª–∞—Å–Ω–∏—Ö User Agents
     */
    public function setCustomUserAgents($userAgents) {
        global $CUSTOM_USER_AGENTS;
        if (is_array($userAgents)) {
            $CUSTOM_USER_AGENTS = $userAgents;
            $this->customUserAgents = $userAgents;
        }
    }
    
    /**
     * –û—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤–ª–∞—Å–Ω–∏—Ö User Agents
     */
    public function getCustomUserAgents() {
        return $this->customUserAgents;
    }
    
    /**
     * –û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤–ª–∞—Å–Ω–∏—Ö User Agents
     */
    public function clearCustomUserAgents() {
        global $CUSTOM_USER_AGENTS;
        $CUSTOM_USER_AGENTS = array();
        $this->customUserAgents = array();
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ IP –Ω–∞–ª–µ–∂–∏—Ç—å –ø–æ—à—É–∫–æ–≤—ñ–π —Å–∏—Å—Ç–µ–º—ñ
     */
    private function isSearchEngineByIP($ip, $userAgent = '') {
        $detectedEngine = null;
        $engineConfig = null;
        
        if (!empty($userAgent)) {
            foreach ($this->searchEngines as $engine => $config) {
                foreach ($config['user_agent_patterns'] as $pattern) {
                    if (stripos($userAgent, $pattern) !== false) {
                        $detectedEngine = $engine;
                        $engineConfig = $config;
                        break 2;
                    }
                }
            }
        }
        
        if ($detectedEngine && $engineConfig && !empty($engineConfig['ip_ranges'])) {
            foreach ($engineConfig['ip_ranges'] as $cidr) {
                if ($this->ipInRange($ip, $cidr)) {
                    error_log("Search engine verified by IP: $detectedEngine ($ip)");
                    $this->logSearchEngine($detectedEngine, $ip, 'IP');
                    return true;
                }
            }
        }
        
        foreach ($this->searchEngines as $engine => $config) {
            if (!empty($config['ip_ranges'])) {
                foreach ($config['ip_ranges'] as $cidr) {
                    if ($this->ipInRange($ip, $cidr)) {
                        error_log("Search engine verified by IP (fallback): $engine ($ip)");
                        $this->logSearchEngine($engine, $ip, 'IP-fallback');
                        return true;
                    }
                }
            }
        }
        
        return false;
    }
    
    /**
     * rDNS –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø–æ—à—É–∫–æ–≤–∏—Ö –±–æ—Ç—ñ–≤
     */
    private function verifySearchEngineRDNS($ip, $userAgent = '') {
        $engineConfig = null;
        $engineName = null;
        
        if (!empty($userAgent)) {
            foreach ($this->searchEngines as $engine => $config) {
                foreach ($config['user_agent_patterns'] as $pattern) {
                    if (stripos($userAgent, $pattern) !== false) {
                        $engineConfig = $config;
                        $engineName = $engine;
                        break 2;
                    }
                }
            }
        }
        
        if (!$engineConfig || empty($engineConfig['rdns_patterns'])) {
            return false;
        }
        
        $verified = $this->performRDNSVerification($ip, $engineConfig);
        
        if ($verified && $engineName) {
            $this->logSearchEngine($engineName, $ip, 'rDNS');
        }
        
        return $verified;
    }
    
    /**
     * –í–∏–∫–æ–Ω–∞–Ω–Ω—è rDNS –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
     */
    private function performRDNSVerification($ip, $engineConfig) {
        try {
            $cacheKey = $this->redisPrefix . $this->rdnsPrefix . 'cache:' . hash('md5', $ip);
            
            $cached = $this->redis->get($cacheKey);
            if ($cached !== false) {
                return $cached === '1';
            }
            
            if (!$this->checkRDNSRateLimit()) {
                if ($this->rdnsSettings['rdns_on_limit_action'] === 'block') {
                    error_log("rDNS rate limit exceeded, blocking IP: $ip");
                    return false;
                }
                error_log("rDNS rate limit exceeded, skipping verification for: $ip");
                return false;
            }
            
            $verified = false;
            $allowedPatterns = $engineConfig['rdns_patterns'];
            $skipForward = isset($engineConfig['skip_forward_verification']) ? $engineConfig['skip_forward_verification'] : false;
            
            $hostname = $this->getHostnameWithTimeout($ip, 2);
            
            if ($hostname && $hostname !== $ip) {
                $hostnameMatches = false;
                foreach ($allowedPatterns as $pattern) {
                    if ($this->matchesDomainPattern($hostname, $pattern)) {
                        $hostnameMatches = true;
                        break;
                    }
                }
                
                if ($hostnameMatches) {
                    if ($skipForward) {
                        $verified = true;
                    } else {
                        $forwardIPs = gethostbynamel($hostname);
                        if ($forwardIPs && in_array($ip, $forwardIPs)) {
                            $verified = true;
                        }
                    }
                }
            }
            
            $this->redis->setex($cacheKey, $this->rdnsSettings['cache_ttl'], $verified ? '1' : '0');
            
            return $verified;
            
        } catch (Exception $e) {
            error_log("rDNS verification error for IP $ip: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ rDNS rate limit
     */
    private function checkRDNSRateLimit() {
        $key = $this->redisPrefix . $this->rdnsPrefix . 'ratelimit';
        $count = $this->redis->incr($key);
        
        if ($count === 1) {
            $this->redis->expire($key, 60);
        }
        
        return $count <= $this->rdnsSettings['rate_limit_per_minute'];
    }
    
    /**
     * –û—Ç—Ä–∏–º–∞–Ω–Ω—è hostname –∑ timeout
     */
    private function getHostnameWithTimeout($ip, $timeout = 2) {
        $hostname = null;
        $start = microtime(true);
        
        $hostname = @gethostbyaddr($ip);
        
        $elapsed = microtime(true) - $start;
        
        if ($elapsed > $timeout) {
            error_log("rDNS lookup timeout for $ip (took {$elapsed}s)");
            return null;
        }
        
        return $hostname !== $ip ? $hostname : null;
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –¥–æ–º–µ–Ω—É –ø–∞—Ç—Ç–µ—Ä–Ω—É
     */
    private function matchesDomainPattern($hostname, $pattern) {
        if (substr($pattern, 0, 1) === '.') {
            return substr($hostname, -strlen($pattern)) === $pattern;
        }
        return $hostname === $pattern;
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ User Agent Rotation
     */
    private function checkUserAgentRotation($ip) {
        if (!$this->uaRotationSettings['enabled']) {
            return false;
        }
        
        $userAgent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';
        if (empty($userAgent)) {
            return false;
        }
        
        $now = time();
        $uaKey = $this->redisPrefix . 'ua:' . $ip;
        $blockKey = $this->redisPrefix . 'ua_blocked:' . $ip;
        
        if ($this->redis->exists($blockKey)) {
            return true;
        }
        
        $uaData = $this->redis->get($uaKey);
        if (!$uaData || !is_array($uaData)) {
            $uaData = array();
        }
        
        $filtered = array();
        foreach ($uaData as $timestamp => $ua) {
            if (($now - $timestamp) < $this->uaRotationSettings['tracking_window']) {
                $filtered[$timestamp] = $ua;
            }
        }
        
        $filtered[$now] = $userAgent;
        
        $uniqueUA5min = array();
        $uniqueUAHour = array();
        
        foreach ($filtered as $timestamp => $ua) {
            if (($now - $timestamp) < 300) {
                $uniqueUA5min[$ua] = true;
            }
            if (($now - $timestamp) < 3600) {
                $uniqueUAHour[$ua] = true;
            }
        }
        
        $count5min = count($uniqueUA5min);
        $countHour = count($uniqueUAHour);
        
        if ($this->debugMode) {
            error_log(sprintf(
                "UA ROTATION CHECK: IP=%s, unique_5min=%d/%d, unique_hour=%d/%d",
                $ip,
                $count5min, $this->uaRotationSettings['max_unique_ua_per_5min'],
                $countHour, $this->uaRotationSettings['max_unique_ua_per_hour']
            ));
        }
        
        $this->redis->setex($uaKey, $this->uaRotationSettings['tracking_window'], $filtered);
        
        if ($count5min > $this->uaRotationSettings['max_unique_ua_per_5min'] ||
            $countHour > $this->uaRotationSettings['max_unique_ua_per_hour']) {
            
            $this->redis->setex(
                $blockKey,
                $this->uaRotationSettings['block_duration'],
                array('time' => $now, 'count_5min' => $count5min, 'count_hour' => $countHour)
            );
            
            error_log("UA ROTATION BLOCK: IP=$ip, 5min=$count5min, hour=$countHour");
            
            if ($this->apiSettings['enabled'] && $this->apiSettings['block_on_api']) {
                $this->callBlockingAPI($ip, 'block');
            }
            
            return true;
        }
        
        return false;
    }
    
    /**
     * –û—Ç—Ä–∏–º–∞—Ç–∏ IP –∫–ª—ñ—î–Ω—Ç–∞
     */
    private function getClientIP() {
        $ip = isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : '0.0.0.0';
        
        if (!empty($_SERVER['HTTP_CF_CONNECTING_IP'])) {
            $ip = $_SERVER['HTTP_CF_CONNECTING_IP'];
        } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            $ips = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);
            $ip = trim($ips[0]);
        } elseif (!empty($_SERVER['HTTP_X_REAL_IP'])) {
            $ip = $_SERVER['HTTP_X_REAL_IP'];
        }
        
        return filter_var($ip, FILTER_VALIDATE_IP) ? $ip : '0.0.0.0';
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ IP –≤ CIDR –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ
     */
    private function ipInRange($ip, $cidr) {
        if (strpos($cidr, '/') === false) {
            return $ip === $cidr;
        }
        
        list($subnet, $mask) = explode('/', $cidr);
        $mask = (int)$mask;
        
        $ipIsV6 = (strpos($ip, ':') !== false);
        $cidrIsV6 = (strpos($subnet, ':') !== false);
        
        if ($ipIsV6 !== $cidrIsV6) {
            return false;
        }
        
        if ($ipIsV6) {
            if ($mask < 0 || $mask > 128) {
                error_log("Invalid IPv6 CIDR mask: $cidr");
                return false;
            }
            return $this->ipv6InRange($ip, $subnet, $mask);
        }
        
        if ($mask < 0 || $mask > 32) {
            error_log("Invalid IPv4 CIDR mask: $cidr (IP: $ip)");
            return false;
        }
        
        $ip_long = ip2long($ip);
        $subnet_long = ip2long($subnet);
        
        if ($ip_long === false || $subnet_long === false) {
            return false;
        }
        
        $mask_long = -1 << (32 - $mask);
        
        return ($ip_long & $mask_long) === ($subnet_long & $mask_long);
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ IPv6 –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ
     */
    private function ipv6InRange($ip, $subnet, $mask) {
        $ip_bin = inet_pton($ip);
        $subnet_bin = inet_pton($subnet);
        
        if ($ip_bin === false || $subnet_bin === false) {
            return false;
        }
        
        $mask = (int)$mask;
        
        if ($mask < 0 || $mask > 128) {
            error_log("Invalid IPv6 mask in ipv6InRange: $mask");
            return false;
        }
        
        $full_bytes = floor($mask / 8);
        $remaining_bits = $mask % 8;
        
        for ($i = 0; $i < $full_bytes; $i++) {
            if ($ip_bin[$i] !== $subnet_bin[$i]) {
                return false;
            }
        }
        
        if ($remaining_bits > 0) {
            $mask_byte = (0xFF << (8 - $remaining_bits)) & 0xFF;
            if ((ord($ip_bin[$full_bytes]) & $mask_byte) !== (ord($subnet_bin[$full_bytes]) & $mask_byte)) {
                return false;
            }
        }
        
        return true;
    }
    
    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è user identifier
     */
    private function generateUserIdentifier() {
        $ip = $this->getClientIP();
        $userAgent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';
        $acceptLang = isset($_SERVER['HTTP_ACCEPT_LANGUAGE']) ? $_SERVER['HTTP_ACCEPT_LANGUAGE'] : '';
        
        $browserHash = hash('sha256', $userAgent . '|' . $acceptLang);
        
        $cookieName = 'bot_protection_uid';
        $cookieId = isset($_COOKIE[$cookieName]) ? $_COOKIE[$cookieName] : '';
        
        if (empty($cookieId)) {
            $cookieId = bin2hex(random_bytes(16));
            $secure = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off';
            
            if (PHP_VERSION_ID >= 70300) {
                setcookie($cookieName, $cookieId, [
                    'expires' => time() + 86400 * 30,
                    'path' => '/',
                    'secure' => $secure,
                    'httponly' => true,
                    'samesite' => 'Lax'
                ]);
            } else {
                setcookie($cookieName, $cookieId, time() + 86400 * 30, '/', '', $secure, true);
            }
        }
        
        return $cookieId . '_' . substr($browserHash, 0, 16);
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ cookie
     */
    private function hasValidCookie() {
        $cookieName = 'bot_protection_uid';
        return isset($_COOKIE[$cookieName]) && !empty($_COOKIE[$cookieName]);
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ JS verification
     */
    private function isJSVerified() {
        global $_JSC_CONFIG;
        return _jsc_isVerified($_JSC_CONFIG['secret_key'], $_JSC_CONFIG['cookie_name']);
    }
    
    /**
     * –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
     */
    private function getUserInfo() {
        $userAgent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';
        $acceptLang = isset($_SERVER['HTTP_ACCEPT_LANGUAGE']) ? $_SERVER['HTTP_ACCEPT_LANGUAGE'] : '';
        $browserHash = hash('sha256', $userAgent . '|' . $acceptLang);
        
        $cookieName = 'bot_protection_uid';
        $cookieId = isset($_COOKIE[$cookieName]) ? $_COOKIE[$cookieName] : '';
        
        return array(
            'browser_hash' => $browserHash,
            'cookie_id' => $cookieId,
            'user_agent' => $userAgent,
            'accept_lang' => $acceptLang
        );
    }
    
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Rate Limit
     */
    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Rate Limit (v3.8.4 - –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é AJAX –º–Ω–æ–∂–Ω–∏–∫–∞)
     * 
     * @param string $ip IP –∞–¥—Ä–µ—Å–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
     * @param float $ajaxMultiplier –ú–Ω–æ–∂–Ω–∏–∫ –¥–ª—è AJAX –∑–∞–ø–∏—Ç—ñ–≤ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 1.0)
     * @return bool true —è–∫—â–æ –ª—ñ–º—ñ—Ç –ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ
     */
    private function checkRateLimit($ip, $ajaxMultiplier = 1.0) {
        $now = time();
        $userId = $this->generateUserIdentifier();
        $hasCookie = $this->hasValidCookie();
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–æ—ó –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
        $useStrictLimits = false;
        
        // ========================================================================
        // –ó–ê–•–ò–°–¢ –í–Ü–î –ë–û–¢–Ü–í –ë–ï–ó COOKIES - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –∂–æ—Ä—Å—Ç–∫—ñ –ª—ñ–º—ñ—Ç–∏
        // ========================================================================
        if (!$hasCookie) {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —Ü–µ –∞—Ç–∞–∫–∞ –±–µ–∑ cookies
            if ($this->checkNoCookieAttempts($ip)) {
                // –í–∂–µ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ —ñ –∑–∞–ª–æ–≥–æ–≤–∞–Ω–æ –≤ checkNoCookieAttempts()
                return true;
            }
            
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∂–æ—Ä—Å—Ç–∫—ñ –ª—ñ–º—ñ—Ç–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –±–µ–∑ cookies
            $useStrictLimits = true;
            
            if ($this->debugMode) {
                error_log(sprintf(
                    "RATE LIMIT: Using STRICT limits for no-cookie user, IP=%s, limits: burst=%d, 5min=%d, hour=%d",
                    $ip,
                    $this->noCookieRateLimits['burst'],
                    $this->noCookieRateLimits['5min'],
                    $this->noCookieRateLimits['hour']
                ));
            }
        } else {
            // =====================================================================
            // Cookie —î - —Å–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–± –±–µ–∑ cookie –¥–ª—è —Ü—å–æ–≥–æ IP
            // –¶–µ –¥–æ–∑–≤–æ–ª—è—î –∫—ñ–ª—å–∫–æ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –æ–¥–Ω–æ–≥–æ IP –∑–∞—Ö–æ–¥–∏—Ç–∏ –Ω–∞ —Å–∞–π—Ç
            // =====================================================================
            $attemptsKey = $this->redisPrefix . 'no_cookie_attempts:' . $ip;
            if ($this->redis->exists($attemptsKey)) {
                $this->redis->del($attemptsKey);
                if ($this->debugMode) {
                    error_log("NO COOKIE ATTEMPTS RESET: IP=$ip (cookie obtained successfully)");
                }
            }
        }
        
        $key = $this->redisPrefix . 'rate:' . hash('md5', $userId);
        $blockKey = $this->redisPrefix . 'blocked:' . hash('md5', $userId);
        
        if ($this->redis->exists($blockKey)) {
            return true;
        }
        
        $data = $this->redis->get($key);
        
        $defaultRequests = array(
            'minute' => array(),
            '5min' => array(),
            'hour' => array(),
            'last_10sec' => array()
        );
        
        if ($data && is_array($data)) {
            $requests = $data;
            foreach (array('minute', '5min', 'hour', 'last_10sec') as $key_name) {
                if (!isset($requests[$key_name]) || !is_array($requests[$key_name])) {
                    $requests[$key_name] = array();
                }
            }
        } else {
            $requests = $defaultRequests;
        }
        
        $filteredMinute = array();
        foreach ($requests['minute'] as $t) {
            if (($now - $t) < 60) {
                $filteredMinute[] = $t;
            }
        }
        $requests['minute'] = $filteredMinute;
        
        $filtered5min = array();
        foreach ($requests['5min'] as $t) {
            if (($now - $t) < 300) {
                $filtered5min[] = $t;
            }
        }
        $requests['5min'] = $filtered5min;
        
        $filteredHour = array();
        foreach ($requests['hour'] as $t) {
            if (($now - $t) < 3600) {
                $filteredHour[] = $t;
            }
        }
        $requests['hour'] = $filteredHour;
        
        $filtered10sec = array();
        foreach ($requests['last_10sec'] as $t) {
            if (($now - $t) < 10) {
                $filtered10sec[] = $t;
            }
        }
        $requests['last_10sec'] = $filtered10sec;
        
        $requests['minute'][] = $now;
        $requests['5min'][] = $now;
        $requests['hour'][] = $now;
        $requests['last_10sec'][] = $now;
        
        // ========================================================================
        // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ–º—ñ—Ç—ñ–≤ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ cookie (v3.8.4 + AJAX multiplier)
        // ========================================================================
        if ($useStrictLimits) {
            // –ñ–æ—Ä—Å—Ç–∫—ñ –ª—ñ–º—ñ—Ç–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ë–ï–ó bot_protection_uid cookie
            // AJAX –º–Ω–æ–∂–Ω–∏–∫ –ù–ï –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –¥–ª—è strict limits (—Ü–µ –º–æ–∂–ª–∏–≤—ñ –±–æ—Ç–∏)
            $limits = array(
                'minute' => $this->noCookieRateLimits['minute'],
                '5min' => $this->noCookieRateLimits['5min'],
                'hour' => $this->noCookieRateLimits['hour'],
                'burst' => $this->noCookieRateLimits['burst']
            );
        } else {
            // –ó–≤–∏—á–∞–π–Ω—ñ –ª—ñ–º—ñ—Ç–∏ –∑ multiplier –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ó cookie
            $multiplier = 1.0;
            if ($hasCookie) {
                $multiplier = $this->rateLimitSettings['cookie_multiplier'];
            }
            if ($this->isJSVerified()) {
                $multiplier = $this->rateLimitSettings['js_verified_multiplier'];
            }
            
            // v3.8.4: –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ AJAX –º–Ω–æ–∂–Ω–∏–∫ –¥–æ–¥–∞—Ç–∫–æ–≤–æ
            // –õ—ñ–º—ñ—Ç–∏ = –±–∞–∑–æ–≤—ñ * cookie/JS multiplier * AJAX multiplier
            $totalMultiplier = $multiplier * $ajaxMultiplier;
            
            $limits = array(
                'minute' => (int)($this->rateLimitSettings['max_requests_per_minute'] * $totalMultiplier),
                '5min' => (int)($this->rateLimitSettings['max_requests_per_5min'] * $totalMultiplier),
                'hour' => (int)($this->rateLimitSettings['max_requests_per_hour'] * $totalMultiplier),
                'burst' => (int)($this->rateLimitSettings['burst_threshold'] * $totalMultiplier)
            );
            
            if ($this->debugMode && $ajaxMultiplier > 1.0) {
                error_log(sprintf(
                    "RATE LIMIT: AJAX multiplier applied: base_mult=%.1f, ajax_mult=%.1f, total=%.1f",
                    $multiplier, $ajaxMultiplier, $totalMultiplier
                ));
            }
        }
        // ========================================================================
        
        $violations = array();
        
        if ($this->debugMode) {
            error_log(sprintf(
                "RATE LIMIT CHECK: user_id=%s, cookie=%s, counts=[min:%d/%d, 5min:%d/%d, hour:%d/%d, burst:%d/%d]",
                substr($userId, 0, 30),
                $hasCookie ? 'YES' : 'NO',
                count($requests['minute']), $limits['minute'],
                count($requests['5min']), $limits['5min'],
                count($requests['hour']), $limits['hour'],
                count($requests['last_10sec']), $limits['burst']
            ));
        }
        
        if (count($requests['minute']) > $limits['minute']) {
            $violations[] = 'minute';
        }
        
        if (count($requests['5min']) > $limits['5min']) {
            $violations[] = '5min';
        }
        
        if (count($requests['hour']) > $limits['hour']) {
            $violations[] = 'hour';
        }
        
        if (count($requests['last_10sec']) > $limits['burst']) {
            $violations[] = 'burst';
        }
        
        $this->redis->setex($key, 3600, $requests);
        
        if (!empty($violations)) {
            $this->blockUser($userId, $ip, $violations, $hasCookie, $limits);
            return true;
        }
        
        return false;
    }
    
    /**
     * –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
     */
    private function blockUser($userId, $ip, $violations, $hasCookie, $limits) {
        $blockKey = $this->redisPrefix . 'blocked:' . hash('md5', $userId);
        $userInfo = $this->getUserInfo();
        
        $blockData = array(
            'time' => time(),
            'violations' => $violations,
            'user_id' => $userId,
            'ip' => $ip,
            'browser_hash' => $userInfo['browser_hash'],
            'cookie_id' => $userInfo['cookie_id'],
            'has_cookie' => $hasCookie,
            'limits' => $limits
        );
        
        if ($this->apiSettings['block_on_redis']) {
            $this->redis->setex(
                $blockKey,
                $this->rateLimitSettings['block_duration'],
                $blockData
            );
        }
        
        error_log("RATE LIMIT BLOCK USER: " .
                  "user_id=" . substr($userId, 0, 20) .
                  ", ip=$ip" .
                  ", cookie=" . ($hasCookie ? 'YES' : 'NO') .
                  ", violations=" . implode(',', $violations));
        
        if (!$hasCookie && $this->apiSettings['enabled'] && $this->apiSettings['block_on_api']) {
            $apiResult = $this->callBlockingAPI($ip, 'block');
            if ($apiResult['status'] === 'success') {
                error_log("API BLOCK SUCCESS: IP=$ip (user without cookie)");
            } elseif ($apiResult['status'] !== 'already_blocked') {
                $msg = isset($apiResult['message']) ? $apiResult['message'] : 'unknown';
                error_log("API BLOCK FAILED: IP=$ip, reason=" . $msg);
            }
        }
    }
    
    /**
     * –í–∏–∫–ª–∏–∫ API –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
     */
    private function callBlockingAPI($ip, $action = 'block') {
        if (!$this->apiSettings['enabled']) {
            return array('status' => 'disabled', 'message' => 'API disabled');
        }
        
        if (!$this->apiSettings['block_on_api']) {
            return array('status' => 'skipped', 'message' => 'API blocking disabled');
        }
        
        $url = $this->apiSettings['url'] .
               '?action=' . urlencode($action) .
               '&ip=' . urlencode($ip) .
               '&api=1' .
               '&api_key=' . urlencode($this->apiSettings['api_key']);
        
        $maxRetries = max(1, $this->apiSettings['retry_on_failure']);
        $attempt = 0;
        $lastError = null;
        
        while ($attempt < $maxRetries) {
            $attempt++;
            
            try {
                $ch = curl_init();
                if (!$ch) {
                    throw new Exception("Failed to initialize cURL");
                }
                
                curl_setopt_array($ch, array(
                    CURLOPT_URL => $url,
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_TIMEOUT => $this->apiSettings['timeout'],
                    CURLOPT_CONNECTTIMEOUT => 3,
                    CURLOPT_FOLLOWLOCATION => false,
                    CURLOPT_SSL_VERIFYPEER => $this->apiSettings['verify_ssl'],
                    CURLOPT_SSL_VERIFYHOST => $this->apiSettings['verify_ssl'] ? 2 : 0,
                    CURLOPT_USERAGENT => $this->apiSettings['user_agent'],
                    CURLOPT_HTTPHEADER => array(
                        'Accept: application/json',
                        'Cache-Control: no-cache'
                    )
                ));
                
                $response = curl_exec($ch);
                $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                $curlError = curl_error($ch);
                $curlErrno = curl_errno($ch);
                curl_close($ch);
                
                if ($curlErrno !== 0) {
                    throw new Exception("cURL error #" . $curlErrno . ": " . $curlError);
                }
                
                if ($httpCode !== 200) {
                    throw new Exception("HTTP error code: " . $httpCode);
                }
                
                $result = json_decode($response, true);
                if (json_last_error() !== JSON_ERROR_NONE) {
                    throw new Exception("Invalid JSON response");
                }
                
                return $result;
                
            } catch (Exception $e) {
                $lastError = $e->getMessage();
                if ($attempt < $maxRetries) {
                    usleep(500000);
                }
            }
        }
        
        return array('status' => 'error', 'message' => $lastError);
    }
    
    /**
     * –ü–æ–∫–∞–∑ 502 –ø–æ–º–∏–ª–∫–∏
     */
    private function show502Error() {
        _show_502_error();
    }
    
    /**
     * –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏
     */
    private function logSearchEngine($engine, $ip, $method = 'IP') {
        if (!$this->searchLogSettings['enabled']) {
            return;
        }
        
        // v3.7.0: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ Redis
        if ($this->searchLogSettings['redis_stats']) {
            $this->logSearchEngineToRedis($engine, $ip, $method);
        }
        
        $logFile = $this->searchLogSettings['file'];
        
        if (file_exists($logFile) && filesize($logFile) >= $this->searchLogSettings['max_size']) {
            $this->rotateSearchLog();
        }
        
        $timestamp = date('Y-m-d H:i:s');
        $logParts = array($timestamp, $engine, $ip, $method);
        
        if ($this->searchLogSettings['log_host']) {
            $host = isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : '-';
            $logParts[] = $host;
        }
        
        if ($this->searchLogSettings['log_url']) {
            $url = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '-';
            $logParts[] = $url;
        }
        
        if ($this->searchLogSettings['log_ua']) {
            $ua = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '-';
            $maxLen = $this->searchLogSettings['ua_max_length'];
            if (strlen($ua) > $maxLen) {
                $ua = substr($ua, 0, $maxLen) . '...';
            }
            $logParts[] = $ua;
        }
        
        $logLine = implode(' | ', $logParts) . "\n";
        
        @file_put_contents($logFile, $logLine, FILE_APPEND | LOCK_EX);
    }
    
    /**
     * v3.7.0: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—à—É–∫–æ–≤–∏—Ö –±–æ—Ç—ñ–≤ –≤ Redis
     */
    private function logSearchEngineToRedis($engine, $ip, $method) {
        if (!$this->redis) {
            return;
        }
        
        try {
            $today = date('Y-m-d');
            $host = isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : 'unknown';
            $url = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '/';
            $ua = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '-';
            
            // –°–∫–æ—Ä–æ—á—É—î–º–æ UA
            $maxLen = $this->searchLogSettings['ua_max_length'];
            if (strlen($ua) > $maxLen) {
                $ua = substr($ua, 0, $maxLen) . '...';
            }
            
            // 1. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ –±–æ—Ç–∞
            $totalKey = $this->redisPrefix . 'search_stats:total:' . strtolower($engine);
            $this->redis->incr($totalKey);
            
            // 2. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –¥–µ–Ω–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ –±–æ—Ç–∞
            $todayKey = $this->redisPrefix . 'search_stats:today:' . $today . ':' . strtolower($engine);
            $this->redis->incr($todayKey);
            $this->redis->expire($todayKey, 86400 * 7); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ 7 –¥–Ω—ñ–≤
            
            // 3. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ —Ö–æ—Å—Ç—É
            $hostKey = $this->redisPrefix . 'search_stats:hosts:' . $host;
            $this->redis->incr($hostKey);
            $this->redis->expire($hostKey, $this->searchLogSettings['redis_stats_ttl']);
            
            // 4. –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ –º–µ—Ç–æ–¥—É –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
            $methodKey = $this->redisPrefix . 'search_stats:methods:' . strtolower($method);
            $this->redis->incr($methodKey);
            
            // 5. –î–æ–¥–∞—î–º–æ –∑–∞–ø–∏—Å –≤ –ª–æ–≥ (Redis List)
            $logEntry = array(
                'time' => date('Y-m-d H:i:s'),
                'engine' => $engine,
                'ip' => $ip,
                'method' => $method,
                'host' => $host,
                'url' => $url,
                'ua' => $ua,
            );
            
            $logKey = $this->redisPrefix . 'search_log';
            $this->redis->lpush($logKey, $logEntry);
            $this->redis->ltrim($logKey, 0, $this->searchLogSettings['redis_log_max'] - 1);
            
        } catch (Exception $e) {
            // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ Redis –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            if ($this->debugMode) {
                error_log("Search stats Redis error: " . $e->getMessage());
            }
        }
    }
    
    /**
     * –†–æ—Ç–∞—Ü—ñ—è –ª–æ–≥—É
     */
    private function rotateSearchLog() {
        $logFile = $this->searchLogSettings['file'];
        $keepBackups = $this->searchLogSettings['keep_backups'];
        
        $oldestBackup = $logFile . '.' . $keepBackups;
        if (file_exists($oldestBackup)) {
            @unlink($oldestBackup);
        }
        
        for ($i = $keepBackups - 1; $i >= 1; $i--) {
            $from = $logFile . '.' . $i;
            $to = $logFile . '.' . ($i + 1);
            if (file_exists($from)) {
                @rename($from, $to);
            }
        }
        
        if (file_exists($logFile)) {
            @rename($logFile, $logFile . '.1');
        }
    }
    
    /**
     * –£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ debug
     */
    public function setDebugMode($enabled) {
        $this->debugMode = (bool)$enabled;
    }
    
    /**
     * –û–Ω–æ–≤–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è rate limit
     */
    public function updateRateLimitSettings($settings) {
        $this->rateLimitSettings = array_merge($this->rateLimitSettings, $settings);
    }
    
    /**
     * –û–Ω–æ–≤–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è UA Rotation
     */
    public function updateUARotationSettings($settings) {
        $this->uaRotationSettings = array_merge($this->uaRotationSettings, $settings);
    }
    
    /**
     * –û–Ω–æ–≤–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è API
     */
    public function updateAPISettings($settings) {
        $this->apiSettings = array_merge($this->apiSettings, $settings);
    }
    
    /**
     * –î–æ–¥–∞—Ç–∏ –ø–æ—à—É–∫–æ–≤—É —Å–∏—Å—Ç–µ–º—É
     */
    public function addSearchEngine($name, $config) {
        $this->searchEngines[$name] = $config;
    }
    
    /**
     * –î–æ–¥–∞—Ç–∏ IP –¥—ñ–∞–ø–∞–∑–æ–Ω –¥–æ –ø–æ—à—É–∫–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏
     */
    public function addSearchEngineIP($engine, $cidr) {
        if (isset($this->searchEngines[$engine])) {
            $this->searchEngines[$engine]['ip_ranges'][] = $cidr;
        }
    }
    
    /**
     * –û—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
     */
    public function getSearchLogStats() {
        $logFile = $this->searchLogSettings['file'];
        
        $stats = array(
            'enabled' => $this->searchLogSettings['enabled'],
            'file' => $logFile,
            'exists' => file_exists($logFile),
            'size' => file_exists($logFile) ? filesize($logFile) : 0,
            'max_size' => $this->searchLogSettings['max_size'],
            'bots' => array()
        );
        
        if ($stats['exists']) {
            $content = @file($logFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
            $stats['total_lines'] = $content ? count($content) : 0;
            
            if ($content) {
                foreach ($content as $line) {
                    $parts = explode(' | ', $line);
                    if (isset($parts[1])) {
                        $bot = trim($parts[1]);
                        if (!isset($stats['bots'][$bot])) {
                            $stats['bots'][$bot] = 0;
                        }
                        $stats['bots'][$bot]++;
                    }
                }
            }
        }
        
        return $stats;
    }
}

// ============================================================================
// –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ò–ô –ó–ê–•–ò–°–¢
// ============================================================================

$protection = new SimpleBotProtection();

// ============================================================================
// –ü–†–ò–ö–õ–ê–î –î–ò–ù–ê–ú–Ü–ß–ù–û–ì–û –î–û–î–ê–í–ê–ù–ù–Ø –í–õ–ê–°–ù–ò–• USER AGENTS
// ============================================================================
// –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ UA –¥–∏–Ω–∞–º—ñ—á–Ω–æ (–ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç—É):
/*
$protection->addCustomUserAgent('MyNewBot/1.0');
$protection->addCustomUserAgent('AnotherService');

// –ê–±–æ –≤—Å—Ç–∞–Ω–æ–≤–∏ –º–∞—Å–∏–≤:
$protection->setCustomUserAgents([
    'hosttracker',
    'nexus',
    'MyApp/1.0',
    'MyBot/2.0',
]);
*/

// ============================================================================
// –Ü–ù–§–û–†–ú–ê–¶–Ü–Ø –ü–†–û –ü–û–¢–û–ß–ù–Ü –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
// ============================================================================
// –†–æ–∑–∫–æ–º–µ–Ω—Ç—É–π –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:
/*
echo "Custom User Agents: " . print_r($protection->getCustomUserAgents(), true);
*/

// –ó–∞–ø—É—Å–∫ –∑–∞—Ö–∏—Å—Ç—É
$protection->protect();
