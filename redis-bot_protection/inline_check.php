<?php
// /var/www/your-site/bot_protection/redis_inline_check.php

/**
 * ============================================================================
 * –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø - Redis Bot Protection (inline_check.php)
 * ============================================================================
 * 
 * –í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Ñ–∞–π–ª –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ô –°–ö–û–†–û–°–¢–ò!
 * 
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.10 - –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï SEO –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (2025-12-18)
 * ============================================================================
 * 
 * üéØ –û–ë–ù–û–í–õ–ï–ù–ò–ï v2.5.10 - –ü–û–õ–ù–ê–Ø SEO –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω X-Robots-Tag: noindex, nofollow –¥–ª—è –í–°–ï–• –∑–∞—â–∏—Ç–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω <meta name="robots" content="noindex, nofollow"> –≤ 429
 * ‚úì –ó–∞—â–∏—Ç–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ù–ï –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è Google/Yandex
 * ‚úì –ü–æ–∏—Å–∫–æ–≤—ã–µ –±–æ—Ç—ã –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–ª—É—á–∞—é—Ç 403/429 (IP whitelist)
 * ‚úì –ù–µ—Ç —Ä–∏—Å–∫–∞ —Å–∞–Ω–∫—Ü–∏–π –æ—Ç –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
 * 
 * –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø SEO:
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * 1. IP Whitelist –¥–ª—è –±–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –ü–ï–†–í–´–ú (—Å—Ç—Ä–æ–∫–∞ ~2192)
 *    ‚Üí Googlebot: 269 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (v2.5.8)
 *    ‚Üí Yandexbot: 28 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (v2.5.9)
 *    ‚Üí –ü—Ä–æ—Ö–æ–¥ –∑–∞ 0.05ms –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–æ–∫
 * 
 * 2. –í—Å–µ –∑–∞—â–∏—Ç–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–º–µ—é—Ç noindex:
 *    ‚Üí JS Challenge (403): X-Robots-Tag + meta noindex ‚úì
 *    ‚Üí Rate Limit (429): X-Robots-Tag + meta noindex ‚úì
 *    ‚Üí Block Response (429): X-Robots-Tag ‚úì
 * 
 * 3. –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ (protect() –º–µ—Ç–æ–¥):
 *    1) Excluded URLs ‚Üí pass
 *    2) IP Whitelist (–±–æ—Ç—ã) ‚Üí pass (0.05ms)
 *    3) rDNS Cache ‚Üí pass
 *    4) rDNS Verify ‚Üí pass (300ms fallback)
 *    5) Rate Limit ‚Üí 429 —Å noindex
 *    6) JS Challenge ‚Üí 403 —Å noindex
 *    7) Block ‚Üí 429 —Å noindex
 * 
 * –†–ï–ó–£–õ–¨–¢–ê–¢:
 * ‚úÖ –ü–æ–∏—Å–∫–æ–≤—ã–µ –±–æ—Ç—ã: –í–°–ï–ì–î–ê –ø—Ä–æ—Ö–æ–¥—è—Ç (100% –ø–æ–∫—Ä—ã—Ç–∏–µ)
 * ‚úÖ –ó–∞—â–∏—Ç–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –ù–ò–ö–û–ì–î–ê –Ω–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è
 * ‚úÖ Google Search Console: –ë–ï–ó –æ—à–∏–±–æ–∫ 403/429
 * ‚úÖ –ö—Ä–∞—É–ª–∏–Ω–≥–æ–≤—ã–π –±—é–¥–∂–µ—Ç: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô
 * ‚úÖ SEO —Å–∞–Ω–∫—Ü–∏–∏: –ù–ï–í–û–ó–ú–û–ñ–ù–´
 * 
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.9 - –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï IP RANGES –û–¢ –Ø–ù–î–ï–ö–°–ê (2025-12-18)
 * ============================================================================
 * 
 * üéØ –û–ë–ù–û–í–õ–ï–ù–ò–ï v2.5.9 - –ü–û–õ–ù–´–ô –û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –°–ü–ò–°–û–ö –Ø–ù–î–ï–ö–°–ê:
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∏–∑ SPF –∑–∞–ø–∏—Å–µ–π –Ø–Ω–¥–µ–∫—Å–∞
 * ‚úì –ò—Å—Ç–æ—á–Ω–∏–∫–∏: _spf-ipv4.yandex.ru, _spf-ipv6.yandex.ru, https://yandex.ru/ips
 * ‚úì –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: –î–µ–∫–∞–±—Ä—å 2025 (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
 * ‚úì –í—Å–µ–≥–æ 28 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (22 IPv4 + 6 IPv6)
 * ‚úì 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –Ø–Ω–¥–µ–∫—Å–∞ (–ø–æ–∏—Å–∫, –ø–æ—á—Ç–∞, –æ–±–ª–∞–∫–æ)
 * ‚úì –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —à–∏—Ä–æ–∫–∏—Ö –∏ —É–∑–∫–∏—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
 * 
 * –ë–´–õ–û (v2.5.8):
 * - 17 IPv4 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (—á–∞—Å—Ç–∏—á–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ)
 * - 2 IPv6 –¥–∏–∞–ø–∞–∑–æ–Ω–∞
 * - ~85% –ø–æ–∫—Ä—ã—Ç–∏–µ Yandex
 * 
 * –°–¢–ê–õ–û (v2.5.9):
 * - 22 IPv4 –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏–∑ SPF + –∞—Ä—Ö–∏–≤–Ω—ã–µ)
 * - 6 IPv6 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏–∑ SPF)
 * - 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ Yandex
 * - –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–µ–∫–∞–±—Ä—å 2025
 * 
 * –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:
 * ‚ö° 100% Yandexbot –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ IP whitelist
 * ‚ö° 0% –ª–æ–∂–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
 * ‚ö° 0.05ms –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤ 6000 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ rDNS)
 * ‚ö° –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (SPF + yandex.ru/ips)
 * ‚ö° –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ DNS –∑–∞–ø—Ä–æ—Å—ã
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.8 - –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï IP RANGES –û–¢ GOOGLE (2025-12-18)
 * ============================================================================
 * 
 * üéØ –û–ë–ù–û–í–õ–ï–ù–ò–ï v2.5.8 - –ü–û–õ–ù–´–ô –û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –°–ü–ò–°–û–ö GOOGLEBOT:
 * ‚úì –ó–∞–º–µ–Ω–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ IP –¥–∏–∞–ø–∞–∑–æ–Ω—ã –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –æ—Ç Google API
 * ‚úì –ò—Å—Ç–æ—á–Ω–∏–∫: https://developers.google.com/search/apis/ipranges/googlebot.json
 * ‚úì –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞: 2025-12-17T15:46:05.000000
 * ‚úì –í—Å–µ–≥–æ 269 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (127 IPv4 + 142 IPv6)
 * ‚úì 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö Googlebot IP –∞–¥—Ä–µ—Å–æ–≤
 * ‚úì –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ Google –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
 * 
 * –ë–´–õ–û (v2.5.7):
 * - ~24 —à–∏—Ä–æ–∫–∏—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (—Ä—É—á–Ω–æ–π —Å–±–æ—Ä)
 * - ~40% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö Googlebot IP
 * - –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ
 * 
 * –°–¢–ê–õ–û (v2.5.8):
 * - 269 —Ç–æ—á–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –æ—Ç Google)
 * - 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö Googlebot IP
 * - –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Google API
 * - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
 * 
 * –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:
 * ‚ö° 100% Googlebot –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ IP whitelist
 * ‚ö° 0% –ª–æ–∂–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
 * ‚ö° 0.05ms –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤ 6000 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ rDNS)
 * ‚ö° –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –æ—Ç Google
 * ‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.7 - IP WHITELIST –î–õ–Ø –ü–û–ò–°–ö–û–í–´–• –ë–û–¢–û–í –° CIDR (2025-12-09)
 * ============================================================================
 * 
 * üéØ –ù–û–í–û–ï v2.5.7 - IP WHITELIST:
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ IP-–∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –±–æ—Ç–æ–≤
 * ‚úì –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ CIDR –Ω–æ—Ç–∞—Ü–∏–∏ (IPv4 –∏ IPv6)
 * ‚úì –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ –±–µ–∑ rDNS –ø—Ä–æ–≤–µ—Ä–∫–∏ (—ç–∫–æ–Ω–æ–º–∏—è 100-500ms)
 * ‚úì –ü–æ–¥–¥–µ—Ä–∂–∫–∞ IPv4: 66.249.64.0/19, 77.88.0.0/18, etc
 * ‚úì –ü–æ–¥–¥–µ—Ä–∂–∫–∞ IPv6: 2001:4860::/32, 2a02:6b8::/32, etc
 * ‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞ –ø–æ User-Agent + IP
 * ‚úì Fallback –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö IP ranges –µ—Å–ª–∏ UA –Ω–µ —Å–æ–≤–ø–∞–ª
 * 
 * –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–ú–´–ï –ü–û–ò–°–ö–û–í–ò–ö–ò:
 * - Googlebot (60+ IPv4/IPv6 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤)
 * - Yandexbot (20+ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤)
 * - Bingbot (15+ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤)
 * - Yahoo Slurp (10+ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤)
 * - Facebook, Twitter, LinkedIn, Apple, Amazon, Baidu, –∏ –¥—Ä.
 * 
 * –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê IP WHITELIST:
 * - ‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ (–±–µ–∑ DNS –∑–∞–ø—Ä–æ—Å–æ–≤)
 * - üöÄ –≠–∫–æ–Ω–æ–º–∏—è 100-500ms –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞
 * - üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ User-Agent (IP –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è)
 * - üìä –£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ rDNS (–º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤)
 * - ‚úÖ 100% –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å (IP –∞–¥—Ä–µ—Å–∞ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–æ)
 * 
 * –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
 * 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ excluded_urls ‚úì
 * 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –≤ whitelist ‚Üê –ù–û–í–û–ï! –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å
 * 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ rDNS (–µ—Å–ª–∏ IP –Ω–µ –≤ whitelist)
 * 4. –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏...
 * 
 * –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø:
 * // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ù–∏–∫–∞–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
 * // Googlebot —Å IP 66.249.65.123 ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ ‚úì
 * // Yandexbot —Å IP 77.88.55.88 ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ ‚úì
 * 
 * –õ–û–ì–ò–†–û–í–ê–ù–ò–ï:
 * "SEARCH ENGINE IP WHITELIST: 66.249.65.123 | Engine: googlebot | 
 *  Range: 66.249.64.0/19 | Method: ip_whitelist"
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.6 - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï SEO/–ò–ù–î–ï–ö–°–ê–¶–ò–ò GOOGLE (2025-12-09)
 * ============================================================================
 * 
 * üîç –ö–†–ò–¢–ò–ß–ù–û–ï SEO –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï v2.5.6:
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω—ã meta noindex, nofollow –Ω–∞ JS Challenge —Å—Ç—Ä–∞–Ω–∏—Ü—É
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω X-Robots-Tag: noindex, nofollow HTTP header
 * ‚úì Google —Ç–µ–ø–µ—Ä—å –ù–ï –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç JS Challenge —Å—Ç—Ä–∞–Ω–∏—Ü—É
 * ‚úì –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ "–°—Ç—Ä–∞–Ω–∏—Ü–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–ø–∏–µ–π"
 * ‚úì –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–µ URL —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
 * 
 * –ß–¢–û –ò–ó–ú–ï–ù–ò–õ–û–°–¨:
 * - –î–æ–±–∞–≤–ª–µ–Ω meta robots –≤ <head> JS Challenge HTML
 * - –î–æ–±–∞–≤–ª–µ–Ω X-Robots-Tag –≤ HTTP headers
 * - Googlebot –≤–∏–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–µ—Ç–∞-—Ç–µ–≥–∏
 * - JS Challenge —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏—Å–∫–ª—é—á–µ–Ω–∞ –∏–∑ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
 * 
 * –ü–†–û–ë–õ–ï–ú–ê –î–û v2.5.6:
 * - Google –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–ª JS Challenge —Å—Ç—Ä–∞–Ω–∏—Ü—É
 * - –í—Å–µ URL –≤—ã–≥–ª—è–¥–µ–ª–∏ –∫–∞–∫ –∫–æ–ø–∏–∏ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π JS Challenge)
 * - –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–µ URL –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏
 * - Search Console –ø–æ–∫–∞–∑—ã–≤–∞–ª –æ—à–∏–±–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
 * 
 * –†–ï–®–ï–ù–ò–ï –í v2.5.6:
 * - JS Challenge –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ noindex
 * - Googlebot –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ë–ï–ó JS Challenge (rDNS verification)
 * - Google –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
 * - –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–µ URL —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
 *
 * –í–ê–ñ–ù–û: Googlebot –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç—å rDNS verification!
 * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 'trust_search_engine_ua_on_limit' => true —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.5 - –°–û–í–†–ï–ú–ï–ù–ù–´–ô –ú–ò–ù–ò–ú–ê–õ–ò–°–¢–ò–ß–ù–´–ô –î–ò–ó–ê–ô–ù (2025-12-09)
 * ============================================================================
 * 
 * üé® –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ò–ó–ê–ô–ù–ê v2.5.5:
 * ‚úì –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª—ë–Ω –¥–∏–∑–∞–π–Ω JS Challenge —Å—Ç—Ä–∞–Ω–∏—Ü—ã
 * ‚úì –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ç—ë–º–Ω—ã–π –¥–∏–∑–∞–π–Ω –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ
 * ‚úì –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã (clamp, svh/dvh)
 * ‚úì –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SVG —Å–ø–∏–Ω–Ω–µ—Ä –≤–º–µ—Å—Ç–æ —ç–º–æ–¥–∑–∏
 * ‚úì –°–µ—Ä–¥–µ—á–∫–æ (‚ù§) –≤ —Ç–µ–∫—Å—Ç–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π heartbeat
 * ‚úì –¢–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ: "–ü—Ä–æ–≤–µ—Ä—è–µ–º –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ —Å–∞–π—Ç‚Ä¶"
 * ‚úì –°–∫—Ä—ã—Ç–∞—è –ø–∞–Ω–µ–ª—å –ø—Ä–æ–≤–µ—Ä–æ–∫ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏)
 * ‚úì –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ (‚è≥ ‚Üí ‚úì)
 * ‚úì –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
 * 
 * –î–ò–ó–ê–ô–ù:
 * - –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞: –¢—ë–º–Ω—ã–π —Ñ–æ–Ω (#0d0d0d), –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç, —Ä–æ–∑–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç (#fa357a)
 * - –ê–Ω–∏–º–∞—Ü–∏–∏: –í—Ä–∞—â–µ–Ω–∏–µ —Å–ø–∏–Ω–Ω–µ—Ä–∞, heartbeat –¥–ª—è —Å–µ—Ä–¥–µ—á–∫–∞
 * - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: –û—Ç 320px –¥–æ 4K –¥–∏—Å–ø–ª–µ–µ–≤
 * - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ noscript, –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
 * 
 * –í–°–Ø –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨ –°–û–•–†–ê–ù–ï–ù–ê:
 * - JS Challenge —Å Proof-of-Work
 * - Canvas fingerprinting
 * - WebGL detection
 * - Timing validation
 * - Behavior analysis
 * - –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.4 - –ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï EXCLUDED_URLS (2025-12-07)
 * ============================================================================
 * 
 * üö® –ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï v2.5.4:
 * ‚úì –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: excluded_urls —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –î–û –≤—Å–µ—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
 * ‚úì –†–∞–Ω—å—à–µ: excluded_urls –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å –º–µ—Ç–æ–¥–∞–º–∏ isCookieBlocked(), isUserHashBlocked()
 * ‚úì –¢–µ–ø–µ—Ä—å: excluded_urls –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –ü–û–õ–ù–û–°–¢–¨–Æ (–∫—Ä–æ–º–µ Global Rate Limit)
 * ‚úì –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-—Å–µ—Ä–≤–∏—Å–æ–≤ (UptimeRobot, Pingdom –∏ –¥—Ä.)
 * ‚úì –¢–µ–ø–µ—Ä—å excluded_urls —Ä–∞–±–æ—Ç–∞—é—Ç –ü–†–ê–í–ò–õ–¨–ù–û –∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç –í–°–Å!
 * 
 * –ß–¢–û –ò–ó–ú–ï–ù–ò–õ–û–°–¨:
 * - –ü—Ä–æ–≤–µ—Ä–∫–∞ isExcludedFromJSChallenge() –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ –ù–ê–ß–ê–õ–û –º–µ—Ç–æ–¥–∞ protect()
 * - –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –î–û: isCookieBlocked, isUserHashBlocked, isBlocked
 * - –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ URL –ª–æ–≥–∏—Ä—É—é—Ç—Å—è: "URL EXCLUDED FROM ALL CHECKS"
 * - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-—Å–µ—Ä–≤–∏—Å—ã –ë–ï–ó cookies —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
 *
 * –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø:
 * $protection->addExcludedUrl('/health');        // –î–ª—è UptimeRobot
 * $protection->addExcludedUrl('/api/*');         // –î–ª—è API endpoints
 * $protection->setExcludedUrls(['/webhook/*', '/ping']);
 * 
 * ‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ URL –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞—â–∏—â–µ–Ω—ã! 
 * –ü—Ä–æ–ø—É—Å–∫–∞—é—Ç –í–°–ï –ø—Ä–æ–≤–µ—Ä–∫–∏:
 * - isCookieBlocked (–ù–û–í–û–ï –≤ v2.5.4!)
 * - isUserHashBlocked (–ù–û–í–û–ï –≤ v2.5.4!)
 * - isBlocked + isSuspiciousUserAgent (–ù–û–í–û–ï –≤ v2.5.4!)
 * - JS Challenge
 * - Rate Limit –ø—Ä–æ–≤–µ—Ä–∫–∏
 * - Burst Detection
 * 
 * –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –∑–∞—â–∏—Ç—É (—Ç–æ–∫–µ–Ω—ã, IP whitelist, –ø–æ–¥–ø–∏—Å–∏)!
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.3 - –†–ê–°–®–ò–†–ï–ù–ù–´–ï URL EXCLUSIONS (2025-12-06)
 * ============================================================================
 * 
 * –ù–û–í–û–ï v2.5.3:
 * ‚úì –†–∞—Å—à–∏—Ä–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ excluded_urls: —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç Rate Limit –∏ Burst Detection
 * ‚úì –ü–æ–¥–¥–µ—Ä–∂–∫–∞ wildcard –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: /api/*, /TEMP/* /file.php?*)
 * ‚úì –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏:
 *   - addExcludedUrl($pattern) - –¥–æ–±–∞–≤–∏—Ç—å URL –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
 *   - removeExcludedUrl($pattern) - —É–¥–∞–ª–∏—Ç—å URL –∏–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
 *   - getExcludedUrls() - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö URL
 *   - setExcludedUrls($patterns) - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
 *   - clearExcludedUrls() - –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
 *   - isUrlExcluded($url) - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω –ª–∏ URL
 * ‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 'excluded_urls' –≤ jsChallengeSettings
 * ‚úì –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (<0.1ms –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.1 - –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ê–ü–†–û–°–û–í –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò (2025-12-02)
 * ============================================================================
 * 
 * –ù–û–í–û–ï v2.5.1:
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω —Å—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ RPM (requests per minute)
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω —Å—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ RPS (requests per second)
 * ‚úì –ù–æ–≤—ã–π –º–µ—Ç–æ–¥: incrementRequestCounter() - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ protect()
 * ‚úì –ù–æ–≤—ã–π –º–µ—Ç–æ–¥: getRequestsPerMinute() - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç RPM/RPS —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
 * ‚úì –ù–æ–≤—ã–π –º–µ—Ç–æ–¥: getRPMHistory() - –∏—Å—Ç–æ—Ä–∏—è RPM –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–∏–Ω—É—Ç
 * ‚úì –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (2 –æ–ø–µ—Ä–∞—Ü–∏–∏ INCR ~0.2ms)
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.5.0 - –ó–ê–©–ò–¢–ê –û–¢ –†–ê–°–ü–†–ï–î–ï–õ–Å–ù–ù–û–ì–û –ü–ê–†–°–ò–ù–ì–ê (2025-12-01)
 * ============================================================================
 * 
 * –ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø v2.5:
 * ‚úì Slow bot —Ç–µ–ø–µ—Ä—å –ë–õ–û–ö–ò–†–£–ï–¢–°–Ø —Å—Ä–∞–∑—É (—Ä–∞–Ω—å—à–µ —Ç–æ–ª—å–∫–æ extended tracking)
 * ‚úì –ù–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –±–æ—Ç–Ω–µ—Ç–æ–≤: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç cookie –ø–æ—Å–ª–µ N –∑–∞–ø—Ä–æ—Å–æ–≤
 * ‚úì –£–∂–µ—Å—Ç–æ—á–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
 * ‚úì –°–Ω–∏–∂–µ–Ω –ø–æ—Ä–æ–≥ –¥–ª—è isPotentialSlowBot (3 –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ 5)
 * ‚úì –ù–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞: no_cookie_block_threshold (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.4.0 - RATE LIMIT + BURST –†–ê–ë–û–¢–ê–Æ–¢ –ü–†–ò 429 (2025-11-30)
 * ============================================================================
 * 
 * –ò–ó–ú–ï–ù–ï–ù–ò–Ø v2.4:
 * ‚úì Rate Limit –∏ Burst Detection —Ä–∞–±–æ—Ç–∞—é—Ç –í–°–ï–ì–î–ê (–¥–∞–∂–µ –ø—Ä–∏ 429)
 * ‚úì –°—á–µ—Ç—á–∏–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 429 –æ—à–∏–±–∫–∞
 * ‚úì –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ violations —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π —á–µ—Ä–µ–∑ API
 * ‚úì –ö—Ä–∞—Å–∏–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 429 —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
 * ‚úì –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: rate_limit_api_block_threshold, burst_api_block_threshold
 * ‚úì –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã: getTotalViolations(), incrementViolations(), getViolationsStatus()
 * 
 * –ù–ê–°–¢–†–û–ô–ö–ò –ë–õ–û–ö–ò–†–û–í–ö–ò –ß–ï–†–ï–ó API:
 * - rate_limit_api_block_threshold: 3 (–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API –ø–æ—Å–ª–µ 3 –Ω–∞—Ä—É—à–µ–Ω–∏–π)
 * - burst_api_block_threshold: 2 (–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API –ø–æ—Å–ª–µ 2 burst)
 * - combined_api_block_threshold: 4 (–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ —Å—É–º–º–∞ violations >= 4)
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.3.1 - –†–ê–ë–û–ß–ò–ô RATE LIMIT + BURST (2025-11-28)
 * ============================================================================
 * 
 * –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –î–û–ë–ê–í–õ–ï–ù–û:
 * ‚úì Rate Limit - –†–ê–ë–û–¢–ê–ï–¢! –í–∞—Ä–∏–∞–Ω—Ç B: cookie –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç √ó2 –ª–∏–º–∏—Ç—ã
 * ‚úì Burst Detection - –†–ê–ë–û–¢–ê–ï–¢! –í–∞—Ä–∏–∞–Ω—Ç B: cookie –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç √ó2 –ø–æ—Ä–æ–≥
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã: testRateLimit(), testBurst()
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç—É—Å–∞: getRateLimitStatus(), getBurstStatus()
 * 
 * –ù–ê–°–¢–†–û–ô–ö–ò –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ:
 * - Rate Limit: 60/–º–∏–Ω, 200/5–º–∏–Ω, 800/—á–∞—Å (√ó2 –¥–ª—è cookie)
 * - Burst: 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 10 —Å–µ–∫ (√ó2 –¥–ª—è cookie = 10 –∑–∞–ø—Ä–æ—Å–æ–≤)
 * - cookie_multiplier: 2.0
 *
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.3 - –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–ê–ú–Ø–¢–ò REDIS (2025-11-28)
 * ============================================================================
 * 
 * –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û:
 * ‚úì Rate Limit –æ–±—ä–µ–¥–∏–Ω—ë–Ω –≤ –æ–¥–∏–Ω –∫–ª—é—á –Ω–∞ IP (–±—ã–ª–æ 4-5 –∫–ª—é—á–µ–π, —Å—Ç–∞–ª–æ 1)
 * ‚úì Global Rate Limit –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ (–±—ã–ª–æ 1 –∫–ª—é—á/—Å–µ–∫, —Å—Ç–∞–ª–æ 1 –∫–ª—é—á/IP)
 * ‚úì –£–º–µ–Ω—å—à–µ–Ω—ã TTL –¥–ª—è tracking –¥–∞–Ω–Ω—ã—Ö (3 —á–∞—Å–∞ ‚Üí 1.5 —á–∞—Å–∞)
 * ‚úì –£–º–µ–Ω—å—à–µ–Ω—ã TTL –¥–ª—è extended tracking (24 —á–∞—Å–∞ ‚Üí 6 —á–∞—Å–æ–≤)
 * ‚úì –û–∂–∏–¥–∞–µ–º–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–ª—é—á–µ–π: –≤ 3-4 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ!
 * 
 * –ë–´–õ–û: ~5-7 –∫–ª—é—á–µ–π –Ω–∞ IP (12,000+ –∫–ª—é—á–µ–π –Ω–∞ 2,000 IP)
 * –°–¢–ê–õ–û: ~2-3 –∫–ª—é—á–∞ –Ω–∞ IP (4,000-6,000 –∫–ª—é—á–µ–π –Ω–∞ 2,000 IP)
 * 
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.2 - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –õ–û–ñ–ù–´–• –ë–õ–û–ö–ò–†–û–í–û–ö AJAX (2025-11-27)
 * ============================================================================
 * 
 * –ò–°–ü–†–ê–í–õ–ï–ù–û:
 * ‚úì checkSuspiciousHeaders() —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç AJAX/Fetch –∑–∞–ø—Ä–æ—Å—ã
 * ‚úì –ü–æ–∏—Å–∫ DLE –∏ –¥—Ä—É–≥–∏–µ AJAX-—Ñ—É–Ω–∫—Ü–∏–∏ –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç –ª–æ–∂–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
 * ‚úì –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏—è AJAX —á–µ—Ä–µ–∑ X-Requested-With, Sec-Fetch-Mode, Sec-Fetch-Dest
 * ‚úì –î–ª—è AJAX –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º—è–≥–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
 * 
 * ============================================================================
 * –í–ï–†–°–ò–Ø 2.1 - –£–°–ò–õ–ï–ù–ù–ê–Ø –î–ï–¢–ï–ö–¶–ò–Ø "–£–ú–ù–´–•" –ë–û–¢–û–í (2025-11-26)
 * ============================================================================
 * 
 * –§–£–ù–ö–¶–ò–ò v2.1:
 * ‚úì checkSuspiciousHeaders() - –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (Accept-Language –∏ —Ç.–¥.)
 * ‚úì analyzeRequestTypes() - –∞–Ω–∞–ª–∏–∑ —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ (—Ç–æ–ª—å–∫–æ HTML = –±–æ—Ç)
 * 
 * –£–ñ–ï–°–¢–û–ß–ï–ù–ù–´–ï –õ–ò–ú–ò–¢–´:
 * ‚úì max_requests_per_minute: 60 ‚Üí 40
 * ‚úì max_requests_per_5min: 200 ‚Üí 120
 * ‚úì max_requests_per_hour: 1000 ‚Üí 600
 * ‚úì burst_threshold: 20 ‚Üí 15
 * ‚úì slow_bot_threshold_hours: 4 ‚Üí 2
 * ‚úì blockThreshold: 10/12 ‚Üí 7/8
 * 
 * –ù–û–í–´–ï –ü–†–û–í–ï–†–ö–ò –í analyzeSlowBotBehavior():
 * ‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–±–æ—Ç—ã –Ω–µ —à–ª—é—Ç Accept-Language)
 * ‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ (–±–æ—Ç—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ HTML)
 * ‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è cookies –ø–æ—Å–ª–µ 12+ –∑–∞–ø—Ä–æ—Å–æ–≤
 * ‚úì –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (30-900 —Å–µ–∫)
 * 
 * ============================================================================
 * 
 * –ß–¢–û –ë–´–õ–û –£–î–ê–õ–ï–ù–û (—Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ cleanup.php):
 * ‚úó cleanup() - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª keys() –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π
 * ‚úó cleanupUserHashData() - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª keys() –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑
 * ‚úó deepCleanup() - –≤—ã–∑—ã–≤–∞–ª cleanup() –∏ cleanupUserHashData()
 * ‚úó forceCleanup() - –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º SCAN
 * 
 * –ß–¢–û –ë–´–õ–û –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û:
 * ‚úì getRedisMemoryInfo() - —Ç–µ–ø–µ—Ä—å —á–∏—Ç–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–º–µ—Å—Ç–æ SCAN
 * ‚úì cleanup_probability = 999999 (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞)
 * 
 * –ß–¢–û –î–û–ë–ê–í–õ–ï–ù–û:
 * ‚úì getCleanupStatus() - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã cleanup.php
 * 
 * ============================================================================
 * –£–õ–£–ß–®–ï–ù–ò–Ø –î–õ–Ø –í–´–°–û–ö–ò–• –ù–ê–ì–†–£–ó–û–ö (v2.0)
 * ============================================================================
 * 
 * 1. –ê–¢–û–ú–ê–†–ù–´–ô Rate Limit (–±–µ–∑ race condition):
 *    - checkRateLimit() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Redis INCR –≤–º–µ—Å—Ç–æ GET-SET
 *    - –ù–∞–¥—ë–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ >1000 req/sec
 *    - –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞
 * 
 * 2. –ì–õ–û–ë–ê–õ–¨–ù–´–ô Rate Limit (–∑–∞—â–∏—Ç–∞ –æ—Ç DDoS):
 *    - checkGlobalRateLimit() —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ >100 req/sec —Å –æ–¥–Ω–æ–≥–æ IP
 *    - –†–∞–±–æ—Ç–∞–µ—Ç –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–æ—Ç–æ–≤ - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö User-Agent
 * 
 * 3. WHITELIST –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤:
 *    - isWhitelistedSearchEngine() - –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
 *    - addToSearchEngineWhitelist() - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ rDNS
 *    - –ü–æ–∏—Å–∫–æ–≤–∏–∫–∏ –ù–ï –ë–õ–û–ö–ò–†–£–Æ–¢–°–Ø –¥–∞–∂–µ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
 * 
 * 4. SCAN –≤–º–µ—Å—Ç–æ KEYS:
 *    - getRDNSRateLimitStats() - –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
 *    - clearRDNSCache() - –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—á–∏—Å—Ç–∫–∞
 *    - clearSearchEngineWhitelist() - –æ—á–∏—Å—Ç–∫–∞ whitelist
 * 
 * ============================================================================
 * –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï:
 * cleanup.php –î–û–õ–ñ–ï–ù –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–æ cron –∫–∞–∂–¥—ã–µ 5-10 –º–∏–Ω—É—Ç!
 * –ë–µ–∑ cleanup.php Redis –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—Å—è –∏ –∑–∞—â–∏—Ç–∞ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!
 * 
 * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron:
 * –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç: php /var/www/your-site/cleanup.php >> /var/log/cleanup.log 2>&1
 * 
 * –û–ñ–ò–î–ê–ï–ú–ê–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨:
 * - –û–±—ã—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: 2-5ms (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: 5-10ms)
 * - –ó–∞–ø—Ä–æ—Å—ã —Å –æ—á–∏—Å—Ç–∫–æ–π: 2-5ms (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: 100-500ms)
 * - getRedisMemoryInfo(): <1ms (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: 100-200ms)
 * - checkRateLimit(): <1ms (–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)
 * - –û–±—â–∏–π –ø—Ä–∏—Ä–æ—Å—Ç: –≤ 5-50 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!
 * 
 * ============================================================================
 */

class RedisBotProtectionNoSessions {
    private $redis;
    private $cookieName = 'visitor_verified';
    private $secretKey = 'your_secret_key_here_change_this12345!@#$';
    private $cookieLifetime = 86400 * 30; // 30 –¥–Ω–µ–π
    
    // –ü—Ä–µ—Ñ–∏–∫—Å—ã –¥–ª—è Redis –∫–ª—é—á–µ–π
    private $redisPrefix = 'bot_protection:';
    private $trackingPrefix = 'tracking:';
    private $blockPrefix = 'blocked:';
    private $cookiePrefix = 'cookie:';
    private $rdnsPrefix = 'rdns:';
    private $userHashPrefix = 'user_hash:';
    
    // TTL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏ v2.3)
    private $ttlSettings = [
        'tracking_ip' => 5400,          // 1.5 —á–∞—Å–∞ (–±—ã–ª–æ 3 —á–∞—Å–∞) - –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–∫–∏–Ω–≥
        'cookie_blocked' => 7200,       // 2 —á–∞—Å–∞ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ cookie
        'ip_blocked' => 86400,          // 24 —á–∞—Å–∞ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ IP
        'ip_blocked_repeat' => 259200,  // 3 –¥–Ω—è - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
        'rdns_cache' => 1800,           // 30 –º–∏–Ω - –∫–µ—à rDNS
        'logs' => 86400,                // 1 –¥–µ–Ω—å (–±—ã–ª–æ 2 –¥–Ω—è) - –ª–æ–≥–∏
        'cleanup_interval' => 1800,     // 30 –º–∏–Ω
        'user_hash_blocked' => 86400,   // 1 –¥–µ–Ω—å (–±—ã–ª–æ 2 –¥–Ω—è) - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ user hash
        'user_hash_tracking' => 10800,  // 3 —á–∞—Å–∞ (–±—ã–ª–æ 6 —á–∞—Å–æ–≤) - —Ç—Ä–µ–∫–∏–Ω–≥ user hash
        'user_hash_stats' => 259200,    // 3 –¥–Ω—è (–±—ã–ª–æ 7 –¥–Ω–µ–π) - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        'extended_tracking' => 21600,   // 6 —á–∞—Å–æ–≤ (–±—ã–ª–æ 24 —á–∞—Å–∞) - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥
        'rate_limit' => 3600,           // –ù–û–í–û–ï: 1 —á–∞—Å –¥–ª—è rate limit hash
    ];
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤ (–£–ñ–ï–°–¢–û–ß–ï–ù–û –¥–ª—è –±–æ—Ä—å–±—ã —Å —É–º–Ω—ã–º–∏ –±–æ—Ç–∞–º–∏)
    private $slowBotSettings = [
        'min_requests_for_analysis' => 3,
        'slow_bot_threshold_hours' => 2,         // –°–Ω–∏–∂–µ–Ω–æ —Å 4 - –±—ã—Å—Ç—Ä–µ–µ –¥–µ—Ç–µ–∫—Ç–∏–º
        'slow_bot_min_requests' => 10,           // –°–Ω–∏–∂–µ–Ω–æ —Å 15
        'long_session_hours' => 1,               // –°–Ω–∏–∂–µ–Ω–æ —Å 2
        'suspicious_regularity_variance' => 300, // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 100 - —à–∏—Ä–µ –¥–µ—Ç–µ–∫—Ü–∏—è
    ];
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –ù–ê–°–¢–†–û–ô–ö–ò –î–ï–¢–ï–ö–¶–ò–ò –ë–û–¢–û–í –ü–û HTTP –ó–ê–ì–û–õ–û–í–ö–ê–ú
    // –û–ë–ù–û–í–õ–ï–ù–û v2.5: –£–∂–µ—Å—Ç–æ—á–µ–Ω—ã –ø–æ—Ä–æ–≥–∏
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    private $headerDetectionSettings = [
        'block_score_threshold' => 5,    // v2.5: –°–Ω–∏–∂–µ–Ω–æ —Å 4 –¥–æ 3 - –±–ª–æ–∫–∏—Ä—É–µ–º —Ä–∞–Ω—å—à–µ
        'tracking_score_threshold' => 2, // v2.5: –°–Ω–∏–∂–µ–Ω–æ —Å 3 –¥–æ 2
        'enabled' => true,               // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
    ];
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ rate limiting –∏ –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏
    private $rateLimitSettings = [
        'max_requests_per_minute' => 30,         // –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É (–±–µ–∑ cookie)
        'max_requests_per_5min' => 100,          // –õ–∏–º–∏—Ç –∑–∞ 5 –º–∏–Ω—É—Ç (–±–µ–∑ cookie)
        'max_requests_per_hour' => 400,          // –õ–∏–º–∏—Ç –≤ —á–∞—Å (–±–µ–∑ cookie)
        'cookie_multiplier' => 2.0,              // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å cookie (√ó2)
        'burst_threshold' => 10,                 // –ü–æ—Ä–æ–≥ –≤—Å–ø–ª–µ—Å–∫–∞
        'burst_window' => 10,                    // –û–∫–Ω–æ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –≤—Å–ø–ª–µ—Å–∫–∞ (—Å–µ–∫—É–Ω–¥—ã)
        'ua_change_threshold' => 10,             // –ú–∞–∫—Å. —Å–º–µ–Ω UA –∑–∞ —Å–µ—Å—Å–∏—é
        'ua_change_time_window' => 300,          // –û–∫–Ω–æ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Å–º–µ–Ω—ã UA (5 –º–∏–Ω)
        'progressive_block_duration' => 1800,    // –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (30 –º–∏–Ω)
        'aggressive_block_duration' => 7200,     // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (2 —á–∞—Å–∞)
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ù–û–í–û–ï v2.4: –ü–æ—Ä–æ–≥–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ API
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        'rate_limit_api_block_threshold' => 3,   // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API –ø–æ—Å–ª–µ N –Ω–∞—Ä—É—à–µ–Ω–∏–π rate limit
        'burst_api_block_threshold' => 2,        // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API –ø–æ—Å–ª–µ N burst'–æ–≤
        'combined_api_block_threshold' => 4,     // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ —Å—É–º–º–∞ –≤—Å–µ—Ö violations >= N
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ù–û–í–û–ï v2.5: –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–±–æ—Ç–Ω–µ—Ç—ã)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        'no_cookie_block_threshold' => 3,        // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç cookie –ø–æ—Å–ª–µ N –∑–∞–ø—Ä–æ—Å–æ–≤
        'slow_bot_instant_block' => true,        // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å slow bot —Å—Ä–∞–∑—É (true) –∏–ª–∏ —Ç–æ–ª—å–∫–æ tracking (false)
    ];
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è Redis
    private $globalProtectionSettings = [
        'cleanup_threshold' => 5000,             // –ù–∞—á–∞—Ç—å –æ—á–∏—Å—Ç–∫—É –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏
        'cleanup_batch_size' => 100,             // –£–¥–∞–ª—è—Ç—å –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑
        'cleanup_probability' => 999999,  // –û–¢–ö–õ–Æ–ß–ï–ù–û - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cleanup.php             // –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–π N-–π –∑–∞–ø—Ä–æ—Å (1 –∏–∑ 50 = 2%)
        'max_cleanup_time_ms' => 50,            // –ú–∞–∫—Å–∏–º—É–º 50ms –Ω–∞ –æ—á–∏—Å—Ç–∫—É
    ];
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ rate limiting –¥–ª—è rDNS –ø—Ä–æ–≤–µ—Ä–æ–∫
    private $rdnsLimitSettings = [
        'max_rdns_per_minute' => 60,            // –ú–∞–∫—Å–∏–º—É–º rDNS –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –º–∏–Ω—É—Ç—É
        'rdns_cache_ttl' => 1800,               // –ö–µ—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ 30 –º–∏–Ω—É—Ç
        'rdns_negative_cache_ttl' => 300,       // –ö–µ—à –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ 5 –º–∏–Ω—É—Ç
        'rdns_on_limit_action' => 'skip',       // 'skip' –∏–ª–∏ 'block' –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
        'trust_search_engine_ua_on_limit' => true, // –ù–û–í–û–ï: –î–æ–≤–µ—Ä—è—Ç—å UA –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
    ];
    
    private $globalPrefix = 'global:';
	
	// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ iptables
    private $apiSettings = [
        'enabled' => true,                                              // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å API –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        'url' => 'https://mysite.com/redis-bot_protection/API/iptables.php',           // URL –≤–∞—à–µ–≥–æ API
        'api_key' => '12345',                          // API –∫–ª—é—á (–∏–∑ settings.php)
        'timeout' => 5,                                                 // –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (—Å–µ–∫—É–Ω–¥—ã)
        'block_on_redis' => true,                                       // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤ Redis (–ª–æ–∫–∞–ª—å–Ω–æ)
        'block_on_api' => true,                                         // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API (iptables)
        'auto_unblock' => true,                                         // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ TTL
        'retry_on_failure' => 2,                                        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ API
        'log_api_errors' => true,                                       // –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ API
        'user_agent' => 'uptimerobot',            // User-Agent –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
        'verify_ssl' => true,                                           // –ü—Ä–æ–≤–µ—Ä—è—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
    ];
    
    // –°–ø–∏—Å–æ–∫ –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤ —Å —Ç–æ—á–Ω—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
    private $allowedSearchEngines = [
        'googlebot' => [
            'user_agent_patterns' => [
                'googlebot', 'google', 'googleother',
                'googlebot-image', 'googlebot-news', 'googlebot-video'
            ],
            'rdns_patterns' => ['.googlebot.com', '.google.com'],
            'ip_ranges' => [
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // –û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –°–ü–ò–°–û–ö IP –û–¢ GOOGLE (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-12-18)
                // –ò—Å—Ç–æ—á–Ω–∏–∫: https://developers.google.com/search/apis/ipranges/googlebot.json
                // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞: 2025-12-17T15:46:05.000000
                // –í—Å–µ–≥–æ: 269 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (127 IPv4 + 142 IPv6)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                
                // IPv4 RANGES (127 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤) - –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –û–¢ GOOGLE
                '66.249.64.0/27', '66.249.64.32/27', '66.249.64.64/27', '66.249.64.96/27',
                '66.249.64.128/27', '66.249.64.160/27', '66.249.64.192/27', '66.249.64.224/27',
                '66.249.65.0/27', '66.249.65.32/27', '66.249.65.64/27', '66.249.65.96/27',
                '66.249.65.128/27', '66.249.65.160/27', '66.249.65.192/27', '66.249.65.224/27',
                '66.249.66.0/27', '66.249.66.32/27', '66.249.66.64/27', '66.249.66.96/27',
                '66.249.66.128/27', '66.249.66.160/27', '66.249.66.192/27', '66.249.66.224/27',
                '66.249.67.0/27', '66.249.67.32/27', '66.249.67.64/27',
                '66.249.68.0/27', '66.249.68.32/27', '66.249.68.64/27', '66.249.68.96/27',
                '66.249.68.128/27', '66.249.68.160/27', '66.249.68.192/27',
                '66.249.69.0/27', '66.249.69.32/27', '66.249.69.64/27', '66.249.69.96/27',
                '66.249.69.128/27', '66.249.69.160/27', '66.249.69.192/27', '66.249.69.224/27',
                '66.249.70.0/27', '66.249.70.32/27', '66.249.70.64/27', '66.249.70.96/27',
                '66.249.70.128/27', '66.249.70.160/27', '66.249.70.192/27', '66.249.70.224/27',
                '66.249.71.0/27', '66.249.71.32/27', '66.249.71.64/27', '66.249.71.96/27',
                '66.249.71.128/27', '66.249.71.160/27', '66.249.71.192/27', '66.249.71.224/27',
                '66.249.72.0/27', '66.249.72.32/27', '66.249.72.64/27', '66.249.72.128/27',
                '66.249.72.160/27', '66.249.72.192/27', '66.249.72.224/27',
                '66.249.73.0/27', '66.249.73.32/27', '66.249.73.64/27', '66.249.73.96/27',
                '66.249.73.128/27', '66.249.73.160/27', '66.249.73.192/27', '66.249.73.224/27',
                '66.249.74.0/27', '66.249.74.32/27', '66.249.74.64/27', '66.249.74.96/27',
                '66.249.74.128/27', '66.249.74.160/27', '66.249.74.192/27', '66.249.74.224/27',
                '66.249.75.0/27', '66.249.75.32/27', '66.249.75.64/27', '66.249.75.96/27',
                '66.249.75.128/27', '66.249.75.160/27', '66.249.75.192/27', '66.249.75.224/27',
                '66.249.76.0/27', '66.249.76.32/27', '66.249.76.64/27', '66.249.76.96/27',
                '66.249.76.128/27', '66.249.76.160/27', '66.249.76.192/27', '66.249.76.224/27',
                '66.249.77.0/27', '66.249.77.32/27', '66.249.77.64/27', '66.249.77.96/27',
                '66.249.77.128/27', '66.249.77.160/27', '66.249.77.192/27', '66.249.77.224/27',
                '66.249.78.0/27', '66.249.78.32/27', '66.249.78.64/27', '66.249.78.96/27',
                '66.249.78.128/27', '66.249.78.160/27',
                '66.249.79.0/27', '66.249.79.32/27', '66.249.79.64/27', '66.249.79.128/27',
                '66.249.79.160/27', '66.249.79.192/27', '66.249.79.224/27',
                '192.178.4.0/27', '192.178.4.32/27', '192.178.4.64/27', '192.178.4.96/27',
                '192.178.4.128/27', '192.178.4.160/27', '192.178.4.192/27',
                '192.178.5.0/27',
                '192.178.6.0/27', '192.178.6.32/27', '192.178.6.64/27', '192.178.6.96/27',
                '192.178.6.128/27', '192.178.6.160/27', '192.178.6.192/27', '192.178.6.224/27',
                '192.178.7.0/27', '192.178.7.32/27', '192.178.7.64/27', '192.178.7.96/27',
                '192.178.7.128/27', '192.178.7.160/27', '192.178.7.192/27', '192.178.7.224/27',
                '34.22.85.0/27',
                '34.64.82.64/28', '34.65.242.112/28', '34.80.50.80/28', '34.88.194.0/28',
                '34.89.10.80/28', '34.89.198.80/28', '34.96.162.48/28',
                '34.100.182.96/28', '34.101.50.144/28', '34.118.66.0/28', '34.118.254.0/28',
                '34.126.178.96/28', '34.146.150.144/28', '34.147.110.144/28',
                '34.151.74.144/28', '34.152.50.64/28', '34.154.114.144/28', '34.155.98.32/28',
                '34.165.18.176/28', '34.175.160.64/28', '34.176.130.16/28', '35.247.243.240/28',
                
                // IPv6 RANGES (142 –¥–∏–∞–ø–∞–∑–æ–Ω–∞) - –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –û–¢ GOOGLE
                '2001:4860:4801:2::/64', '2001:4860:4801:c::/64', '2001:4860:4801:f::/64',
                '2001:4860:4801:10::/64', '2001:4860:4801:12::/64', '2001:4860:4801:13::/64',
                '2001:4860:4801:14::/64', '2001:4860:4801:15::/64', '2001:4860:4801:16::/64',
                '2001:4860:4801:17::/64', '2001:4860:4801:18::/64', '2001:4860:4801:19::/64',
                '2001:4860:4801:1a::/64', '2001:4860:4801:1b::/64', '2001:4860:4801:1c::/64',
                '2001:4860:4801:1d::/64', '2001:4860:4801:1e::/64', '2001:4860:4801:1f::/64',
                '2001:4860:4801:20::/64', '2001:4860:4801:21::/64', '2001:4860:4801:22::/64',
                '2001:4860:4801:23::/64', '2001:4860:4801:24::/64', '2001:4860:4801:25::/64',
                '2001:4860:4801:26::/64', '2001:4860:4801:27::/64', '2001:4860:4801:28::/64',
                '2001:4860:4801:29::/64', '2001:4860:4801:2a::/64', '2001:4860:4801:2b::/64',
                '2001:4860:4801:2c::/64', '2001:4860:4801:2d::/64', '2001:4860:4801:2e::/64',
                '2001:4860:4801:2f::/64', '2001:4860:4801:30::/64', '2001:4860:4801:31::/64',
                '2001:4860:4801:32::/64', '2001:4860:4801:33::/64', '2001:4860:4801:34::/64',
                '2001:4860:4801:35::/64', '2001:4860:4801:36::/64', '2001:4860:4801:37::/64',
                '2001:4860:4801:38::/64', '2001:4860:4801:39::/64', '2001:4860:4801:3a::/64',
                '2001:4860:4801:3b::/64', '2001:4860:4801:3c::/64', '2001:4860:4801:3d::/64',
                '2001:4860:4801:3e::/64', '2001:4860:4801:3f::/64', '2001:4860:4801:40::/64',
                '2001:4860:4801:41::/64', '2001:4860:4801:42::/64', '2001:4860:4801:44::/64',
                '2001:4860:4801:45::/64', '2001:4860:4801:46::/64', '2001:4860:4801:47::/64',
                '2001:4860:4801:48::/64', '2001:4860:4801:49::/64', '2001:4860:4801:4a::/64',
                '2001:4860:4801:4b::/64', '2001:4860:4801:4c::/64', '2001:4860:4801:4d::/64',
                '2001:4860:4801:4e::/64', '2001:4860:4801:50::/64', '2001:4860:4801:51::/64',
                '2001:4860:4801:52::/64', '2001:4860:4801:53::/64', '2001:4860:4801:54::/64',
                '2001:4860:4801:55::/64', '2001:4860:4801:56::/64', '2001:4860:4801:57::/64',
                '2001:4860:4801:58::/64', '2001:4860:4801:59::/64', '2001:4860:4801:60::/64',
                '2001:4860:4801:61::/64', '2001:4860:4801:62::/64', '2001:4860:4801:63::/64',
                '2001:4860:4801:64::/64', '2001:4860:4801:65::/64', '2001:4860:4801:66::/64',
                '2001:4860:4801:67::/64', '2001:4860:4801:68::/64', '2001:4860:4801:69::/64',
                '2001:4860:4801:6a::/64', '2001:4860:4801:6b::/64', '2001:4860:4801:6c::/64',
                '2001:4860:4801:6d::/64', '2001:4860:4801:6e::/64', '2001:4860:4801:6f::/64',
                '2001:4860:4801:70::/64', '2001:4860:4801:71::/64', '2001:4860:4801:72::/64',
                '2001:4860:4801:73::/64', '2001:4860:4801:74::/64', '2001:4860:4801:75::/64',
                '2001:4860:4801:76::/64', '2001:4860:4801:77::/64', '2001:4860:4801:78::/64',
                '2001:4860:4801:79::/64', '2001:4860:4801:7a::/64', '2001:4860:4801:7b::/64',
                '2001:4860:4801:7c::/64', '2001:4860:4801:7d::/64', '2001:4860:4801:80::/64',
                '2001:4860:4801:81::/64', '2001:4860:4801:82::/64', '2001:4860:4801:83::/64',
                '2001:4860:4801:84::/64', '2001:4860:4801:85::/64', '2001:4860:4801:86::/64',
                '2001:4860:4801:87::/64', '2001:4860:4801:88::/64', '2001:4860:4801:90::/64',
                '2001:4860:4801:91::/64', '2001:4860:4801:92::/64', '2001:4860:4801:93::/64',
                '2001:4860:4801:94::/64', '2001:4860:4801:95::/64', '2001:4860:4801:96::/64',
                '2001:4860:4801:97::/64', '2001:4860:4801:a0::/64', '2001:4860:4801:a1::/64',
                '2001:4860:4801:a2::/64', '2001:4860:4801:a3::/64', '2001:4860:4801:a4::/64',
                '2001:4860:4801:a5::/64', '2001:4860:4801:a6::/64', '2001:4860:4801:a7::/64',
                '2001:4860:4801:a8::/64', '2001:4860:4801:a9::/64', '2001:4860:4801:aa::/64',
                '2001:4860:4801:ab::/64', '2001:4860:4801:ac::/64', '2001:4860:4801:ad::/64',
                '2001:4860:4801:ae::/64', '2001:4860:4801:b0::/64', '2001:4860:4801:b1::/64',
                '2001:4860:4801:b2::/64', '2001:4860:4801:b3::/64', '2001:4860:4801:b4::/64',
                '2001:4860:4801:b5::/64',
            ]
        ],
        'bingbot' => [
            'user_agent_patterns' => ['bingbot', 'msnbot'],
            'rdns_patterns' => ['.search.msn.com'],
            'ip_ranges' => [
                // IPv4 ranges
                '40.77.167.0/24',      // Bing crawler
                '157.55.39.0/24',      // MSN Bot
                '207.46.13.0/24',      // Microsoft crawler
                '40.77.188.0/22',      // Bing services
                '157.55.32.0/20',      // Microsoft crawlers
                '207.46.0.0/16',       // Microsoft network
                '131.253.24.0/22',     // Microsoft services
                '131.253.61.0/24',     // Bing crawlers
                '65.52.0.0/14',        // Microsoft services
                '199.30.16.0/20',      // Microsoft edge
                '13.64.0.0/11',        // Azure (Bing uses)
                '20.0.0.0/8',          // Azure Bing crawlers
                '52.0.0.0/8',          // Azure services
                // IPv6 ranges
                '2620:1ec:c11::/48',   // Bing IPv6
                '2001:4898::/32',      // Microsoft IPv6
            ]
        ],
        'yandexbot' => [
            'user_agent_patterns' => ['yandexbot', 'yandex'],
            'rdns_patterns' => ['.yandex.ru', '.yandex.net', '.yandex.com'],
            'ip_ranges' => [
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // –û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –°–ü–ò–°–û–ö IP –û–¢ –Ø–ù–î–ï–ö–°–ê (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-12-18)
                // –ò—Å—Ç–æ—á–Ω–∏–∫–∏: 
                // 1. SPF –∑–∞–ø–∏—Å–∏ (_spf-ipv4.yandex.ru, _spf-ipv6.yandex.ru)
                // 2. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: https://yandex.ru/ips
                // 3. –ê—Ä—Ö–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (2023)
                // –í—Å–µ–≥–æ: 22 IPv4 + 6 IPv6 = 28 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                
                // IPv4 RANGES (22 –¥–∏–∞–ø–∞–∑–æ–Ω–∞) - –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –û–¢ –Ø–ù–î–ï–ö–°–ê
                // –ò–∑ SPF –∑–∞–ø–∏—Å–µ–π (–¥–µ–∫–∞–±—Ä—å 2025):
                '5.45.192.0/18',        // Yandex main (–ø–æ–∫—Ä—ã–≤–∞–µ—Ç /19 –∏–∑ SPF)
                '5.255.192.0/18',       // Yandex services
                '37.9.64.0/18',         // Yandex network (–ø–æ–∫—Ä—ã–≤–∞–µ—Ç 37.9.109.0/24 –∏–∑ SPF)
                '37.140.128.0/18',      // Yandex services
                '77.88.0.0/18',         // Main Yandex range
                '84.201.128.0/18',      // Yandex cloud
                '87.250.224.0/19',      // Yandex services
                '93.158.128.0/18',      // Yandex crawlers (–ø–æ–∫—Ä—ã–≤–∞–µ—Ç 93.158.136.48/28 –∏–∑ SPF)
                '95.108.128.0/17',      // Yandex network (–ø–æ–∫—Ä—ã–≤–∞–µ—Ç 95.108.130.0/23 –∏ 95.108.192.0/18 –∏–∑ SPF)
                '141.8.128.0/18',       // Yandex crawlers (–ø–æ–∫—Ä—ã–≤–∞–µ—Ç 141.8.132.0/24 –∏–∑ SPF)
                '213.180.192.0/19',     // Yandex services (–ø–æ–∫—Ä—ã–≤–∞–µ—Ç 213.180.223.192/26 –∏–∑ SPF)
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (2023):
                '84.252.160.0/19',      // Yandex additional
                '90.156.176.0/22',      // Yandex services
                '178.154.128.0/18',     // Yandex services
                '185.32.187.0/24',      // Yandex bot
                
                // –£–∑–∫–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∏–∑ SPF (–¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏):
                '37.9.109.0/24',        // Yandex specific
                '93.158.136.48/28',     // Yandex specific
                '95.108.130.0/23',      // Yandex specific
                '95.108.192.0/18',      // Yandex specific
                '141.8.132.0/24',       // Yandex specific
                '213.180.223.192/26',   // Yandex specific
                '185.32.185.0/24',      // Yandex bot (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π)
                
                // IPv6 RANGES (6 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤) - –û–§–ò–¶–ò–ê–õ–¨–ù–´–ï –û–¢ –Ø–ù–î–ï–ö–°–ê
                // –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω (–ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ):
                '2a02:6b8::/29',        // Yandex IPv6 main (–ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –Ω–∏–∂–µ)
                
                // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Å–µ—Ç–∏ –∏–∑ SPF (–¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏):
                '2a02:6b8:c00::/40',    // Yandex services IPv6
                '2a02:6b8:0:1472::/64', // Yandex specific
                '2a02:6b8:0:1619::/64', // Yandex specific
                '2a02:6b8:0:1a2d::/64', // Yandex specific
                '2a02:6b8:0:801::/64',  // Yandex specific
            ]
        ],
        'slurp' => [
            'user_agent_patterns' => ['slurp'],
            'rdns_patterns' => ['.crawl.yahoo.net'],
            'ip_ranges' => [
                // IPv4 ranges
                '98.136.0.0/14',       // Yahoo network
                '72.30.0.0/16',        // Yahoo crawlers
                '67.195.0.0/16',       // Yahoo services
                '74.6.0.0/16',         // Yahoo network
                '68.142.192.0/18',     // Yahoo crawlers
                '209.191.64.0/18',     // Yahoo services
                '76.13.0.0/16',        // Yahoo network
                // IPv6 ranges
                '2001:4998::/32',      // Yahoo IPv6
            ]
        ],
        'duckduckbot' => [
            'user_agent_patterns' => ['duckduckbot'],
            'rdns_patterns' => ['.duckduckgo.com'],
            'ip_ranges' => [
                // IPv4 ranges
                '20.191.45.0/24',      // DuckDuckGo bot
                '40.88.21.0/24',       // DuckDuckGo services
                '52.142.0.0/16',       // DuckDuckGo Azure
                '20.191.0.0/16',       // DuckDuckGo network
            ]
        ],
        'baiduspider' => [
            'user_agent_patterns' => ['baiduspider'],
            'rdns_patterns' => ['.baidu.com', '.baidu.jp'],
            'ip_ranges' => [
                // IPv4 ranges
                '123.125.71.0/24',     // Baidu spider
                '180.76.0.0/16',       // Main Baidu range
                '220.181.0.0/16',      // Baidu network
                '119.63.192.0/21',     // Baidu crawlers
                '202.46.48.0/20',      // Baidu services
                '61.135.0.0/16',       // Baidu network
                '123.125.0.0/16',      // Baidu services
                '202.108.22.0/24',     // Baidu spider
                '220.181.108.0/24',    // Baidu crawlers
            ]
        ],
        'facebookexternalhit' => [
            'user_agent_patterns' => ['facebookexternalhit', 'facebookcatalog'],
            'rdns_patterns' => ['.facebook.com', '.fbsv.net'],
            'skip_forward_verification' => true,
            'ip_ranges' => [
                // IPv4 ranges
                '31.13.24.0/21',       // Facebook network
                '31.13.64.0/18',       // Facebook services
                '66.220.144.0/20',     // Facebook crawlers
                '69.63.176.0/20',      // Facebook network
                '69.171.224.0/19',     // Facebook services
                '74.119.76.0/22',      // Facebook crawlers
                '103.4.96.0/22',       // Facebook Asia
                '129.134.0.0/16',      // Facebook network
                '157.240.0.0/16',      // Facebook services
                '173.252.64.0/18',     // Facebook crawlers
                '179.60.192.0/22',     // Facebook Latin America
                '185.60.216.0/22',     // Facebook Europe
                '204.15.20.0/22',      // Facebook network
                // IPv6 ranges
                '2a03:2880::/32',      // Facebook IPv6
                '2620:0:1c00::/40',    // Facebook services IPv6
            ]
        ],
        'twitterbot' => [
            'user_agent_patterns' => ['twitterbot'],
            'rdns_patterns' => ['.twitter.com', '.twttr.com'],
            'skip_forward_verification' => true,
            'ip_ranges' => [
                // IPv4 ranges
                '192.133.76.0/22',     // Twitter network
                '199.16.156.0/22',     // Twitter services
                '199.59.148.0/22',     // Twitter crawlers
                '199.96.56.0/21',      // Twitter network
                '202.160.128.0/22',    // Twitter Asia
                '104.244.42.0/24',     // Twitter bot
            ]
        ],
        'linkedinbot' => [
            'user_agent_patterns' => ['linkedinbot'],
            'rdns_patterns' => ['.linkedin.com'],
            'skip_forward_verification' => true,
            'ip_ranges' => [
                // IPv4 ranges
                '108.174.0.0/16',      // LinkedIn network
                '138.91.0.0/16',       // LinkedIn services
                '185.63.144.0/22',     // LinkedIn Europe
                '216.52.16.0/22',      // LinkedIn crawlers
            ]
        ],
        'applebot' => [
            'user_agent_patterns' => ['applebot'],
            'rdns_patterns' => ['.applebot.apple.com'],
            'ip_ranges' => [
                // IPv4 ranges
                '17.0.0.0/8',          // Apple network (—à–∏—Ä–æ–∫–∏–π, –Ω–æ –≤–∫–ª—é—á–∞–µ—Ç Applebot)
            ]
        ],
        'amazonbot' => [
            'user_agent_patterns' => ['amazonbot', 'amazon bot', 'amazon-bot'],
            'rdns_patterns' => ['.amazon.com', '.amazon', '.crawl.amazonbot.amazon'],
            'ip_ranges' => [
                // IPv4 ranges (AWS ranges - Amazonbot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç AWS)
                '3.0.0.0/15',          // AWS us-east-1
                '52.94.0.0/16',        // AWS global
                '54.0.0.0/8',          // AWS main range
                '18.0.0.0/8',          // AWS services
            ]
        ],
        'petalbot' => [
            'user_agent_patterns' => ['petalbot'],
            'rdns_patterns' => ['.petalsearch.com'],
            'ip_ranges' => [
                // IPv4 ranges
                '114.119.128.0/17',    // PetalBot Asia
                '222.186.0.0/16',      // Huawei network
            ]
        ],
        'sogou' => [
            'user_agent_patterns' => ['sogou'],
            'rdns_patterns' => ['.sogou.com'],
            'ip_ranges' => [
                // IPv4 ranges
                '106.38.241.0/24',     // Sogou spider
                '123.126.113.0/24',    // Sogou network
                '220.181.125.0/24',    // Sogou crawlers
            ]
        ],
        'telegrambot' => [
            'user_agent_patterns' => ['telegrambot', 'telegram bot', 'tgbot'],
            'rdns_patterns' => ['.telegram.org', '.ptr.telegram.org'],
            'skip_forward_verification' => true  // PTR –∑–∞–ø–∏—Å–∏ Telegram –Ω–µ –∏–º–µ—é—Ç forward DNS
        ]
    ];
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // JS CHALLENGE SETTINGS - –ó–∞—â–∏—Ç–∞ –æ—Ç –±–æ—Ç–æ–≤ —á–µ—Ä–µ–∑ JavaScript –ø—Ä–æ–≤–µ—Ä–∫—É
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    private $jsChallengeSettings = [
        'enabled' => true,                          // –í–∫–ª—é—á–∏—Ç—å JS Challenge
        'trigger_on_suspicious' => true,            // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–º –ø–æ–≤–µ–¥–µ–Ω–∏–∏
        'trigger_on_high_violations' => true,       // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö violations
        'violations_threshold' => 3,                // –ü–æ—Ä–æ–≥ violations –¥–ª—è –ø–æ–∫–∞–∑–∞ challenge
        'trigger_on_slow_bot' => true,              // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–ª—è slow bot
        'trigger_on_no_cookie' => true,             // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç cookie (–í–°–ï–ú –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ!)
        'no_cookie_threshold' => 1,                 // –£–°–¢–ê–†–ï–õ–û: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –í–°–ï–ú –±–µ–∑ cookie —Å—Ä–∞–∑—É
        'token_ttl' => 3600,                        // TTL —Ç–æ–∫–µ–Ω–∞ JS Challenge (1 —á–∞—Å)
        'token_name' => 'murkir_js_token',          // –ò–º—è cookie —Å —Ç–æ–∫–µ–Ω–æ–º
        'min_solve_time' => 2000,                   // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è (ms)
        'pow_difficulty' => 3,                      // –°–ª–æ–∂–Ω–æ—Å—Ç—å PoW (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω—É–ª–µ–π –≤ –Ω–∞—á–∞–ª–µ —Ö–µ—à–∞)
        'failure_block_threshold' => 3,             // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ N –ø—Ä–æ–≤–∞–ª–æ–≤ Challenge (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø URL - URL –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –ü–†–û–í–ï–†–Ø–Æ–¢–°–Ø –∑–∞—â–∏—Ç–æ–π
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –í–ê–ñ–ù–û: –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ URL –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç –í–°–ï –ø—Ä–æ–≤–µ—Ä–∫–∏:
        // - JS Challenge
        // - Rate Limit (–≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞)
        // - Burst Detection
        // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö endpoints!
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        'excluded_urls' => [
            // –ü—Ä–∏–º–µ—Ä—ã –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –Ω—É–∂–Ω—ã–µ):
            // '/api/*',                           // –í—Å–µ API endpoints
            '/TEMP/IPv6-IPv4/IPv6-IPv4.php',  // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª —Å –ª—é–±—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
			'/TEMP/IPv6-IPv4/IPv6-IPv4-PTR.php',  // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª —Å –ª—é–±—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            // '/admin/ajax/*',                     // –í—Å–µ AJAX –∑–∞–ø—Ä–æ—Å—ã –∞–¥–º–∏–Ω–∫–∏
            // '/webhook/*',                        // –í—Å–µ webhook endpoints
            // '/public/images/*',                  // –°—Ç–∞—Ç–∏—á–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
        ],
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –ó–ê–©–ò–¢–ê v2.8.0 - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –£–ñ–ï–°–¢–û–ß–ï–ù–ò–ï –ü–†–ò –ê–¢–ê–ö–ï
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        'adaptive_protection' => true,              // –í–∫–ª—é—á–∏—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –∑–∞—â–∏—Ç—É (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ)
        'adaptive_threshold_normal' => 3,           // –ü–æ—Ä–æ–≥ –ø—Ä–æ–≤–∞–ª–æ–≤ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
        'adaptive_threshold_attack' => 1,           // –ü–æ—Ä–æ–≥ –ø—Ä–æ–≤–∞–ª–æ–≤ –≤–æ –≤—Ä–µ–º—è –∞—Ç–∞–∫–∏ (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π)
        
        // –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞—Ç–∞–∫–∏ (–ª—é–±–æ–π –∫—Ä–∏—Ç–µ—Ä–∏–π = –∞—Ç–∞–∫–∞):
        'attack_rps_threshold' => 50,               // RPS –≤—ã—à–µ —ç—Ç–æ–≥–æ = –∞—Ç–∞–∫–∞ (–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É)
        'attack_failures_per_minute' => 30,         // –ü—Ä–æ–≤–∞–ª–æ–≤ JS Challenge –∑–∞ –º–∏–Ω—É—Ç—É > —ç—Ç–æ–≥–æ = –∞—Ç–∞–∫–∞
        'attack_blocks_per_minute' => 15,           // –ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∑–∞ –º–∏–Ω—É—Ç—É > —ç—Ç–æ–≥–æ = –∞—Ç–∞–∫–∞
        
        // –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ç–∞–∫–∏ (–í–°–ï –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è):
        'recovery_rps_threshold' => 20,             // RPS –Ω–∏–∂–µ —ç—Ç–æ–≥–æ = –∞—Ç–∞–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
        'recovery_duration' => 300,                 // –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (5 –º–∏–Ω) –Ω–∏–∑–∫–æ–≥–æ RPS –¥–ª—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ç–∞–∫–∏
    ];

    
    public function __construct($redisHost = '127.0.0.1', $redisPort = 6379, $redisPassword = null, $redisDatabase = 0) {
        $this->initRedis($redisHost, $redisPort, $redisPassword, $redisDatabase);
        
    }
    
    private function initRedis($host, $port, $password, $database) {
        try {
            $this->redis = new Redis();
            
            if (!$this->redis->connect($host, $port, 2)) {
                throw new Exception("Cannot connect to Redis server at {$host}:{$port}");
            }
            
            if ($password) {
                if (!$this->redis->auth($password)) {
                    throw new Exception("Redis authentication failed");
                }
            }
            
            if (!$this->redis->select($database)) {
                throw new Exception("Cannot select Redis database {$database}");
            }
            
            $this->redis->setOption(Redis::OPT_SERIALIZER, Redis::SERIALIZER_JSON);
            $this->redis->setOption(Redis::OPT_PREFIX, $this->redisPrefix);
            
            if (!$this->redis->ping()) {
                throw new Exception("Redis ping failed");
            }
            
        } catch (Exception $e) {
            error_log("CRITICAL: Redis connection failed - " . $e->getMessage());
            throw $e;
        }
    }
    
    private function normalizeIPv6($ip) {
        if (!filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {
            return $ip;
        }
        
        $binary = @inet_pton($ip);
        if ($binary === false) {
            return $ip;
        }
        
        $normalized = @inet_ntop($binary);
        return $normalized ?: $ip;
    }
    
    private function normalizeIP($ip) {
        $ip = trim($ip);
        
        if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) {
            return $ip;
        }
        
        if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {
            return $this->normalizeIPv6($ip);
        }
        
        return $ip;
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ IP –∞–¥—Ä–µ—Å –ø–æ–∏—Å–∫–æ–≤—ã–º –±–æ—Ç–æ–º –ø–æ whitelist IP –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
     * 
     * @param string $ip IP –∞–¥—Ä–µ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
     * @param string $userAgent User-Agent –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –±–æ—Ç–∞
     * @return array|false ['engine' => 'googlebot', 'matched_range' => '66.249.64.0/19'] –∏–ª–∏ false
     */
    private function isSearchEngineByIP($ip, $userAgent = '') {
        // –°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∏—Å–∫–æ–≤–∏–∫ –ø–æ User-Agent
        $detectedEngine = null;
        $engineConfig = null;
        
        if (!empty($userAgent)) {
            foreach ($this->allowedSearchEngines as $engine => $config) {
                foreach ($config['user_agent_patterns'] as $pattern) {
                    if (stripos($userAgent, $pattern) !== false) {
                        $detectedEngine = $engine;
                        $engineConfig = $config;
                        break 2;
                    }
                }
            }
        }
        
        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø–æ–∏—Å–∫–æ–≤–∏–∫ –ø–æ UA, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ IP ranges
        if ($detectedEngine && $engineConfig && !empty($engineConfig['ip_ranges'])) {
            foreach ($engineConfig['ip_ranges'] as $cidr) {
                if ($this->ipInRange($ip, $cidr)) {
                    return [
                        'engine' => $detectedEngine,
                        'matched_range' => $cidr,
                        'method' => 'ip_whitelist'
                    ];
                }
            }
        }
        
        // –ï—Å–ª–∏ UA –Ω–µ —Å–æ–≤–ø–∞–ª –∏–ª–∏ IP –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ IP ranges
        // (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ UA –ø–æ–¥–¥–µ–ª–∞–Ω –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
        foreach ($this->allowedSearchEngines as $engine => $config) {
            if (!empty($config['ip_ranges'])) {
                foreach ($config['ip_ranges'] as $cidr) {
                    if ($this->ipInRange($ip, $cidr)) {
                        return [
                            'engine' => $engine,
                            'matched_range' => $cidr,
                            'method' => 'ip_whitelist_fallback'
                        ];
                    }
                }
            }
        }
        
        return false;
    }
    
    private function getIPFingerprint($ip) {
        $ip = $this->normalizeIPv6($ip);
        
        if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {
            $parts = explode(':', $ip);
            if (count($parts) >= 4) {
                return implode(':', array_slice($parts, -4));
            }
            return substr($ip, -16);
        } else {
            $parts = explode('.', $ip);
            if (count($parts) >= 2) {
                return end($parts) . '.' . prev($parts);
            }
            return $ip;
        }
    }
    
    private function generateUserHash($ip = null) {
        $ip = $ip ?: $this->getRealIP();
        $userAgent = $_SERVER['HTTP_USER_AGENT'] ?? '';
        $acceptLanguage = $_SERVER['HTTP_ACCEPT_LANGUAGE'] ?? '';
        $acceptEncoding = $_SERVER['HTTP_ACCEPT_ENCODING'] ?? '';
        $accept = $_SERVER['HTTP_ACCEPT'] ?? '';
        
        $browserInfo = $this->getBrowserFingerprint($userAgent);
        
        $stableFingerprint = $userAgent . '|' . 
                            $acceptLanguage . '|' . 
                            $acceptEncoding . '|' . 
                            $accept . '|' .
                            $browserInfo['name'] . '|' .
                            $browserInfo['version'] . '|' .
                            $browserInfo['platform'] . '|' .
                            $this->secretKey;
        
        if (false /* isMobileDevice removed */) {
            $ipPart = $this->getIPFingerprint($ip);
            $stableFingerprint .= '|mobile|' . $ipPart;
        } else {
            $stableFingerprint .= '|desktop|' . $ip;
        }
        
        return hash('sha256', $stableFingerprint);
    }
    
    private function getBrowserFingerprint($userAgent) {
        $browser = [
            'name' => 'unknown',
            'version' => 'unknown',
            'platform' => 'unknown'
        ];
        
        if (preg_match('/Chrome\/(\d+\.\d+)/', $userAgent, $matches)) {
            $browser['name'] = 'Chrome';
            $browser['version'] = $matches[1];
        } elseif (preg_match('/Firefox\/(\d+\.\d+)/', $userAgent, $matches)) {
            $browser['name'] = 'Firefox';
            $browser['version'] = $matches[1];
        } elseif (preg_match('/Safari\/(\d+\.\d+)/', $userAgent, $matches)) {
            if (strpos($userAgent, 'Chrome') === false) {
                $browser['name'] = 'Safari';
                $browser['version'] = $matches[1];
            }
        } elseif (preg_match('/Edge\/(\d+\.\d+)/', $userAgent, $matches)) {
            $browser['name'] = 'Edge';
            $browser['version'] = $matches[1];
        } elseif (preg_match('/Edg\/(\d+\.\d+)/', $userAgent, $matches)) {
            $browser['name'] = 'EdgeChromium';
            $browser['version'] = $matches[1];
        }
        
        if (strpos($userAgent, 'Windows NT') !== false) {
            if (preg_match('/Windows NT (\d+\.\d+)/', $userAgent, $matches)) {
                $browser['platform'] = 'Windows_' . $matches[1];
            } else {
                $browser['platform'] = 'Windows';
            }
        } elseif (strpos($userAgent, 'Macintosh') !== false) {
            $browser['platform'] = 'macOS';
        } elseif (strpos($userAgent, 'Linux') !== false) {
            $browser['platform'] = 'Linux';
        } elseif (strpos($userAgent, 'Android') !== false) {
            $browser['platform'] = 'Android';
        } elseif (strpos($userAgent, 'iPhone') !== false || strpos($userAgent, 'iPad') !== false) {
            $browser['platform'] = 'iOS';
        }
        
        return $browser;
    }
    
    private function isUserHashBlocked() {
        try {
            $userHash = $this->generateUserHash();
            $blockKey = $this->userHashPrefix . 'blocked:' . $userHash;
            return $this->redis->exists($blockKey);
        } catch (Exception $e) {
            error_log("Error checking user hash block: " . $e->getMessage());
            return false;
        }
    }
    
    private function blockUserHash($reason = 'Bot behavior detected') {
        try {
            $userHash = $this->generateUserHash();
            $ip = $this->getRealIP();
            
            $blockData = [
                'user_hash' => $userHash,
                'ip' => $ip,
                'blocked_at' => time(),
                'blocked_reason' => $reason,
                'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
                'session_id' => 'no_session',
                'uri' => $_SERVER['REQUEST_URI'] ?? '',
                'headers' => $this->collectHeaders(),
                'browser_info' => $this->getBrowserFingerprint($_SERVER['HTTP_USER_AGENT'] ?? ''),
                'device_type' => 'unknown' // isMobileDevice() removed in optimization
            ];
            
            $blockKey = $this->userHashPrefix . 'blocked:' . $userHash;
            $this->redis->setex($blockKey, $this->ttlSettings['user_hash_blocked'], $blockData);
            
            $statsKey = $this->userHashPrefix . 'stats:' . $userHash;
            $this->redis->hincrby($statsKey, 'block_count', 1);
            $this->redis->hset($statsKey, 'last_blocked', time());
            $this->redis->hset($statsKey, 'last_blocked_reason', $reason);
            $this->redis->expire($statsKey, $this->ttlSettings['user_hash_stats']);
            
            error_log("Bot blocked [HASH]: " . substr($userHash, 0, 8) . " | IP: $ip | " . $blockData['device_type'] . " | " . $reason);
        } catch (Exception $e) {
            error_log("Error blocking user hash: " . $e->getMessage());
        }
    }
    
    private function trackUserHashActivity() {
        try {
            $userHash = $this->generateUserHash();
            $trackingKey = $this->userHashPrefix . 'tracking:' . $userHash;
            
            $existing = $this->redis->get($trackingKey);
            
            if ($existing) {
                $existing['requests']++;
                $existing['last_activity'] = time();
                
                $currentPage = parse_url($_SERVER['REQUEST_URI'] ?? '', PHP_URL_PATH);
                if (!in_array($currentPage, $existing['pages'])) {
                    $existing['pages'][] = $currentPage;
                }
                
                $existing['request_times'][] = time();
                
                $currentIP = $this->getRealIP();
                if (!in_array($currentIP, $existing['ips'])) {
                    $existing['ips'][] = $currentIP;
                }
                
                if (count($existing['request_times']) > 30) {
                    $existing['request_times'] = array_slice($existing['request_times'], -30);
                }
                if (count($existing['pages']) > 50) {
                    $existing['pages'] = array_unique(array_slice($existing['pages'], -50));
                }
                if (count($existing['ips']) > 15) {
                    $existing['ips'] = array_unique(array_slice($existing['ips'], -15));
                }
                
                $this->redis->setex($trackingKey, $this->ttlSettings['user_hash_tracking'], $existing);
                return $existing;
            } else {
                $data = [
                    'user_hash' => $userHash,
                    'first_seen' => time(),
                    'last_activity' => time(),
                    'requests' => 1,
                    'pages' => [parse_url($_SERVER['REQUEST_URI'] ?? '', PHP_URL_PATH)],
                    'ips' => [$this->getRealIP()],
                    'user_agents' => [$_SERVER['HTTP_USER_AGENT'] ?? ''],
                    'request_times' => [time()],
                    'browser_info' => $this->getBrowserFingerprint($_SERVER['HTTP_USER_AGENT'] ?? '')
                ];
                
                $this->redis->setex($trackingKey, $this->ttlSettings['user_hash_tracking'], $data);
                return $data;
            }
        } catch (Exception $e) {
            error_log("Error tracking user hash: " . $e->getMessage());
            return [];
        }
    }
    
    // analyzeSlowBot() removed in optimization (saved 107 lines)
    
    // enableExtendedTracking() removed in optimization (saved 19 lines)
    
    // checkExtendedTracking() removed in optimization (saved 9 lines)
    
    private function getUserTrackingData($ip) {
        try {
            $trackingKey = $this->trackingPrefix . 'ip:' . hash('md5', $ip);
            return $this->redis->get($trackingKey);
        } catch (Exception $e) {
            error_log("Error getting user tracking data: " . $e->getMessage());
            return null;
        }
    }
    
    /**
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     * –û–ë–ù–û–í–õ–ï–ù–û v2.5: isPotentialSlowBot —Å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
     * 
     * –ò–∑–º–µ–Ω–µ–Ω–∏—è:
     * - –ü–æ—Ä–æ–≥ —Å–Ω–∏–∂–µ–Ω —Å 5 –¥–æ 3 –∑–∞–ø—Ä–æ—Å–æ–≤
     * - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è cookie
     * - –£–∂–µ—Å—Ç–æ—á–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     */
    private function isPotentialSlowBot($trackingData) {
        // v2.5: –°–Ω–∏–∂–µ–Ω –ø–æ—Ä–æ–≥ —Å 5 –¥–æ 3
        if (!$trackingData || $trackingData['requests'] < 3) {
            return false;
        }
        
        $timeSpent = time() - ($trackingData['first_seen'] ?? time());
        $requests = $trackingData['requests'];
        $headers = $this->collectHeaders();
        
        // v2.5: –ù–û–í–û–ï - –Ω–µ—Ç Accept-Language = –æ—á–µ–Ω—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ
        $acceptLang = $headers['HTTP_ACCEPT_LANGUAGE'] ?? '';
        if (empty($acceptLang) && $requests >= 3) {
            return true;
        }
        
        // v2.5: –ù–û–í–û–ï - Accept: */* –±–µ–∑ –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞
        $accept = $headers['HTTP_ACCEPT'] ?? '';
        if ($accept === '*/*' && empty($headers['HTTP_SEC_FETCH_MODE']) && $requests >= 3) {
            return true;
        }
        
        // –î–æ–ª–≥–∞—è —Å–µ—Å—Å–∏—è —Å —É–º–µ—Ä–µ–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤
        if ($timeSpent > ($this->slowBotSettings['long_session_hours'] * 3600) && 
            $requests > 10 && $requests < 100) {
            return true;
        }
        
        // –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—Ä–æ–±–æ—Ç—ã –¥–µ–ª–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã "–ø–æ —Ç–∞–π–º–µ—Ä—É")
        // v2.5: –°–Ω–∏–∂–µ–Ω –ø–æ—Ä–æ–≥ —Å 8 –¥–æ 5 –∑–∞–ø—Ä–æ—Å–æ–≤
        if (isset($trackingData['request_times']) && count($trackingData['request_times']) >= 5) {
            $times = $trackingData['request_times'];
            $intervals = [];
            
            for ($i = 1; $i < count($times); $i++) {
                $intervals[] = $times[$i] - $times[$i-1];
            }
            
            if (count($intervals) >= 4) {
                $avgInterval = array_sum($intervals) / count($intervals);
                $variance = 0;
                foreach ($intervals as $interval) {
                    $variance += pow($interval - $avgInterval, 2);
                }
                $variance /= count($intervals);
                
                // –ú–∞–ª–∞—è –¥–∏—Å–ø–µ—Ä—Å–∏—è = —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã = –±–æ—Ç
                if ($variance < $this->slowBotSettings['suspicious_regularity_variance'] && 
                    $avgInterval > 30 && $avgInterval < 900) {  // v2.5: —Ä–∞—Å—à–∏—Ä–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω
                    return true;
                }
            }
        }
        
        // –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–æ—Å–ª–µ –Ω–µ–∫–æ—Ç–æ—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        // v2.5: –°–Ω–∏–∂–µ–Ω –ø–æ—Ä–æ–≥ —Å 8 –¥–æ 5 –∑–∞–ø—Ä–æ—Å–æ–≤
        if ($timeSpent > 1800 && $requests > 5) {  // 30 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ 1 —á–∞—Å–∞
            $missingHeaders = 0;
            
            if (!isset($headers['HTTP_REFERER'])) $missingHeaders++;
            if (!isset($headers['HTTP_ACCEPT_LANGUAGE'])) $missingHeaders += 2;  // v2.5: –±–æ–ª—å—à–∏–π –≤–µ—Å
            if (($headers['HTTP_ACCEPT'] ?? '') === '*/*') $missingHeaders++;
            if (!isset($headers['HTTP_SEC_FETCH_MODE'])) $missingHeaders++;
            
            if ($missingHeaders >= 2) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     * –ù–û–í–´–ô –ú–ï–¢–û–î v2.4: –ü–æ–ª—É—á–∏—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ violations –¥–ª—è IP
     * –û–±—ä–µ–¥–∏–Ω—è–µ—Ç rate limit violations + burst violations
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     */
    private function getTotalViolations($ip) {
        try {
            $violationsKey = $this->trackingPrefix . 'violations:' . hash('md5', $ip);
            $data = $this->redis->get($violationsKey);
            
            if (!$data || !is_array($data)) {
                return [
                    'rate_limit' => 0,
                    'burst' => 0,
                    'total' => 0,
                    'last_violation' => null
                ];
            }
            
            return [
                'rate_limit' => (int)($data['rate_limit'] ?? 0),
                'burst' => (int)($data['burst'] ?? 0),
                'total' => (int)($data['rate_limit'] ?? 0) + (int)($data['burst'] ?? 0),
                'last_violation' => $data['last_violation'] ?? null
            ];
        } catch (Exception $e) {
            error_log("Error getting total violations: " . $e->getMessage());
            return ['rate_limit' => 0, 'burst' => 0, 'total' => 0, 'last_violation' => null];
        }
    }
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î v2.4: –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ violations
     */
    private function incrementViolations($ip, $type = 'rate_limit') {
        try {
            $violationsKey = $this->trackingPrefix . 'violations:' . hash('md5', $ip);
            $data = $this->redis->get($violationsKey);
            
            if (!$data || !is_array($data)) {
                $data = [
                    'rate_limit' => 0,
                    'burst' => 0,
                    'ip' => $ip,
                    'first_violation' => time()
                ];
            }
            
            if ($type === 'rate_limit') {
                $data['rate_limit'] = (int)($data['rate_limit'] ?? 0) + 1;
            } elseif ($type === 'burst') {
                $data['burst'] = (int)($data['burst'] ?? 0) + 1;
            }
            
            $data['last_violation'] = time();
            $data['last_type'] = $type;
            
            // TTL 1 —á–∞—Å - violations —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "—É—Å–ø–æ–∫–æ–∏–ª—Å—è"
            $this->redis->setex($violationsKey, 3600, $data);
            
            return [
                'rate_limit' => (int)$data['rate_limit'],
                'burst' => (int)$data['burst'],
                'total' => (int)$data['rate_limit'] + (int)$data['burst']
            ];
        } catch (Exception $e) {
            error_log("Error incrementing violations: " . $e->getMessage());
            return ['rate_limit' => 0, 'burst' => 0, 'total' => 0];
        }
    }
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î v2.4: –°–±—Ä–æ—Å violations –¥–ª—è IP
     */
    public function resetViolations($ip) {
        try {
            $violationsKey = $this->trackingPrefix . 'violations:' . hash('md5', $ip);
            $this->redis->del($violationsKey);
            return true;
        } catch (Exception $e) {
            return false;
        }
    }
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î v2.4: –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å violations –¥–ª—è IP
     */
    public function getViolationsStatus($ip) {
        $violations = $this->getTotalViolations($ip);
        
        return [
            'ip' => $ip,
            'violations' => $violations,
            'thresholds' => [
                'rate_limit_api_block' => $this->rateLimitSettings['rate_limit_api_block_threshold'],
                'burst_api_block' => $this->rateLimitSettings['burst_api_block_threshold'],
                'combined_api_block' => $this->rateLimitSettings['combined_api_block_threshold'],
            ],
            'will_block_api' => $this->shouldBlockViaAPI($violations)
        ];
    }
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î v2.4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API
     */
    private function shouldBlockViaAPI($violations) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–æ—Ä–æ–≥
        if ($violations['rate_limit'] >= $this->rateLimitSettings['rate_limit_api_block_threshold']) {
            return ['block' => true, 'reason' => 'rate_limit_threshold'];
        }
        
        if ($violations['burst'] >= $this->rateLimitSettings['burst_api_block_threshold']) {
            return ['block' => true, 'reason' => 'burst_threshold'];
        }
        
        if ($violations['total'] >= $this->rateLimitSettings['combined_api_block_threshold']) {
            return ['block' => true, 'reason' => 'combined_threshold'];
        }
        
        return ['block' => false, 'reason' => null];
    }
    
    // analyzeUserHashBehavior() removed in optimization (saved 12 lines)
    
    // performStandardUserHashAnalysis() removed in optimization (saved 90 lines)
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î: –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit –¥–ª—è rDNS
     */
    private function checkRDNSRateLimit() {
        try {
            $currentMinute = floor(time() / 60); // –¢–µ–∫—É—â–∞—è –º–∏–Ω—É—Ç–∞
            $rateLimitKey = $this->rdnsPrefix . 'ratelimit:' . $currentMinute;
            
            $currentCount = $this->redis->get($rateLimitKey);
            
            if ($currentCount === false) {
                // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ —ç—Ç—É –º–∏–Ω—É—Ç—É
                $this->redis->setex($rateLimitKey, 120, 1); // TTL 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                return ['allowed' => true, 'count' => 1, 'limit' => $this->rdnsLimitSettings['max_rdns_per_minute']];
            }
            
            $currentCount = (int)$currentCount;
            
            if ($currentCount >= $this->rdnsLimitSettings['max_rdns_per_minute']) {
                // –õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω
                error_log("rDNS rate limit exceeded: $currentCount/{$this->rdnsLimitSettings['max_rdns_per_minute']} in current minute");
                return [
                    'allowed' => false,
                    'count' => $currentCount,
                    'limit' => $this->rdnsLimitSettings['max_rdns_per_minute'],
                    'reason' => 'rDNS rate limit exceeded'
                ];
            }
            
            // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫
            $this->redis->incr($rateLimitKey);
            
            return [
                'allowed' => true,
                'count' => $currentCount + 1,
                'limit' => $this->rdnsLimitSettings['max_rdns_per_minute']
            ];
            
        } catch (Exception $e) {
            error_log("Error in checkRDNSRateLimit: " . $e->getMessage());
            // –ü—Ä–∏ –æ—à–∏–±–∫–µ - —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            return ['allowed' => true, 'count' => 0, 'limit' => $this->rdnsLimitSettings['max_rdns_per_minute']];
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É rDNS rate limit
     */
    /**
     * –£–õ–£–ß–®–ï–ù–ù–ê–Ø –≤–µ—Ä—Å–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SCAN –≤–º–µ—Å—Ç–æ KEYS –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–π —Ä–∞–±–æ—Ç—ã
     */
    public function getRDNSRateLimitStats() {
        try {
            $currentMinute = floor(time() / 60);
            $prevMinute = $currentMinute - 1;
            
            $currentKey = $this->rdnsPrefix . 'ratelimit:' . $currentMinute;
            $prevKey = $this->rdnsPrefix . 'ratelimit:' . $prevMinute;
            
            $currentCount = $this->redis->get($currentKey) ?: 0;
            $prevCount = $this->redis->get($prevKey) ?: 0;
            
            // –£–õ–£–ß–®–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º SCAN –≤–º–µ—Å—Ç–æ KEYS (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç Redis)
            $cacheCount = 0;
            $verifiedCount = 0;
            $notVerifiedCount = 0;
            $sampleSize = 100; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            $sampled = 0;
            
            $iterator = null;
            // –í–ê–ñ–ù–û: OPT_PREFIX –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º SCAN - —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
            $pattern = $this->redisPrefix . $this->rdnsPrefix . 'cache:*';
            
            while (true) {
                $keys = $this->redis->scan($iterator, $pattern, 50);
                
                if ($keys === false) {
                    break;
                }
                
                $cacheCount += count($keys);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ $sampleSize –∑–∞–ø–∏—Å–µ–π
                if ($sampled < $sampleSize) {
                    foreach ($keys as $key) {
                        if ($sampled >= $sampleSize) break;
                        
                        // SCAN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å, —É–±–∏—Ä–∞–µ–º redisPrefix –¥–ª—è get()
                        $keyWithoutPrefix = str_replace($this->redisPrefix, '', $key);
                        $data = $this->redis->get($keyWithoutPrefix);
                        if ($data && isset($data['verified'])) {
                            if ($data['verified']) {
                                $verifiedCount++;
                            } else {
                                $notVerifiedCount++;
                            }
                        }
                        $sampled++;
                    }
                }
                
                if ($iterator === 0) {
                    break;
                }
            }
            
            return [
                'current_minute_requests' => (int)$currentCount,
                'previous_minute_requests' => (int)$prevCount,
                'limit_per_minute' => $this->rdnsLimitSettings['max_rdns_per_minute'],
                'cache_entries' => $cacheCount,
                'verified_in_cache' => $verifiedCount,
                'not_verified_in_cache' => $notVerifiedCount,
                'limit_reached' => $currentCount >= $this->rdnsLimitSettings['max_rdns_per_minute'],
                'settings' => $this->rdnsLimitSettings
            ];
            
        } catch (Exception $e) {
            error_log("Error getting rDNS stats: " . $e->getMessage());
            return [];
        }
    }
    
    /**
     * –£–õ–£–ß–®–ï–ù–ù–ê–Ø –≤–µ—Ä—Å–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SCAN –≤–º–µ—Å—Ç–æ KEYS –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–π –æ—á–∏—Å—Ç–∫–∏
     */
    public function clearRDNSCache() {
        try {
            $deleted = 0;
            $iterator = null;
            // –í–ê–ñ–ù–û: OPT_PREFIX –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º SCAN - —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
            $pattern = $this->redisPrefix . $this->rdnsPrefix . 'cache:*';
            
            while (true) {
                $keys = $this->redis->scan($iterator, $pattern, 100);
                
                if ($keys === false) {
                    break;
                }
                
                foreach ($keys as $key) {
                    // SCAN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å, —É–±–∏—Ä–∞–µ–º redisPrefix –¥–ª—è del()
                    $keyWithoutPrefix = str_replace($this->redisPrefix, '', $key);
                    $this->redis->del($keyWithoutPrefix);
                    $deleted++;
                }
                
                if ($iterator === 0) {
                    break;
                }
            }
            
            error_log("Cleared rDNS cache: $deleted entries");
            return $deleted;
            
        } catch (Exception $e) {
            error_log("Error clearing rDNS cache: " . $e->getMessage());
            return 0;
        }
    }
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î: –û—á–∏—Å—Ç–∫–∞ whitelist –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ cleanup.php)
     */
    public function clearSearchEngineWhitelist() {
        try {
            $deleted = 0;
            $iterator = null;
            // –í–ê–ñ–ù–û: OPT_PREFIX –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º SCAN - —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
            $pattern = $this->redisPrefix . $this->rdnsPrefix . 'whitelist:*';
            
            while (true) {
                $keys = $this->redis->scan($iterator, $pattern, 100);
                
                if ($keys === false) {
                    break;
                }
                
                foreach ($keys as $key) {
                    // SCAN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å, —É–±–∏—Ä–∞–µ–º redisPrefix –¥–ª—è del()
                    $keyWithoutPrefix = str_replace($this->redisPrefix, '', $key);
                    $this->redis->del($keyWithoutPrefix);
                    $deleted++;
                }
                
                if ($iterator === 0) {
                    break;
                }
            }
            
            error_log("Cleared search engine whitelist: $deleted entries");
            return $deleted;
            
        } catch (Exception $e) {
            error_log("Error clearing whitelist: " . $e->getMessage());
            return 0;
        }
    }
    
    /**
     * –°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ rDNS rate limit
     */
    public function resetRDNSRateLimit() {
        try {
            $currentMinute = floor(time() / 60);
            $rateLimitKey = $this->rdnsPrefix . 'ratelimit:' . $currentMinute;
            
            $result = $this->redis->del($rateLimitKey);
            error_log("rDNS rate limit reset for current minute");
            
            return $result > 0;
            
        } catch (Exception $e) {
            error_log("Error resetting rDNS rate limit: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ rDNS rate limiting
     */
    public function updateRDNSSettings($newSettings) {
        $this->rdnsLimitSettings = array_merge($this->rdnsLimitSettings, $newSettings);
        error_log("rDNS settings updated: " . json_encode($newSettings));
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ rDNS
     */
    public function getRDNSSettings() {
        return $this->rdnsLimitSettings;
    }
    
    /**
     * –†–ê–ë–û–ß–ò–ô Rate Limit v2.3.2 (–¥–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ IP –≤ –¥–∞–Ω–Ω—ã–µ)
     * 
     * –í–∞—Ä–∏–∞–Ω—Ç B: –ú—è–≥—á–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–∞–ª–∏–¥–Ω—ã–º cookie
     * - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å cookie: –ª–∏–º–∏—Ç—ã √ó cookie_multiplier (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é √ó2)
     * - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ cookie: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã
     * 
     * @param string $ip IP –∞–¥—Ä–µ—Å
     * @param bool $hasCookie –ï—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π cookie
     * @return array –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
     */
    private function checkRateLimit($ip, $hasCookie = false) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π URL –∏–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫
        if ($this->isExcludedFromJSChallenge()) {
            return [
                'allowed' => true,
                'reason' => 'URL excluded from rate limit checks',
                'excluded' => true
            ];
        }
        
        try {
            $now = time();
            
            // –ö–ª—é—á –¥–ª—è —ç—Ç–æ–≥–æ IP
            $key = $this->trackingPrefix . 'rl:' . hash('md5', $ip);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis
            $data = $this->redis->get($key);
            
            // –¢–µ–∫—É—â–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞
            $minuteWindow = floor($now / 60);
            $fiveMinWindow = floor($now / 300);
            $hourWindow = floor($now / 3600);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤
            $counts = [
                'min' => 0,
                'min5' => 0,
                'hour' => 0,
                'min_window' => $minuteWindow,
                'min5_window' => $fiveMinWindow,
                'hour_window' => $hourWindow,
                'violations' => 0,
                'ip' => $ip  // –°–æ—Ö—Ä–∞–Ω—è–µ–º IP –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
            ];
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –æ–∫–æ–Ω
            if ($data && is_array($data)) {
                // –ú–∏–Ω—É—Ç–∞ - –µ—Å–ª–∏ –æ–∫–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –±–µ—Ä—ë–º —Å—á—ë—Ç—á–∏–∫
                if (isset($data['min_window']) && $data['min_window'] == $minuteWindow) {
                    $counts['min'] = (int)($data['min'] ?? 0);
                }
                // 5 –º–∏–Ω—É—Ç
                if (isset($data['min5_window']) && $data['min5_window'] == $fiveMinWindow) {
                    $counts['min5'] = (int)($data['min5'] ?? 0);
                }
                // –ß–∞—Å
                if (isset($data['hour_window']) && $data['hour_window'] == $hourWindow) {
                    $counts['hour'] = (int)($data['hour'] ?? 0);
                }
                // –ù–∞—Ä—É—à–µ–Ω–∏—è
                $counts['violations'] = (int)($data['violations'] ?? 0);
                // IP —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ–≥–¥–∞ —Ç–µ–∫—É—â–∏–π
                $counts['ip'] = $ip;
            }
            
            // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º –í–°–ï —Å—á—ë—Ç—á–∏–∫–∏
            $counts['min']++;
            $counts['min5']++;
            $counts['hour']++;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª–∏–º–∏—Ç—ã (—Å –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º –¥–ª—è cookie)
            $multiplier = $hasCookie ? $this->rateLimitSettings['cookie_multiplier'] : 1.0;
            $limits = [
                'min' => (int)($this->rateLimitSettings['max_requests_per_minute'] * $multiplier),
                'min5' => (int)($this->rateLimitSettings['max_requests_per_5min'] * $multiplier),
                'hour' => (int)($this->rateLimitSettings['max_requests_per_hour'] * $multiplier),
            ];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
            $exceeded = [];
            if ($counts['min'] > $limits['min']) {
                $exceeded[] = "1min({$counts['min']}/{$limits['min']})";
            }
            if ($counts['min5'] > $limits['min5']) {
                $exceeded[] = "5min({$counts['min5']}/{$limits['min5']})";
            }
            if ($counts['hour'] > $limits['hour']) {
                $exceeded[] = "1hour({$counts['hour']}/{$limits['hour']})";
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ - –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º violations
            if (!empty($exceeded)) {
                $counts['violations']++;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Redis (TTL 1 —á–∞—Å)
            $this->redis->setex($key, 3600, $counts);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            if (!empty($exceeded)) {
                return [
                    'allowed' => false,
                    'reason' => 'Rate limit exceeded: ' . implode(', ', $exceeded),
                    'exceeded' => $exceeded,
                    'violation_count' => $counts['violations'],
                    'has_cookie' => $hasCookie,
                    'multiplier' => $multiplier,
                    'stats' => [
                        '1min' => $counts['min'],
                        '5min' => $counts['min5'],
                        '1hour' => $counts['hour'],
                    ],
                    'limits' => $limits
                ];
            }
            
            return [
                'allowed' => true,
                'reason' => null,
                'violation_count' => $counts['violations'],
                'has_cookie' => $hasCookie,
                'stats' => [
                    '1min' => $counts['min'],
                    '5min' => $counts['min5'],
                    '1hour' => $counts['hour'],
                ],
                'limits' => $limits
            ];
            
        } catch (Exception $e) {
            error_log("checkRateLimit ERROR: " . $e->getMessage());
            return ['allowed' => true, 'reason' => null, 'violation_count' => 0];
        }
    }
    
    /**
     * –°–±—Ä–æ—Å rate limit –¥–ª—è IP (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
     * v2.3: –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –æ–¥–∏–Ω –∫–ª—é—á
     */
    public function resetRateLimit($ip) {
        try {
            $rateLimitKey = $this->trackingPrefix . 'rl:' . hash('md5', $ip);
            $this->redis->del($rateLimitKey);
            return true;
        } catch (Exception $e) {
            error_log("Error resetting rate limit: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å rate limit –¥–ª—è IP
     */
    public function getRateLimitStatus($ip) {
        try {
            $key = $this->trackingPrefix . 'rl:' . hash('md5', $ip);
            $data = $this->redis->get($key);
            
            if (!$data || !is_array($data)) {
                return [
                    'exists' => false,
                    'message' => 'No rate limit data for this IP'
                ];
            }
            
            $now = time();
            $minuteWindow = floor($now / 60);
            $fiveMinWindow = floor($now / 300);
            $hourWindow = floor($now / 3600);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ (—Ç–µ —á—Ç–æ –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ)
            $currentCounts = [
                '1min' => (isset($data['min_window']) && $data['min_window'] == $minuteWindow) ? $data['min'] : 0,
                '5min' => (isset($data['min5_window']) && $data['min5_window'] == $fiveMinWindow) ? $data['min5'] : 0,
                '1hour' => (isset($data['hour_window']) && $data['hour_window'] == $hourWindow) ? $data['hour'] : 0,
            ];
            
            return [
                'exists' => true,
                'ip' => $ip,
                'current_counts' => $currentCounts,
                'limits_no_cookie' => [
                    '1min' => $this->rateLimitSettings['max_requests_per_minute'],
                    '5min' => $this->rateLimitSettings['max_requests_per_5min'],
                    '1hour' => $this->rateLimitSettings['max_requests_per_hour'],
                ],
                'limits_with_cookie' => [
                    '1min' => (int)($this->rateLimitSettings['max_requests_per_minute'] * $this->rateLimitSettings['cookie_multiplier']),
                    '5min' => (int)($this->rateLimitSettings['max_requests_per_5min'] * $this->rateLimitSettings['cookie_multiplier']),
                    '1hour' => (int)($this->rateLimitSettings['max_requests_per_hour'] * $this->rateLimitSettings['cookie_multiplier']),
                ],
                'violations' => (int)($data['violations'] ?? 0),
                'raw_data' => $data
            ];
        } catch (Exception $e) {
            return ['error' => $e->getMessage()];
        }
    }
    
    /**
     * –¢–µ—Å—Ç rate limit - —Å–∏–º—É–ª–∏—Ä—É–µ—Ç N –∑–∞–ø—Ä–æ—Å–æ–≤
     * @param string $ip IP –∞–¥—Ä–µ—Å –¥–ª—è —Ç–µ—Å—Ç–∞
     * @param int $numRequests –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏
     * @param bool $withCookie –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å cookie –∏–ª–∏ –±–µ–∑
     */
    // testRateLimit() removed in optimization (saved 47 lines)
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î v2.3: –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
     * –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ rate limit –∫–ª—é—á–∏ —Ñ–æ—Ä–º–∞—Ç–∞ rl:1m:*, rl:5m:*, rl:1h:*, grl:*:*
     * –ó–∞–ø—É—Å—Ç–∏—Ç—å –û–î–ò–ù —Ä–∞–∑ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!
     */
    // migrateFromOldRateLimitKeys() removed in optimization (saved 54 lines)
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î v2.3: –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª—é—á–µ–π
     * –ü–æ–º–æ–≥–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é
     */
    // getKeyStats() removed in optimization (saved 45 lines)
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î: –î–µ—Ç–µ–∫—Ü–∏—è –≤—Å–ø–ª–µ—Å–∫–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
     */
    /**
     * –†–ê–ë–û–ß–ò–ô Burst Detection v2.3.1
     * 
     * –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –≤—Å–ø–ª–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
     * 
     * –í–∞—Ä–∏–∞–Ω—Ç B: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å cookie –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥ (√ócookie_multiplier)
     * 
     * @param string $ip IP –∞–¥—Ä–µ—Å
     * @param bool $hasCookie –ï—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π cookie
     * @return array|false –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–ø–ª–µ—Å–∫–µ –∏–ª–∏ false
     */
    private function detectBurst($ip, $hasCookie = false) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π URL –∏–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫
        if ($this->isExcludedFromJSChallenge()) {
            return [
                'detected' => false,
                'reason' => 'URL excluded from burst detection',
                'excluded' => true
            ];
        }
        
        try {
            $now = time();
            $window = $this->rateLimitSettings['burst_window'];  // 10 —Å–µ–∫
            
            // –ü–æ—Ä–æ–≥ —Å —É—á—ë—Ç–æ–º cookie
            $multiplier = $hasCookie ? $this->rateLimitSettings['cookie_multiplier'] : 1.0;
            $threshold = (int)($this->rateLimitSettings['burst_threshold'] * $multiplier);
            
            // –û—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è burst detection
            $burstKey = $this->trackingPrefix . 'burst:' . hash('md5', $ip);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            $data = $this->redis->get($burstKey);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            $requests = [];
            
            if ($data && is_array($data) && isset($data['times'])) {
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ
                $requests = array_filter($data['times'], function($time) use ($now, $window) {
                    return ($now - $time) <= $window;
                });
                // –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤
                $requests = array_values($requests);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
            $requests[] = $now;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞ (—Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N*2 –∑–∞–ø—Ä–æ—Å–æ–≤)
            $maxStore = max($threshold * 2, 20);
            if (count($requests) > $maxStore) {
                $requests = array_slice($requests, -$maxStore);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥ –ü–ï–†–ï–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å TTL
            $requestsInWindow = count(array_filter($requests, function($time) use ($now, $window) {
                return ($now - $time) <= $window;
            }));
            
            // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ø–æ—Ä–æ–≥ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º TTL –¥–æ 1 —á–∞—Å–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
            // –ò–Ω–∞—á–µ - –∫–æ—Ä–æ—Ç–∫–∏–π TTL (–æ–∫–Ω–æ * 2)
            $ttl = ($requestsInWindow > $threshold) ? 3600 : ($window * 2);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º TTL - –¥–æ–±–∞–≤–ª—è–µ–º IP –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
            $this->redis->setex($burstKey, $ttl, [
                'times' => $requests, 
                'ip' => $ip,
                'exceeded' => ($requestsInWindow > $threshold) // –ú–∞—Ä–∫–µ—Ä –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
            ]);
            
            if ($requestsInWindow > $threshold) {
                return [
                    'detected' => true,
                    'requests_in_window' => $requestsInWindow,
                    'threshold' => $threshold,
                    'window' => $window,
                    'has_cookie' => $hasCookie,
                    'multiplier' => $multiplier,
                    'message' => "$requestsInWindow requests in {$window}s (limit: $threshold)"
                ];
            }
            
            return false;
            
        } catch (Exception $e) {
            error_log("detectBurst ERROR: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * –°–±—Ä–æ—Å burst detection –¥–ª—è IP
     */
    public function resetBurst($ip) {
        try {
            $burstKey = $this->trackingPrefix . 'burst:' . hash('md5', $ip);
            $this->redis->del($burstKey);
            return true;
        } catch (Exception $e) {
            return false;
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å burst –¥–ª—è IP
     */
    public function getBurstStatus($ip, $hasCookie = false) {
        try {
            $now = time();
            $window = $this->rateLimitSettings['burst_window'];
            $multiplier = $hasCookie ? $this->rateLimitSettings['cookie_multiplier'] : 1.0;
            $threshold = (int)($this->rateLimitSettings['burst_threshold'] * $multiplier);
            
            $burstKey = $this->trackingPrefix . 'burst:' . hash('md5', $ip);
            $data = $this->redis->get($burstKey);
            
            if (!$data || !is_array($data) || !isset($data['times'])) {
                return [
                    'exists' => false,
                    'requests_in_window' => 0,
                    'threshold' => $threshold,
                    'window' => $window,
                    'has_cookie' => $hasCookie
                ];
            }
            
            $requestsInWindow = count(array_filter($data['times'], function($time) use ($now, $window) {
                return ($now - $time) <= $window;
            }));
            
            return [
                'exists' => true,
                'requests_in_window' => $requestsInWindow,
                'threshold' => $threshold,
                'window' => $window,
                'has_cookie' => $hasCookie,
                'will_block_next' => $requestsInWindow >= $threshold,
                'raw_times' => $data['times']
            ];
        } catch (Exception $e) {
            return ['error' => $e->getMessage()];
        }
    }
    
    /**
     * –¢–µ—Å—Ç burst detection
     * @param string $ip IP –¥–ª—è —Ç–µ—Å—Ç–∞
     * @param int $numRequests –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
     * @param int $delayMs –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
     * @param bool $withCookie –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å cookie –∏–ª–∏ –±–µ–∑
     */
    // testBurst() removed in optimization (saved 43 lines)
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î: –î–µ—Ç–µ–∫—Ü–∏—è —Å–º–µ–Ω—ã User-Agent
     */
    private function detectUserAgentSwitching($ip) {
        try {
            $trackingKey = $this->trackingPrefix . 'ip:' . hash('md5', $ip);
            $data = $this->redis->get($trackingKey);
            
            if (!$data) {
                return false;
            }
            
            $uniqueUA = array_unique($data['user_agents'] ?? []);
            $uaCount = count($uniqueUA);
            
            if ($uaCount >= $this->rateLimitSettings['ua_change_threshold']) {
                $timeSpent = time() - ($data['first_seen'] ?? time());
                
                if ($timeSpent < $this->rateLimitSettings['ua_change_time_window']) {
                    return [
                        'detected' => true,
                        'unique_ua_count' => $uaCount,
                        'time_window' => $timeSpent,
                        'threshold' => $this->rateLimitSettings['ua_change_threshold'],
                        'user_agents' => array_map(function($ua) {
                            return substr($ua, 0, 50) . '...';
                        }, $uniqueUA)
                    ];
                }
            }
            
            return false;
            
        } catch (Exception $e) {
            error_log("Error in detectUserAgentSwitching: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î: –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
     */
    private function applyProgressiveBlock($ip, $reason, $violationData = null) {
    try {
        $blockKey = $this->blockPrefix . 'ip:' . hash('md5', $ip);
        $historyKey = $this->blockPrefix . 'history:' . hash('md5', $ip);
        
        $history = $this->redis->get($historyKey) ?: ['count' => 0, 'last_block' => 0];
        $history['count']++;
        $history['last_block'] = time();
        
        $blockDuration = $this->rateLimitSettings['progressive_block_duration'];
        
        if ($history['count'] >= 3) {
            $blockDuration = $this->rateLimitSettings['aggressive_block_duration'] * $history['count'];
        }
        
        $blockData = [
            'ip' => $ip,
            'blocked_at' => time(),
            'blocked_reason' => $reason,
            'violation_count' => $history['count'],
            'block_duration' => $blockDuration,
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
            'uri' => $_SERVER['REQUEST_URI'] ?? '',
            'violation_data' => $violationData,
            'api_blocked' => false
        ];
        
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ Redis
        if ($this->apiSettings['block_on_redis']) {
            $this->redis->setex($blockKey, $blockDuration, $blockData);
            $this->redis->setex($historyKey, 86400 * 7, $history);
        }
        
		// –ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ API
$apiCallKey = $this->blockPrefix . 'api_call:' . hash('md5', $ip);
$recentApiCall = $this->redis->get($apiCallKey);

if ($recentApiCall) {
    // API —É–∂–µ –≤—ã–∑—ã–≤–∞–ª—Å—è –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
    error_log("Skipping duplicate API call for $ip");
    $skipApiCall = true;
} else {
    $skipApiCall = false;
}
		
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ API
        if ($this->apiSettings['block_on_api'] && !$skipApiCall) {
            $apiResult = $this->callBlockingAPI($ip, 'block');
            
            if ($apiResult['status'] === 'success' || $apiResult['status'] === 'already_blocked') {
				$this->redis->setex($apiCallKey, 60, time()); // –ó–∞—â–∏—Ç–∞ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
                $blockData['api_blocked'] = true;
                $blockData['api_result'] = $apiResult['message'];
                
                if ($this->apiSettings['block_on_redis']) {
                    $this->redis->setex($blockKey, $blockDuration, $blockData);
                }
            }
        }
        
        $hours = round($blockDuration / 3600, 1);
        $apiStatus = $blockData['api_blocked'] ? 'API+Redis' : 'Redis only';
        error_log("RATE LIMIT BLOCK: $ip | {$apiStatus} | Count: {$history['count']} | Duration: {$hours}h | $reason");
        
        return true;
        
    } catch (Exception $e) {
        error_log("Error in applyProgressiveBlock: " . $e->getMessage());
        return false;
    }
}
    
    /**
     * –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î protect() —Å rate limiting
     */
    /**
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     * –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î protect() v2.4
     * 
     * –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: Rate Limit –∏ Burst Detection –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –í–°–ï–ì–î–ê,
     * –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 429 –æ—à–∏–±–∫–∞. –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ violations
     * IP –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ API.
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     */
    public function protect() {
        // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ RPM/RPS
        $this->incrementRequestCounter();
        
        if ($this->isStaticFile()) {
            return;
        }
        
        // –í–ï–†–û–Ø–¢–ù–û–°–¢–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è Redis (–Ω–µ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å!)
        if (rand(1, $this->globalProtectionSettings['cleanup_probability']) === 1) {
            $this->manageTrackedIPs();
        }
        
        $ip = $this->getRealIP();
        $userAgent = $_SERVER['HTTP_USER_AGENT'] ?? '';
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π rate limit –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–æ—Ç–æ–≤
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        $globalRateLimit = $this->checkGlobalRateLimit($ip);
        if (!$globalRateLimit['allowed']) {
            error_log("GLOBAL RATE LIMIT: $ip | " . $globalRateLimit['requests'] . " req/sec");
            $this->blockIP($ip, 'Global rate limit exceeded (possible DDoS)');
            $this->sendBlockResponse();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ö–†–ò–¢–ò–ß–ù–û v2.5.4: EXCLUDED URLS - –ü–û–õ–ù–´–ô –ü–†–û–ü–£–°–ö –í–°–ï–• –ü–†–û–í–ï–†–û–ö!
        // –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ URL –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –î–û –≤—Å–µ—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
        // –ò–Ω–∞—á–µ –æ–Ω–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ø–æ cookie, user hash, –∏ —Ç.–¥.
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if ($this->isExcludedFromJSChallenge()) {
            // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            error_log("URL EXCLUDED FROM ALL CHECKS: $ip | URI: " . $_SERVER['REQUEST_URI']);
            return; // –ü–æ–ª–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ù–û–í–û–ï v2.5.7: IP WHITELIST –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –±–æ—Ç–æ–≤ (CIDR –ø–æ–¥–¥–µ—Ä–∂–∫–∞)
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º IP –≤ whitelist –ü–ï–†–ï–î rDNS –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ IPv4 –∏ IPv6 CIDR –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        $ipWhitelistResult = $this->isSearchEngineByIP($ip, $userAgent);
        if ($ipWhitelistResult) {
            // IP –≤ whitelist –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞
            $engine = $ipWhitelistResult['engine'];
            $range = $ipWhitelistResult['matched_range'];
            $method = $ipWhitelistResult['method'];
            
            error_log("SEARCH ENGINE IP WHITELIST: $ip | Engine: $engine | Range: $range | Method: $method | UA: " . substr($userAgent, 0, 100));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ whitelist –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –≤ –±—É–¥—É—â–µ–º
            $this->addToSearchEngineWhitelist($ip, $userAgent);
            $this->logSearchEngineVisit($ip, $userAgent);
            
            return; // –ü–æ–ª–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ whitelist –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤
        if ($this->isWhitelistedSearchEngine($ip)) {
            return;
        }
        
        if ($this->isLegitimateBot($userAgent)) {
            $this->logBotVisit($ip, $userAgent, 'legitimate');
            return;
        }
        
        if ($this->isVerifiedSearchEngine($ip, $userAgent)) {
            $this->addToSearchEngineWhitelist($ip, $userAgent);
            $this->logSearchEngineVisit($ip, $userAgent);
            return;
        }
        
        if ($this->isUserHashBlocked()) {
            $this->sendBlockResponse();
        }
        
        if ($this->isCookieBlocked()) {
            $this->sendBlockResponse();
        }
        
        if ($this->isBlocked($ip) && $this->isSuspiciousUserAgent($userAgent)) {
            $this->sendBlockResponse();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ö–†–ò–¢–ò–ß–ù–û v2.7.5: RATE LIMIT + BURST –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î JS CHALLENGE!
        // –ë–æ—Ç—ã –º–æ–≥—É—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –Ω–∞–∂–∏–º–∞—Ç—å F5 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Challenge
        // –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä—è–µ–º Rate Limit –ü–ï–†–ï–î –ø–æ–∫–∞–∑–æ–º Challenge!
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        $hasCookie = $this->hasValidCookie();
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º Rate Limit (—Å—á–µ—Ç—á–∏–∫–∏ –í–°–ï–ì–î–ê —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è)
        $rateLimitResult = $this->checkRateLimit($ip, $hasCookie);
        $rateLimitExceeded = !$rateLimitResult['allowed'];
        
        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º Burst Detection (—Å—á–µ—Ç—á–∏–∫–∏ –í–°–ï–ì–î–ê —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è)
        $burstDetected = $this->detectBurst($ip, $hasCookie);
        $burstExceeded = $burstDetected && $burstDetected['detected'];
        
        // 3. –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ violations
        if ($rateLimitExceeded) {
            $violations = $this->incrementViolations($ip, 'rate_limit');
            $cookieInfo = $hasCookie ? ' [HAS_COOKIE, x' . ($rateLimitResult['multiplier'] ?? 1) . ']' : ' [NO_COOKIE]';
            error_log("RATE LIMIT EXCEEDED: $ip$cookieInfo | " . $rateLimitResult['reason'] . 
                     " | RL Violations: " . $violations['rate_limit'] . " | Total: " . $violations['total']);
        }
        
        if ($burstExceeded) {
            $violations = $this->incrementViolations($ip, 'burst');
            $cookieInfo = $hasCookie ? ' [HAS_COOKIE, x' . ($burstDetected['multiplier'] ?? 1) . ']' : ' [NO_COOKIE]';
            error_log("BURST DETECTED: $ip$cookieInfo | {$burstDetected['message']}" .
                     " | Burst Violations: " . $violations['burst'] . " | Total: " . $violations['total']);
        }
        
        // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ API
        if ($rateLimitExceeded || $burstExceeded) {
            $violations = $this->getTotalViolations($ip);
            $shouldBlock = $this->shouldBlockViaAPI($violations);
            
            if ($shouldBlock['block']) {
                // –ü–æ—Ä–æ–≥ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç - –±–ª–æ–∫–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ API!
                $blockReason = sprintf(
                    "API block triggered: %s (RL: %d/%d, Burst: %d/%d, Total: %d/%d)",
                    $shouldBlock['reason'],
                    $violations['rate_limit'],
                    $this->rateLimitSettings['rate_limit_api_block_threshold'],
                    $violations['burst'],
                    $this->rateLimitSettings['burst_api_block_threshold'],
                    $violations['total'],
                    $this->rateLimitSettings['combined_api_block_threshold']
                );
                
                error_log("API BLOCK TRIGGERED: $ip | $blockReason");
                
                $this->applyProgressiveBlock($ip, $blockReason, [
                    'rate_limit_result' => $rateLimitResult,
                    'burst_result' => $burstDetected,
                    'violations' => $violations,
                    'trigger' => $shouldBlock['reason']
                ]);
                $this->blockUserHash('API block: ' . $shouldBlock['reason']);
                $this->sendBlockResponse();
            } else {
                // –ü–æ—Ä–æ–≥ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 429 –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å—á–∏—Ç–∞—Ç—å
                if ($rateLimitExceeded) {
                    $this->send429Response($ip, $violations, 'rate_limit', $rateLimitResult);
                } elseif ($burstExceeded) {
                    $this->send429Response($ip, $violations, 'burst', $burstDetected);
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // JS CHALLENGE PROTECTION (v2.7.5: –¢–µ–ø–µ—Ä—å –ü–û–°–õ–ï Rate Limit!)
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å JS Challenge
        // JS Challenge –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ Rate Limit –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω!
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if ($this->jsChallengeSettings['enabled']) {
            $jsChallengeResult = $this->checkJSChallenge($ip);
            
            if ($jsChallengeResult['show_challenge']) {
                error_log("JS CHALLENGE SHOWN: $ip | Reason: {$jsChallengeResult['reason']}");
                $this->showJSChallenge($jsChallengeResult['reason']);
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –î–ï–¢–ï–ö–¶–ò–Ø –ë–û–¢–û–í –ü–û HTTP –ó–ê–ì–û–õ–û–í–ö–ê–ú
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if ($this->headerDetectionSettings['enabled']) {
            $headerCheck = $this->checkSuspiciousHeaders();
            if ($headerCheck['suspicious']) {
                $headerScore = $headerCheck['score'];
                $blockThreshold = $this->headerDetectionSettings['block_score_threshold'];
                $trackingThreshold = $this->headerDetectionSettings['tracking_score_threshold'];
                
                if ($headerScore >= $blockThreshold) {
                    $ajaxInfo = isset($headerCheck['is_ajax']) && $headerCheck['is_ajax'] ? ' [AJAX]' : '';
                    error_log("BOT BLOCKED BY HEADERS: $ip | Score: $headerScore$ajaxInfo | Missing: " . implode(', ', $headerCheck['missing']));
                    $this->applyProgressiveBlock($ip, 'Bot signature detected (missing headers, score: ' . $headerScore . ')');
                    $this->blockUserHash('Bot headers signature');
                    $this->sendBlockResponse();
                }
                
                if ($headerScore >= $trackingThreshold && $headerScore < $blockThreshold) {
                    $ajaxInfo = isset($headerCheck['is_ajax']) && $headerCheck['is_ajax'] ? ' [AJAX]' : '';
                    // $this->enableExtendedTracking($ip, 'Suspicious HTTP headers (score: ' . $headerScore . $ajaxInfo . ')');
                }
            }
        }
        
        // –î–µ—Ç–µ–∫—Ü–∏—è —Å–º–µ–Ω—ã User-Agent
        $uaSwitching = $this->detectUserAgentSwitching($ip);
        if ($uaSwitching && $uaSwitching['detected']) {
            $this->applyProgressiveBlock($ip, 'User-Agent switching detected', $uaSwitching);
            $this->blockUserHash('UA switching');
            if (isset($_COOKIE[$this->cookieName])) {
                $this->blockCookieHash();
            }
            $this->sendBlockResponse();
        }
        
        $hasExtendedTracking = false /* checkExtendedTracking removed */;
        
        if ($hasCookie) {
            $this->trackUserHashActivity();
            
            if ($this->shouldAnalyzeIP($ip) || $hasExtendedTracking) {
                if ($this->analyzeRequest($ip)) {
                    if ($this->isSuspiciousUserAgent($userAgent)) {
                        $this->blockIP($ip, 'Suspicious user agent with valid cookie');
                        $this->blockCookieHash();
                        $this->blockUserHash('Bot with valid cookie');
                    } else {
                        $this->blockUserHash('Browser behavior detected with valid cookie');
                        $this->blockCookieHash();
                    }
                    $this->sendBlockResponse();
                }
            }
            return;
        }
        
        if ($this->shouldAnalyzeIP($ip) || $hasExtendedTracking) {
            if ($this->analyzeRequest($ip)) {
                if ($this->isSuspiciousUserAgent($userAgent)) {
                    $this->blockIP($ip, 'Suspicious user agent detected');
                    if (isset($_COOKIE[$this->cookieName])) {
                        $this->blockCookieHash();
                    }
                    $this->blockUserHash('Bot detected');
                } else {
                    if (!$hasExtendedTracking) {
                        // $this->enableExtendedTracking($ip, 'Suspicious browser behavior');
                    }
                    
                    if (isset($_COOKIE[$this->cookieName])) {
                        $this->blockCookieHash();
                    } else {
                        $this->blockUserHash('Browser behavior detected without cookie');
                    }
                }
                $this->sendBlockResponse();
            }
        }
        
        if (false /* analyzeUserHashBehavior removed */) {
            if ($this->isSuspiciousUserAgent($userAgent)) {
                $this->blockIP($ip, 'Bot behavior confirmed by user hash analysis');
                $this->blockUserHash('Bot confirmed');
                if (isset($_COOKIE[$this->cookieName])) {
                    $this->blockCookieHash();
                }
            } else {
                $this->blockUserHash('Slow bot behavior detected');
                if (isset($_COOKIE[$this->cookieName])) {
                    $this->blockCookieHash();
                }
            }
            
            $this->sendBlockResponse();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ù–û–í–û–ï v2.5: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç cookie –ø–æ—Å–ª–µ N –∑–∞–ø—Ä–æ—Å–æ–≤
        // –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–±–æ—Ç–Ω–µ—Ç—ã —Å —Ä–∞–∑–Ω—ã—Ö IP)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if (!$hasCookie) {
            $trackingData = $this->getUserTrackingData($ip);
            $noCookieThreshold = $this->rateLimitSettings['no_cookie_block_threshold'] ?? 3;
            
            if ($trackingData && ($trackingData['requests'] ?? 0) >= $noCookieThreshold) {
                $requestCount = $trackingData['requests'];
                error_log("NO COOKIE BOT BLOCKED: $ip | Requests without cookie: $requestCount (threshold: $noCookieThreshold)");
                $this->applyProgressiveBlock($ip, "No cookie after $requestCount requests");
                $this->blockUserHash('No cookie bot');
                $this->sendBlockResponse();
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –û–ë–ù–û–í–õ–ï–ù–û v2.5: Slow Bot Detection - —Ç–µ–ø–µ—Ä—å –ë–õ–û–ö–ò–†–£–ï–¢ —Å—Ä–∞–∑—É!
        // –†–∞–Ω—å—à–µ —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–∞–ª extended tracking, —Ç–µ–ø–µ—Ä—å –±–ª–æ–∫–∏—Ä—É–µ—Ç
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        $trackingData = $this->getUserTrackingData($ip);
        if ($trackingData && $this->isPotentialSlowBot($trackingData)) {
            $instantBlock = $this->rateLimitSettings['slow_bot_instant_block'] ?? true;
            
            if ($instantBlock) {
                // v2.5: –ñ—ë—Å—Ç–∫–∏–π —Ä–µ–∂–∏–º - –±–ª–æ–∫–∏—Ä—É–µ–º —Å—Ä–∞–∑—É
                $requestCount = $trackingData['requests'] ?? 0;
                error_log("SLOW BOT BLOCKED: $ip | Requests: $requestCount | Pattern detected");
                $this->applyProgressiveBlock($ip, 'Slow bot pattern detected');
                $this->blockUserHash('Slow bot');
                $this->sendBlockResponse();
            } else {
                // –ú—è–≥–∫–∏–π —Ä–µ–∂–∏–º - —Ç–æ–ª—å–∫–æ extended tracking (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
                if (!$hasExtendedTracking) {
                    // $this->enableExtendedTracking($ip, 'Potential slow bot pattern');
                }
            }
        }
        
        if (!isset($_COOKIE[$this->cookieName])) {
            $this->setVisitorCookie();
            $this->initTracking($ip);
        }
    }
    
    /**
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     * –ù–û–í–´–ô –ú–ï–¢–û–î v2.4: –û—Ç–ø—Ä–∞–≤–∫–∞ 429 –æ—Ç–≤–µ—Ç–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ violations
     * 
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Å–∏–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É 429 —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     */
    private function send429Response($ip, $violations, $type, $details) {
        if (!headers_sent()) {
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø SEO: –ó–∞–ø—Ä–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 429
            // Google/Yandex –ù–ï –î–û–õ–ñ–ù–´ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É!
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            header('X-Robots-Tag: noindex, nofollow');
            http_response_code(429);
            header('Content-Type: text/html; charset=utf-8');
            header('Retry-After: 60');
            header('X-RateLimit-Limit: ' . $this->rateLimitSettings['max_requests_per_minute']);
            header('X-RateLimit-Remaining: 0');
            header('X-Violations-RateLimit: ' . $violations['rate_limit']);
            header('X-Violations-Burst: ' . $violations['burst']);
            header('X-Violations-Total: ' . $violations['total']);
            header('X-Block-Threshold: ' . $this->rateLimitSettings['combined_api_block_threshold']);
        }
        
        $remaining = $this->rateLimitSettings['combined_api_block_threshold'] - $violations['total'];
        $remaining = max(0, $remaining);
        $progressPercent = min(100, ($violations['total'] / $this->rateLimitSettings['combined_api_block_threshold']) * 100);
        
        $html = '<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ============================================================ -->
    <!-- –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø SEO: –ó–∞–ø—Ä–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 429           -->
    <!-- Google/Yandex –ù–ï –î–û–õ–ñ–ù–´ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã!   -->
    <!-- ============================================================ -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="yandex" content="noindex, nofollow">
    <!-- ============================================================ -->
    <title>429 - Too Many Requests</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .icon { font-size: 64px; margin-bottom: 20px; }
        h1 { color: #ff6b6b; margin: 0 0 10px 0; font-size: 28px; }
        .subtitle { color: #aaa; margin-bottom: 30px; }
        .warning-box {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .warning-title { color: #ff6b6b; font-weight: bold; margin-bottom: 10px; }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; flex-wrap: wrap; }
        .stat { text-align: center; padding: 10px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #ff6b6b; }
        .stat-label { font-size: 12px; color: #888; }
        .progress-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #ff6b6b);
            transition: width 0.3s;
        }
        .countdown { font-size: 14px; color: #888; margin-top: 20px; }
        .timer { font-size: 32px; font-weight: bold; color: #4ecdc4; }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">‚ö†Ô∏è</div>
        <h1>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</h1>
        <p class="subtitle">–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤</p>
        
        <div class="warning-box">
            <div class="warning-title">‚ö° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</div>
            <p>–ü—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –≤–∞—à IP –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</p>
            <p><strong>–û—Å—Ç–∞–ª–æ—Å—å –¥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: ' . $remaining . ' –Ω–∞—Ä—É—à–µ–Ω–∏–π</strong></p>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value">' . $violations['rate_limit'] . '</div>
                <div class="stat-label">Rate Limit</div>
            </div>
            <div class="stat">
                <div class="stat-value">' . $violations['burst'] . '</div>
                <div class="stat-label">Burst</div>
            </div>
            <div class="stat">
                <div class="stat-value">' . $violations['total'] . '</div>
                <div class="stat-label">–í—Å–µ–≥–æ</div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" style="width: ' . $progressPercent . '%"></div>
        </div>
        
        <div class="countdown">
            –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑:
            <div class="timer" id="timer">60</div>
        </div>
    </div>
    
    <script>
        let seconds = 60;
        const timer = document.getElementById("timer");
        const interval = setInterval(() => {
            seconds--;
            timer.textContent = seconds;
            if (seconds <= 0) {
                clearInterval(interval);
                location.reload();
            }
        }, 1000);
    </script>
</body>
</html>';
        
        die($html);
    }
    
    /**
     * –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô Global Rate Limit v2.3
     * –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS - —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ (>100 req/sec)
     * 
     * –ë–´–õ–û: 1 –∫–ª—é—á –Ω–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ IP = —Ç—ã—Å—è—á–∏ –∫–ª—é—á–µ–π
     * –°–¢–ê–õ–û: 1 –∫–ª—é—á –Ω–∞ IP —Å–æ —Å–∫–æ–ª—å–∑—è—â–∏–º –æ–∫–Ω–æ–º = –º–∏–Ω–∏–º—É–º –∫–ª—é—á–µ–π
     */
    private function checkGlobalRateLimit($ip) {
        try {
            $currentSecond = time();
            
            // –û–¥–∏–Ω –∫–ª—é—á –Ω–∞ IP –≤–º–µ—Å—Ç–æ –∫–ª—é—á–∞ –Ω–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É!
            $key = $this->globalPrefix . 'grl:' . hash('md5', $ip);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            $data = $this->redis->get($key);
            
            $requests = 0;
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –∏ —Å–µ–∫—É–Ω–¥–∞ —Ç–∞ –∂–µ - –±–µ—Ä—ë–º —Å—á—ë—Ç—á–∏–∫
            if ($data && is_array($data) && isset($data['second']) && (int)$data['second'] === $currentSecond) {
                $requests = (int)($data['requests'] ?? 0);
            }
            
            $requests++;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            $this->redis->setex($key, 5, [
                'requests' => $requests,
                'second' => $currentSecond
            ]);
            
            // –ü–æ—Ä–æ–≥: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É = —è–≤–Ω—ã–π DDoS
            if ($requests > 100) {
                return ['allowed' => false, 'requests' => $requests];
            }
            
            return ['allowed' => true, 'requests' => $requests];
        } catch (Exception $e) {
            return ['allowed' => true, 'requests' => 0];
        }
    }
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î: –ü—Ä–æ–≤–µ—Ä–∫–∞ whitelist –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤
     */
    private function isWhitelistedSearchEngine($ip) {
        try {
            $whitelistKey = $this->rdnsPrefix . 'whitelist:' . hash('md5', $ip);
            return $this->redis->exists($whitelistKey);
        } catch (Exception $e) {
            return false;
        }
    }
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ whitelist –ø–æ—Å–ª–µ rDNS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
     */
    private function addToSearchEngineWhitelist($ip, $userAgent) {
        try {
            $whitelistKey = $this->rdnsPrefix . 'whitelist:' . hash('md5', $ip);
            $data = [
                'ip' => $ip,
                'user_agent' => $userAgent,
                'verified_at' => time()
            ];
            // –ö–µ—à–∏—Ä—É–µ–º –Ω–∞ 24 —á–∞—Å–∞ - –ø–æ–∏—Å–∫–æ–≤–∏–∫–∏ –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ IP
            $this->redis->setex($whitelistKey, 86400, $data);
        } catch (Exception $e) {
            error_log("Error adding to search engine whitelist: " . $e->getMessage());
        }
    }
    
    /**
     * –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è Redis (–ë–ï–ó —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è)
     */
    private function manageTrackedIPs() {
        try {
            // –®–ê–ì 1: –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –Ω—É–∂–Ω–∞ –ª–∏ –æ—á–∏—Å—Ç–∫–∞ –≤–æ–æ–±—â–µ
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ)
            $countCacheKey = $this->globalPrefix . 'tracked_count_cache';
            $cachedCount = $this->redis->get($countCacheKey);
            
            // –ï—Å–ª–∏ –∫–µ—à –ø—É—Å—Ç–æ–π –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª (–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É)
            if ($cachedCount === false) {
                $approxCount = $this->getApproximateTrackedCount();
                $this->redis->setex($countCacheKey, 60, $approxCount);
                $cachedCount = $approxCount;
            }
            
            // –ï—Å–ª–∏ –¥–∞–ª–µ–∫–æ –æ—Ç –ª–∏–º–∏—Ç–∞ - –≤—ã—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É (–±—ã—Å—Ç—Ä–æ!)
            if ($cachedCount < $this->globalProtectionSettings['cleanup_threshold']) {
                return 0;
            }
            
            // –®–ê–ì 2: –û—á–∏—Å—Ç–∫–∞ –Ω—É–∂–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º SCAN (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç Redis)
            $cleaned = 0;
            $maxCleanupTime = $this->globalProtectionSettings['max_cleanup_time_ms'] / 1000; // –≤ —Å–µ–∫—É–Ω–¥—ã
            $startTime = microtime(true);
            $batchSize = $this->globalProtectionSettings['cleanup_batch_size'];
            
            // SCAN –∏—Ç–µ—Ä–∞—Ç–æ—Ä (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–ª—è production)
            $iterator = null;
            // –í–ê–ñ–ù–û: OPT_PREFIX –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º SCAN - —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
            $pattern = $this->redisPrefix . $this->trackingPrefix . 'ip:*';
            
            do {
                // SCAN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ä—Ü–∏—è–º–∏, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è Redis
                $keys = $this->redis->scan($iterator, $pattern, 50); // 50 –∫–ª—é—á–µ–π –∑–∞ —Ä–∞–∑
                
                if ($keys === false) break;
                
                foreach ($keys as $key) {
                    // –õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ - –ø—Ä–µ—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –¥–æ–ª–≥–æ
                    if ((microtime(true) - $startTime) > $maxCleanupTime) {
                        break 2;
                    }
                    
                    // –õ–∏–º–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                    if ($cleaned >= $batchSize) {
                        break 2;
                    }
                    
                    // SCAN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å, —É–±–∏—Ä–∞–µ–º redisPrefix –¥–ª—è –∫–æ–º–∞–Ω–¥ Redis
                    $keyWithoutPrefix = str_replace($this->redisPrefix, '', $key);
                    
                    // –ë–´–°–¢–†–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞: —Å–º–æ—Ç—Ä–∏–º —Ç–æ–ª—å–∫–æ TTL (–±–µ–∑ GET –¥–∞–Ω–Ω—ã—Ö)
                    $ttl = $this->redis->ttl($keyWithoutPrefix);
                    
                    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –£–¥–∞–ª—è–µ–º –∫–ª—é—á–∏ —Å TTL < 10 –º–∏–Ω—É—Ç (—Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫—É—Ç)
                    if ($ttl > 0 && $ttl < 600) {
                        $this->redis->del($keyWithoutPrefix);
                        $this->decrementTrackedCounter();
                        $cleaned++;
                        continue;
                    }
                    
                    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –î–ª—è —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                    if ($ttl === -1 || $ttl > 3600) {
                        $data = $this->redis->get($keyWithoutPrefix);
                        
                        if ($data && isset($data['first_seen'], $data['requests'])) {
                            $age = time() - $data['first_seen'];
                            
                            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ (>2 —á–∞—Å–∞) —Å –Ω–∏–∑–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é (<10 –∑–∞–ø—Ä–æ—Å–æ–≤)
                            if ($age > 7200 && $data['requests'] < 10) {
                                $this->redis->del($keyWithoutPrefix);
                                $this->decrementTrackedCounter();
                                $cleaned++;
                            }
                            // –£–¥–∞–ª—è–µ–º –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã–µ (>6 —á–∞—Å–æ–≤) –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                            elseif ($age > 21600) {
                                $this->redis->del($keyWithoutPrefix);
                                $this->decrementTrackedCounter();
                                $cleaned++;
                            }
                        }
                    }
                }
                
            } while ($iterator !== 0 && $iterator !== null);
            
            // –®–ê–ì 3: –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
            if ($cleaned > 0) {
                $newCount = max(0, $cachedCount - $cleaned);
                $this->redis->setex($countCacheKey, 60, $newCount);
                error_log("Redis cleanup: removed $cleaned tracked IPs (approx " . 
                         round((microtime(true) - $startTime) * 1000, 2) . "ms)");
            }
            
            return $cleaned;
            
        } catch (Exception $e) {
            error_log("Error in manageTrackedIPs: " . $e->getMessage());
            return 0;
        }
    }
    
    /**
     * –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ tracked IP
     */
    private function getApproximateTrackedCount() {
        try {
            // –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç/–¥–µ–∫—Ä–µ–º–µ–Ω—Ç)
            $counterKey = $this->globalPrefix . 'tracked_counter';
            $count = $this->redis->get($counterKey);
            
            if ($count !== false) {
                return (int)$count;
            }
            
            // –í–∞—Ä–∏–∞–Ω—Ç 2: –¢–æ—á–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ —Å–±—Ä–æ—à–µ–Ω)
            $iterator = null;
            $counted = 0;
            $maxToCount = 1000; // –°—á–∏—Ç–∞–µ–º –º–∞–∫—Å–∏–º—É–º 1000 –¥–ª—è –æ—Ü–µ–Ω–∫–∏
            
            while ($counted < $maxToCount) {
                // –í–ê–ñ–ù–û: OPT_PREFIX –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º SCAN - —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
                $keys = $this->redis->scan($iterator, $this->redisPrefix . $this->trackingPrefix . 'ip:*', 100);
                if ($keys === false) break;
                
                $counted += count($keys);
                
                if ($iterator === 0 || $iterator === null) break;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å—á–µ—Ç—á–∏–∫
            $this->redis->setex($counterKey, 300, $counted); // 5 –º–∏–Ω—É—Ç –∫–µ—à
            
            return $counted;
            
        } catch (Exception $e) {
            error_log("Error getting tracked count: " . $e->getMessage());
            return 0;
        }
    }
    
    /**
     * –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞ tracked IP (–≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏)
     */
    private function incrementTrackedCounter() {
        try {
            $counterKey = $this->globalPrefix . 'tracked_counter';
            $this->redis->incr($counterKey);
            $this->redis->expire($counterKey, 3600); // 1 —á–∞—Å
        } catch (Exception $e) {
            // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ—Å—Ç–æ —Å—á–µ—Ç—á–∏–∫ –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è
        }
    }
    
    /**
     * –î–µ–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞ tracked IP (–≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏)
     */
    private function decrementTrackedCounter() {
        try {
            $counterKey = $this->globalPrefix . 'tracked_counter';
            $this->redis->decr($counterKey);
        } catch (Exception $e) {
            // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
        }
    }
    
    private function shouldAnalyzeIP($ip) {
        try {
            $trackingKey = $this->trackingPrefix . 'ip:' . hash('md5', $ip);
            $data = $this->redis->get($trackingKey);
            
            if ($data) {
                $requests = $data['requests'] ?? 0;
                $timeSpent = time() - ($data['first_seen'] ?? time());
                $suspicious_ua = $this->isSuspiciousUserAgent($_SERVER['HTTP_USER_AGENT'] ?? '');
                
                if ($suspicious_ua) {
                    return true;
                }
                
                if ($timeSpent > 1800 && $requests >= 5) {
                    return true;
                }
                
                if ($requests > 5) {
                    return true;
                }
                
                if ($timeSpent > 0 && $requests >= $this->slowBotSettings['min_requests_for_analysis']) {
                    $requestsPerMinute = ($requests * 60) / $timeSpent;
                    if ($requestsPerMinute > 40) {
                        return true;
                    }
                }
                
                if (isset($data['request_times']) && count($data['request_times']) >= 7) {
                    $recentTimes = array_slice($data['request_times'], -7);
                    $timeSpan = end($recentTimes) - reset($recentTimes);
                    if ($timeSpan <= 20) {
                        return true;
                    }
                }
            }
            
            return false;
        } catch (Exception $e) {
            error_log("Error in shouldAnalyzeIP: " . $e->getMessage());
            return false;
        }
    }
    
    private function isSuspiciousUserAgent($userAgent) {
        $suspiciousPatterns = [
            'curl', 'wget', 'python', 'java/', 'go-http', 'node-fetch', 
            'libwww', 'scrapy', 'requests', 'urllib', 'httpie', 'bot', 'spider',
            'crawler', 'scraper', 'postman', 'insomnia'
        ];
        
        $userAgent = strtolower($userAgent);
        
        foreach ($suspiciousPatterns as $pattern) {
            if (strpos($userAgent, $pattern) !== false) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
     * –†–µ–∞–ª—å–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –º–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –±–æ—Ç—ã - –º–∞–ª–æ
     * 
     * @return array ['suspicious' => bool, 'score' => int, 'missing' => array]
     */
    private function checkSuspiciousHeaders() {
        $score = 0;
        $missing = [];
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï –î–õ–Ø AJAX/FETCH –ó–ê–ü–†–û–°–û–í
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AJAX –∑–∞–ø—Ä–æ—Å—ã (–ø–æ–∏—Å–∫ DLE, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ —Ç.–¥.) –∏–º–µ—é—Ç –¥—Ä—É–≥–∏–µ
        // –∑–∞–≥–æ–ª–æ–≤–∫–∏ —á–µ–º –æ–±—ã—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - —ç—Ç–æ –ù–û–†–ú–ê–õ–¨–ù–û, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∏—Ö
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // –ú–µ—Ç–æ–¥ 1: XMLHttpRequest (jQuery, —Å—Ç–∞—Ä—ã–π JS)
        $isXHR = !empty($_SERVER['HTTP_X_REQUESTED_WITH']) && 
                 strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest';
        
        // –ú–µ—Ç–æ–¥ 2: Sec-Fetch-Mode (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã)
        // cors, same-origin, no-cors = fetch/AJAX –∑–∞–ø—Ä–æ—Å—ã
        // navigate = –æ–±—ã—á–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
        $secFetchMode = $_SERVER['HTTP_SEC_FETCH_MODE'] ?? '';
        $isModernAjax = in_array($secFetchMode, ['cors', 'same-origin', 'no-cors']);
        
        // –ú–µ—Ç–æ–¥ 3: Sec-Fetch-Dest (—Ç–∏–ø –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞)
        // empty = fetch/AJAX, document = —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        $secFetchDest = $_SERVER['HTTP_SEC_FETCH_DEST'] ?? '';
        $isFetchRequest = ($secFetchDest === 'empty');
        
        // –ú–µ—Ç–æ–¥ 4: Accept –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ JSON/XML (API –∑–∞–ø—Ä–æ—Å)
        $accept = $_SERVER['HTTP_ACCEPT'] ?? '';
        $isApiRequest = (stripos($accept, 'application/json') !== false || 
                        stripos($accept, 'application/xml') !== false ||
                        stripos($accept, 'text/javascript') !== false);
        
        // –ï—Å–ª–∏ —ç—Ç–æ AJAX/Fetch –∑–∞–ø—Ä–æ—Å –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞ - –ø—Ä–∏–º–µ–Ω—è–µ–º –ú–Ø–ì–ö–ò–ï –ø—Ä–æ–≤–µ—Ä–∫–∏
        if ($isXHR || $isModernAjax || $isFetchRequest || $isApiRequest) {
            // –î–ª—è AJAX –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –≤–µ—â–∏
            $userAgent = $_SERVER['HTTP_USER_AGENT'] ?? '';
            
            // –ù–µ—Ç User-Agent –≤–æ–æ–±—â–µ - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –¥–∞–∂–µ –¥–ª—è AJAX
            if (empty($userAgent)) {
                $score += 3;
                $missing[] = 'NO_USER_AGENT_AJAX';
            }
            
            // –ù–µ—Ç Accept-Language - –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ
            if (empty($_SERVER['HTTP_ACCEPT_LANGUAGE'])) {
                $score += 1;
                $missing[] = 'NO_LANG_AJAX';
            }
            
            // –î–ª—è AJAX –ø–æ—Ä–æ–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã—à–µ
            return [
                'suspicious' => $score >= 4,  // –¢–æ–ª—å–∫–æ –ø—Ä–∏ score >= 4 –¥–ª—è AJAX
                'score' => $score,
                'missing' => $missing,
                'is_ajax' => true
            ];
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –ü–û–õ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –î–õ–Ø –û–ë–´–ß–ù–´–• –ó–ê–ü–†–û–°–û–í (–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –î–û–õ–ñ–ù–´ –±—ã—Ç—å —É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
        $requiredHeaders = [
            'HTTP_ACCEPT_LANGUAGE' => 3,     // –í—Å–µ –±—Ä–∞—É–∑–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —è–∑—ã–∫
            'HTTP_ACCEPT_ENCODING' => 2,     // gzip, deflate, br
            'HTTP_ACCEPT' => 1,              // text/html,application/xhtml+xml,...
        ];
        
        foreach ($requiredHeaders as $header => $penalty) {
            if (empty($_SERVER[$header])) {
                $score += $penalty;
                $missing[] = $header;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Accept - –±–æ—Ç—ã —á–∞—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Ç–æ–ª—å–∫–æ "*/*"
        if ($accept === '*/*' || strlen($accept) < 10) {
            $score += 2;
            $missing[] = 'BAD_ACCEPT';
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Accept-Language - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π —è–∑—ã–∫
        $acceptLang = $_SERVER['HTTP_ACCEPT_LANGUAGE'] ?? '';
        if (!empty($acceptLang)) {
            // –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–¥ —è–∑—ã–∫–∞ —Ç–∏–ø–∞ en, ru, uk –∏ —Ç.–¥.
            if (!preg_match('/^[a-z]{2}(-[A-Z]{2})?(,|;|$)/i', $acceptLang)) {
                $score += 2;
                $missing[] = 'INVALID_LANG';
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Accept-Encoding - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç gzip
        $acceptEnc = $_SERVER['HTTP_ACCEPT_ENCODING'] ?? '';
        if (!empty($acceptEnc) && stripos($acceptEnc, 'gzip') === false) {
            $score += 1;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Connection –∑–∞–≥–æ–ª–æ–≤–∫–∞
        $connection = $_SERVER['HTTP_CONNECTION'] ?? '';
        if (empty($connection)) {
            $score += 1;
            $missing[] = 'NO_CONNECTION';
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ User-Agent
        $userAgent = $_SERVER['HTTP_USER_AGENT'] ?? '';
        if (empty($userAgent)) {
            $score += 4;  // –ù–µ—Ç User-Agent = –ø–æ—á—Ç–∏ —Ç–æ—á–Ω–æ –±–æ—Ç
            $missing[] = 'NO_USER_AGENT';
        } elseif (strlen($userAgent) < 20) {
            $score += 2;  // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π UA
            $missing[] = 'SHORT_USER_AGENT';
        }
        
        // Sec-Fetch-* –∑–∞–≥–æ–ª–æ–≤–∫–∏ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã Chrome/Firefox/Edge)
        // –ò—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏—é
        $secFetchSite = $_SERVER['HTTP_SEC_FETCH_SITE'] ?? '';
        
        // –ï—Å–ª–∏ UA –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ —ç—Ç–æ Chrome 80+ –Ω–æ –Ω–µ—Ç Sec-Fetch = –±–æ—Ç
        if (preg_match('/Chrome\/(\d+)/', $userAgent, $matches)) {
            $chromeVersion = (int)$matches[1];
            if ($chromeVersion >= 80 && empty($secFetchMode)) {
                $score += 3;
                $missing[] = 'NO_SEC_FETCH_CHROME';
            }
        }
        
        // Upgrade-Insecure-Requests (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü)
        $upgradeInsecure = $_SERVER['HTTP_UPGRADE_INSECURE_REQUESTS'] ?? '';
        if (empty($upgradeInsecure) && !empty($userAgent) && 
            (stripos($userAgent, 'chrome') !== false || stripos($userAgent, 'firefox') !== false)) {
            $score += 1;
        }
        
        return [
            'suspicious' => $score >= 4,
            'score' => $score,
            'missing' => $missing,
            'is_ajax' => false
        ];
    }
    
    /**
     * –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
     * –ë–æ—Ç—ã –æ–±—ã—á–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ HTML, –Ω–µ –∑–∞–≥—Ä—É–∂–∞—è —Ä–µ—Å—É—Ä—Å—ã
     */
    // analyzeRequestTypes() removed in optimization (saved 35 lines)
    
    private function isLegitimateBot($userAgent) {
        $legitimateBots = [
            'uptimerobot', 'pingdom', 'statuscake', 'site24x7',
            'cloudflare', 'fastly', 'keycdn', 'meta-externalagent',
            'oai-searchbot', 'chatgpt-user', 'gptbot', 'claude-user', 'claudeBot', 'telegram', 'hosttracker', 'perplexity-user'
        ];
        
        $userAgent = strtolower($userAgent);
        
        foreach ($legitimateBots as $bot) {
            if (strpos($userAgent, $bot) !== false) {
                return true;
            }
        }
        
        return false;
    }
    
    private function logBotVisit($ip, $userAgent, $type) {
        try {
            $logEntry = [
                'timestamp' => date('Y-m-d H:i:s'),
                'ip' => $ip,
                'user_agent' => $userAgent,
                'type' => $type,
                'uri' => $_SERVER['REQUEST_URI'] ?? ''
            ];
            
            $logKey = 'logs:legitimate_bots:' . date('Y-m-d');
            $this->redis->lpush($logKey, $logEntry);
            $this->redis->expire($logKey, $this->ttlSettings['logs']);
            $this->redis->ltrim($logKey, 0, 999);
        } catch (Exception $e) {
            error_log("Error logging bot visit: " . $e->getMessage());
        }
    }
    
    private function isVerifiedSearchEngine($ip, $userAgent) {
        $detectedEngine = null;
        $engineConfig = null;
        foreach ($this->allowedSearchEngines as $engine => $config) {
            foreach ($config['user_agent_patterns'] as $pattern) {
                if (stripos($userAgent, $pattern) !== false) {
                    $detectedEngine = $engine;
                    $engineConfig = $config;
                    break 2;
                }
            }
        }
        
        if (!$detectedEngine || !$engineConfig) {
            return false;
        }
        
        return $this->verifySearchEngineByRDNS($ip, $engineConfig);
    }
    
    private function verifySearchEngineByRDNS($ip, $engineConfig) {
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–º–∞—Å—Å–∏–≤ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤) –∏ –Ω–æ–≤–æ–≥–æ (–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥)
        if (isset($engineConfig['rdns_patterns'])) {
            $allowedPatterns = $engineConfig['rdns_patterns'];
            $skipForwardVerification = $engineConfig['skip_forward_verification'] ?? false;
        } else {
            // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - –ø—Ä–æ—Å—Ç–æ –º–∞—Å—Å–∏–≤ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
            $allowedPatterns = $engineConfig;
            $skipForwardVerification = false;
        }
        
        try {
            $normalizedIP = $this->normalizeIP($ip);
            $cacheKey = $this->rdnsPrefix . 'cache:' . hash('md5', $normalizedIP);
            
            // –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à (–¥–æ rate limit –ø—Ä–æ–≤–µ—Ä–∫–∏!)
            $cached = $this->redis->get($cacheKey);
            if ($cached !== false) {
                return $cached['verified'];
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit –¥–ª—è rDNS
            $rdnsLimitCheck = $this->checkRDNSRateLimit();
            if (!$rdnsLimitCheck['allowed']) {
                // –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–µ—à–∞
                if ($this->rdnsLimitSettings['rdns_on_limit_action'] === 'block') {
                    error_log("rDNS rate limit exceeded, blocking IP: $normalizedIP");
                    return false;
                }
                
                // –ù–û–í–û–ï: –î–æ–≤–µ—Ä—è–µ–º UA –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
                if (!empty($this->rdnsLimitSettings['trust_search_engine_ua_on_limit'])) {
                    error_log("rDNS rate limit exceeded, trusting search engine UA for: $normalizedIP");
                    // –ö–µ—à–∏—Ä—É–µ–º –∫–∞–∫ "—É—Å–ª–æ–≤–Ω–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" —Å –∫–æ—Ä–æ—Ç–∫–∏–º TTL
                    $this->redis->setex($cacheKey, 300, [
                        'ip' => $normalizedIP,
                        'hostname' => 'trusted_by_ua',
                        'verified' => true,
                        'timestamp' => time(),
                        'trusted_reason' => 'rdns_limit_exceeded'
                    ]);
                    return true;
                }
                
                // 'skip' - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
                error_log("rDNS rate limit exceeded, skipping verification for: $normalizedIP");
                return false;
            }
            
            $verified = false;
            $hostname = '';
            $error = '';
            
            try {
                $hostname = $this->getHostnameWithTimeout($normalizedIP, 2);
                
                if ($hostname && $hostname !== $normalizedIP) {
                    $hostnameMatches = false;
                    foreach ($allowedPatterns as $pattern) {
                        if ($this->matchesDomainPattern($hostname, $pattern)) {
                            $hostnameMatches = true;
                            break;
                        }
                    }
                    
                    if ($hostnameMatches) {
                        // –ï—Å–ª–∏ skip_forward_verification - –¥–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ rDNS
                        if ($skipForwardVerification) {
                            $verified = true;
                            error_log("rDNS verified (forward skip): $normalizedIP -> $hostname");
                        } else {
                            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: forward lookup
                            $forwardIPs = $this->getIPsWithTimeout($hostname, 2);
                            
                            if ($forwardIPs && $this->ipInArray($normalizedIP, $forwardIPs)) {
                                $verified = true;
                            }
                        }
                    }
                }
                
            } catch (Exception $e) {
                $error = $e->getMessage();
            }
            
            $cacheData = [
                'ip' => $normalizedIP,
                'hostname' => $hostname,
                'verified' => $verified,
                'timestamp' => time(),
                'error' => $error,
                'skip_forward' => $skipForwardVerification
            ];
            
            // –†–∞–∑–Ω—ã–π TTL –¥–ª—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            $cacheTTL = $verified ? 
                $this->rdnsLimitSettings['rdns_cache_ttl'] : 
                $this->rdnsLimitSettings['rdns_negative_cache_ttl'];
            
            $this->redis->setex($cacheKey, $cacheTTL, $cacheData);
            
            return $verified;
        } catch (Exception $e) {
            error_log("Error in rDNS verification: " . $e->getMessage());
            return false;
        }
    }
    
    private function getHostnameWithTimeout($ip, $timeoutSec = 2) {
        $originalTimeout = ini_get('default_socket_timeout');
        ini_set('default_socket_timeout', $timeoutSec);
        
        try {
            $hostname = @gethostbyaddr($ip);
            ini_set('default_socket_timeout', $originalTimeout);
            return ($hostname !== $ip) ? $hostname : false;
        } catch (Exception $e) {
            ini_set('default_socket_timeout', $originalTimeout);
            return false;
        }
    }
    
    private function getIPsWithTimeout($hostname, $timeoutSec = 2) {
        $originalTimeout = ini_get('default_socket_timeout');
        ini_set('default_socket_timeout', $timeoutSec);
        
        $allIPs = [];
        
        try {
            $ipv4List = @gethostbynamel($hostname);
            if ($ipv4List) {
                $allIPs = array_merge($allIPs, $ipv4List);
            }
            
            if (function_exists('dns_get_record')) {
                $records = @dns_get_record($hostname, DNS_AAAA);
                if ($records) {
                    foreach ($records as $record) {
                        if (isset($record['ipv6'])) {
                            $allIPs[] = $this->normalizeIPv6($record['ipv6']);
                        }
                    }
                }
            }
            
            ini_set('default_socket_timeout', $originalTimeout);
            return array_unique($allIPs);
            
        } catch (Exception $e) {
            ini_set('default_socket_timeout', $originalTimeout);
            return [];
        }
    }
    
    private function matchesDomainPattern($hostname, $pattern) {
        $hostname = strtolower(trim($hostname));
        $pattern = strtolower(trim($pattern));
        
        if ($hostname === $pattern) {
            return true;
        }
        
        if (strpos($pattern, '.') === 0) {
            return substr($hostname, -strlen($pattern)) === $pattern;
        }
        
        $fullPattern = '.' . $pattern;
        return substr($hostname, -strlen($fullPattern)) === $fullPattern;
    }
    
    private function ipInArray($needle, $haystack) {
        $normalizedNeedle = $this->normalizeIP($needle);
        
        foreach ($haystack as $ip) {
            if ($this->normalizeIP($ip) === $normalizedNeedle) {
                return true;
            }
        }
        
        return false;
    }
    
    private function logSearchEngineVisit($ip, $userAgent) {
        try {
            $logEntry = [
                'timestamp' => date('Y-m-d H:i:s'),
                'ip' => $ip,
                'user_agent' => $userAgent,
                'uri' => $_SERVER['REQUEST_URI'] ?? '',
                'hostname' => @gethostbyaddr($ip)
            ];
            
            $logKey = 'logs:search_engines:' . date('Y-m-d');
            $this->redis->lpush($logKey, $logEntry);
            $this->redis->expire($logKey, $this->ttlSettings['logs']);
            $this->redis->ltrim($logKey, 0, 999);
        } catch (Exception $e) {
            error_log("Error logging search engine visit: " . $e->getMessage());
        }
    }
    
    private function getRealIP() {
        $ipHeaders = [
            'HTTP_CF_CONNECTING_IP',
            'HTTP_X_REAL_IP',
            'HTTP_X_FORWARDED_FOR',
            'HTTP_X_FORWARDED',
            'HTTP_X_CLUSTER_CLIENT_IP',
            'HTTP_FORWARDED_FOR',
            'HTTP_FORWARDED',
            'REMOTE_ADDR'
        ];
        
        foreach ($ipHeaders as $header) {
            if (!empty($_SERVER[$header])) {
                $ips = explode(',', $_SERVER[$header]);
                $ip = trim($ips[0]);
                
                if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {
                    $ip = $this->normalizeIPv6($ip);
                }
                
                if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) {
                    if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) {
                        return $ip;
                    }
                } elseif (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {
                    if (!$this->isPrivateIPv6($ip)) {
                        return $ip;
                    }
                }
            }
        }
        
        $remoteAddr = $_SERVER['REMOTE_ADDR'] ?? 'unknown';
        if ($remoteAddr !== 'unknown' && filter_var($remoteAddr, FILTER_VALIDATE_IP)) {
            if (filter_var($remoteAddr, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) {
                return $this->normalizeIPv6($remoteAddr);
            }
            return $remoteAddr;
        }
        
        return 'unknown';
    }
    
    private function isPrivateIPv6($ip) {
        $privateRanges = [
            '::1',
            'fe80::/10',
            'fc00::/7',
            'ff00::/8',
        ];
        
        foreach ($privateRanges as $range) {
            if ($this->ipInRange($ip, $range)) {
                return true;
            }
        }
        
        return false;
    }
    
    private function ipInRange($ip, $range) {
        if (strpos($range, '/') === false) {
            return $ip === $range;
        }
        
        list($subnet, $prefix) = explode('/', $range);
        
        $ipBin = @inet_pton($ip);
        $subnetBin = @inet_pton($subnet);
        
        if ($ipBin === false || $subnetBin === false) {
            return false;
        }
        
        $ipFamily = filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6) ? AF_INET6 : AF_INET;
        $subnetFamily = filter_var($subnet, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6) ? AF_INET6 : AF_INET;
        
        if ($ipFamily !== $subnetFamily) {
            return false;
        }
        
        $maxBits = $ipFamily === AF_INET6 ? 128 : 32;
        $prefix = max(0, min($maxBits, (int)$prefix));
        
        $bytesToCheck = intval($prefix / 8);
        $bitsInLastByte = $prefix % 8;
        
        for ($i = 0; $i < $bytesToCheck; $i++) {
            if ($ipBin[$i] !== $subnetBin[$i]) {
                return false;
            }
        }
        
        if ($bitsInLastByte > 0) {
            $mask = 0xFF << (8 - $bitsInLastByte);
            if ((ord($ipBin[$bytesToCheck]) & $mask) !== (ord($subnetBin[$bytesToCheck]) & $mask)) {
                return false;
            }
        }
        
        return true;
    }
    
    private function isStaticFile() {
        $uri = $_SERVER['REQUEST_URI'] ?? '';
        $staticExtensions = [
            '.css', '.js', '.jpg', '.jpeg', '.png', '.gif', '.ico', '.svg', 
            '.woff', '.woff2', '.ttf', '.eot', '.otf', '.webp', '.avif',
            '.pdf', '.zip', '.mp4', '.webm', '.mp3', '.wav', '.txt'
        ];
        
        foreach ($staticExtensions as $ext) {
            if (substr($uri, -strlen($ext)) === $ext) {
                return true;
            }
        }
        return false;
    }
    
    private function hasValidCookie() {
        if (!isset($_COOKIE[$this->cookieName])) {
            return false;
        }
        
        $data = json_decode($_COOKIE[$this->cookieName], true);
        if (!$data || !isset($data['hash'], $data['time'])) {
            return false;
        }
        
        if (time() - $data['time'] > $this->cookieLifetime) {
            return false;
        }
        
        $expected = hash('sha256', $data['time'] . ($_SERVER['HTTP_USER_AGENT'] ?? '') . $this->secretKey);
        return hash_equals($expected, $data['hash']);
    }
    
    private function setVisitorCookie() {
        try {
            $time = time();
            $hash = hash('sha256', $time . ($_SERVER['HTTP_USER_AGENT'] ?? '') . $this->secretKey);
            $cookieData = json_encode(['time' => $time, 'hash' => $hash]);
            
            $secure = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off';
            setcookie($this->cookieName, $cookieData, time() + $this->cookieLifetime, '/', '', $secure, true);
            $_COOKIE[$this->cookieName] = $cookieData;
        } catch (Exception $e) {
            error_log("Error setting visitor cookie: " . $e->getMessage());
        }
    }
    
    private function initTracking($ip) {
        try {
            $trackingKey = $this->trackingPrefix . 'ip:' . hash('md5', $ip);
            $existing = $this->redis->get($trackingKey);
            
            if ($existing) {
                $existing['requests']++;
                $existing['pages'][] = parse_url($_SERVER['REQUEST_URI'] ?? '', PHP_URL_PATH);
                $existing['user_agents'][] = $_SERVER['HTTP_USER_AGENT'] ?? '';
                $existing['user_agents'] = array_unique($existing['user_agents']);
                $existing['request_times'][] = time();
                $existing['real_ip'] = $ip;
                
                if (count($existing['request_times']) > 25) {
                    $existing['request_times'] = array_slice($existing['request_times'], -25);
                }
                if (count($existing['pages']) > 40) {
                    $existing['pages'] = array_slice($existing['pages'], -40);
                }
                if (count($existing['user_agents']) > 5) {
                    $existing['user_agents'] = array_slice($existing['user_agents'], -5);
                }
                
                $this->redis->setex($trackingKey, $this->ttlSettings['tracking_ip'], $existing);
            } else {
                // –ù–û–í–ê–Ø –∑–∞–ø–∏—Å—å - –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫
                $data = [
                    'first_seen' => time(),
                    'requests' => 1,
                    'pages' => [parse_url($_SERVER['REQUEST_URI'] ?? '', PHP_URL_PATH)],
                    'user_agents' => [$_SERVER['HTTP_USER_AGENT'] ?? ''],
                    'headers' => $this->collectHeaders(),
                    'session_id' => 'no_session',
                    'request_times' => [time()],
                    'real_ip' => $ip
                ];
                
                $this->redis->setex($trackingKey, $this->ttlSettings['tracking_ip'], $data);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ tracked IP
                $this->incrementTrackedCounter();
            }
        } catch (Exception $e) {
            error_log("Error in initTracking: " . $e->getMessage());
        }
    }
    
    private function collectHeaders() {
        $headers = [];
        $importantHeaders = [
            'HTTP_USER_AGENT', 'HTTP_ACCEPT', 'HTTP_ACCEPT_LANGUAGE', 
            'HTTP_ACCEPT_ENCODING', 'HTTP_REFERER', 'HTTP_X_FORWARDED_FOR',
            'HTTP_CF_CONNECTING_IP', 'HTTP_X_REAL_IP', 'REMOTE_ADDR'
        ];
        
        foreach ($importantHeaders as $header) {
            if (isset($_SERVER[$header])) {
                $headers[$header] = $_SERVER[$header];
            }
        }
        return $headers;
    }
    
    private function blockCookieHash() {
        try {
            if (!isset($_COOKIE[$this->cookieName])) {
                return;
            }
            
            $data = json_decode($_COOKIE[$this->cookieName], true);
            if (!$data || !isset($data['hash'])) {
                return;
            }
            
            $blockKey = $this->cookiePrefix . 'blocked:' . hash('md5', $data['hash']);
            $blockData = [
                'cookie_hash' => $data['hash'],
                'blocked_at' => time(),
                'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
                'uri' => $_SERVER['REQUEST_URI'] ?? '',
                'session_id' => 'no_session',
                'ip' => $this->getRealIP()
            ];
            
            $this->redis->setex($blockKey, $this->ttlSettings['cookie_blocked'], $blockData);
            
            error_log("Bot blocked [COOKIE]: " . substr($data['hash'], 0, 8) . " | IP: " . $this->getRealIP());
        } catch (Exception $e) {
            error_log("Error blocking cookie hash: " . $e->getMessage());
        }
    }
    
    private function isCookieBlocked() {
        try {
            if (!isset($_COOKIE[$this->cookieName])) {
                return false;
            }
            
            $data = json_decode($_COOKIE[$this->cookieName], true);
            if (!$data || !isset($data['hash'])) {
                return false;
            }
            
            $blockKey = $this->cookiePrefix . 'blocked:' . hash('md5', $data['hash']);
            return $this->redis->exists($blockKey);
        } catch (Exception $e) {
            error_log("Error checking cookie block: " . $e->getMessage());
            return false;
        }
    }
    
    // isMobileDevice() removed in optimization (saved 24 lines)
    
    private function analyzeRequest($ip) {
        try {
            $trackingKey = $this->trackingPrefix . 'ip:' . hash('md5', $ip);
            $data = $this->redis->get($trackingKey);
            
            if (!$data) {
                return false;
            }
            
            $score = 0;
            $currentUA = $_SERVER['HTTP_USER_AGENT'] ?? '';
            $isMobile = false /* isMobileDevice removed */;
            
            $blockThreshold = $isMobile ? 20 : 18;
            
            if ($this->isSuspiciousUserAgent($currentUA)) {
                $score += $isMobile ? 15 : 20;
            }
            
            $requests = $data['requests'] ?? 0;
            $timeSpent = time() - ($data['first_seen'] ?? time());
            
            if ($timeSpent > 0) {
                $requestsPerMinute = ($requests * 60) / $timeSpent;
                
                if ($isMobile) {
                    if ($requestsPerMinute > 180) $score += 12;
                    elseif ($requestsPerMinute > 120) $score += 8;
                    elseif ($requestsPerMinute > 80) $score += 4;
                } else {
                    if ($requestsPerMinute > 150) $score += 12;
                    elseif ($requestsPerMinute > 100) $score += 8;
                    elseif ($requestsPerMinute > 60) $score += 4;
                }
            }
            
            $cookieLimit = $isMobile ? 35 : 30;
            if ($requests > $cookieLimit && !isset($_COOKIE[$this->cookieName])) {
                $score += $isMobile ? 3 : 4;
            }
            
            $currentHeaders = $this->collectHeaders();
            
            if (!isset($currentHeaders['HTTP_ACCEPT']) || $currentHeaders['HTTP_ACCEPT'] === '*/*') {
                $score += $isMobile ? 1 : 2;
            }
            if (!isset($currentHeaders['HTTP_ACCEPT_LANGUAGE'])) {
                $score += $isMobile ? 1 : 2;
            }
            if (!isset($currentHeaders['HTTP_ACCEPT_ENCODING'])) {
                $score += $isMobile ? 1 : 2;
            }
            
            $uniquePages = array_unique($data['pages'] ?? []);
            $totalPages = count($data['pages'] ?? []);
            
            $pageLimit = $isMobile ? 50 : 40;
            if ($totalPages > $pageLimit && count($uniquePages) <= 2) {
                $score += $isMobile ? 2 : 3;
            }
            
            $uniqueUA = array_unique($data['user_agents'] ?? []);
            if (count($uniqueUA) > 5) {
                $score += 8;
            }
            
            if (isset($data['request_times']) && count($data['request_times']) >= 15) {
                $intervals = [];
                $lastFifteen = array_slice($data['request_times'], -15);
                
                for ($i = 1; $i < count($lastFifteen); $i++) {
                    $intervals[] = $lastFifteen[$i] - $lastFifteen[$i-1];
                }
                
                if (count($intervals) >= 12) {
                    $avgInterval = array_sum($intervals) / count($intervals);
                    $variance = 0;
                    foreach ($intervals as $interval) {
                        $variance += pow($interval - $avgInterval, 2);
                    }
                    $variance /= count($intervals);
                    
                    $varianceThreshold = $isMobile ? 1.0 : 1.5;
                    $intervalThreshold = $isMobile ? 3 : 5;
                    
                    if ($variance < $varianceThreshold && $avgInterval < $intervalThreshold) {
                        $score += $isMobile ? 3 : 5;
                    }
                }
            }
            
            if (isset($data['request_times']) && count($data['request_times']) >= 10) {
                $lastTen = array_slice($data['request_times'], -10);
                $timeDiff = end($lastTen) - reset($lastTen);
                
                if ($timeDiff <= 5) {
                    $score += $isMobile ? 3 : 5;
                }
                if ($timeDiff <= 2) {
                    $score += 6;
                }
            }
            
            return $score >= $blockThreshold;
        } catch (Exception $e) {
            error_log("Error in analyzeRequest: " . $e->getMessage());
            return false;
        }
    }
    
    private function isBlocked($ip) {
        try {
            $blockKey = $this->blockPrefix . 'ip:' . hash('md5', $ip);
            return $this->redis->exists($blockKey);
        } catch (Exception $e) {
            error_log("Error checking IP block: " . $e->getMessage());
            return false;
        }
    }
    
    private function blockIP($ip, $reason = 'Bot behavior detected') {
    try {
        $blockKey = $this->blockPrefix . 'ip:' . hash('md5', $ip);
        $apiCallKey = $this->blockPrefix . 'api_call:' . hash('md5', $ip);
        
        $isRepeatOffender = $this->redis->exists($blockKey);
        
        $blockData = [
            'ip' => $ip,
            'blocked_at' => time(),
            'blocked_reason' => $reason,
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
            'uri' => $_SERVER['REQUEST_URI'] ?? '',
            'session_id' => 'no_session',
            'repeat_offender' => $isRepeatOffender,
            'is_suspicious_ua' => $this->isSuspiciousUserAgent($_SERVER['HTTP_USER_AGENT'] ?? ''),
            'browser_info' => $this->getBrowserFingerprint($_SERVER['HTTP_USER_AGENT'] ?? ''),
            'api_blocked' => false  // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∏–∂–µ
        ];
        
        $blockDuration = $isRepeatOffender ? $this->ttlSettings['ip_blocked_repeat'] : $this->ttlSettings['ip_blocked'];
        
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ Redis (–ª–æ–∫–∞–ª—å–Ω–æ)
        if ($this->apiSettings['block_on_redis']) {
            $this->redis->setex($blockKey, $blockDuration, $blockData);
        }
        
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ API (iptables)
        if ($this->apiSettings['block_on_api']) {
            $apiResult = $this->callBlockingAPI($ip, 'block');
            
            if ($apiResult['status'] === 'success' || $apiResult['status'] === 'already_blocked') {
				$this->redis->setex($apiCallKey, 60, time()); // –ó–∞—â–∏—Ç–∞ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
                $blockData['api_blocked'] = true;
                $blockData['api_blocked_at'] = time();
                $blockData['api_result'] = $apiResult['message'];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Redis —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± API –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
                if ($this->apiSettings['block_on_redis']) {
                    $this->redis->setex($blockKey, $blockDuration, $blockData);
                }
            } else {
                $blockData['api_blocked'] = false;
                $blockData['api_error'] = $apiResult['message'] ?? 'API call failed';
                
                if ($this->apiSettings['block_on_redis']) {
                    $this->redis->setex($blockKey, $blockDuration, $blockData);
                }
            }
        }
        
        $durHours = round($blockDuration / 3600);
        $apiStatus = $blockData['api_blocked'] ? 'API+Redis' : 'Redis only';
        error_log("Bot blocked [IP]: $ip | {$apiStatus} | " . ($isRepeatOffender ? "REPEAT | " : "") . "{$durHours}h | $reason");
        
    } catch (Exception $e) {
        error_log("Error blocking IP: " . $e->getMessage());
    }
}
    
	/**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ IP
     * 
     * @param string $ip IP –∞–¥—Ä–µ—Å –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
     * @param string $action 'block' –∏–ª–∏ 'unblock'
     * @return array –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è API –∑–∞–ø—Ä–æ—Å–∞
     */
    private function callBlockingAPI($ip, $action = 'block') {
        if (!$this->apiSettings['enabled']) {
            return ['status' => 'disabled', 'message' => 'API integration disabled'];
        }
        
        if (!$this->apiSettings['block_on_api']) {
            return ['status' => 'skipped', 'message' => 'API blocking disabled in settings'];
        }
        
        $normalizedIP = $this->normalizeIP($ip);
        
        $url = $this->apiSettings['url'] . 
               '?action=' . urlencode($action) . 
               '&ip=' . urlencode($normalizedIP) . 
               '&api=1' . 
               '&api_key=' . urlencode($this->apiSettings['api_key']);
        
        $maxRetries = max(1, $this->apiSettings['retry_on_failure']);
        $attempt = 0;
        $lastError = null;
        
        while ($attempt < $maxRetries) {
            $attempt++;
            
            try {
                $ch = curl_init();
                
                if (!$ch) {
                    throw new Exception("Failed to initialize cURL");
                }
                
                curl_setopt_array($ch, [
                    CURLOPT_URL => $url,
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_TIMEOUT => $this->apiSettings['timeout'],
                    CURLOPT_CONNECTTIMEOUT => 3,
                    CURLOPT_FOLLOWLOCATION => false,
                    CURLOPT_MAXREDIRS => 0,
                    CURLOPT_SSL_VERIFYPEER => $this->apiSettings['verify_ssl'],
                    CURLOPT_SSL_VERIFYHOST => $this->apiSettings['verify_ssl'] ? 2 : 0,
                    CURLOPT_USERAGENT => $this->apiSettings['user_agent'],
                    CURLOPT_HTTPHEADER => [
                        'Accept: application/json',
                        'Cache-Control: no-cache'
                    ]
                ]);
                
                $response = curl_exec($ch);
                $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                $curlError = curl_error($ch);
                $curlErrno = curl_errno($ch);
                
                curl_close($ch);
                
                if ($curlErrno !== 0) {
                    throw new Exception("cURL error #{$curlErrno}: {$curlError}");
                }
                
                if ($httpCode !== 200) {
                    throw new Exception("HTTP error code: {$httpCode}");
                }
                
                if (empty($response)) {
                    throw new Exception("Empty response from API");
                }
                
                $result = json_decode($response, true);
                
                if (!is_array($result)) {
                    throw new Exception("Invalid JSON response: " . substr($response, 0, 100));
                }
                
                if (isset($result['status'])) {
                    if ($result['status'] === 'success') {
                        error_log("API {$action} SUCCESS: {$normalizedIP} | " . ($result['message'] ?? 'OK'));
                        return [
                            'status' => 'success',
                            'message' => $result['message'] ?? 'Operation completed',
                            'api_response' => $result,
                            'attempt' => $attempt
                        ];
                    } elseif ($result['status'] === 'error') {
                        $errorMsg = $result['message'] ?? 'Unknown error';
                        
                        if (strpos($errorMsg, '—É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω') !== false || 
                            strpos($errorMsg, 'already blocked') !== false) {
                            return [
                                'status' => 'already_blocked',
                                'message' => $errorMsg,
                                'api_response' => $result
                            ];
                        }
                        
                        if (strpos($errorMsg, '–Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω') !== false || 
                            strpos($errorMsg, 'not blocked') !== false) {
                            return [
                                'status' => 'not_blocked',
                                'message' => $errorMsg,
                                'api_response' => $result
                            ];
                        }
                        
                        throw new Exception("API error: {$errorMsg}");
                    }
                }
                
                throw new Exception("Unknown API response format");
                
            } catch (Exception $e) {
                $lastError = $e->getMessage();
                
                if ($this->apiSettings['log_api_errors']) {
                    error_log("API {$action} ATTEMPT {$attempt}/{$maxRetries} FAILED: {$normalizedIP} | {$lastError}");
                }
                
                if ($attempt < $maxRetries) {
                    usleep(200000);
                } else {
                    if ($this->apiSettings['log_api_errors']) {
                        error_log("API {$action} FINAL FAILURE: {$normalizedIP} | All {$maxRetries} attempts failed");
                    }
                }
            }
        }
        
        return [
            'status' => 'error',
            'message' => $lastError ?? 'Unknown error',
            'attempts' => $maxRetries
        ];
    }
	
    private function sendBlockResponse() {
        if (!headers_sent()) {
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø SEO: –ó–∞–ø—Ä–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            header('X-Robots-Tag: noindex, nofollow');
            http_response_code(429);
            header('Content-Type: text/plain; charset=utf-8');
            header('Retry-After: 900');
        }
        die('Rate limit exceeded. Please try again later.');
    }
    
    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ 429 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ rate limit (–ø–µ—Ä–≤–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ)
     * –û—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç sendBlockResponse - –¥–∞—ë—Ç —à–∞–Ω—Å –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è
     */
    private function sendRateLimitResponse($rateLimitResult) {
        if (!headers_sent()) {
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø SEO: –ó–∞–ø—Ä–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã rate limit
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            header('X-Robots-Tag: noindex, nofollow');
            http_response_code(429);
            header('Content-Type: text/plain; charset=utf-8');
            header('Retry-After: 60');  // –ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞ - 60 —Å–µ–∫—É–Ω–¥
            header('X-RateLimit-Limit: ' . $this->rateLimitSettings['max_requests_per_minute']);
            header('X-RateLimit-Remaining: 0');
        }
        die('Too Many Requests. Please slow down. Retry after 60 seconds.');
    }
    
    // testRDNS() removed in optimization (saved 82 lines)
	// –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ï –ú–ï–¢–û–î–´
    
    // getUserHashInfo() removed in optimization (saved 23 lines)
    
    public function unblockUserHash($userHash = null) {
        try {
            $userHash = $userHash ?: $this->generateUserHash();
            
            $blockKey = $this->userHashPrefix . 'blocked:' . $userHash;
            $trackingKey = $this->userHashPrefix . 'tracking:' . $userHash;
            
            $result = [
                'user_hash' => substr($userHash, 0, 16) . '...',
                'unblocked' => $this->redis->del($blockKey) > 0,
                'tracking_cleared' => $this->redis->del($trackingKey) > 0
            ];
            
            error_log("UNBLOCKED [HASH]: " . substr($userHash, 0, 8) . " | Manual");
            return $result;
        } catch (Exception $e) {
            error_log("Error unblocking user hash: " . $e->getMessage());
            return ['error' => $e->getMessage()];
        }
    }
    
    // diagnoseUserHash() removed in optimization (saved 21 lines)
    
    // getUserHashStats() removed in optimization (saved 51 lines)
    
    // cleanupUserHashData() –º–µ—Ç–æ–¥ —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cleanup.php

    
    public function getRateLimitStats($ip) {
        try {
            $ipHash = hash('md5', $ip);
            $historyKey = $this->blockPrefix . 'history:' . $ipHash;
            $trackingKey = $this->trackingPrefix . 'ip:' . $ipHash;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å—á—ë—Ç—á–∏–∫–∏ –∏–∑ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –∫–ª—é—á–µ–π
            $current = time();
            $minute = floor($current / 60);
            $fiveMin = floor($current / 300);
            $hour = floor($current / 3600);
            
            $req1min = $this->redis->get($this->trackingPrefix . 'rl:1m:' . $minute . ':' . $ipHash) ?: 0;
            $req5min = $this->redis->get($this->trackingPrefix . 'rl:5m:' . $fiveMin . ':' . $ipHash) ?: 0;
            $req1hour = $this->redis->get($this->trackingPrefix . 'rl:1h:' . $hour . ':' . $ipHash) ?: 0;
            $violations = $this->redis->get($this->trackingPrefix . 'rl:violations:' . $ipHash) ?: 0;
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ tracking –¥–∞–Ω–Ω—ã—Ö
            $lastRequest = 0;
            $trackingData = $this->redis->get($trackingKey);
            if ($trackingData && isset($trackingData['last_request'])) {
                $lastRequest = $trackingData['last_request'];
            }
            
            $currentStats = null;
            if ($req1min > 0 || $req5min > 0 || $req1hour > 0 || $violations > 0) {
                $currentStats = [
                    'requests_1min' => (int)$req1min,
                    'requests_5min' => (int)$req5min,
                    'requests_1hour' => (int)$req1hour,
                    'violations' => (int)$violations,
                    'last_request' => $lastRequest
                ];
            }
            
            return [
                'ip' => $ip,
                'current_stats' => $currentStats,
                'block_history' => $this->redis->get($historyKey),
                'is_blocked' => $this->isBlocked($ip),
                'extended_tracking' => false /* checkExtendedTracking removed */
            ];
        } catch (Exception $e) {
            error_log("Error getting rate limit stats: " . $e->getMessage());
            return [];
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è resetRateLimit —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤—ã—à–µ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π (—Å—Ç—Ä–æ–∫–∞ ~1048)
    // –≠—Ç–∞ –≤–µ—Ä—Å–∏—è —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
    
    /**
     * –£–õ–£–ß–®–ï–ù–ù–ê–Ø –≤–µ—Ä—Å–∏—è: —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –∫–ª—é—á–µ–π
     */
    // getTopRateLimitViolators() removed in optimization (saved 71 lines)
    
    public function getStats() {
        $stats = [
            'blocked_ips' => 0,
            'blocked_cookies' => 0,
            'tracking_records' => 0,
            'rate_limit_tracking' => 0,
            'rate_limit_violations' => 0,
            'extended_tracking_active' => 0,
            'block_history_records' => 0,
            'total_keys' => 0,
            'memory_usage' => 0
        ];
        
        try {
            // –í–ê–ñ–ù–û: OPT_PREFIX –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º SCAN!
            // –ü–æ—ç—Ç–æ–º—É —É–∫–∞–∑—ã–≤–∞–µ–º –ü–û–õ–ù–´–ô –ø—É—Ç—å –≤ –ø–∞—Ç—Ç–µ—Ä–Ω–µ
            $patterns = [
                'blocked_ips' => $this->redisPrefix . $this->blockPrefix . 'ip:*',
                'blocked_cookies' => $this->redisPrefix . $this->cookiePrefix . 'blocked:*',
                'tracking_records' => $this->redisPrefix . $this->trackingPrefix . 'ip:*',
                'extended_tracking_active' => $this->redisPrefix . $this->trackingPrefix . 'extended:*',
                'block_history_records' => $this->redisPrefix . $this->blockPrefix . 'history:*',
            ];
            
            foreach ($patterns as $statKey => $pattern) {
                $count = 0;
                $iterator = null;
                do {
                    $keys = $this->redis->scan($iterator, $pattern, 100);
                    if ($keys !== false) {
                        $count += count($keys);
                    }
                } while ($iterator !== 0 && $iterator !== null);
                $stats[$statKey] = $count;
            }
            
            // Rate limit –∫–ª—é—á–∏ —Å –ø–æ–¥—Å—á–µ—Ç–æ–º –Ω–∞—Ä—É—à–µ–Ω–∏–π
            $rateLimitCount = 0;
            $violations = 0;
            $iterator = null;
            $pattern = $this->redisPrefix . $this->trackingPrefix . 'rl:violations:*';
            do {
                $keys = $this->redis->scan($iterator, $pattern, 100);
                if ($keys !== false) {
                    $rateLimitCount += count($keys);
                    foreach ($keys as $key) {
                        // SCAN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å, —É–±–∏—Ä–∞–µ–º redisPrefix –¥–ª—è get() (OPT_PREFIX –¥–æ–±–∞–≤–∏—Ç –µ–≥–æ)
                        $keyWithoutPrefix = str_replace($this->redisPrefix, '', $key);
                        $count = $this->redis->get($keyWithoutPrefix);
                        if ($count) {
                            $violations += intval($count);
                        }
                    }
                }
            } while ($iterator !== 0 && $iterator !== null);
            $stats['rate_limit_tracking'] = $rateLimitCount;
            $stats['rate_limit_violations'] = $violations;
            
            // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π —á–µ—Ä–µ–∑ DBSIZE (–±—ã—Å—Ç—Ä–µ–µ —á–µ–º SCAN –≤—Å–µ—Ö)
            $stats['total_keys'] = $this->redis->dbSize();
            
            $info = $this->redis->info('memory');
            $stats['memory_usage'] = $info['used_memory_human'] ?? 'unknown';
            
            // User Hash —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
            $userHashBlocked = 0;
            $iterator = null;
            $pattern = $this->redisPrefix . $this->userHashPrefix . 'blocked:*';
            do {
                $keys = $this->redis->scan($iterator, $pattern, 100);
                if ($keys !== false) {
                    $userHashBlocked += count($keys);
                }
            } while ($iterator !== 0 && $iterator !== null);
            $stats['user_hash_blocked'] = $userHashBlocked;
            
        } catch (Exception $e) {
            error_log("Error getting stats: " . $e->getMessage());
        }
        
        return $stats;
    }
    
    /**
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     * –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ê–ü–†–û–°–û–í –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò v1.0 (2025-12-02)
     * 
     * –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç RPM (requests per minute) –∏ RPS (requests per second)
     * —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π INCR. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     */
    
    /**
     * –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ protect() –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
     * 
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç 2 —Å—á—ë—Ç—á–∏–∫–∞:
     * - stats:rpm:{minute} - –∑–∞–ø—Ä–æ—Å—ã –∑–∞ –º–∏–Ω—É—Ç—É (TTL 120 —Å–µ–∫)
     * - stats:rps:{second} - –∑–∞–ø—Ä–æ—Å—ã –∑–∞ —Å–µ–∫—É–Ω–¥—É (TTL 10 —Å–µ–∫)
     */
    public function incrementRequestCounter() {
        try {
            $now = time();
            $currentMinute = floor($now / 60);
            $currentSecond = $now;
            
            // –°—á—ë—Ç—á–∏–∫ –∑–∞ –º–∏–Ω—É—Ç—É (TTL 120 —Å–µ–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –º–∏–Ω—É—Ç—ã)
            $minuteKey = 'stats:rpm:' . $currentMinute;
            $this->redis->incr($minuteKey);
            $this->redis->expire($minuteKey, 120);
            
            // –°—á—ë—Ç—á–∏–∫ –∑–∞ —Å–µ–∫—É–Ω–¥—É (TTL 10 —Å–µ–∫ –¥–ª—è —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –æ–∫–Ω–∞)
            $secondKey = 'stats:rps:' . $currentSecond;
            $this->redis->incr($secondKey);
            $this->redis->expire($secondKey, 10);
            
        } catch (Exception $e) {
            // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —á—Ç–æ–±—ã –Ω–µ –∑–∞–º–µ–¥–ª—è—Ç—å —Ä–∞–±–æ—Ç—É
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
     * 
     * @return array [
     *   'current_rpm' => int,      // –ó–∞–ø—Ä–æ—Å—ã –∑–∞ —Ç–µ–∫—É—â—É—é –º–∏–Ω—É—Ç—É
     *   'previous_rpm' => int,     // –ó–∞–ø—Ä–æ—Å—ã –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –º–∏–Ω—É—Ç—É
     *   'avg_rps' => float,        // –°—Ä–µ–¥–Ω–∏–π RPS (–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –º–∏–Ω—É—Ç—ã)
     *   'current_rps' => int,      // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π RPS (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–µ–∫—É–Ω–¥–∞)
     *   'peak_rps' => int,         // –ü–∏–∫–æ–≤—ã–π RPS –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥
     *   'timestamp' => int         // –í—Ä–µ–º—è –∑–∞–º–µ—Ä–∞
     * ]
     */
    public function getRequestsPerMinute() {
        $stats = [
            'current_rpm' => 0,
            'previous_rpm' => 0,
            'avg_rps' => 0.0,
            'current_rps' => 0,
            'peak_rps' => 0,
            'timestamp' => time()
        ];
        
        try {
            $now = time();
            $currentMinute = floor($now / 60);
            $previousMinute = $currentMinute - 1;
            
            // RPM –∑–∞ —Ç–µ–∫—É—â—É—é –º–∏–Ω—É—Ç—É
            $currentRPM = $this->redis->get('stats:rpm:' . $currentMinute);
            $stats['current_rpm'] = $currentRPM ? intval($currentRPM) : 0;
            
            // RPM –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –º–∏–Ω—É—Ç—É (–±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
            $previousRPM = $this->redis->get('stats:rpm:' . $previousMinute);
            $stats['previous_rpm'] = $previousRPM ? intval($previousRPM) : 0;
            
            // –°—Ä–µ–¥–Ω–∏–π RPS –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –º–∏–Ω—É—Ç—ã
            $stats['avg_rps'] = round($stats['previous_rpm'] / 60, 2);
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π RPS (–ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ª–Ω–∞—è —Å–µ–∫—É–Ω–¥–∞)
            $lastSecond = $now - 1;
            $currentRPS = $this->redis->get('stats:rps:' . $lastSecond);
            $stats['current_rps'] = $currentRPS ? intval($currentRPS) : 0;
            
            // –ü–∏–∫–æ–≤—ã–π RPS –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥
            $peakRPS = 0;
            for ($i = 1; $i <= 10; $i++) {
                $sec = $now - $i;
                $rps = $this->redis->get('stats:rps:' . $sec);
                if ($rps && intval($rps) > $peakRPS) {
                    $peakRPS = intval($rps);
                }
            }
            $stats['peak_rps'] = $peakRPS;
            
        } catch (Exception $e) {
            error_log("Error getting request stats: " . $e->getMessage());
        }
        
        return $stats;
    }
    
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é RPM –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–∏–Ω—É—Ç
     * 
     * @param int $minutes –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
     * @return array –ú–∞—Å—Å–∏–≤ —Å RPM –∑–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
     */
    // getRPMHistory() removed in optimization (saved 23 lines)
    
    // cleanup() –º–µ—Ç–æ–¥ —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cleanup.php

    
    // deepCleanup() –º–µ—Ç–æ–¥ —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cleanup.php

    
    /**
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     * –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î unblockIP() v2.4
     * 
     * –¢–µ–ø–µ—Ä—å —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –í–°–Å: –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, violations, rate limit —Å—á—ë—Ç—á–∏–∫–∏
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     */
    public function unblockIP($ip) {
    try {
        $ipHash = hash('md5', $ip);
        $blockKey = $this->blockPrefix . 'ip:' . $ipHash;
        $trackingKey = $this->trackingPrefix . 'ip:' . $ipHash;
        $extendedKey = $this->trackingPrefix . 'extended:' . $ipHash;
        $violationsKey = $this->trackingPrefix . 'violations:' . $ipHash;
        
        $result = [
            'ip_unblocked' => false,
            'tracking_cleared' => false,
            'extended_tracking_cleared' => false,
            'violations_cleared' => false,
            'rate_limit_cleared' => false,
            'api_unblocked' => false,
            'api_message' => null
        ];
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ Redis
        if ($this->apiSettings['block_on_redis']) {
            $result['ip_unblocked'] = $this->redis->del($blockKey) > 0;
            $result['tracking_cleared'] = $this->redis->del($trackingKey) > 0;
            $result['extended_tracking_cleared'] = $this->redis->del($extendedKey) > 0;
        }
        
        // –ù–û–í–û–ï v2.4: –°–±—Ä–æ—Å violations
        $result['violations_cleared'] = $this->redis->del($violationsKey) > 0;
        
        // –ù–û–í–û–ï v2.4: –°–±—Ä–æ—Å rate limit —Å—á—ë—Ç—á–∏–∫–æ–≤
        $current = time();
        $minute = floor($current / 60);
        $fiveMin = floor($current / 300);
        $hour = floor($current / 3600);
        
        $keysToDelete = [
            $this->trackingPrefix . 'rl:1m:' . $minute . ':' . $ipHash,
            $this->trackingPrefix . 'rl:5m:' . $fiveMin . ':' . $ipHash,
            $this->trackingPrefix . 'rl:1h:' . $hour . ':' . $ipHash,
            $this->trackingPrefix . 'rl:violations:' . $ipHash,
            $this->trackingPrefix . 'burst:' . $ipHash,
            $this->trackingPrefix . 'burst_warn:' . $ipHash,
        ];
        
        $rlDeleted = 0;
        foreach ($keysToDelete as $key) {
            $rlDeleted += $this->redis->del($key);
        }
        $result['rate_limit_cleared'] = $rlDeleted > 0;
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ API (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
        if ($this->apiSettings['auto_unblock'] && $this->apiSettings['block_on_api']) {
            $apiResult = $this->callBlockingAPI($ip, 'unblock');
            
            if ($apiResult['status'] === 'success' || $apiResult['status'] === 'not_blocked') {
                $result['api_unblocked'] = true;
                $result['api_message'] = $apiResult['message'];
                error_log("UNBLOCKED [IP]: $ip | API+Redis+Violations | Manual");
            } else {
                $result['api_unblocked'] = false;
                $result['api_message'] = $apiResult['message'] ?? 'API call failed';
                error_log("UNBLOCKED [IP]: $ip | Redis+Violations only (API failed) | Manual");
            }
        } else {
            error_log("UNBLOCKED [IP]: $ip | Redis+Violations only | Manual");
        }
        
        return $result;
    } catch (Exception $e) {
        error_log("Error unblocking IP: " . $e->getMessage());
        return ['error' => $e->getMessage()];
    }
}
    
    public function getBlockedIPInfo($ip) {
        try {
            $ipHash = hash('md5', $ip);
            $blockKey = $this->blockPrefix . 'ip:' . $ipHash;
            $trackingKey = $this->trackingPrefix . 'ip:' . $ipHash;
            $extendedKey = $this->trackingPrefix . 'extended:' . $ipHash;
            $violationsKey = $this->trackingPrefix . 'violations:' . $ipHash;
            
            return [
                'blocked' => $this->redis->exists($blockKey),
                'block_data' => $this->redis->get($blockKey),
                'tracking_data' => $this->redis->get($trackingKey),
                'extended_tracking' => $this->redis->get($extendedKey),
                'violations' => $this->getTotalViolations($ip),
                'ttl' => $this->redis->ttl($blockKey)
            ];
        } catch (Exception $e) {
            error_log("Error getting blocked IP info: " . $e->getMessage());
            return [];
        }
    }
    
    public function getTTLSettings() {
        return $this->ttlSettings;
    }
    
    public function getSlowBotSettings() {
        return $this->slowBotSettings;
    }
    
    public function getRateLimitSettings() {
        return $this->rateLimitSettings;
    }
    
    public function getGlobalProtectionSettings() {
        return $this->globalProtectionSettings;
    }
    
    public function updateTTLSettings($newSettings) {
        $this->ttlSettings = array_merge($this->ttlSettings, $newSettings);
        error_log("TTL settings updated: " . json_encode($newSettings));
    }
    
	/**
 * –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API
 */
public function updateAPISettings($newSettings) {
    $this->apiSettings = array_merge($this->apiSettings, $newSettings);
    error_log("API settings updated: " . json_encode($newSettings));
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API
 */
public function getAPISettings() {
    return $this->apiSettings;
}

/**
 * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
 */
public function testAPIConnection() {
    if (!$this->apiSettings['enabled']) {
        return [
            'status' => 'disabled',
            'message' => 'API integration is disabled'
        ];
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IP –¥–ª—è —Ç–µ—Å—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    $url = $this->apiSettings['url'] . 
           '?action=list&api=1&api_key=' . urlencode($this->apiSettings['api_key']);
    
    try {
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => $this->apiSettings['timeout'],
            CURLOPT_SSL_VERIFYPEER => $this->apiSettings['verify_ssl'],
            CURLOPT_SSL_VERIFYHOST => $this->apiSettings['verify_ssl'] ? 2 : 0,
        ]);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        if ($httpCode === 200) {
            $result = json_decode($response, true);
            if (isset($result['status']) && $result['status'] === 'success') {
                return [
                    'status' => 'success',
                    'message' => 'API connection successful',
                    'api_response' => $result
                ];
            }
        }
        
        return [
            'status' => 'error',
            'message' => "API returned HTTP {$httpCode}",
            'response' => substr($response, 0, 200)
        ];
        
    } catch (Exception $e) {
        return [
            'status' => 'error',
            'message' => $e->getMessage()
        ];
    }
}

/**
 * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤ API –≤—Å–µ IP, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ Redis
 */
public function syncBlockedIPsToAPI() {
    if (!$this->apiSettings['enabled'] || !$this->apiSettings['block_on_api']) {
        return [
            'status' => 'disabled',
            'message' => 'API integration is disabled'
        ];
    }
    
    try {
        // –í–ê–ñ–ù–û: OPT_PREFIX –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º SCAN - —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
        $pattern = $this->redisPrefix . $this->blockPrefix . 'ip:*';
        $iterator = null;
        $synced = 0;
        $failed = 0;
        
        do {
            $keys = $this->redis->scan($iterator, $pattern, 100);
            
            if ($keys === false) break;
            
            foreach ($keys as $key) {
                // SCAN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å, —É–±–∏—Ä–∞–µ–º redisPrefix
                $keyWithoutPrefix = str_replace($this->redisPrefix, '', $key);
                $blockData = $this->redis->get($keyWithoutPrefix);
                
                if ($blockData && isset($blockData['ip'])) {
                    $ip = $blockData['ip'];
                    
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ API
                    if (isset($blockData['api_blocked']) && $blockData['api_blocked']) {
                        continue;
                    }
                    
                    $apiResult = $this->callBlockingAPI($ip, 'block');
                    
                    if ($apiResult['status'] === 'success' || $apiResult['status'] === 'already_blocked') {
                        $synced++;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Redis
                        $blockData['api_blocked'] = true;
                        $blockData['api_synced_at'] = time();
                        $ttl = $this->redis->ttl($keyWithoutPrefix);
                        if ($ttl > 0) {
                            $this->redis->setex($keyWithoutPrefix, $ttl, $blockData);
                        }
                    } else {
                        $failed++;
                    }
                    
                    usleep(100000); // 100ms –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                }
            }
            
        } while ($iterator > 0);
        
        error_log("API SYNC: Synced {$synced} IPs to API, {$failed} failed");
        
        return [
            'status' => 'success',
            'synced' => $synced,
            'failed' => $failed,
            'message' => "Synced {$synced} blocked IPs to API"
        ];
        
    } catch (Exception $e) {
        error_log("Error in syncBlockedIPsToAPI: " . $e->getMessage());
        return [
            'status' => 'error',
            'message' => $e->getMessage()
        ];
    }
}
	
    public function updateSlowBotSettings($newSettings) {
        $this->slowBotSettings = array_merge($this->slowBotSettings, $newSettings);
        error_log("Slow bot settings updated: " . json_encode($newSettings));
    }
    
    public function updateRateLimitSettings($newSettings) {
        $this->rateLimitSettings = array_merge($this->rateLimitSettings, $newSettings);
        error_log("Rate limit settings updated: " . json_encode($newSettings));
    }
    
    public function updateGlobalProtectionSettings($newSettings) {
        $this->globalProtectionSettings = array_merge($this->globalProtectionSettings, $newSettings);
        error_log("Global protection settings updated: " . json_encode($newSettings));
    }
    
    public function getRedisMemoryInfo() {
        try {
            // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û: —á–∏—Ç–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ cleanup.php –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            $metrics = $this->redis->get($this->globalPrefix . 'metrics');
            
            if ($metrics && is_array($metrics)) {
                return [
                    'tracked_ips_count' => isset($metrics['tracked_ips']) ? $metrics['tracked_ips'] : 0,
                    'blocked_ips_count' => isset($metrics['blocked_ips']) ? $metrics['blocked_ips'] : 0,
                    'blocked_hashes_count' => isset($metrics['blocked_hashes']) ? $metrics['blocked_hashes'] : 0,
                    'rdns_cache_size' => isset($metrics['rdns_cache_size']) ? $metrics['rdns_cache_size'] : 0,
                    'cleanup_threshold' => $this->globalProtectionSettings['cleanup_threshold'],
                    'cleanup_needed' => isset($metrics['tracked_ips']) ? 
                        ($metrics['tracked_ips'] > $this->globalProtectionSettings['cleanup_threshold']) : false,
                    'last_cleanup' => isset($metrics['last_cleanup']) ? $metrics['last_cleanup'] : 0,
                    'last_cleanup_ago' => isset($metrics['last_cleanup']) ? 
                        (time() - $metrics['last_cleanup']) : null
                ];
            }
            
            // Fallback: –µ—Å–ª–∏ –º–µ—Ç—Ä–∏–∫ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—á–µ—Ç—á–∏–∫ (cleanup.php –µ—â–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è)
            $counterKey = $this->globalPrefix . 'tracked_counter';
            $trackedCount = $this->redis->get($counterKey) ?: 0;
            
            return [
                'tracked_ips_count' => $trackedCount,
                'blocked_ips_count' => 0,
                'blocked_hashes_count' => 0,
                'rdns_cache_size' => 0,
                'cleanup_threshold' => $this->globalProtectionSettings['cleanup_threshold'],
                'cleanup_needed' => $trackedCount >= $this->globalProtectionSettings['cleanup_threshold'],
                'last_cleanup' => 0,
                'last_cleanup_ago' => null,
                'warning' => 'Metrics not available - ensure cleanup.php is running via cron'
            ];
        } catch (Exception $e) {
            error_log("Error getting Redis memory info: " . $e->getMessage());
            return [];
        }
    }
    
    // forceCleanup() –º–µ—Ç–æ–¥ —É–¥–∞–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cleanup.php

    
    
    /**
     * –ù–û–í–´–ô –ú–ï–¢–û–î: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ cleanup.php
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∑–∞–ø—É—Å–∫–∞–ª—Å—è cleanup.php –∏ –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
     */
    public function getCleanupStatus() {
        try {
            $metrics = $this->redis->get($this->globalPrefix . 'metrics');
            
            if (!$metrics || !isset($metrics['last_cleanup'])) {
                return [
                    'status' => 'never_run',
                    'message' => 'cleanup.php never executed or metrics not available',
                    'recommendation' => 'Setup cron: */5 * * * * php /path/to/cleanup.php >> /var/log/cleanup.log 2>&1',
                    'critical' => true
                ];
            }
            
            $lastCleanup = $metrics['last_cleanup'];
            $timeSince = time() - $lastCleanup;
            $minutesAgo = round($timeSince / 60);
            
            if ($timeSince > 1800) { // 30 –º–∏–Ω—É—Ç
                return [
                    'status' => 'warning',
                    'message' => "cleanup.php not run for {$minutesAgo} minutes",
                    'last_run' => date('Y-m-d H:i:s', $lastCleanup),
                    'minutes_ago' => $minutesAgo,
                    'recommendation' => 'Check if cron is working: crontab -l | grep cleanup',
                    'critical' => $timeSince > 3600 // –ö—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ > 1 —á–∞—Å–∞
                ];
            }
            
            return [
                'status' => 'ok',
                'message' => 'cleanup.php running normally',
                'last_run' => date('Y-m-d H:i:s', $lastCleanup),
                'minutes_ago' => $minutesAgo,
                'metrics' => $metrics,
                'critical' => false
            ];
        } catch (Exception $e) {
            error_log("Error checking cleanup status: " . $e->getMessage());
            return [
                'status' => 'error',
                'message' => $e->getMessage(),
                'critical' => true
            ];
        }
    }
    
    /**
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     * JS CHALLENGE –ú–ï–¢–û–î–´
     * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     */
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ JS Challenge
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å challenge –∏ –µ—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
     */
    private function checkJSChallenge($ip) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π URL –∏–∑ JS Challenge
        if ($this->isExcludedFromJSChallenge()) {
            return [
                'show_challenge' => false,
                'has_valid_token' => true, // –°—á–∏—Ç–∞–µ–º –∫–∞–∫ –±—É–¥—Ç–æ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω
                'reason' => 'URL excluded from JS Challenge',
                'excluded' => true
            ];
        }
        
        $result = [
            'show_challenge' => false,
            'has_valid_token' => false,
            'reason' => null
        ];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
        if ($this->hasValidJSToken($ip)) {
            $result['has_valid_token'] = true;
            return $result; // –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º challenge
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ challenge
        
        // 1. –í—ã—Å–æ–∫–∏–µ violations
        if ($this->jsChallengeSettings['trigger_on_high_violations']) {
            $violations = $this->getTotalViolations($ip);
            if ($violations['total'] >= $this->jsChallengeSettings['violations_threshold']) {
                $result['show_challenge'] = true;
                $result['reason'] = "High violations: {$violations['total']}";
                return $result;
            }
        }
        
        // 2. Slow bot detection
        if ($this->jsChallengeSettings['trigger_on_slow_bot']) {
            $trackingData = $this->getUserTrackingData($ip);
            if ($trackingData && $this->isPotentialSlowBot($trackingData)) {
                $result['show_challenge'] = true;
                $result['reason'] = 'Slow bot pattern detected';
                return $result;
            }
        }
        
        // 3. –ù–µ—Ç cookie - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï–ú –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
        if ($this->jsChallengeSettings['trigger_on_no_cookie']) {
            $trackingData = $this->getUserTrackingData($ip);
            $hasCookie = $this->hasValidCookie();
            
            // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Challenge –í–°–ï–ú –±–µ–∑ cookie (–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ)
            if (!$hasCookie) {
                $result['show_challenge'] = true;
                $result['reason'] = "No cookie (requests: " . ($trackingData['requests'] ?? 0) . ")";
                return $result;
            }
        }
        
        return $result;
    }
    
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞, –∏—Å–∫–ª—é—á—ë–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π URL –∏–∑ JS Challenge
     * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç wildcard –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å *
     * 
     * @return bool True –µ—Å–ª–∏ URL –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
     */
    private function isExcludedFromJSChallenge() {
        $excludedUrls = $this->jsChallengeSettings['excluded_urls'] ?? [];
        
        if (empty($excludedUrls)) {
            return false;
        }
        
        $currentUri = $_SERVER['REQUEST_URI'] ?? '/';
        
        foreach ($excludedUrls as $pattern) {
            if ($this->matchUrlPattern($currentUri, $pattern)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è URL –ø–∞—Ç—Ç–µ—Ä–Ω—É —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π wildcard (*)
     * 
     * @param string $url –ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–π URL
     * @param string $pattern –ü–∞—Ç—Ç–µ—Ä–Ω —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ * (wildcard)
     * @return bool True –µ—Å–ª–∏ URL —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É
     */
    private function matchUrlPattern($url, $pattern) {
        // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if ($url === $pattern) {
            return true;
        }
        
        // –ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç *, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if (strpos($pattern, '*') === false) {
            return false;
        }
        
        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã regex, –∫—Ä–æ–º–µ *
        $pattern = preg_quote($pattern, '/');
        
        // –ó–∞–º–µ–Ω—è–µ–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ \* –Ω–∞ .* –¥–ª—è regex
        $pattern = str_replace('\*', '.*', $pattern);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        return preg_match('/^' . $pattern . '$/', $url) === 1;
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ JS Challenge —Ç–æ–∫–µ–Ω–∞
     */
    private function hasValidJSToken($ip) {
        $tokenName = $this->jsChallengeSettings['token_name'];
        
        if (!isset($_COOKIE[$tokenName])) {
            return false;
        }
        
        $token = $_COOKIE[$tokenName];
        
        try {
            $tokenKey = 'js_challenge:token:' . hash('md5', $token);
            $tokenData = $this->redis->get($tokenKey);
            
            if (!$tokenData || !is_array($tokenData)) {
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º IP —Å–æ–≤–ø–∞–¥–∞–µ—Ç
            if (($tokenData['ip'] ?? '') !== $ip) {
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ —Ç–æ–∫–µ–Ω
            $createdAt = $tokenData['created_at'] ?? 0;
            $ttl = $this->jsChallengeSettings['token_ttl'];
            
            if ((time() - $createdAt) > $ttl) {
                // –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫
                $this->redis->del($tokenKey);
                return false;
            }
            
            return true;
            
        } catch (Exception $e) {
            error_log("Error checking JS token: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ JS Challenge —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     */
    private function showJSChallenge($reason = 'Security check required') {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫–∞–∑–µ challenge
        $this->logChallengeShown($this->getRealIP(), $reason);
        
        $originalUrl = $_SERVER['REQUEST_URI'] ?? '/';
        $difficulty = $this->jsChallengeSettings['pow_difficulty'];
        $minTime = $this->jsChallengeSettings['min_solve_time'];
        
        if (!headers_sent()) {
            http_response_code(403);
            header('Content-Type: text/html; charset=utf-8');
            header('X-Robots-Tag: noindex, nofollow');
        }
        
        $html = <<<'HTML'
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <title>–ü—Ä–æ–≤–µ—Ä—è–µ–º –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ —Å–∞–π—Ç‚Ä¶</title>
    <style>
        :root {
            --bg: #0d0d0d;
            --fg: #fff;
            --muted: #bbb;
            --accent: #fa357a;
            --spinner: #667eea;
        }
        
        html, body {
            margin: 0;
            height: 100%;
            background: var(--bg);
            color: var(--fg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }
        
        .box {
            min-height: 100svh;
            min-height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(12px, 3vw, 24px);
            box-sizing: border-box;
        }
        
        .inner {
            max-width: min(640px, 92vw);
            text-align: center;
        }
        
        .spinner {
            width: clamp(36px, 8vmin, 64px);
            height: clamp(36px, 8vmin, 64px);
            margin: 0 auto 16px;
        }
        
        .spinner svg {
            width: 100%;
            height: 100%;
            animation: rot 1s linear infinite;
        }
        
        @keyframes rot {
            to { transform: rotate(360deg); }
        }
        
        .title {
            font-size: clamp(18px, 4.5vw, 24px);
            font-weight: 700;
            margin: 12px 0 6px;
            line-height: 1.35;
        }
        
        .desc {
            color: var(--muted);
            font-size: clamp(14px, 3.8vw, 18px);
            line-height: 1.55;
        }
        
        .heart {
            color: var(--accent);
            margin-left: 4px;
            display: inline-block;
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1); }
        }
        
        .checks {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
        
        .check-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-size: clamp(13px, 3.2vw, 15px);
            color: var(--muted);
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }
        
        .check-item.done {
            opacity: 1;
            color: var(--fg);
        }
        
        .check-icon {
            font-size: 16px;
            margin-left: 8px;
        }
        
        .error {
            background: rgba(250, 53, 122, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: clamp(13px, 3.2vw, 14px);
            display: none;
        }
        
        noscript {
            display: block;
            color: var(--accent);
            font-size: clamp(13px, 3.2vw, 15px);
            margin-top: 16px;
            padding: 12px;
            background: rgba(250, 53, 122, 0.1);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="box">
        <div class="inner">
            <div class="spinner">
                <svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" 
                            stroke-width="4" stroke-linecap="round" 
                            stroke-dasharray="31.4 31.4" 
                            style="color: var(--spinner); opacity: 0.3;"/>
                    <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" 
                            stroke-width="4" stroke-linecap="round" 
                            stroke-dasharray="15.7 94.2"
                            style="color: var(--spinner);"/>
                </svg>
            </div>
            
            <div class="title">–ü—Ä–æ–≤–µ—Ä—è–µ–º –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ —Å–∞–π—Ç‚Ä¶</div>
            <div class="desc" id="status">–≠—Ç–æ –Ω–µ –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ<span class="heart">‚ù§</span></div>
            
            <div class="checks" id="checks">
                <div class="check-item" id="check-js">
                    <span>JavaScript</span>
                    <span class="check-icon">‚è≥</span>
                </div>
                <div class="check-item" id="check-canvas">
                    <span>Canvas</span>
                    <span class="check-icon">‚è≥</span>
                </div>
                <div class="check-item" id="check-webgl">
                    <span>WebGL</span>
                    <span class="check-icon">‚è≥</span>
                </div>
                <div class="check-item" id="check-timing">
                    <span>Timing</span>
                    <span class="check-icon">‚è≥</span>
                </div>
                <div class="check-item" id="check-pow">
                    <span>Security</span>
                    <span class="check-icon">‚è≥</span>
                </div>
                <div class="check-item" id="check-behavior">
                    <span>Behavior</span>
                    <span class="check-icon">‚è≥</span>
                </div>
            </div>
            
            <div class="error" id="error"></div>
            
            <noscript>
                ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ JavaScript –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
            </noscript>
        </div>
    </div>

    <script>
HTML;
        
        $html .= "\n        const startTime = Date.now();\n";
        $html .= "        const minTime = {$minTime};\n";
        $html .= "        const difficulty = {$difficulty};\n";
        $html .= "        const originalUrl = '" . addslashes($originalUrl) . "';\n";
        
        $html .= <<<'JAVASCRIPT'
        
        let checks = {
            js: false,
            canvas: false,
            webgl: false,
            timing: false,
            pow: false,
            behavior: false
        };
        
        let checksData = {};
        
        function updateProgress() {
            const total = Object.keys(checks).length;
            const completed = Object.values(checks).filter(v => v).length;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (completed > 0) {
                document.getElementById('checks').style.display = 'block';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (completed === total) {
                document.getElementById('status').innerHTML = '–ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É<span class="heart">‚ù§</span>';
                submitChallenge();
            } else {
                document.getElementById('status').innerHTML = `–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (${completed}/${total})<span class="heart">‚ù§</span>`;
            }
        }
        
        function markCheckDone(checkId) {
            const el = document.getElementById('check-' + checkId);
            if (el) {
                el.classList.add('done');
                el.querySelector('.check-icon').textContent = '‚úì';
            }
        }
        
        function checkJS() {
            setTimeout(() => {
                checksData.js = {
                    hasLocalStorage: typeof(Storage) !== "undefined",
                    hasSessionStorage: typeof(sessionStorage) !== "undefined",
                    hasCookies: navigator.cookieEnabled,
                    userAgent: navigator.userAgent
                };
                
                checks.js = true;
                markCheckDone('js');
                updateProgress();
                checkCanvas();
            }, 100);
        }
        
        function checkCanvas() {
            setTimeout(() => {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 50;
                    
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(0, 0, 200, 50);
                    ctx.fillStyle = '#069';
                    ctx.fillText('Security Check üõ°Ô∏è', 2, 15);
                    
                    const dataURL = canvas.toDataURL();
                    checksData.canvas = simpleHash(dataURL);
                    
                    checks.canvas = true;
                    markCheckDone('canvas');
                    updateProgress();
                    checkWebGL();
                } catch(e) {
                    checksData.canvas = 'error';
                    checks.canvas = true;
                    markCheckDone('canvas');
                    updateProgress();
                    checkWebGL();
                }
            }, 150);
        }
        
        function checkWebGL() {
            setTimeout(() => {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    
                    if (gl) {
                        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                        checksData.webgl = {
                            vendor: gl.getParameter(gl.VENDOR),
                            renderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown'
                        };
                    } else {
                        checksData.webgl = 'not_supported';
                    }
                    
                    checks.webgl = true;
                    markCheckDone('webgl');
                    updateProgress();
                    checkTiming();
                } catch(e) {
                    checksData.webgl = 'error';
                    checks.webgl = true;
                    markCheckDone('webgl');
                    updateProgress();
                    checkTiming();
                }
            }, 200);
        }
        
        function checkTiming() {
            setTimeout(() => {
                const elapsed = Date.now() - startTime;
                checksData.timing = {
                    elapsed: elapsed,
                    performance: performance.now()
                };
                
                checks.timing = true;
                markCheckDone('timing');
                updateProgress();
                checkPoW();
            }, 100);
        }
        
        function checkPoW() {
            // –ü–†–û–°–¢–ê–Ø –í–ï–†–°–ò–Ø: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º fallback —Å—Ä–∞–∑—É
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ checksData.pow –±—É–¥–µ—Ç –æ–±—ä–µ–∫—Ç–æ–º, –∞ –Ω–µ undefined
            checksData.pow = {
                challenge: 'simple',
                nonce: 0,
                hash: '000fallback',
                time: Date.now() - startTime,
                fallback: true
            };
            
            checks.pow = true;
            markCheckDone('pow');
            
            console.log('PoW: Using simplified fallback mode');
            
            updateProgress();
            checkBehavior();
        }
        
        function checkBehavior() {
            setTimeout(() => {
                checksData.behavior = {
                    screen: {
                        width: screen.width,
                        height: screen.height,
                        colorDepth: screen.colorDepth
                    },
                    language: navigator.language,
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency || 0,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };
                
                checks.behavior = true;
                markCheckDone('behavior');
                updateProgress();
            }, 100);
        }
        
        function simpleHash(str) {
            let hash = 2166136261;
            for (let i = 0; i < str.length; i++) {
                hash ^= str.charCodeAt(i);
                hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
            }
            return (hash >>> 0).toString(16);
        }
        
        function submitChallenge() {
            const totalTime = Date.now() - startTime;
            
            if (totalTime < minTime) {
                const waitTime = minTime - totalTime;
                document.getElementById('status').innerHTML = '–ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É<span class="heart">‚ù§</span>';
                
                setTimeout(() => {
                    actualSubmit();
                }, waitTime);
            } else {
                actualSubmit();
            }
        }
        
        function actualSubmit() {
            document.getElementById('status').innerHTML = '–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...<span class="heart">‚ù§</span>';
            
            const data = {
                checks: checks,
                data: checksData,
                totalTime: Date.now() - startTime,
                originalUrl: originalUrl
            };
            
            // DEBUG: –í—ã–≤–æ–¥–∏–º —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
            console.log('JS Challenge: Submitting data', data);
            console.log('JS Challenge: PoW data', checksData.pow);
            
            fetch('?js_challenge_verify=1', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('JS Challenge: Server response', result);
                if (result.success) {
                    window.location.href = result.redirect || originalUrl;
                } else {
                    showError(result.message || 'Verification failed');
                }
            })
            .catch(error => {
                console.error('JS Challenge: Network error', error);
                showError('Network error: ' + error.message);
            });
        }
        
        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('status').innerHTML = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏<span class="heart">‚ù§</span>';
        }
        
        setTimeout(() => {
            checkJS();
        }, 500);
    </script>
</body>
</html>
JAVASCRIPT;
        
        die($html);
    }
    
    /**
     * –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JS Challenge (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å)
     */
    public function verifyJSChallenge() {
        if (!isset($_GET['js_challenge_verify']) || $_GET['js_challenge_verify'] !== '1') {
            return false;
        }
        
        $input = file_get_contents('php://input');
        $data = json_decode($input, true);
        
        if (!$data || !isset($data['checks'], $data['data'], $data['totalTime'])) {
            error_log("JS CHALLENGE DEBUG: Invalid data received - " . substr($input, 0, 200));
            $this->sendJSONResponse(['success' => false, 'message' => 'Invalid data']);
            return true;
        }
        
        $ip = $this->getRealIP();
        $totalTime = $data['totalTime'];
        $checks = $data['checks'];
        $checksData = $data['data'];
        
        // DEBUG: –õ–æ–≥–∏—Ä—É–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏
        error_log("JS CHALLENGE DEBUG: $ip | Received checks: " . json_encode($checks));
        error_log("JS CHALLENGE DEBUG: $ip | PoW data: " . json_encode($checksData['pow'] ?? 'MISSING'));
        
        $errors = [];
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö checks
        foreach ($checks as $check => $status) {
            if (!$status) {
                $errors[] = "Check '$check' not completed";
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        $minTime = $this->jsChallengeSettings['min_solve_time'];
        if ($totalTime < $minTime) {
            $errors[] = "Completed too fast: {$totalTime}ms < {$minTime}ms";
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ PoW (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        if (isset($checksData['pow']) && is_array($checksData['pow'])) {
            $pow = $checksData['pow'];
            $challenge = $pow['challenge'] ?? '';
            $nonce = $pow['nonce'] ?? 0;
            $hash = $pow['hash'] ?? '';
            $isFallback = isset($pow['fallback']) && $pow['fallback'] === true;
            
            // –ï—Å–ª–∏ —ç—Ç–æ fallback –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–µ –Ω–∞—à–ª–∏ —Ä–µ—à–µ–Ω–∏–µ) - —Ä–∞–∑—Ä–µ—à–∞–µ–º
            if ($isFallback) {
                error_log("JS CHALLENGE: $ip | PoW fallback used (difficulty too high or slow device)");
                // Fallback —Ä–∞–∑—Ä–µ—à—ë–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            } else {
                // –û–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ PoW
                $expectedHash = $this->simpleHashPHP($challenge . $nonce);
                $difficulty = $this->jsChallengeSettings['pow_difficulty'];
                $targetPrefix = str_repeat('0', $difficulty);
                
                if ($hash !== $expectedHash) {
                    error_log("JS CHALLENGE: $ip | PoW hash mismatch (non-critical)");
                }
                
                if (substr($hash, 0, $difficulty) !== $targetPrefix) {
                    error_log("JS CHALLENGE: $ip | PoW difficulty not met (non-critical)");
                }
            }
        } else {
            // PoW –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç - –ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            error_log("JS CHALLENGE: $ip | PoW data missing (skipped, other checks passed)");
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ canvas fingerprint
        if (empty($checksData['canvas']) || $checksData['canvas'] === 'error') {
            $errors[] = "Canvas fingerprint invalid";
        }
        
        if (!empty($errors)) {
            error_log("JS CHALLENGE FAILED: $ip | Errors: " . implode(', ', $errors));
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // –ù–û–í–ê–Ø –ó–ê–©–ò–¢–ê: –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≤–∞–ª—ã –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            $failuresKey = $this->trackingPrefix . 'js_challenge_failures:' . hash('md5', $ip);
            $failures = (int)$this->redis->get($failuresKey);
            $failures++;
            $this->redis->setex($failuresKey, 3600, $failures); // TTL 1 —á–∞—Å
            
            // –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –ó–ê–©–ò–¢–ê v2.8.0: –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥
            $failureThreshold = $this->getAdaptiveThreshold();
            
            if ($failures >= $failureThreshold) {
                $mode = $this->jsChallengeSettings['adaptive_protection'] ? 
                    ($failureThreshold === 1 ? 'ATTACK MODE' : 'NORMAL MODE') : 
                    'STATIC MODE';
                error_log("JS CHALLENGE: $ip | Failed $failures times ‚Üí BLOCKING via API! [$mode, threshold=$failureThreshold]");
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ API (iptables)
                $blockReason = "JS Challenge failed $failures times (bot detected)";
                $this->applyProgressiveBlock($ip, $blockReason, [
                    'js_challenge_failures' => $failures,
                    'last_errors' => $errors,
                    'adaptive_mode' => $mode,
                    'adaptive_threshold' => $failureThreshold
                ]);
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º user hash
                $this->blockUserHash($blockReason);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
                $this->sendJSONResponse([
                    'success' => false,
                    'message' => 'Too many failed attempts. Your IP has been blocked.',
                    'blocked' => true
                ]);
                return true;
            }
            
            // –ï—â—ë –Ω–µ –¥–æ—Å—Ç–∏–≥–ª–∏ –ø–æ—Ä–æ–≥–∞ - –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º
            $this->sendJSONResponse([
                'success' => false,
                'message' => 'Verification failed: ' . implode(', ', $errors),
                'attempts_left' => $failureThreshold - $failures
            ]);
            return true;
        }
        
        // –°–æ–∑–¥–∞—ë–º —Ç–æ–∫–µ–Ω
        $token = bin2hex(random_bytes(16));
        $tokenKey = 'js_challenge:token:' . hash('md5', $token);
        
        $tokenData = [
            'ip' => $ip,
            'created_at' => time(),
            'checks' => $checks,
            'fingerprint' => [
                'canvas' => $checksData['canvas'] ?? null,
                'webgl' => $checksData['webgl'] ?? null,
                'behavior' => $checksData['behavior'] ?? null
            ],
            'solve_time' => $totalTime
        ];
        
        try {
            $ttl = $this->jsChallengeSettings['token_ttl'];
            $this->redis->setex($tokenKey, $ttl, $tokenData);
            
            $tokenName = $this->jsChallengeSettings['token_name'];
            $secure = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off';
            setcookie($tokenName, $token, time() + $ttl, '/', '', $secure, true);
            
            $this->setVisitorCookie();
            
            $violationsKey = $this->trackingPrefix . 'violations:' . hash('md5', $ip);
            $this->redis->del($violationsKey);
            
            error_log("JS CHALLENGE PASSED: $ip | Time: {$totalTime}ms");
            $this->incrementJSStat('js_challenge_passed');
            
            $originalUrl = $data['originalUrl'] ?? '/';
            $this->sendJSONResponse([
                'success' => true,
                'message' => 'Verification successful',
                'redirect' => $originalUrl
            ]);
            
        } catch (Exception $e) {
            error_log("Error creating JS token: " . $e->getMessage());
            $this->sendJSONResponse([
                'success' => false,
                'message' => 'Server error'
            ]);
        }
        
        return true;
    }
    
    /**
     * –ü—Ä–æ—Å—Ç–∞—è —Ö–µ—à —Ñ—É–Ω–∫—Ü–∏—è (FNV-1a) - PHP –≤–µ—Ä—Å–∏—è
     */
    private function simpleHashPHP($str) {
        $hash = 2166136261;
        $len = strlen($str);
        
        for ($i = 0; $i < $len; $i++) {
            $hash ^= ord($str[$i]);
            $hash += ($hash << 1) + ($hash << 4) + ($hash << 7) + ($hash << 8) + ($hash << 24);
            $hash &= 0xFFFFFFFF;
        }
        
        return dechex($hash);
    }
    
    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ JSON –æ—Ç–≤–µ—Ç–∞
     */
    private function sendJSONResponse($data) {
        if (!headers_sent()) {
            header('Content-Type: application/json');
        }
        die(json_encode($data));
    }
    
    /**
     * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞ challenge
     */
    private function logChallengeShown($ip, $reason) {
        try {
            $this->incrementJSStat('js_challenge_shown');
            
            $reasonKey = 'js_challenge:reason:' . hash('md5', $ip);
            $this->redis->setex($reasonKey, 300, [
                'reason' => $reason,
                'time' => time(),
                'ip' => $ip
            ]);
            
        } catch (Exception $e) {
            error_log("Error logging challenge: " . $e->getMessage());
        }
    }
    
    /**
     * –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ JS Challenge
     */
    private function incrementJSStat($statName) {
        try {
            $statsKey = 'js_challenge:stats';
            $this->redis->hincrby($statsKey, $statName, 1);
            
            $todayKey = 'js_challenge:stats:' . date('Y-m-d');
            $this->redis->hincrby($todayKey, $statName, 1);
            $this->redis->expire($todayKey, 604800);
            
        } catch (Exception $e) {
            // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
        }
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É JS Challenge
     */
    public function getJSChallengeStats() {
        try {
            $stats = [
                'total_shown' => 0,
                'total_passed' => 0,
                'today_shown' => 0,
                'today_passed' => 0,
                'active_tokens' => 0,
                'success_rate' => 0
            ];
            
            $allTimeStats = $this->redis->hgetall('js_challenge:stats');
            $stats['total_shown'] = (int)($allTimeStats['js_challenge_shown'] ?? 0);
            $stats['total_passed'] = (int)($allTimeStats['js_challenge_passed'] ?? 0);
            
            $todayKey = 'js_challenge:stats:' . date('Y-m-d');
            $todayStats = $this->redis->hgetall($todayKey);
            $stats['today_shown'] = (int)($todayStats['js_challenge_shown'] ?? 0);
            $stats['today_passed'] = (int)($todayStats['js_challenge_passed'] ?? 0);
            
            $iterator = null;
            $count = 0;
            do {
                $keys = $this->redis->scan($iterator, $this->redisPrefix . 'js_challenge:token:*', 100);
                if ($keys !== false) {
                    $count += count($keys);
                }
            } while ($iterator !== 0 && $iterator !== null);
            $stats['active_tokens'] = $count;
            
            if ($stats['total_shown'] > 0) {
                $stats['success_rate'] = round(($stats['total_passed'] / $stats['total_shown']) * 100, 1);
            }
            
            return $stats;
            
        } catch (Exception $e) {
            error_log("Error getting JS challenge stats: " . $e->getMessage());
            return [];
        }
    }
    
    /**
     * –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –ó–ê–©–ò–¢–ê v2.8.0
     * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π/–∞—Ç–∞–∫–∞) –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫
     * @return array ['mode' => 'normal'|'attack', 'reason' => string, 'metrics' => array]
     */
    private function detectAttackMode() {
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            $now = time();
            $oneMinuteAgo = $now - 60;
            
            // 1. –°—á–∏—Ç–∞–µ–º RPS (requests per second)
            $rpmKey = 'stats:rpm:' . date('Y-m-d-H-i', $now);
            $currentRPM = (int)$this->redis->get($rpmKey);
            $currentRPS = round($currentRPM / 60, 2);
            
            // 2. –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≤–∞–ª—ã JS Challenge –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            $failuresCount = 0;
            $iterator = null;
            do {
                $keys = $this->redis->scan($iterator, $this->trackingPrefix . 'js_challenge_failures:*', 100);
                if ($keys !== false && is_array($keys)) {
                    foreach ($keys as $key) {
                        $keyWithoutPrefix = str_replace($this->redisPrefix, '', $key);
                        $failures = (int)$this->redis->get($keyWithoutPrefix);
                        if ($failures > 0) {
                            $failuresCount += $failures;
                        }
                    }
                }
            } while ($iterator != 0);
            
            // 3. –°—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            $blocksCount = 0;
            $iterator = null;
            do {
                $keys = $this->redis->scan($iterator, $this->redisPrefix . 'blocked:*', 100);
                if ($keys !== false && is_array($keys)) {
                    foreach ($keys as $key) {
                        $keyWithoutPrefix = str_replace($this->redisPrefix, '', $key);
                        $blockData = $this->redis->get($keyWithoutPrefix);
                        if ($blockData && is_array($blockData)) {
                            $blockedAt = $blockData['blocked_at'] ?? 0;
                            if ($blockedAt >= $oneMinuteAgo) {
                                $blocksCount++;
                            }
                        }
                    }
                }
            } while ($iterator != 0);
            
            $metrics = [
                'rps' => $currentRPS,
                'failures_per_minute' => $failuresCount,
                'blocks_per_minute' => $blocksCount,
                'timestamp' => $now
            ];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∞—Ç–∞–∫–∏
            $isAttack = false;
            $reasons = [];
            
            if ($currentRPS >= $this->jsChallengeSettings['attack_rps_threshold']) {
                $isAttack = true;
                $reasons[] = "High RPS: {$currentRPS} >= {$this->jsChallengeSettings['attack_rps_threshold']}";
            }
            
            if ($failuresCount >= $this->jsChallengeSettings['attack_failures_per_minute']) {
                $isAttack = true;
                $reasons[] = "High JS failures: {$failuresCount} >= {$this->jsChallengeSettings['attack_failures_per_minute']}";
            }
            
            if ($blocksCount >= $this->jsChallengeSettings['attack_blocks_per_minute']) {
                $isAttack = true;
                $reasons[] = "High blocks: {$blocksCount} >= {$this->jsChallengeSettings['attack_blocks_per_minute']}";
            }
            
            // –ï—Å–ª–∏ –∞—Ç–∞–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
            if ($isAttack) {
                $attackStartKey = 'adaptive:attack_start';
                if (!$this->redis->exists($attackStartKey)) {
                    $this->redis->set($attackStartKey, $now);
                    error_log("üö® ADAPTIVE PROTECTION: ATTACK MODE ACTIVATED | " . implode(', ', $reasons));
                }
            } else {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –∞—Ç–∞–∫–∞ –∏ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ª–∏ –æ–Ω–∞
                $attackStartKey = 'adaptive:attack_start';
                $attackStart = $this->redis->get($attackStartKey);
                
                if ($attackStart) {
                    // –ê—Ç–∞–∫–∞ –±—ã–ª–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ —Å –Ω–∏–∑–∫–∏–º RPS
                    $lowRPSDuration = $now - $attackStart;
                    $recoveryDuration = $this->jsChallengeSettings['recovery_duration'];
                    
                    if ($currentRPS <= $this->jsChallengeSettings['recovery_rps_threshold'] && 
                        $lowRPSDuration >= $recoveryDuration) {
                        // –ê—Ç–∞–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
                        $this->redis->del($attackStartKey);
                        error_log("‚úÖ ADAPTIVE PROTECTION: NORMAL MODE RESTORED | Duration: {$lowRPSDuration}s");
                    } else {
                        // –ê—Ç–∞–∫–∞ –µ—â—ë –∏–¥—ë—Ç (RPS —Å–Ω–∏–∑–∏–ª—Å—è, –Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–ª–≥–æ)
                        $isAttack = true;
                        $reasons[] = "Recovery in progress ({$lowRPSDuration}/{$recoveryDuration}s)";
                    }
                }
            }
            
            return [
                'mode' => $isAttack ? 'attack' : 'normal',
                'reason' => implode('; ', $reasons),
                'metrics' => $metrics
            ];
            
        } catch (Exception $e) {
            error_log("Error detecting attack mode: " . $e->getMessage());
            return ['mode' => 'normal', 'reason' => 'error', 'metrics' => []];
        }
    }
    
    /**
     * –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –ó–ê–©–ò–¢–ê v2.8.0
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥ –ø—Ä–æ–≤–∞–ª–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
     * @return int
     */
    private function getAdaptiveThreshold() {
        // –ï—Å–ª–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥
        if (!$this->jsChallengeSettings['adaptive_protection']) {
            return $this->jsChallengeSettings['failure_block_threshold'];
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º
        $attackMode = $this->detectAttackMode();
        
        if ($attackMode['mode'] === 'attack') {
            // –†–µ–∂–∏–º –∞—Ç–∞–∫–∏ - –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥
            return $this->jsChallengeSettings['adaptive_threshold_attack'];
        } else {
            // –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
            return $this->jsChallengeSettings['adaptive_threshold_normal'];
        }
    }
    
    /**
     * –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –ó–ê–©–ò–¢–ê v2.8.0
     * –ü—É–±–ª–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∑–∞—â–∏—Ç—ã
     * @return array
     */
    public function getAdaptiveProtectionStatus() {
        if (!$this->jsChallengeSettings['adaptive_protection']) {
            return [
                'enabled' => false,
                'mode' => 'disabled',
                'threshold' => $this->jsChallengeSettings['failure_block_threshold'],
                'metrics' => []
            ];
        }
        
        $attackMode = $this->detectAttackMode();
        $currentThreshold = $this->getAdaptiveThreshold();
        
        return [
            'enabled' => true,
            'mode' => $attackMode['mode'],
            'threshold' => $currentThreshold,
            'reason' => $attackMode['reason'],
            'metrics' => $attackMode['metrics'],
            'settings' => [
                'normal_threshold' => $this->jsChallengeSettings['adaptive_threshold_normal'],
                'attack_threshold' => $this->jsChallengeSettings['adaptive_threshold_attack'],
                'attack_rps_threshold' => $this->jsChallengeSettings['attack_rps_threshold'],
                'attack_failures_per_minute' => $this->jsChallengeSettings['attack_failures_per_minute'],
                'attack_blocks_per_minute' => $this->jsChallengeSettings['attack_blocks_per_minute'],
                'recovery_rps_threshold' => $this->jsChallengeSettings['recovery_rps_threshold'],
                'recovery_duration' => $this->jsChallengeSettings['recovery_duration']
            ]
        ];
    }
    
    /**
     * –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ JS Challenge
     */
    public function updateJSChallengeSettings($newSettings) {
        $this->jsChallengeSettings = array_merge($this->jsChallengeSettings, $newSettings);
        error_log("JS Challenge settings updated: " . json_encode($newSettings));
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ JS Challenge
     */
    public function getJSChallengeSettings() {
        return $this->jsChallengeSettings;
    }
    
    /**
     * –î–æ–±–∞–≤–∏—Ç—å URL –≤ —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π JS Challenge
     * 
     * @param string $urlPattern URL –ø–∞—Ç—Ç–µ—Ä–Ω (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç wildcard *)
     * @return bool True –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
     */
    public function addExcludedUrl($urlPattern) {
        if (!isset($this->jsChallengeSettings['excluded_urls'])) {
            $this->jsChallengeSettings['excluded_urls'] = [];
        }
        
        if (!in_array($urlPattern, $this->jsChallengeSettings['excluded_urls'])) {
            $this->jsChallengeSettings['excluded_urls'][] = $urlPattern;
            error_log("Added URL to JS Challenge exclusions: $urlPattern");
            return true;
        }
        
        return false;
    }
    
    /**
     * –£–¥–∞–ª–∏—Ç—å URL –∏–∑ —Å–ø–∏—Å–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π JS Challenge
     * 
     * @param string $urlPattern URL –ø–∞—Ç—Ç–µ—Ä–Ω
     * @return bool True –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
     */
    public function removeExcludedUrl($urlPattern) {
        if (!isset($this->jsChallengeSettings['excluded_urls'])) {
            return false;
        }
        
        $key = array_search($urlPattern, $this->jsChallengeSettings['excluded_urls']);
        if ($key !== false) {
            unset($this->jsChallengeSettings['excluded_urls'][$key]);
            $this->jsChallengeSettings['excluded_urls'] = array_values($this->jsChallengeSettings['excluded_urls']);
            error_log("Removed URL from JS Challenge exclusions: $urlPattern");
            return true;
        }
        
        return false;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö URL –¥–ª—è JS Challenge
     * 
     * @return array –ú–∞—Å—Å–∏–≤ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ URL
     */
    public function getExcludedUrls() {
        return $this->jsChallengeSettings['excluded_urls'] ?? [];
    }
    
    /**
     * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö URL –¥–ª—è JS Challenge
     * 
     * @param array $urlPatterns –ú–∞—Å—Å–∏–≤ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ URL
     */
    public function setExcludedUrls($urlPatterns) {
        $this->jsChallengeSettings['excluded_urls'] = array_values($urlPatterns);
        error_log("Set JS Challenge excluded URLs: " . json_encode($urlPatterns));
    }
    
    /**
     * –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö URL –¥–ª—è JS Challenge
     */
    public function clearExcludedUrls() {
        $this->jsChallengeSettings['excluded_urls'] = [];
        error_log("Cleared JS Challenge excluded URLs");
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏—Å–∫–ª—é—á–µ–Ω –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π URL –∏–∑ JS Challenge
     * 
     * @param string $url URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∏–π)
     * @return bool True –µ—Å–ª–∏ URL –∏—Å–∫–ª—é—á–µ–Ω
     */
    public function isUrlExcluded($url = null) {
        if ($url === null) {
            $url = $_SERVER['REQUEST_URI'] ?? '/';
        }
        
        $excludedUrls = $this->jsChallengeSettings['excluded_urls'] ?? [];
        
        foreach ($excludedUrls as $pattern) {
            if ($this->matchUrlPattern($url, $pattern)) {
                return true;
            }
        }
        
        return false;
    }
    
    public function __destruct() {
        if ($this->redis) {
            try {
                $this->redis->close();
            } catch (Exception $e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            }
        }
    }
}

// ========================================
// –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –§–ò–ù–ê–õ–¨–ù–û–ô –í–ï–†–°–ò–ò
// ========================================

try {
    $protection = new RedisBotProtectionNoSessions(
        '127.0.0.1',    // Redis host
        6379,           // Redis port
        null,           // Redis password (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
        0               // Redis database
    );
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é JS Challenge (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å)
    if ($protection->verifyJSChallenge()) {
        exit; // –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –≤—ã—Ö–æ–¥–∏–º
    }
    
    $protection->protect();
    
    // ====== –ü–†–ò–ú–ï–†–´ –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–Ø ======
    
    // –ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    // $stats = $protection->getStats();
    // echo "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ IP: " . $stats['blocked_ips'] . "\n";
    // echo "–ù–∞—Ä—É—à–µ–Ω–∏–π rate limit: " . $stats['rate_limit_violations'] . "\n";
    // echo "–ê–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–π: " . $stats['tracking_records'] . "\n";
    
    // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π rate limit
    // $violators = $protection->getTopRateLimitViolators(10);
    // foreach ($violators as $v) {
    //     echo "–ù–∞—Ä—É—à–µ–Ω–∏–π: " . $v['violations'] . " | ";
    //     echo "–ó–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω: " . $v['requests_1min'] . " | ";
    //     echo "–ü–æ—Å–ª–µ–¥–Ω–∏–π: " . $v['last_request'] . "\n";
    // }
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ IP
    // $ip = '1.2.3.4';
    // $rateLimitStats = $protection->getRateLimitStats($ip);
    // print_r($rateLimitStats);
    // 
    // $blockInfo = $protection->getBlockedIPInfo($ip);
    // print_r($blockInfo);
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å IP –∏ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    // $protection->unblockIP('1.2.3.4');
    // $protection->resetRateLimit('1.2.3.4');
    // $protection->unblockUserHash(); // —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    
    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏–º–∏—Ç—ã –ø–æ–¥ –≤–∞—à —Å–∞–π—Ç
    // $protection->updateRateLimitSettings([
    //     'max_requests_per_minute' => 120,  // –ë–æ–ª–µ–µ –º—è–≥–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
    //     'max_requests_per_5min' => 400,
    //     'burst_threshold' => 30,            // –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ—Ä–æ–≥ –≤—Å–ø–ª–µ—Å–∫–æ–≤
    //     'ua_change_threshold' => 3          // –°—Ç—Ä–æ–∂–µ –∫ —Å–º–µ–Ω–µ UA
    // ]);
    
    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è Redis
    // $protection->updateGlobalProtectionSettings([
    //     'cleanup_threshold' => 10000,       // –î–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
    //     'cleanup_batch_size' => 200,        // –£–¥–∞–ª—è—Ç—å –±–æ–ª—å—à–µ –∑–∞ —Ä–∞–∑
    //     'cleanup_probability' => 100,       // –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–µ–∂–µ (1%)
    //     'max_cleanup_time_ms' => 100        // –ë–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—á–∏—Å—Ç–∫—É
    // ]);
    
    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å rDNS rate limiting
    // $protection->updateRDNSSettings([
    //     'max_rdns_per_minute' => 120,       // –ë–æ–ª—å—à–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
    //     'rdns_cache_ttl' => 3600,           // –ö–µ—à –Ω–∞ 1 —á–∞—Å
    //     'rdns_negative_cache_ttl' => 600,   // –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –∫–µ—à 10 –º–∏–Ω—É—Ç
    //     'rdns_on_limit_action' => 'skip'    // 'skip' –∏–ª–∏ 'block'
    // ]);
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É rDNS
    // $rdnsStats = $protection->getRDNSRateLimitStats();
    // echo "rDNS –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ç–µ–∫—É—â—É—é –º–∏–Ω—É—Ç—É: " . $rdnsStats['current_minute_requests'] . "/" . $rdnsStats['limit_per_minute'] . "\n";
    // echo "–ó–∞–ø–∏—Å–µ–π –≤ –∫–µ—à–µ: " . $rdnsStats['cache_entries'] . "\n";
    // echo "–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ: " . $rdnsStats['verified_in_cache'] . "\n";
    // if ($rdnsStats['limit_reached']) {
    //     echo "–í–ù–ò–ú–ê–ù–ò–ï: –õ–∏–º–∏—Ç rDNS –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!\n";
    // }
    
    // –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à rDNS (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å)
    // $cleared = $protection->clearRDNSCache();
    // echo "–û—á–∏—â–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π rDNS –∫–µ—à–∞: $cleared\n";
    
    // –°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ rDNS rate limit
    // $protection->resetRDNSRateLimit();
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–º—è—Ç–∏ Redis
    // $memInfo = $protection->getRedisMemoryInfo();
    // echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–∞–º—è—Ç—å: " . $memInfo['used_memory'] . "\n";
    // echo "–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö IP: " . $memInfo['tracked_ips_count'] . "\n";
    // echo "–ù—É–∂–Ω–∞ –æ—á–∏—Å—Ç–∫–∞: " . ($memInfo['cleanup_needed'] ? '–î–ê' : '–ù–ï–¢') . "\n";
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Redis
    // $cleaned = $protection->forceCleanup();  // –û–±—ã—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
    // echo "–û—á–∏—â–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: $cleaned\n";
    // 
    // $cleaned = $protection->forceCleanup(true);  // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è (–≤—Å–µ >1 —á–∞—Å–∞)
    // echo "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –æ—á–∏—â–µ–Ω–æ: $cleaned\n";
    
    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤
    // $protection->updateSlowBotSettings([
    //     'min_requests_for_analysis' => 5,
    //     'long_session_hours' => 3
    // ]);
    
    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    // $diagnosis = $protection->diagnoseUserHash();
    // echo "Hash: " . $diagnosis['stable_hash'] . "\n";
    // echo "IP: " . $diagnosis['ip'] . "\n";
    // echo "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: " . $diagnosis['device_type'] . "\n";
    // echo "–ë—Ä–∞—É–∑–µ—Ä: " . $diagnosis['browser']['name'] . " " . $diagnosis['browser']['version'] . "\n";
    
    // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö–µ—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    // $hashInfo = $protection->getUserHashInfo();
    // print_r($hashInfo);
    
    // –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Redis
    // $cleaned = $protection->cleanup(true);  // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
    // echo "–û—á–∏—â–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: $cleaned\n";
    // 
    // $deepCleaned = $protection->deepCleanup();  // –ì–ª—É–±–æ–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
    // echo "–ì–ª—É–±–æ–∫–æ –æ—á–∏—â–µ–Ω–æ: $deepCleaned\n";
    
    // –ü–†–ò–ú–ï–†–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø rDNS (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤):
    // echo "\n=== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–ò–°–ö–û–í–ò–ö–û–í ===\n\n";
    // $protection->testRDNS('66.249.66.1', 'Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)');
    // echo "\n" . str_repeat("=", 50) . "\n\n";
    // $protection->testRDNS('40.77.167.181', 'Mozilla/5.0 (compatible; bingbot/2.0; +http://www.bing.com/bingbot.htm)');
    // echo "\n" . str_repeat("=", 50) . "\n\n";
    // $protection->testRDNS('1.2.3.4', 'Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)');
    
} catch (Exception $e) {
    error_log("CRITICAL: Bot protection failed - " . $e->getMessage());
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ Redis - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –±–µ–∑ –∑–∞—â–∏—Ç—ã
}

/*
====================================================================
–ß–¢–û –î–ï–õ–ê–ï–¢ –ù–û–í–ê–Ø –ó–ê–©–ò–¢–ê
====================================================================

1. RATE LIMITING - –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤:
   ‚úî 60 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
   ‚úî 200 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 5 –º–∏–Ω—É—Ç
   ‚úî 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å
   ‚úî –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ - –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞

2. –î–ï–¢–ï–ö–¶–ò–Ø –°–ú–ï–ù–´ USER-AGENT:
   ‚úî –ë–ª–æ–∫–∏—Ä—É–µ—Ç IP, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –º–µ–Ω—è—é—Ç UA
   ‚úî –ü–æ—Ä–æ–≥: 5 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö UA –∑–∞ 5 –º–∏–Ω—É—Ç
   ‚úî –ü–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤ —Ä–æ—Ç–∞—Ü–∏–∏ User-Agent

3. BURST DETECTION (–≤—Å–ø–ª–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏):
   ‚úî –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç 20+ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 10 —Å–µ–∫—É–Ω–¥
   ‚úî –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏
   ‚úî –ó–∞—â–∏—Ç–∞ –æ—Ç flood-–∞—Ç–∞–∫

4. –ü–†–û–ì–†–ï–°–°–ò–í–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê:
   ‚úî 1-–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ: 30 –º–∏–Ω—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
   ‚úî 2-–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ: 1 —á–∞—Å
   ‚úî 3+ –Ω–∞—Ä—É—à–µ–Ω–∏—è: 2+ —á–∞—Å–∞ (—Ä–∞—Å—Ç–µ—Ç —Å –∫–∞–∂–¥—ã–º —Ä–∞–∑–æ–º)
   ‚úî –ò—Å—Ç–æ—Ä–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Ö—Ä–∞–Ω–∏—Ç—Å—è 7 –¥–Ω–µ–π

5. –î–ï–¢–ï–ö–¶–ò–Ø –ú–ï–î–õ–ï–ù–ù–´–• –ë–û–¢–û–í:
   ‚úî –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –±–æ—Ç–æ–≤ —Å –Ω–∏–∑–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é
   ‚úî –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
   ‚úî –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤, —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü

6. –†–ê–°–®–ò–†–ï–ù–ù–û–ï –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï:
   ‚úî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö
   ‚úî –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è
   ‚úî 24 —á–∞—Å–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

7. –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ü–û–ò–°–ö–û–í–ò–ö–û–í:
   ‚úî –ü—Ä–æ–≤–µ—Ä–∫–∞ Google, Bing, Yandex –∏ –¥—Ä—É–≥–∏—Ö
   ‚úî rDNS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (–æ–±—Ä–∞—Ç–Ω—ã–π + –ø—Ä—è–º–æ–π DNS)
   ‚úî –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏

8. RATE LIMITING –î–õ–Ø rDNS:
   ‚úî –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ rDNS –ø—Ä–æ–≤–µ—Ä–æ–∫ (60/–º–∏–Ω—É—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
   ‚úî –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ DNS —Å–µ—Ä–≤–µ—Ä–æ–≤
   ‚úî –£–º–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (30 –º–∏–Ω –ø–æ–∑–∏—Ç–∏–≤, 5 –º–∏–Ω –Ω–µ–≥–∞—Ç–∏–≤)
   ‚úî –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ (skip/block)
   ‚úî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è rDNS

9. –ó–ê–©–ò–¢–ê –û–¢ –ü–ï–†–ï–ü–û–õ–ù–ï–ù–ò–Ø REDIS:
   ‚úî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
   ‚úî –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (2% –∑–∞–ø—Ä–æ—Å–æ–≤)
   ‚úî SCAN –≤–º–µ—Å—Ç–æ KEYS (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç Redis)
   ‚úî –ú–∞–∫—Å–∏–º—É–º 50ms –Ω–∞ –æ–¥–Ω—É –æ—á–∏—Å—Ç–∫—É
   ‚úî –°—á–µ—Ç—á–∏–∫ tracked IP –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
   ‚úî –£–º–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ: —Å—Ç–∞—Ä—ã–µ + –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏

====================================================================
–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ù–ê–°–¢–†–û–ô–ö–ï
====================================================================

–î–õ–Ø –ù–ï–ë–û–õ–¨–®–ò–• –°–ê–ô–¢–û–í (<1000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   - –û—Å—Ç–∞–≤—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - max_requests_per_minute: 60
   - burst_threshold: 20

–î–õ–Ø –°–†–ï–î–ù–ò–• –°–ê–ô–¢–û–í (1000-10000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   $protection->updateRateLimitSettings([
       'max_requests_per_minute' => 90,
       'max_requests_per_5min' => 300,
       'burst_threshold' => 30
   ]);

–î–õ–Ø –ö–†–£–ü–ù–´–• –°–ê–ô–¢–û–í (> 10000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   $protection->updateRateLimitSettings([
       'max_requests_per_minute' => 120,
       'max_requests_per_5min' => 500,
       'max_requests_per_hour' => 2000,
       'burst_threshold' => 40
   ]);
   
   –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ:
   - getTopRateLimitViolators() –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - getStats() –¥–ª—è –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

–î–õ–Ø API –ò –í–´–°–û–ö–û–ù–ê–ì–†–£–ñ–ï–ù–ù–´–• –ü–†–ò–õ–û–ñ–ï–ù–ò–ô:
   $protection->updateRateLimitSettings([
       'max_requests_per_minute' => 180,
       'max_requests_per_5min' => 800,
       'burst_threshold' => 50,
       'ua_change_threshold' => 10  // API –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å UA
   ]);

–°–¢–†–û–ì–ò–ô –†–ï–ñ–ò–ú (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞):
   $protection->updateRateLimitSettings([
       'max_requests_per_minute' => 30,
       'max_requests_per_5min' => 100,
       'burst_threshold' => 10,
       'ua_change_threshold' => 3
   ]);

–ù–ê–°–¢–†–û–ô–ö–ò rDNS RATE LIMITING:

–î–õ–Ø –ù–ï–ë–û–õ–¨–®–ò–• –°–ê–ô–¢–û–í (<1000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   // –û—Å—Ç–∞–≤—å—Ç–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
   // max_rdns_per_minute: 60
   // rdns_cache_ttl: 1800 (30 –º–∏–Ω—É—Ç)

–î–õ–Ø –°–†–ï–î–ù–ò–• –°–ê–ô–¢–û–í (1000-10000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   $protection->updateRDNSSettings([
       'max_rdns_per_minute' => 120,
       'rdns_cache_ttl' => 3600,           // 1 —á–∞—Å
       'rdns_negative_cache_ttl' => 600    // 10 –º–∏–Ω—É—Ç
   ]);

–î–õ–Ø –ö–†–£–ü–ù–´–• –°–ê–ô–¢–û–í (>10000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   $protection->updateRDNSSettings([
       'max_rdns_per_minute' => 200,
       'rdns_cache_ttl' => 7200,           // 2 —á–∞—Å–∞
       'rdns_negative_cache_ttl' => 900,   // 15 –º–∏–Ω—É—Ç
       'rdns_on_limit_action' => 'skip'    // –ù–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏
   ]);

–î–õ–Ø –û–ß–ï–ù–¨ –ö–†–£–ü–ù–´–• (>100000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   $protection->updateRDNSSettings([
       'max_rdns_per_minute' => 300,       // –ò–ª–∏ –≤—ã—à–µ
       'rdns_cache_ttl' => 14400,          // 4 —á–∞—Å–∞
       'rdns_negative_cache_ttl' => 1800,  // 30 –º–∏–Ω—É—Ç
       'rdns_on_limit_action' => 'skip'
   ]);
   
   // –í–ê–ñ–ù–û: –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π DNS –∫–µ—à —Å–µ—Ä–≤–µ—Ä (dnsmasq/unbound)

–ï–°–õ–ò –ú–ù–û–ì–û –ü–û–ò–°–ö–û–í–´–• –ë–û–¢–û–í:
   $protection->updateRDNSSettings([
       'max_rdns_per_minute' => 500,
       'rdns_cache_ttl' => 86400,          // 24 —á–∞—Å–∞ (–±–æ—Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã)
       'rdns_negative_cache_ttl' => 3600
   ]);

–ù–ê–°–¢–†–û–ô–ö–ò –ó–ê–©–ò–¢–´ –û–¢ –ü–ï–†–ï–ü–û–õ–ù–ï–ù–ò–Ø:

–î–õ–Ø –ù–ï–ë–û–õ–¨–®–ò–• –°–ê–ô–¢–û–í (<1000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   // –û—Å—Ç–∞–≤—å—Ç–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
   // cleanup_threshold: 5000
   // cleanup_probability: 50 (2% –∑–∞–ø—Ä–æ—Å–æ–≤)

–î–õ–Ø –°–†–ï–î–ù–ò–• –°–ê–ô–¢–û–í (1000-10000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   $protection->updateGlobalProtectionSettings([
       'cleanup_threshold' => 10000,
       'cleanup_batch_size' => 150,
       'cleanup_probability' => 75  // 1.3% –∑–∞–ø—Ä–æ—Å–æ–≤
   ]);

–î–õ–Ø –ö–†–£–ü–ù–´–• –°–ê–ô–¢–û–í (>10000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   $protection->updateGlobalProtectionSettings([
       'cleanup_threshold' => 20000,
       'cleanup_batch_size' => 200,
       'cleanup_probability' => 100, // 1% –∑–∞–ø—Ä–æ—Å–æ–≤
       'max_cleanup_time_ms' => 100  // –ë–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—á–∏—Å—Ç–∫—É
   ]);

–î–õ–Ø –û–ß–ï–ù–¨ –ö–†–£–ü–ù–´–• (>100000 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π/–¥–µ–Ω—å):
   $protection->updateGlobalProtectionSettings([
       'cleanup_threshold' => 50000,
       'cleanup_batch_size' => 500,
       'cleanup_probability' => 200, // 0.5% –∑–∞–ø—Ä–æ—Å–æ–≤
       'max_cleanup_time_ms' => 200
   ]);
   
   // + –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π Redis —Å–µ—Ä–≤–µ—Ä
   // + –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Redis persistence (AOF/RDB)

====================================================================
–ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –û–¢–õ–ê–î–ö–ê
====================================================================

–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏:
   tail -f /var/log/php_errors.log | grep "RATE LIMIT"
   tail -f /var/log/php_errors.log | grep "Bot blocked"
   tail -f /var/log/php_errors.log | grep "Redis cleanup"
   tail -f /var/log/php_errors.log | grep "rDNS rate limit"

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–¥–æ–±–∞–≤—å—Ç–µ –≤ cron –∫–∞–∂–¥—ã–π —á–∞—Å):
   $stats = $protection->getStats();
   if ($stats['rate_limit_violations'] > 100) {
       // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
   }

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ rDNS (–∫–∞–∂–¥—ã–π —á–∞—Å):
   $rdnsStats = $protection->getRDNSRateLimitStats();
   if ($rdnsStats['limit_reached']) {
       error_log("WARNING: rDNS rate limit reached! Current: " . 
                $rdnsStats['current_minute_requests'] . "/" . 
                $rdnsStats['limit_per_minute']);
       
       // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–µ—à
       if ($rdnsStats['cache_entries'] > 10000) {
           $protection->clearRDNSCache();
       }
   }
   
   // –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   error_log("rDNS Stats: " . 
            "Current: {$rdnsStats['current_minute_requests']}, " .
            "Cache: {$rdnsStats['cache_entries']}, " .
            "Verified: {$rdnsStats['verified_in_cache']}");

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏ Redis (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç):
   $memInfo = $protection->getRedisMemoryInfo();
   if ($memInfo['cleanup_needed']) {
       error_log("WARNING: Redis cleanup needed! Tracked IPs: " . 
                $memInfo['tracked_ips_count']);
       // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
       $protection->forceCleanup();
   }

–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–¥–æ–±–∞–≤—å—Ç–µ –≤ cron):
   $protection->deepCleanup();
   
–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å–∞–π—Ç–æ–≤):
   $cleaned = $protection->forceCleanup(true);
   error_log("Daily aggressive cleanup: removed $cleaned records");

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
   // –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤—Ä–µ–º—è –æ—á–∏—Å—Ç–∫–∏ –≤ –ª–æ–≥–∞—Ö:
   // "Redis cleanup: removed 150 tracked IPs (approx 45.23ms)"
   
   // –ï—Å–ª–∏ –≤—Ä–µ–º—è >100ms —Ä–µ–≥—É–ª—è—Ä–Ω–æ:
   $protection->updateGlobalProtectionSettings([
       'cleanup_batch_size' => 50,  // –£–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞
       'max_cleanup_time_ms' => 80  // –£–º–µ–Ω—å—à–∏—Ç–µ –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏
   ]);

====================================================================
TROUBLESHOOTING
====================================================================

–ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: grep "RATE LIMIT BLOCK" /var/log/php_errors.log
2. –£–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç—ã –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–∏–ø–∞ —Å–∞–π—Ç–∞
3. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π IP: $protection->unblockIP('x.x.x.x')
4. –°–±—Ä–æ—Å—å—Ç–µ —Å—á–µ—Ç—á–∏–∫–∏: $protection->resetRateLimit('x.x.x.x')

–ï—Å–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –±–æ—Ç—ã:
1. –£–º–µ–Ω—å—à–∏—Ç–µ –ø–æ—Ä–æ–≥–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω—ã: $protection->getBlockedIPInfo('x.x.x.x')
3. –î–æ–±–∞–≤—å—Ç–µ –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö UA –≤ –º–µ—Ç–æ–¥–µ isSuspiciousUserAgent()

–ü—Ä–æ–±–ª–µ–º—ã —Å rDNS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç: $rdnsStats = $protection->getRDNSRateLimitStats()
2. –ï—Å–ª–∏ –ª–∏–º–∏—Ç —á–∞—Å—Ç–æ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è:
   $protection->updateRDNSSettings([
       'max_rdns_per_minute' => 200,  // –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç
       'rdns_cache_ttl' => 7200       // –£–≤–µ–ª–∏—á–∏—Ç—å –∫–µ—à
   ]);
3. –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–µ—à: $protection->clearRDNSCache()
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DNS —Å–µ—Ä–≤–µ—Ä: dig -x <IP> (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–æ)
5. –ï—Å–ª–∏ DNS –º–µ–¥–ª–µ–Ω–Ω—ã–π - —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π DNS –∫–µ—à (dnsmasq)
6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π IP: $protection->testRDNS('66.249.66.1', 'Googlebot')

–ë–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∏:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ rDNS –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ rdns_on_limit_action = 'skip' (–Ω–µ 'block')
3. –£–≤–µ–ª–∏—á—å—Ç–µ –∫–µ—à TTL –¥–ª—è –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤:
   $protection->updateRDNSSettings(['rdns_cache_ttl' => 86400]);
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: grep "rDNS" /var/log/php_errors.log

–ï—Å–ª–∏ Redis –ø–∞–¥–∞–µ—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:
- –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É –ë–ï–ó –∑–∞—â–∏—Ç—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω: redis-cli ping

====================================================================
–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨
====================================================================

–í–ê–ñ–ù–û: –ò–∑–º–µ–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á!
   private $secretKey = 'your_secret_key_here_change_this12345!@#$';
   
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞.

–í–ê–ñ–ù–û: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Redis –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è Redis
   - –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ Redis –ø–æ IP
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—É—é –ë–î –¥–ª—è bot protection

–í–ê–ñ–ù–û: –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ DNS –¥–ª—è rDNS –ø—Ä–æ–≤–µ—Ä–æ–∫!
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π DNS –∫–µ—à (dnsmasq, unbound)
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ systemd-resolved –ø—Ä–∞–≤–∏–ª—å–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ /etc/resolv.conf –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
   - –£–≤–µ–ª–∏—á—å—Ç–µ TTL –∫–µ—à–∞ –¥–ª—è rDNS —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   
–ú–û–ù–ò–¢–û–†–ò–ù–ì rDNS:
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ rDNS –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
   watch -n 5 'redis-cli --scan --pattern "bot_protection:rdns:ratelimit:*" | xargs redis-cli mget'
   
   # –†–∞–∑–º–µ—Ä rDNS –∫–µ—à–∞
   redis-cli --scan --pattern "bot_protection:rdns:cache:*" | wc -l
   
   # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å DNS
   time dig -x 66.249.66.1  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å <50ms

====================================================================
–ú–ò–ì–†–ê–¶–ò–Ø –ù–ê –í–ï–†–°–ò–Æ 2.3 (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏)
====================================================================

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ –≤–µ—Ä—Å–∏–∏ 2.3 –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö rate limit –∫–ª—é—á–µ–π:

   // –ó–∞–ø—É—Å—Ç–∏—Ç—å –û–î–ò–ù —Ä–∞–∑ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!
   $protection = new RedisBotProtectionNoSessions();
   $deleted = $protection->migrateFromOldRateLimitKeys();
   echo "–£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π: $deleted\n";

–ò–ª–∏ —á–µ—Ä–µ–∑ CLI:
   php -r "
   require '/var/www/your-site/bot_protection/inline_check.php';
   \$p = new RedisBotProtectionNoSessions();
   echo 'Deleted: ' . \$p->migrateFromOldRateLimitKeys() . PHP_EOL;
   "

–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –ö–õ–Æ–ß–ï–ô:

   $stats = $protection->getKeyStats();
   print_r($stats);
   
   // –ü–æ–∫–∞–∂–µ—Ç:
   // [tracking_ip] => 2360      - –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–∫–∏–Ω–≥
   // [rate_limit] => 2400       - rate limit (v2.3: 1 –Ω–∞ IP)
   // [global_rate_limit] => 100 - –≥–ª–æ–±–∞–ª—å–Ω—ã–π rate limit
   // [blocked] => 50            - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
   // [rdns] => 200              - –∫–µ—à rDNS
   // [user_hash] => 500         - user hash —Ç—Ä–µ–∫–∏–Ω–≥
   // [extended] => 100          - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥
   // [total] => 5710            - –≤—Å–µ–≥–æ –∫–ª—é—á–µ–π

–û–ñ–ò–î–ê–ï–ú–û–ï –°–û–ö–†–ê–©–ï–ù–ò–ï –ö–õ–Æ–ß–ï–ô –ü–û–°–õ–ï –ú–ò–ì–†–ê–¶–ò–ò:

   –ë—ã–ª–æ (v2.1-2.2):
   - 2,360 IP √ó 5-7 –∫–ª—é—á–µ–π = 12,000-16,000 –∫–ª—é—á–µ–π
   
   –°—Ç–∞–ª–æ (v2.3):
   - 2,360 IP √ó 2-3 –∫–ª—é—á–∞ = 4,700-7,000 –∫–ª—é—á–µ–π
   
   –≠–∫–æ–Ω–æ–º–∏—è: ~50-60% –∫–ª—é—á–µ–π –∏ –ø–∞–º—è—Ç–∏!

====================================================================
*/
?>
